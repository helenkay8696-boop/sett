// @ts-nocheck

window.handleAdvanceTotal = function () {
    let advanceTotal = 0;
    let receivableAdditionTotal = 0;

    const tbody = document.getElementById('fee-entry-income-tbody');
    if (tbody) {
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            const amountInput = row.querySelector('.income-fee-amount');
            const categorySelect = row.querySelector('.income-fee-category');
            if (amountInput && categorySelect) {
                const val = parseFloat(amountInput.value);
                if (!isNaN(val)) {
                    if (categorySelect.value === '代垫') {
                        advanceTotal += val;
                    } else if (categorySelect.value === '应收') {
                        receivableAdditionTotal += val;
                    }
                }
            }
        });
    }

    // Add custom configured fields in receivable grid to the addition total
    const customReceivableInputs = document.querySelectorAll('#expense-entry-receivable-grid .custom-fee-input');
    customReceivableInputs.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) {
            receivableAdditionTotal += val;
        }
    });

    const deliveryFee = parseFloat(document.getElementById('expense-entry-delivery-fee')?.value) || 0;
    const loadingFee = parseFloat(document.getElementById('expense-entry-loading-fee')?.value) || 0;
    const unloadingFee = parseFloat(document.getElementById('expense-entry-unloading-fee')?.value) || 0;

    const additionalFeeTotal = deliveryFee + loadingFee + unloadingFee + receivableAdditionTotal;
    const additionalFeeInput = document.getElementById('expense-entry-additional-fee');
    if (additionalFeeInput) {
        additionalFeeInput.value = additionalFeeTotal > 0 ? additionalFeeTotal.toFixed(2) : '0.00';
    }

    // 收入合计 = 应收运费 + 附加费
    const receivableFreight = parseFloat(document.getElementById('expense-entry-receivable-freight')?.value) || 0;
    const incomeTotal = receivableFreight + additionalFeeTotal;
    const incomeTotalInput = document.getElementById('expense-entry-income-total');
    if (incomeTotalInput) {
        incomeTotalInput.value = incomeTotal > 0 ? incomeTotal.toFixed(2) : '0.00';
    }

    const advanceTotalInput = document.getElementById('expense-entry-advance-total');
    if (advanceTotalInput) advanceTotalInput.value = advanceTotal > 0 ? advanceTotal.toFixed(2) : '0.00';
};

window.handleFreightCalc = function (type, changed) {
    const isRec = type === 'receivable';
    const freightInput = document.getElementById(isRec ? 'expense-entry-receivable-freight' : 'expense-entry-payable-freight');
    const weightInput = document.getElementById(isRec ? 'expense-entry-customer-weight' : 'expense-entry-carrier-weight');
    const priceInput = document.getElementById(isRec ? 'expense-entry-customer-unit-price' : 'expense-entry-carrier-unit-price');

    if (!freightInput || !weightInput || !priceInput) return;

    let f = parseFloat(freightInput.value);
    let w = parseFloat(weightInput.value);
    let p = parseFloat(priceInput.value);

    // Helper to check if it's a valid number. We allow strings to convert, NaN comes if empty.
    const isValid = (val) => !isNaN(val) && val !== null;

    if (changed === 'price') {
        if (isValid(p) && isValid(w)) {
            freightInput.value = (p * w).toFixed(2);
            if (isRec) window.handleAdvanceTotal();
        } else if (isValid(p) && isValid(f) && p !== 0) {
            weightInput.value = (f / p).toFixed(4);
        }
    } else if (changed === 'weight') {
        if (isValid(w) && isValid(p)) {
            freightInput.value = (p * w).toFixed(2);
            if (isRec) window.handleAdvanceTotal();
        } else if (isValid(w) && isValid(f) && w !== 0) {
            priceInput.value = (f / w).toFixed(2);
        }
    } else if (changed === 'freight') {
        if (isValid(f) && isValid(w) && w !== 0) {
            priceInput.value = (f / w).toFixed(2);
        } else if (isValid(f) && isValid(p) && p !== 0) {
            weightInput.value = (f / p).toFixed(4);
        }
    }
};

window.invoiceExpenseConfigs = [
    { code: "1060101010000000000", name: "运输服务", taxName: "运输服务", rate: "9", isTaxFree: "否" }
];

const menuData = [
    {
        title: "应收应付",
        icon: "file-text",
        items: ["应收对账", "应付对账", "应收明细", "应付明细", "客户账单"]
    },
    {
        title: "收付",
        icon: "credit-card",
        items: ["收付款", "付款申请"]
    },
    {
        title: "放单",
        icon: "file-check",
        items: ["放单", "放货"],
        exclude: true
    },
    {
        title: "发票",
        icon: "form-input",
        items: ["发票管理", "开票申请", "开票费用配置", "红字申请确认单"]
    },
    {
        title: "结算主体",
        icon: "building",
        items: ["结算单位"]
    },
    {
        title: "银企直连",
        icon: "landmark",
        items: ["银行收款流水", "银行付款流水", "银企直连配置"]
    },
    {
        title: "内部费用",
        icon: "receipt",
        items: ["费用单", "费用申请"]
    },
    {
        title: "卡片管理",
        icon: "wallet",
        items: ["油卡管理", "储值管理"]
    },
    {
        title: "设置",
        icon: "settings",
        items: ["结算设置"]
    }
];

const businessMenuData = [
    {
        title: "业务管理",
        icon: "briefcase",
        items: ["费用录入", "费用面板", "订单回显", "配载费用", "运单管理"]
    }
];

const reportMenuData = [
    {
        title: "业务报表",
        icon: "bar-chart-3",
        items: ["货量利润表"]
    }
];

window.goToInvoiceApplication = function () {
    // 1. Use existing addTab function to switch to the tab and render it
    if (typeof window.addTab === 'function') {
        window.addTab('开票申请');
    } else if (typeof addTab === 'function') {
        addTab('开票申请');
    } else {
        console.error('addTab function not found');
        return;
    }

    // 2. Open the create view immediately
    // Wait for render to complete (since renderTabs replaces innerHTML)
    setTimeout(() => {
        const listView = document.getElementById('invoice-application-list-view');
        const createView = document.getElementById('invoice-application-create-view');
        const customerSidebar = document.querySelector('.customer-sidebar');

        if (listView && createView) {
            listView.style.display = 'none';
            createView.style.display = 'flex';
        }

        // Hide customer sidebar
        if (customerSidebar) {
            customerSidebar.style.display = 'none';
        }
    }, 100);
};

window.goToPaymentApplication = function () {
    // 1. Use existing addTab function to switch to the tab and render it
    if (typeof window.addTab === 'function') {
        window.addTab('付款申请');
    } else if (typeof addTab === 'function') {
        addTab('付款申请');
    } else {
        console.error('addTab function not found');
        return;
    }

    // 2. Open the create view immediately
    // Wait for render to complete (since renderTabs replaces innerHTML)
    setTimeout(() => {
        const listView = document.getElementById('payment-application-list-view');
        const createView = document.getElementById('payment-application-create-view');
        const customerSidebar = document.querySelector('.customer-sidebar');

        if (listView && createView) {
            listView.style.display = 'none';
            createView.style.display = 'flex';
        }

        // Hide customer sidebar
        if (customerSidebar) {
            customerSidebar.style.display = 'none';
        }
    }, 100);
};

window.openReceiptCreateView = function () {
    // Hide all main views directly in the current active tab (likely 收付款)
    const container = document.querySelector('.page-content');
    if (!container) return;

    // A simple approach if we know we are inside "收付款" is to hide other sibling views
    const listView = document.getElementById('payment-list-view');
    const statementView = document.getElementById('statement-create-view');
    const receiptCreateView = document.getElementById('receipt-create-view');
    const customerSidebar = document.querySelector('.customer-sidebar');

    if (listView) listView.style.display = 'none';
    if (statementView) statementView.style.display = 'none';

    // Also try to hide Payment Application views if present
    const payAppListView = document.getElementById('payment-application-list-view');
    const payAppCreateView = document.getElementById('payment-application-create-view');
    if (payAppListView) payAppListView.style.display = 'none';
    if (payAppCreateView) payAppCreateView.style.display = 'none';

    if (customerSidebar) customerSidebar.style.display = 'none';

    if (receiptCreateView) {
        receiptCreateView.style.display = 'flex';
    }
};

window.closeReceiptCreateView = function () {
    const listView = document.getElementById('payment-list-view');
    const receiptCreateView = document.getElementById('receipt-create-view');
    const customerSidebar = document.querySelector('.customer-sidebar');

    if (receiptCreateView) receiptCreateView.style.display = 'none';
    if (listView) listView.style.display = 'flex';
    if (customerSidebar) customerSidebar.style.display = 'block';
};

window.pendingRechargeRequests = [];
window.processedRechargeRequests = [];

// --- Expense Audit Data ---
window.expenseAuditData = [];
window.payableExpenseData = []; // New data structure for payable expenses
window.ordersData = [];
window.waybillsData = [
    { no: 'WB20250101001', date: '2025-01-01', customer: '孝感市丰源物流有限公司', route: '孝感 -> 北京', goods: '电子产品' },
    { no: 'WB20250101002', date: '2025-01-02', customer: '上海顺丰速运有限公司', route: '上海 -> 广州', goods: '服装' },
    { no: 'WB20250101003', date: '2025-01-03', customer: '北京京东世纪贸易有限公司', route: '北京 -> 成都', goods: '食品' }
];

// --- Invoice Application Data ---
window.invoiceApplicationData = [
    { id: 1, status: '待审核', statusColor: '#d97706', statusBg: '#fef3c7', invoiceNo: '-', type: '普票', unit: '深圳市好运来货运代理有限公司', date: '2023-12-05', currency: 'CNY', amount: '2,000.00', tax: '120.00', total: '2,120.00', localTotal: '2,120.00', workNo: 'YO2512-0023', billNo: 'B2023120501', user: '赵六', time: '2023-12-05 11:00' },
    { id: 2, status: '已开票', statusColor: '#4f46e5', statusBg: '#dbeafe', invoiceNo: 'INV20231206001', type: '专票(6%)', unit: '北京京华物流有限公司', date: '2023-12-06', currency: 'CNY', amount: '8,000.00', tax: '480.00', total: '8,480.00', localTotal: '8,480.00', workNo: 'YO2512-0024', billNo: 'B2023120601', user: '孙七', time: '2023-12-06 15:20' },
    { id: 3, status: '草稿', statusColor: '#475569', statusBg: '#e2e8f0', invoiceNo: '-', type: '专票(13%)', unit: '天津港保税区物流', date: '2023-12-07', currency: 'USD', amount: '1,500.00', tax: '0.00', total: '1,500.00', localTotal: '10,800.00', workNo: 'YO2512-0025', billNo: 'B2023120701', user: '周八', time: '2023-12-07 09:45' },
    { id: 4, status: '已驳回/已取消', statusColor: '#ef4444', statusBg: '#fee2e2', invoiceNo: '-', type: '普票', unit: '上海海运物流有限公司', date: '2023-12-08', currency: 'CNY', amount: '3,200.00', tax: '0.00', total: '3,200.00', localTotal: '3,200.00', workNo: 'YO2512-0026', billNo: 'B2023120801', user: '吴九', time: '2023-12-08 14:10' },
    { id: 5, status: '已批准', statusColor: '#10b981', statusBg: '#dcfce7', invoiceNo: '-', type: '专票(6%)', unit: '广州顺丰速运', date: '2023-12-09', currency: 'CNY', amount: '5,500.00', tax: '330.00', total: '5,830.00', localTotal: '5,830.00', workNo: 'YO2512-0027', billNo: 'B2023120901', user: '郑十', time: '2023-12-09 10:30' }
];

window.renderInvoiceApplicationList = function (status = '全部') {
    const tbody = document.querySelector('#invoice-application-list-view .statement-table tbody');
    if (!tbody) return;

    let filteredData = window.invoiceApplicationData;
    if (status !== '全部') {
        // Map tab names to status values loosely if needed, or exact match
        if (status.includes('审核中')) status = '待审核'; // Map "审核中" tab to "待审核" data status if consistent
        else if (status.includes('已驳回')) status = '已驳回/已取消';
        else if (status.includes('草稿')) status = '草稿';
        else if (status.includes('已批准')) status = '已批准';
        else if (status.includes('已开票')) status = '已开票';

        filteredData = window.invoiceApplicationData.filter(item => item.status === status);
    }

    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="17" style="text-align: center; padding: 24px; color: #94a3b8;">暂无数据</td></tr>';
        return;
    }

    tbody.innerHTML = filteredData.map((item, index) => `
        <tr style="border-bottom: 1px solid #f1f5f9;">
            <td style="padding: 10px; text-align: center;"><input type="checkbox" /></td>
            <td style="padding: 10px; text-align: center;">${index + 1}</td>
            <td style="padding: 10px;"><span style="background: ${item.statusBg}; color: ${item.statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${item.status}</span></td>
            <td style="padding: 10px;">${item.invoiceNo}</td>
            <td style="padding: 10px;">${item.type}</td>
            <td style="padding: 10px;">${item.unit}</td>
            <td style="padding: 10px;">${item.date}</td>
            <td style="padding: 10px;">${item.currency}</td>
            <td style="padding: 10px; text-align: right;">${item.amount}</td>
            <td style="padding: 10px; text-align: right;">${item.tax}</td>
            <td style="padding: 10px; text-align: right;">${item.total}</td>
            <td style="padding: 10px; text-align: right;">${item.localTotal}</td>
            <td style="padding: 10px;">${item.workNo}</td>
            <td style="padding: 10px;">${item.billNo}</td>
            <td style="padding: 10px;">${item.user}</td>
            <td style="padding: 10px;">${item.time}</td>
            <td style="padding: 10px;">${item.time}</td>
            <td style="padding: 10px; text-align: center;">
                ${(item.status === '待审核' || item.status === '审核中') ? `
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <a href="javascript:void(0)" onclick="window.approveInvoiceApplication(${item.id})" style="color: #4f46e5; font-size: 0.8rem; text-decoration: none;">批准</a>
                        <a href="javascript:void(0)" onclick="window.rejectInvoiceApplication(${item.id})" style="color: #ef4444; font-size: 0.8rem; text-decoration: none;">驳回</a>
                    </div>
                ` : `
                    <i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i>
                `}
            </td>
        </tr>
    `).join('');

    if (window.lucide) window.lucide.createIcons();
};

window.approveInvoiceApplication = function (id) {
    const item = window.invoiceApplicationData.find(i => i.id === id);
    if (item) {
        item.status = '已批准';
        item.statusColor = '#4f46e5';
        item.statusBg = '#dbeafe';
        alert('申请已批准');
        window.renderInvoiceApplicationList(document.querySelector('.status-tab.active span')?.parentElement.textContent.trim().split(' ')[0] || '全部');
    }
};

window.rejectInvoiceApplication = function (id) {
    const item = window.invoiceApplicationData.find(i => i.id === id);
    if (item) {
        item.status = '已驳回';
        item.statusColor = '#ef4444';
        item.statusBg = '#fee2e2';
        alert('申请已驳回');
        window.renderInvoiceApplicationList(document.querySelector('.status-tab.active span')?.parentElement.textContent.trim().split(' ')[0] || '全部');
    }
};





window.switchPaymentApplicationTab = function (el) {
    const tabs = el.parentElement.children;
    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
        tabs[i].style.borderBottom = 'none';
        tabs[i].style.color = '#475569';
        tabs[i].style.fontWeight = 'normal';
    }
    el.classList.add('active');
    el.style.borderBottom = '2px solid #4f46e5';
    el.style.color = '#4f46e5';
    el.style.fontWeight = '500';

    // Logic to filter list or switch views can go here. 
    // Currently just visual switching as per request "switch to that tab".
};

// --- Waybill to Payment Jump ---
window.jumpToPaymentFromWaybill = function () {
    // 1. Check if there are expenses to pay
    let expenses = [];
    if (window.expenseAuditData) {
        expenses = window.expenseAuditData.filter(e => {
            return (e.cost && parseFloat(e.cost) > 0) || e.expenseType === 'advance';
        });
    }

    if (expenses.length === 0) {
        // Fallback for demo
        expenses.push(
            { id: 999, date: '2025-01-25', itemName: '临时运费', cost: 500, customer: '临时客户', expenseType: 'advance' }
        );
    }

    // 2. Open "付款申请" Tab
    if (window.addTab) {
        window.addTab('付款申请');
    } else {
        alert('Error: addTab function not found');
        return;
    }

    // 3. Switch to Create View
    setTimeout(() => {
        if (typeof window.openPaymentApplicationCreateView === 'function') {
            window.openPaymentApplicationCreateView();
        } else {
            const listView = document.getElementById('payment-application-list-view');
            const createView = document.getElementById('payment-application-create-view');
            if (listView && createView) {
                listView.style.display = 'none';
                createView.style.display = 'flex';
            }
        }

        // 4. Pre-fill Data
        const tableBody = document.querySelector('#payment-application-create-view table tbody');
        if (tableBody) {
            tableBody.innerHTML = expenses.map((e, index) => `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 8px; text-align: center;"><input type="checkbox" checked></td>
                    <td style="padding: 8px;">${index + 1}</td>
                    <td style="padding: 8px;">${e.date}</td>
                    <td style="padding: 8px;">EXP${e.id}</td>
                    <td style="padding: 8px;">${e.itemName}</td>
                    <td style="padding: 8px;">CNY</td>
                    <td style="padding: 8px; text-align: right;">${Number(e.cost).toFixed(2)}</td>
                    <td style="padding: 8px;">CUST001</td>
                    <td style="padding: 8px;">${e.customer}</td>
                    <td style="padding: 8px;">${e.customer}</td>
                    <td style="padding: 8px; text-align: right;">1.00</td>
                </tr>
            `).join('');
        }
    }, 100);
};

// --- Invoice Management Data ---
window.invoiceManagementData = [
    { id: 1, status: '待开票', statusBg: '#e2e8f0', statusColor: '#475569', invoiceNo: '-', type: '普票', unit: '深圳市好运来货运代理有限公司', date: '2023-12-01', currency: 'CNY', amount: '1,000.00', tax: '60.00', total: '1,060.00', localTotal: '1,060.00', workNo: 'YO2512-0020', billNo: 'B2023120101', user: '张三', time: '2023-12-01 10:00' },
    { id: 2, status: '已出票', statusBg: '#dbeafe', statusColor: '#4f46e5', invoiceNo: 'INV20231201001', type: '专票(6%)', unit: '广州市顺风物流有限公司', date: '2023-12-02', currency: 'USD', amount: '500.00', tax: '0.00', total: '500.00', localTotal: '3,600.00', workNo: 'YO2512-0021', billNo: 'B2023120201', user: '李四', time: '2023-12-02 14:30' },
    { id: 3, status: '审核中', statusBg: '#fef3c7', statusColor: '#d97706', invoiceNo: '-', type: '专票(13%)', unit: '上海市东方国际物流集团', date: '2023-12-03', currency: 'CNY', amount: '5,000.00', tax: '650.00', total: '5,650.00', localTotal: '5,650.00', workNo: 'YO2512-0022', billNo: 'B2023120301', user: '王五', time: '2023-12-03 09:15' }
];

window.renderInvoiceManagementList = function (status) {
    const tableContainer = document.querySelector('#invoice-management-table-container table tbody');
    if (!tableContainer) return;

    let filteredData = window.invoiceManagementData;
    if (status && status !== '全部') {
        // Handle "已出票" special case to match the UI which likely groups things
        if (status === '已出票') {
            filteredData = window.invoiceManagementData.filter(item => item.status === '已出票' || item.status === '已开票');
        } else {
            filteredData = window.invoiceManagementData.filter(item => item.status === status);
        }
    }

    if (filteredData.length === 0) {
        tableContainer.innerHTML = '<tr><td colspan="17" style="text-align: center; padding: 24px; color: #94a3b8;">暂无数据</td></tr>';
        return;
    }

    tableContainer.innerHTML = filteredData.map((item, index) => `
        <tr style="border-bottom: 1px solid #f1f5f9;">
            <td style="padding: 10px; text-align: center;"><input type="checkbox"></td>
            <td style="padding: 10px; text-align: center;">${index + 1}</td>
            <td style="padding: 10px;"><span style="background: ${item.statusBg}; color: ${item.statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${item.status}</span></td>
            <td style="padding: 10px;">${item.invoiceNo}</td>
            <td style="padding: 10px;">${item.type}</td>
            <td style="padding: 10px;">${item.unit}</td>
            <td style="padding: 10px;">${item.date}</td>
            <td style="padding: 10px;">${item.currency}</td>
            <td style="padding: 10px; text-align: right;">${item.amount}</td>
            <td style="padding: 10px; text-align: right;">${item.tax}</td>
            <td style="padding: 10px; text-align: right;">${item.total}</td>
            <td style="padding: 10px; text-align: right;">${item.localTotal}</td>
            <td style="padding: 10px;">${item.workNo}</td>
            <td style="padding: 10px;">${item.billNo}</td>
            <td style="padding: 10px;">${item.user}</td>
            <td style="padding: 10px;">${item.time}</td>
            <td style="padding: 10px; text-align: center;"><i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i></td>
        </tr>
    `).join('');

    if (window.lucide) window.lucide.createIcons();
};

window.switchInvoiceManagementTab = function (el) {
    const tabs = el.parentElement.querySelectorAll('.internal-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
        tab.style.color = '#475569';
        tab.style.fontWeight = 'normal';
    });
    el.classList.add('active');
    el.style.borderBottom = '2px solid #4f46e5';
    el.style.color = '#4f46e5';
    el.style.fontWeight = '500';

    const statusText = el.textContent.trim().split('?')[0].split(/\d/)[0]; // Clean up "已出票5" -> "已出票"
    window.renderInvoiceManagementList(statusText);
};

// --- Task Center Data ---
window.taskCenterData = [
    { id: 1, type: '付款申请', title: '付款申请-PAY20251227001', content: '深圳市供应商A有限公司 - ¥12,000.00', status: '待处理', time: '2025-12-27 10:30', user: '张三' },
    { id: 2, type: '费用单审核', title: '费用单-EXP20251227002', content: '广州分公司 - 运费补贴', status: '待处理', time: '2025-12-27 11:15', user: '李四' }
];

window.submitInvoiceApplication = function () {
    // 1. Get Data from Form
    const customerSelect = document.getElementById('invoice-create-customer-select');
    const customerName = customerSelect ? customerSelect.value : '';

    if (!customerName) {
        alert('请选择客户');
        return;
    }

    const amountInput = document.querySelector('#invoice-application-create-view .input-label-group input[type="text"]');
    // This selector might be weak if there are multiple, let's try to be specific or rely on the populated mocked total
    // Actually the total is in the table bottom summary "价税合计", or we can just grab the mock total "2,120.00" style data.
    // For this demo, let's assume we sum up the table rows or take a static value if not fully interactive yet.
    // We'll scrape the "价税合计" from the bottom summary if possible, or just use a dummy value based on the "mock" form state.
    const totalAmount = "2,120.00"; // Mocked for now as calculation logic isn't fully bound yet
    const taxAmount = "120.00";

    const newId = window.invoiceApplicationData.length + 1;
    const workNo = 'YO2512-' + (1000 + newId);
    const billNo = 'B202512' + (10 + newId);
    const dateStr = new Date().toISOString().split('T')[0];
    const timeStr = new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');

    // 2. Create Invoice Data Object
    const newInvoice = {
        id: newId,
        status: '待审核',
        statusColor: '#d97706',
        statusBg: '#fef3c7',
        invoiceNo: '-',
        type: '普票', // Mock default
        unit: customerName,
        date: dateStr,
        currency: 'CNY',
        amount: '2,000.00',
        tax: taxAmount,
        total: totalAmount,
        localTotal: totalAmount,
        workNo: workNo,
        billNo: billNo,
        user: 'limquan', // Current user
        time: timeStr
    };

    // 3. Add to Invoice List
    window.invoiceApplicationData.unshift(newInvoice);

    // 4. Create Task Center Item
    const newTask = {
        id: window.taskCenterData.length + 1,
        type: '开票申请',
        title: `开票申请-${workNo}`,
        content: `${customerName} - ¥${totalAmount}`,
        status: '待处理',
        time: timeStr,
        user: 'limquan'
    };
    window.taskCenterData.unshift(newTask);

    // 5. Feedback and Navigation
    alert('提交审核成功！已生成审批任务。');

    // Switch back to list view
    document.getElementById('invoice-application-create-view').style.display = 'none';
    document.getElementById('invoice-application-list-view').style.display = 'flex';
    document.querySelector('.customer-sidebar').style.display = 'flex';

    // Switch tab to "审核中" (Matches the text in switch function)
    const tabs = document.querySelectorAll('#invoice-application-list-view .status-tabs .status-tab');
    tabs.forEach(t => {
        if (t.textContent.includes('审核中')) {
            t.click();
        }
    });

    // Also refreshing the list is handled by the click() above
};

window.switchInvoiceApplicationTab = function (el) {
    const tabs = el.parentElement.querySelectorAll('.status-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
        tab.style.color = '#475569';
        tab.style.fontWeight = 'normal';
    });

    el.classList.add('active');
    el.style.borderBottom = '2px solid #4f46e5';
    el.style.color = '#4f46e5';
    el.style.fontWeight = '500';

    // Get status name (remove counts if any)
    let statusText = el.textContent.trim();
    // Simple way to get text node only or split checks, but here we can just pass the raw text and handle in render loosely
    // Or clean it up:
    const clone = el.cloneNode(true);
    const badge = clone.querySelector('span');
    if (badge) badge.remove();
    statusText = clone.textContent.trim();

    window.renderInvoiceApplicationList(statusText);
};

window.saveWaybillEntry = function () {
    const waybillNo = 'WB' + Date.now().toString().slice(-8);
    const date = document.getElementById('entry-date')?.value;
    const customer = document.getElementById('entry-customer')?.value;
    const origin = document.getElementById('entry-origin')?.value;
    const destination = document.getElementById('entry-destination')?.value;

    const waybillObj = {
        no: waybillNo,
        date: date,
        customer: customer,
        route: `${origin || '-'} -> ${destination || '-'}`,
        goods: document.getElementById('cargo-name-1')?.value || '未命名货物'
    };

    window.waybillsData.push(waybillObj);
    alert('运单保存成功！运单号: ' + waybillNo);

    // Clear basic fields
    if (document.getElementById('entry-date')) document.getElementById('entry-date').value = '';
    if (document.getElementById('entry-customer')) document.getElementById('entry-customer').value = '';
    if (document.getElementById('entry-origin')) document.getElementById('entry-origin').value = '';
    if (document.getElementById('entry-destination')) document.getElementById('entry-destination').value = '';
    if (document.getElementById('cargo-name-1')) document.getElementById('cargo-name-1').value = '';
};

window.viewWaybillDetails = function (no) {
    const waybill = window.waybillsData.find(w => w.no === no);
    if (!waybill) {
        alert('未找到该运单: ' + no);
        return;
    }

    addTab('录入运单');

    // Delay to ensure DOM is ready
    setTimeout(() => {
        if (document.getElementById('entry-date')) document.getElementById('entry-date').value = waybill.date || '';
        if (document.getElementById('entry-customer')) document.getElementById('entry-customer').value = waybill.customer || '';
        // Parse route to extract origin/destination if possible, or just skip if complex. 
        // We saved it as "Origin -> Destination".
        if (waybill.route && waybill.route.includes(' -> ')) {
            const parts = waybill.route.split(' -> ');
            if (document.getElementById('entry-origin')) document.getElementById('entry-origin').value = parts[0] !== '-' ? parts[0] : '';
            if (document.getElementById('entry-destination')) document.getElementById('entry-destination').value = parts[1] !== '-' ? parts[1] : '';
        }
        if (document.getElementById('cargo-name-1')) document.getElementById('cargo-name-1').value = waybill.goods !== '未命名货物' ? waybill.goods : '';
    }, 100);
};

window.toggleAllWaybills = function (source) {
    const checkboxes = document.querySelectorAll('.waybill-row-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
};

window.toggleAllWaybills = function (source) {
    const checkboxes = document.querySelectorAll('.waybill-row-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
};

window.bankReceiptData = [
    { id: 1, name: '深圳市远通物流有限公司', bank: '招商银行深圳分行', account: '755912345678901', currency: 'CNY', serial: '202512270001', amount: '50,000.00', time: '2025-12-27 10:30', payer: 'ABC TRADING LTD', unit: '总公司', payerAccount: '6222021234567890', summary: '货款', match: 'ORDER-001', status: 'pending_confirm' },
    { id: 2, name: '广州快运达货运代理有限公司', bank: '中国银行广州分行', account: '621234567890123', currency: 'USD', serial: '202512270002', amount: '10,000.00', time: '2025-12-27 11:15', payer: 'XYZ LOGISTICS INC', unit: '广州分公司', payerAccount: '4567890123456789', summary: '运费', match: '-', status: 'pending_confirm' },
    { id: 3, name: '深圳市远通物流有限公司', bank: '工商银行深圳分行', account: '955880123456789', currency: 'CNY', serial: '202512270003', amount: '2,500.00', time: '2025-12-27 14:00', payer: 'GLOBAL TRADERS', unit: '总公司', payerAccount: '1234567890123456', summary: '配合费', match: 'ORDER-002', status: 'pending_confirm' },
    { id: 4, name: '未知付款人', bank: '建设银行', account: '****', currency: 'CNY', serial: '202512280001', amount: '5,000.00', time: '2025-12-28 09:00', payer: 'UNKNOWN', unit: '-', payerAccount: '****', summary: '转账', match: '-', status: 'pending_claim' },
    { id: 5, name: '深圳市远通物流有限公司', bank: '招商银行', account: '755912345678901', currency: 'CNY', serial: '202512260005', amount: '12,000.00', time: '2025-12-26 15:30', payer: 'OLD CUSTOMER', unit: '总公司', payerAccount: '****', summary: '货款', match: 'ORDER-000', status: 'written_off' }
];

window.confirmBankReceipt = function (id) {
    const item = window.bankReceiptData.find(i => i.id == id);
    if (item) {
        item.status = 'written_off';
        alert('已确认销账');
        const activeTab = document.querySelector('.internal-tab.active');
        if (activeTab) {
            window.switchBankReceiptTab(activeTab);
        }
    }
};

window.injectClaimModal = function () {
    if (document.getElementById('claim-modal-container')) return;

    const modalHtml = `
        <div id="claim-modal-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; align-items: center; justify-content: center; font-family: sans-serif;">
            <div style="background: white; border-radius: 8px; width: 400px; max-width: 90%; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                <div style="padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                    <h3 style="margin: 0; font-size: 1rem; color: #1e293b;">认领流水</h3>
                    <button onclick="window.closeClaimModal()" style="background: none; border: none; cursor: pointer; color: #64748b; padding: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="font-size: 0.85rem; color: #64748b; font-weight: 600;">匹配单号:</label>
                        <input id="claim-bill-no" type="text" placeholder="请输入订单号" style="height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; outline: none;">
                    </div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                    <button onclick="window.closeClaimModal()" style="padding: 8px 20px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-size: 0.9rem; cursor: pointer;">取消</button>
                    <button onclick="window.saveClaim()" style="padding: 8px 24px; border: none; border-radius: 6px; background: #4f46e5; color: white; font-size: 0.9rem; cursor: pointer; font-weight: 600;">保存</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.openClaimModal = function (id) {
    window.injectClaimModal();
    window.currentClaimId = id;
    const container = document.getElementById('claim-modal-container');
    const input = document.getElementById('claim-bill-no');
    if (container) {
        container.style.display = 'flex';
        if (input) input.value = '';
    }
};

window.closeClaimModal = function () {
    const container = document.getElementById('claim-modal-container');
    if (container) {
        container.style.display = 'none';
    }
    window.currentClaimId = null;
};

window.saveClaim = function () {
    const billNo = document.getElementById('claim-bill-no').value;
    if (!billNo) {
        alert('请输入匹配单号');
        return;
    }

    const item = window.bankReceiptData.find(i => i.id == window.currentClaimId);
    if (item) {
        item.status = 'others';
        item.match = billNo;
        alert('认领成功，已转入其他');
        window.closeClaimModal();
        const activeTab = document.querySelector('.internal-tab.active');
        if (activeTab) {
            window.switchBankReceiptTab(activeTab);
        }
    }
};

window.switchBankReceiptTab = function (el) {
    const tabs = el.parentElement.querySelectorAll('.internal-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
        tab.style.color = '#475569';
        tab.style.fontWeight = 'normal';
    });

    el.classList.add('active');
    el.style.borderBottom = '2px solid #4f46e5';
    el.style.color = '#4f46e5';
    el.style.fontWeight = '500';

    const tabName = el.textContent.trim();
    const tbody = document.getElementById('bank-receipt-tbody');
    if (!tbody) return;

    let filterStatus = '';
    if (tabName === '销账待确认') filterStatus = 'pending_confirm';
    else if (tabName === '待认领') filterStatus = 'pending_claim';
    else if (tabName === '已销账') filterStatus = 'written_off';
    else filterStatus = 'others';

    const data = window.bankReceiptData.filter(item => item.status === filterStatus);

    tbody.innerHTML = data.length ? data.map(item => {
        let actionButton = '';
        if (tabName === '销账待确认') {
            actionButton = `<a href="javascript:void(0)" onclick="window.confirmBankReceipt('${item.id}')" style="color: #4f46e5;">确认</a>`;
        } else if (tabName !== '已销账') {
            actionButton = `<a href="javascript:void(0)" onclick="window.openClaimModal('${item.id}')" style="color: #4f46e5;">认领</a>`;
        }

        return `
        <tr style="border-bottom: 1px solid #f1f5f9;">
            <td style="padding: 12px; text-align: center; color: #64748b;">${item.id}</td>
            <td style="padding: 12px; color: #334155;">${item.name}</td>
            <td style="padding: 12px; color: #64748b;">${item.bank}</td>
            <td style="padding: 12px; color: #64748b;">${item.account}</td>
            <td style="padding: 12px; color: #64748b;">${item.currency}</td>
            <td style="padding: 12px; color: #64748b;">${item.serial}</td>
            <td style="padding: 12px; color: #334155; font-weight: 500;">${item.amount}</td>
            <td style="padding: 12px; color: #64748b;">${item.time}</td>
            <td style="padding: 12px; color: #64748b;">${item.payer}</td>
            <td style="padding: 12px; color: #64748b;">${item.unit}</td>
            <td style="padding: 12px; color: #64748b;">${item.payerAccount}</td>
            <td style="padding: 12px; color: #64748b;">${item.summary}</td>
            <td style="padding: 12px; color: #64748b;">${item.match}</td>
            <td style="padding: 12px; color: #64748b;">${item.match !== '-' ? '已生成' : '-'}</td>
            <td style="padding: 12px;">
                <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                ${actionButton}
            </td>
        </tr>
    `;
    }).join('') : `<tr><td colspan="15" style="padding: 24px; text-align: center; color: #94a3b8;">暂无数据</td></tr>`;
};

window.bankPaymentData = [
    { id: 1, billNo: 'PAY-20251227-001', applicant: '张三', unit: '总公司', payer: '深圳卡供应有限公司', bank: '建设银行深圳分行', currency: 'CNY', amount: '12,000.00', remark: '采购款', status: 'pending_submit' },
    { id: 2, billNo: 'PAY-20251227-002', applicant: '李四', unit: '广州分公司', payer: 'GLOBAL COMMERCE INC', bank: 'HSBC HK', currency: 'USD', amount: '5,000.00', remark: 'Service Fee', status: 'pending_submit' },
    { id: 3, billNo: 'PAY-20251227-003', applicant: '王五', unit: '总公司', payer: '上海物流合作伙伴', bank: '农业银行上海分行', currency: 'CNY', amount: '3,500.00', remark: '运费补贴', status: 'pending_submit' },
    { id: 4, billNo: 'PAY-20251228-001', applicant: '赵六', unit: '总公司', payer: 'FAST SHIP', bank: '招商银行', currency: 'CNY', amount: '500.00', remark: '招待费', status: 'processing' },
    { id: 5, billNo: 'PAY-20251225-001', applicant: '孙七', unit: '总公司', payer: 'SUPPLIER A', bank: '工商银行', currency: 'CNY', amount: '8,000.00', remark: '设备款', status: 'paid' },
    { id: 6, billNo: 'PAY-20251220-009', applicant: '钱八', unit: '广州分公司', payer: 'VENDOR B', bank: '中国银行', currency: 'CNY', amount: '2,000.00', remark: '定金退回', status: 'cancelled' }
];

window.deleteBankPayment = function (id) {
    if (confirm('确认删除该条数据吗？')) {
        window.bankPaymentData = window.bankPaymentData.filter(item => item.id != id);
        const activeTab = document.querySelector('#bank-payment-tbody').previousElementSibling.parentElement.parentElement.parentElement.querySelector('.internal-tab.active'); // Find active tab in this specific view relative to table or just query globally if unique enough.
        // Actually, switchBankPaymentTab expects the element that was clicked.
        // But here we want to refresh the CURRENT active tab.
        // Creating a fake element or passing null might not work with current implementation.
        // Let's find the active tab element in the DOM.
        // The tabs for bank payment have 'onclick="window.switchBankPaymentTab(this)"'.
        // We can query selector for it.
        const tabs = document.querySelectorAll('.internal-tab');
        let currentTab = null;
        tabs.forEach(t => {
            if (t.classList.contains('active') && t.getAttribute('onclick') === 'window.switchBankPaymentTab(this)') {
                currentTab = t;
            }
        });

        if (currentTab) {
            window.switchBankPaymentTab(currentTab);
        }
    }
};

window.submitBankPayment = function () {
    const checkedBoxes = document.querySelectorAll('.bank-payment-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('请先选择要提交的数据！');
        return;
    }

    const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

    let count = 0;
    window.bankPaymentData.forEach(item => {
        if (ids.includes(item.id)) {
            item.status = 'processing';
            count++;

            // Add to Task Center
            const task = {
                id: 'TASK-' + Date.now() + '-' + item.id,
                cardId: item.billNo,
                cardName: '付款申请',
                amount: item.amount,
                applicant: item.applicant,
                applyTime: new Date().toLocaleString(),
                type: 'payment_audit',
                status: 'pending'
            };
            if (window.pendingRechargeRequests) {
                window.pendingRechargeRequests.push(task);
            }
        }
    });

    alert(`已成功提交 ${count} 条付款申请，请前往任务中心查看。`);

    // Refresh view by finding active tab
    const tabs = document.querySelectorAll('.internal-tab');
    let currentTab = null;
    tabs.forEach(t => {
        if (t.classList.contains('active') && t.getAttribute('onclick') === 'window.switchBankPaymentTab(this)') {
            currentTab = t;
        }
    });

    if (currentTab) {
        window.switchBankPaymentTab(currentTab);
    }
};

window.switchBankPaymentTab = function (el) {
    const tabs = el.parentElement.querySelectorAll('.internal-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
        tab.style.color = '#475569';
        tab.style.fontWeight = 'normal';
    });

    el.classList.add('active');
    el.style.borderBottom = '2px solid #ed171f';
    el.style.color = '#ed171f';
    el.style.fontWeight = '500';

    const tabName = el.textContent.trim();
    const tbody = document.getElementById('bank-payment-tbody');
    if (!tbody) return;

    let filterStatus = '';
    if (tabName === '待提交') filterStatus = 'pending_submit';
    else if (tabName === '付款处理中') filterStatus = 'processing';
    else if (tabName === '已付款') filterStatus = 'paid';
    else if (tabName === '已核销') filterStatus = 'cancelled';
    else filterStatus = 'others';

    const data = window.bankPaymentData.filter(item => item.status === filterStatus);

    tbody.innerHTML = data.length ? data.map(item => {
        let actionButtons = `<a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>`;
        if (tabName === '待提交') {
            actionButtons += `<a href="javascript:void(0)" onclick="window.deleteBankPayment('${item.id}')" style="color: #ef4444;">删除</a>`;
        }

        return `
        <tr style="border-bottom: 1px solid #f1f5f9;">
            <td style="padding: 12px; text-align: center;"><input type="checkbox" class="bank-payment-checkbox" value="${item.id}" style="width: 14px; height: 14px;"></td>
             <td style="padding: 12px; text-align: center; color: #64748b;">${item.id}</td>
             <td style="padding: 12px; color: #334155;">${item.billNo}</td>
             <td style="padding: 12px; color: #64748b;">${item.applicant}</td>
             <td style="padding: 12px; color: #64748b;">${item.unit}</td>
             <td style="padding: 12px; color: #334155;">${item.payer}</td>
             <td style="padding: 12px; color: #64748b;">${item.bank}</td>
             <td style="padding: 12px; color: #64748b;">${item.currency}</td>
             <td style="padding: 12px; color: #334155; font-weight: 500;">${item.amount}</td>
             <td style="padding: 12px; color: #64748b;">${item.remark}</td>
             <td style="padding: 12px;">
                ${actionButtons}
            </td>
        </tr>
    `}).join('') : `<tr><td colspan="11" style="padding: 24px; text-align: center; color: #94a3b8;">暂无数据</td></tr>`;
};

window.updateOrderEntryTotals = function () {
    const additionalFeeInput = document.getElementById('entry-additional-fee');
    const advanceTotalInput = document.getElementById('entry-advance-total');
    const freightInput = document.getElementById('entry-freight');
    const revenueTotalInput = document.getElementById('entry-revenue-total');

    let revenueSideTotal = 0;
    let advanceSideTotal = 0;

    window.expenseAuditData.forEach(e => {
        if (e.expenseType === 'revenue') {
            revenueSideTotal += (parseFloat(e.revenue) || 0);
        } else if (e.expenseType === 'advance') {
            advanceSideTotal += (parseFloat(e.cost) || 0);
        }
    });

    if (additionalFeeInput) additionalFeeInput.value = revenueSideTotal.toFixed(2);
    if (advanceTotalInput) advanceTotalInput.value = advanceSideTotal.toFixed(2);

    // Calculate overall revenue total: Freight + Additional Fee
    if (revenueTotalInput) {
        const freight = freightInput ? (parseFloat(freightInput.value) || 0) : 0;
        const additional = revenueSideTotal;
        revenueTotalInput.value = (freight + additional).toFixed(2);
    }
};


/**
 * Saves the current order entry form data.
 */
window.saveOrderEntry = function () {
    const orderNo = 'OR' + Date.now().toString().slice(-8);
    const date = document.getElementById('entry-date')?.value;
    const customer = document.getElementById('entry-customer')?.value;
    const origin = document.getElementById('entry-origin')?.value;
    const destination = document.getElementById('entry-destination')?.value;

    if (!date || !customer) {
        alert('请填写订单日期和客户名称！');
        return;
    }

    const orderObj = {
        orderNo,
        date,
        customer,
        route: `${origin || '-'} -> ${destination || '-'}`,
        goods: document.getElementById('cargo-name-1')?.value || '未命名货物',
        status: '正常', // Default status
        details: {
            origin,
            destination,
            cargo: [
                {
                    name: document.getElementById('cargo-name-1')?.value,
                    type: document.getElementById('cargo-type-1')?.value,
                    count: document.getElementById('cargo-count-1')?.value,
                    weight: document.getElementById('cargo-weight-1')?.value,
                    volume: document.getElementById('cargo-volume-1')?.value,
                    pricingMethod: document.getElementById('cargo-pricing-method-1')?.value,
                    unitPrice: document.getElementById('cargo-unit-price-1')?.value,
                    subtotal: document.getElementById('cargo-freight-subtotal-1')?.value
                }
            ],
            totals: {
                count: document.getElementById('summary-count')?.value,
                weight: document.getElementById('summary-weight')?.value,
                volume: document.getElementById('summary-volume')?.value,
                classification: document.getElementById('entry-cargo-classification')?.value,
                pricingMethod: document.getElementById('summary-pricing-method')?.value,
                unitPrice: document.getElementById('entry-unit-price')?.value,
                freight: document.getElementById('entry-freight')?.value,
                deliveryFee: document.getElementById('entry-delivery-fee')?.value,
                loadingFee: document.getElementById('entry-loading-fee')?.value,
                unloadingFee: document.getElementById('entry-unloading-fee')?.value,
                additionalFee: document.getElementById('entry-additional-fee')?.value,
                revenue: document.getElementById('entry-revenue-total')?.value,
                advanceTotal: document.getElementById('entry-advance-total')?.value
            }
        }
    };

    window.ordersData.push(orderObj);
    alert('订单保存成功！订单号: ' + orderNo);

    // Clear form basic info
    const fieldsToClear = [
        'entry-date', 'entry-customer', 'entry-origin', 'entry-destination',
        'cargo-name-1', 'cargo-type-1', 'cargo-count-1', 'cargo-weight-1', 'cargo-volume-1', 'cargo-unit-price-1', 'cargo-freight-subtotal-1',
        'entry-unit-price', 'entry-freight', 'entry-delivery-fee', 'entry-loading-fee', 'entry-unloading-fee', 'entry-cargo-classification'
    ];
    fieldsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    // Reset summaries
    const summaryFields = ['summary-count', 'summary-weight', 'summary-volume', 'entry-revenue-total', 'entry-additional-fee', 'entry-advance-total'];
    summaryFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '0.00';
    });

    // If order management tab is active, we should ideally refresh it, but renderTabs will handle it on next click.
};

/**
 * Views order details by populating the "录入订单" form.
 */
window.viewOrderDetails = function (orderNo) {
    const order = window.ordersData.find(o => o.orderNo === orderNo);
    if (!order) {
        alert('未找到该订单：' + orderNo);
        return;
    }

    // Switch to the correct tab first
    window.addTab('录入订单');

    // Use setTimeout to allow the tab to render before populating fields
    setTimeout(() => {
        // Basic Info
        const dateInput = document.getElementById('entry-date');
        const customerInput = document.getElementById('entry-customer');
        const originInput = document.getElementById('entry-origin');
        const destinationInput = document.getElementById('entry-destination');

        if (dateInput) dateInput.value = order.date;
        if (customerInput) customerInput.value = order.customer;

        if (order.details) {
            if (originInput) originInput.value = order.details.origin || '';
            if (destinationInput) destinationInput.value = order.details.destination || '';

            // Cargo (Assuming first row for now as we only save one row currently)
            if (order.details.cargo && order.details.cargo.length > 0) {
                const cargo = order.details.cargo[0];
                const nameInput = document.getElementById('cargo-name-1');
                const typeInput = document.getElementById('cargo-type-1');
                const countInput = document.getElementById('cargo-count-1');
                const weightInput = document.getElementById('cargo-weight-1');
                const volumeInput = document.getElementById('cargo-volume-1');
                const pricingInput = document.getElementById('cargo-pricing-method-1');
                const unitPriceInput = document.getElementById('cargo-unit-price-1');
                const subtotalInput = document.getElementById('cargo-freight-subtotal-1');

                if (nameInput) nameInput.value = cargo.name || '';
                if (typeInput) typeInput.value = cargo.type || '';
                if (countInput) countInput.value = cargo.count || '';
                if (weightInput) weightInput.value = cargo.weight || '';
                if (volumeInput) volumeInput.value = cargo.volume || '';
                if (pricingInput) pricingInput.value = cargo.pricingMethod || '按件数';
                if (unitPriceInput) unitPriceInput.value = cargo.unitPrice || '';
                if (subtotalInput) subtotalInput.value = cargo.subtotal || '';
            }

            // Totals
            if (order.details.totals) {
                const summaryCount = document.getElementById('summary-count');
                const summaryWeight = document.getElementById('summary-weight');
                const summaryVolume = document.getElementById('summary-volume');
                const classification = document.getElementById('entry-cargo-classification');
                const pricingMethod = document.getElementById('summary-pricing-method');
                const unitPrice = document.getElementById('entry-unit-price');
                const freight = document.getElementById('entry-freight');
                const deliveryFee = document.getElementById('entry-delivery-fee');
                const loadingFee = document.getElementById('entry-loading-fee');
                const unloadingFee = document.getElementById('entry-unloading-fee');
                const additionalFee = document.getElementById('entry-additional-fee');
                const revenueTotal = document.getElementById('entry-revenue-total');
                const advanceTotal = document.getElementById('entry-advance-total');

                if (summaryCount) summaryCount.value = order.details.totals.count || '0.00';
                if (summaryWeight) summaryWeight.value = order.details.totals.weight || '0.00';
                if (summaryVolume) summaryVolume.value = order.details.totals.volume || '0.00';
                if (classification) classification.value = order.details.totals.classification || '';
                if (pricingMethod) pricingMethod.value = order.details.totals.pricingMethod || '按件数';
                if (unitPrice) unitPrice.value = order.details.totals.unitPrice || '';
                if (freight) freight.value = order.details.totals.freight || '';
                if (deliveryFee) deliveryFee.value = order.details.totals.deliveryFee || '';
                if (loadingFee) loadingFee.value = order.details.totals.loadingFee || '';
                if (unloadingFee) unloadingFee.value = order.details.totals.unloadingFee || '';
                if (additionalFee) additionalFee.value = order.details.totals.additionalFee || '0.00';
                if (revenueTotal) revenueTotal.value = order.details.totals.revenue || '0.00';
                if (advanceTotal) advanceTotal.value = order.details.totals.advanceTotal || '0.00';
            }
        }

        if (window.lucide) window.lucide.createIcons();
    }, 100);
};

/**
 * Calculates the total pieces, weight, and volume from the cargo list.
 */
window.calculateItemizedBilling = function () {
    const counts = document.querySelectorAll('.cargo-count');
    const weights = document.querySelectorAll('.cargo-weight');
    const volumes = document.querySelectorAll('.cargo-volume');
    const freightSubtotals = document.querySelectorAll('.cargo-freight-subtotal');

    // Get all method selects and unit price inputs to calculate row subtotals first
    const methods = document.querySelectorAll('.cargo-pricing-method');
    const unitPrices = document.querySelectorAll('.cargo-unit-price');
    const mileageInput = document.getElementById('entry-mileage');
    const mileage = parseFloat(mileageInput?.value) || 0;

    const summaryCount = document.getElementById('summary-count');
    const summaryWeight = document.getElementById('summary-weight');
    const summaryVolume = document.getElementById('summary-volume');
    const entryFreight = document.getElementById('entry-freight');

    let totalCount = 0;
    let totalWeight = 0;
    let totalVolume = 0;
    let totalFreight = 0;

    // First pass: Calculate Row Subtotals
    for (let i = 0; i < methods.length; i++) {
        const method = methods[i].value;
        const price = parseFloat(unitPrices[i]?.value) || 0;
        // Initialize with existing value (manual entry)
        let subtotal = parseFloat(freightSubtotals[i]?.value) || 0;

        if (price > 0) {
            if (method === '按件数') {
                const count = parseFloat(counts[i]?.value) || 0;
                subtotal = count * price;
            } else if (method === '按重量') {
                const weight = parseFloat(weights[i]?.value) || 0;
                subtotal = weight * price;
            } else if (method === '按体积') {
                const volume = parseFloat(volumes[i]?.value) || 0;
                subtotal = volume * price;
            } else if (method === '按吨公里') {
                const weight = parseFloat(weights[i]?.value) || 0;
                if (mileage > 0) {
                    subtotal = weight * price * mileage;
                }
            }
            // Update the subtotal input ONLY if a calculation was performed (price > 0)
            if (freightSubtotals[i]) {
                freightSubtotals[i].value = subtotal > 0 ? subtotal.toFixed(2) : '';
            }
        }
    }

    // Second pass: Sum up totals
    counts.forEach(input => {
        totalCount += (parseFloat(input.value) || 0);
    });

    weights.forEach(input => {
        totalWeight += (parseFloat(input.value) || 0);
    });

    volumes.forEach(input => {
        totalVolume += (parseFloat(input.value) || 0);
    });

    freightSubtotals.forEach(input => {
        totalFreight += (parseFloat(input.value) || 0);
    });

    if (summaryCount) summaryCount.value = totalCount || '';
    if (summaryWeight) summaryWeight.value = totalWeight ? totalWeight.toFixed(2) : '';
    if (summaryVolume) summaryVolume.value = totalVolume ? totalVolume.toFixed(2) : '';
    if (entryFreight) entryFreight.value = totalFreight ? totalFreight.toFixed(2) : '';

    // Also update order entry totals just in case
    window.updateOrderEntryTotals();
};

/**
 * Synchronizes the pricing method from the summary area to all cargo items.
 */
window.syncPricingMethod = function () {
    const summaryMethodSelect = document.getElementById('summary-pricing-method');
    if (!summaryMethodSelect) return;

    const selectedMethod = summaryMethodSelect.value;
    const cargoSelects = document.querySelectorAll('.cargo-pricing-method');

    cargoSelects.forEach(select => {
        select.value = selectedMethod;
    });
};

/**
 * Calculates freight based on billable weight and unit price.
 */
window.calculateFreight = function () {
    const billableWeightInput = document.getElementById('entry-billable-weight');
    const unitPriceInput = document.getElementById('entry-unit-price');
    const freightInput = document.getElementById('entry-freight');

    if (billableWeightInput && unitPriceInput && freightInput) {
        const weight = parseFloat(billableWeightInput.value) || 0;
        const price = parseFloat(unitPriceInput.value) || 0;
        freightInput.value = (weight * price).toFixed(2);

        // Trigger total calculation update
        window.updateOrderEntryTotals();
    }
};

/**
 * Submits an expense item for audit.
 */
window.submitExpenseAudit = function (orderId) {
    const expense = window.expenseAuditData.find(e => e.id === orderId);
    if (!expense || expense.status !== '未提交') return;

    expense.status = '审核中';

    const task = {
        id: 'EXP-' + orderId,
        cardId: orderId, // Reuse field for simplicity
        cardName: expense.type,
        amount: expense.cost,
        applicant: expense.salesman,
        applyTime: new Date().toLocaleString(),
        type: 'expense_audit', // Custom type
        orderId: orderId
    };

    window.pendingRechargeRequests.push(task);
    alert('费用审核申请已提交至任务中心');
    addTab('费用审核'); // Refresh view
};

function renderMenu() {
    const container = document.getElementById('secondary-content');
    container.innerHTML = '';

    // Filter out restricted nodes
    const filteredData = menuData.filter(section => !section.exclude);

    filteredData.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'menu-section';

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
            <i data-lucide="${section.icon}"></i>
            <span>${section.title}</span>
        `;
        sectionDiv.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'menu-grid';

        section.items.forEach(item => {
            const link = document.createElement('a');
            link.className = 'menu-link';
            link.textContent = item;
            link.addEventListener('click', () => addTab(item));
            grid.appendChild(link);
        });

        sectionDiv.appendChild(grid);
        container.appendChild(sectionDiv);
    });

    lucide.createIcons();
}

/**
 * Renders the Workbench menu in the secondary sidebar
 */
function renderWorkbenchMenu() {
    const container = document.getElementById('secondary-content');
    container.innerHTML = '';

    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'menu-section';

    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `
        <i data-lucide="layout-dashboard"></i>
        <span>工作台</span>
    `;
    sectionDiv.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'menu-grid';

    const items = ['运营概览', '任务中心'];

    items.forEach(item => {
        const link = document.createElement('a');
        link.className = 'menu-link';
        link.textContent = item;
        link.addEventListener('click', () => addTab(item));
        grid.appendChild(link);
    });

    sectionDiv.appendChild(grid);
    container.appendChild(sectionDiv);

    if (window.lucide) window.lucide.createIcons();
}

/**
 * Renders the Business menu in the secondary sidebar
 */
function renderBusinessMenu() {
    const container = document.getElementById('secondary-content');
    container.innerHTML = '';

    businessMenuData.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'menu-section';

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
            <i data-lucide="${section.icon}"></i>
            <span>${section.title}</span>
        `;
        sectionDiv.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'menu-grid';

        section.items.forEach(item => {
            const link = document.createElement('a');
            link.className = 'menu-link';
            link.textContent = item;
            link.addEventListener('click', () => addTab(item));
            grid.appendChild(link);
        });

        sectionDiv.appendChild(grid);
        container.appendChild(sectionDiv);
    });

    if (window.lucide) window.lucide.createIcons();
}

/**
 * Renders the Report menu in the secondary sidebar
 */
function renderReportMenu() {
    const container = document.getElementById('secondary-content');
    container.innerHTML = '';

    reportMenuData.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'menu-section';

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
            <i data-lucide="${section.icon}"></i>
            <span>${section.title}</span>
        `;
        sectionDiv.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'menu-grid';

        section.items.forEach(item => {
            const link = document.createElement('a');
            link.className = 'menu-link';
            link.textContent = item;
            link.addEventListener('click', () => addTab(item));
            grid.appendChild(link);
        });

        sectionDiv.appendChild(grid);
        container.appendChild(sectionDiv);
    });

    if (window.lucide) window.lucide.createIcons();
}

function initSidebar() {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            navItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            const title = item.getAttribute('data-title');

            if (title === '工作台') {
                document.querySelector('.sub-sidebar').classList.remove('hidden');
                document.getElementById('menu-mask').classList.add('show');
                renderWorkbenchMenu();
            } else if (title === '结算' || title === '充值管理') {
                document.querySelector('.sub-sidebar').classList.remove('hidden');
                document.getElementById('menu-mask').classList.add('show');
                renderMenu();
            } else if (title === '业务') {
                document.querySelector('.sub-sidebar').classList.remove('hidden');
                document.getElementById('menu-mask').classList.add('show');
                renderBusinessMenu();
            } else if (title === '报表') {
                document.querySelector('.sub-sidebar').classList.remove('hidden');
                document.getElementById('menu-mask').classList.add('show');
                renderReportMenu();
            } else {
                // For other main categories, show a placeholder or just open secondary menu if applicable
                alert('正在开发中...');
            }
        });
    });
}

// Initialize "Workbench" by default
document.addEventListener('DOMContentLoaded', () => {
    initSidebar();
    addTab('运营概览');
});

let openTabs = [];

function addTab(title) {
    if (!openTabs.includes(title)) openTabs.push(title);
    renderTabs(title);
    document.querySelector('.sub-sidebar').classList.add('hidden');
    document.getElementById('menu-mask').classList.remove('show'); // Hide mask when tab is selected
    document.getElementById('tabs-bar').style.display = 'flex';
}

function renderTabs(activeTab) {
    const list = document.getElementById('tabs-list');
    list.innerHTML = '';

    const customers = [
        { name: "萨姆达拉", count: 0 },
        { name: "深圳市远航达国际货运代理有限公司", count: 0 },
        { name: "深圳市路路通运输有限公司", count: 0 },
        { name: "深圳市好运来货运代理有限公司", count: 1 },
        { name: "深圳运物云物流科技有限公司", count: 0 },
        { name: "贝塔测试科技有限公司", count: 0 },
        { name: "拖车公司", count: 0 },
        { name: "全部多个", count: 0 },
        { name: "22333344", count: 0 },
        { name: "杭州娃哈哈集团有限公司", count: 0 },
        { name: "广州快捷到国际货运代理有限公司", count: 0 },
        { name: "663333", count: 0 },
        { name: "上海哇哈哈国际物流有限公司深圳分公司", count: 0 },
        { name: "hy", count: 0 },
        { name: "马士基（中国）航运有限公司深圳分公司", count: 1 },
        { name: "欣旺达新能源动力汽车有限公司", count: 0 }
    ];

    openTabs.forEach(tab => {
        const item = document.createElement('div');
        item.className = `tab-item ${tab === activeTab ? 'active' : ''}`;
        item.innerHTML = `<span>${tab}</span><div class="tab-close" onclick="event.stopPropagation(); closeTab('${tab}')"><i data-lucide="x"></i></div>`;
        item.addEventListener('click', () => renderTabs(tab));
        list.appendChild(item);
    });
    if (activeTab === '运营概览' || activeTab === '任务中心' || activeTab === '对账单' || activeTab === '应收对账' || activeTab === '应付对账' || activeTab === '客户账单' || activeTab === '接收账单' || activeTab === '费用明细' || activeTab === '应收明细' || activeTab === '应付明细' || activeTab === '业务员成本明细' || activeTab === '代收代付明细' || activeTab === '收付款' || activeTab === '付款申请' || activeTab === '发票管理' || activeTab === '开票申请' || activeTab === '开票费用配置' || activeTab === '红字申请确认单' || activeTab === '结算单位' || activeTab === '银行收款流水' || activeTab === '银行付款流水' || activeTab === '银企直连配置' || activeTab === '批量确认' || activeTab === '费用审核' || activeTab === '结算设置' || activeTab === '储值管理' || activeTab === '油卡管理' || activeTab === '录入订单' || activeTab === '订单管理' || activeTab === '货量利润表' || activeTab === '录入运单' || activeTab === '运单管理' || activeTab === '运单录入(新)' || activeTab === '费用录入' || activeTab === '费用面板' || activeTab === '配载费用' || activeTab === '订单回显' || activeTab === '费用单' || activeTab === '费用申请' || activeTab === '新增费用申请') {


        let mainContent = '';
        if (activeTab === '运营概览') {
            mainContent = `
                <div id="workbench-content-area" style="height: 100%; overflow: auto; background: var(--bg-main);">
                    ${window.renderWorkbenchOverview()}
                </div>
            `;
        } else if (activeTab === '订单管理') {
            mainContent = `
                <div style="height: 100%; width: 100%; flex: 1; display: flex; flex-direction: column; background: #f1f5f9;">
                    <!-- Filter Toolbar -->
                    <div style="padding: 16px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 0.75rem; color: #64748b;">订单单号</label>
                            <input type="text" placeholder="输入单号" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; width: 140px;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 0.75rem; color: #64748b;">客户名称</label>
                            <input type="text" placeholder="输入客户" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; width: 180px;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 0.75rem; color: #64748b;">下单日期</label>
                            <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="primary-btn" style="height: 32px; padding: 0 16px;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                            <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; cursor: pointer; color: #64748b;">重置</button>
                        </div>
                        <div style="margin-left: auto;">
                            <button class="primary-btn" onclick="addTab('录入订单')" style="height: 32px; padding: 0 16px;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 新增订单</button>
                        </div>
                    </div>

                    <!-- Statistics Bar -->
                    <div style="padding: 12px 24px; display: flex; gap: 24px; align-items: center; background: #fff; border-bottom: 1px solid #e2e8f0;">
                         <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <span style="color: #64748b;">全部订单:</span>
                            <span style="font-weight: 700; color: #1e293b;">${window.ordersData.length}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <span style="color: #64748b;">进行中:</span>
                            <span style="font-weight: 700; color: #3b82f6;">${window.ordersData.filter(o => o.status === '正常').length}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <span style="color: #64748b;">已完结:</span>
                            <span style="font-weight: 700; color: #10b981;">0</span>
                        </div>
                    </div>

                    <!-- Table Area -->
                    <div style="flex-grow: 1; overflow: auto; padding: 16px;">
                        <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead style="background: #f8fafc; color: #64748b; border-bottom: 1px solid #e2e8f0;">
                                    <tr>
                                        <th style="padding: 12px 16px; text-align: left; width: 40px;"><input type="checkbox"></th>
                                        <th style="padding: 12px 16px; text-align: left;">订单单号</th>
                                        <th style="padding: 12px 16px; text-align: left;">下单日期</th>
                                        <th style="padding: 12px 16px; text-align: left;">客户名称</th>
                                        <th style="padding: 12px 16px; text-align: left;">线路</th>
                                        <th style="padding: 12px 16px; text-align: left;">货物信息</th>
                                        <th style="padding: 12px 16px; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${window.ordersData.length === 0 ? `
                                        <tr>
                                            <td colspan="7" style="padding: 100px 0; text-align: center;">
                                                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                                    <i data-lucide="search" style="width: 48px; height: 48px; color: #cbd5e1; opacity: 0.5;"></i>
                                                    <span style="color: #94a3b8; font-size: 0.85rem;">暂无订单数据</span>
                                                </div>
                                            </td>
                                        </tr>
                                    ` : window.ordersData.map(order => `
                                        <tr style="border-bottom: 1px solid #f1f5f9; background: white;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                            <td style="padding: 12px 16px; text-align: left;"><input type="checkbox"></td>
                                            <td style="padding: 12px 16px; color: #4f46e5; font-weight: 500;">${order.orderNo}</td>
                                            <td style="padding: 12px 16px;">${order.date}</td>
                                            <td style="padding: 12px 16px;">${order.customer}</td>
                                            <td style="padding: 12px 16px;">${order.route}</td>
                                            <td style="padding: 12px 16px;">${order.goods}</td>
                                            <td style="padding: 12px 16px; text-align: center;">
                                                <div style="display: flex; gap: 8px; justify-content: center;">
                                                    <button onclick="window.viewOrderDetails('${order.orderNo}')" style="color: #4f46e5; background: none; border: none; font-size: 0.75rem; cursor: pointer;">详情</button>
                                                    <button style="color: #ef4444; background: none; border: none; font-size: 0.75rem; cursor: pointer;">删除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div style="padding: 12px 24px; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #64748b;">
                        <div>共 ${window.ordersData.length} 条记录，每页 20 条</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                             <button style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; cursor: pointer;"><i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i></button>
                             <span style="padding: 4px 12px; background: #4f46e5; color: white; border-radius: 4px;">1</span>
                             <button style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: #fff; cursor: pointer;"><i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i></button>
                        </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '运单管理') {
            const waybills = window.waybillsData || [];
            mainContent = `
                <div style="height: 100%; width: 100%; flex: 1; display: flex; flex-direction: column; background: #f1f5f9;">
                    <!-- Filter Toolbar -->
                    <div style="padding: 16px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 0.75rem; color: #64748b;">运单号</label>
                            <input type="text" placeholder="输入运单号" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; width: 140px;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 0.75rem; color: #64748b;">客户名称</label>
                            <input type="text" placeholder="输入客户" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; width: 180px;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 0.75rem; color: #64748b;">托运日期</label>
                            <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="primary-btn" style="height: 32px; padding: 0 16px;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                            <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; cursor: pointer; color: #64748b;">重置</button>
                            <button class="primary-btn" onclick="window.showBatchAddTaxRateModal()" style="height: 32px; padding: 0 16px; margin-left: 8px;">批量添加平台税金</button>
                        </div>

                    </div>

                    <!-- Statistics Bar -->
                    <div style="padding: 12px 24px; display: flex; gap: 24px; align-items: center; background: #fff; border-bottom: 1px solid #e2e8f0;">
                         <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <span style="color: #64748b;">全部运单:</span>
                            <span style="font-weight: 700; color: #1e293b;">${waybills.length}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <span style="color: #64748b;">进行中:</span>
                            <span style="font-weight: 700; color: #3b82f6;">0</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <span style="color: #64748b;">已完结:</span>
                            <span style="font-weight: 700; color: #10b981;">0</span>
                        </div>
                    </div>

                    <!-- Table Area -->
                    <div style="flex-grow: 1; overflow: auto; padding: 16px;">
                        <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead style="background: #f8fafc; color: #64748b; border-bottom: 1px solid #e2e8f0;">
                                    <tr>
                                        <th style="padding: 12px 16px; text-align: left; width: 40px;"><input type="checkbox" onchange="window.toggleAllWaybills(this)"></th>
                                        <th style="padding: 12px 16px; text-align: left;">运单号</th>
                                        <th style="padding: 12px 16px; text-align: left;">托运日期</th>
                                        <th style="padding: 12px 16px; text-align: left;">客户名称</th>
                                        <th style="padding: 12px 16px; text-align: left;">线路</th>
                                        <th style="padding: 12px 16px; text-align: left;">货物信息</th>
                                        <th style="padding: 12px 16px; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${waybills.length === 0 ? `
                                        <tr>
                                            <td colspan="7" style="padding: 100px 0; text-align: center;">
                                                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                                    <i data-lucide="search" style="width: 48px; height: 48px; color: #cbd5e1; opacity: 0.5;"></i>
                                                    <span style="color: #94a3b8; font-size: 0.85rem;">暂无运单数据</span>
                                                </div>
                                            </td>
                                        </tr>
                                    ` : waybills.map(item => `
                                        <tr style="border-bottom: 1px solid #f1f5f9; background: white;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                            <td style="padding: 12px 16px; text-align: left;"><input type="checkbox" class="waybill-row-checkbox"></td>
                                            <td style="padding: 12px 16px; color: #4f46e5; font-weight: 500;">${item.no || '-'}</td>
                                            <td style="padding: 12px 16px;">${item.date || '-'}</td>
                                            <td style="padding: 12px 16px;">${item.customer || '-'}</td>
                                            <td style="padding: 12px 16px;">${item.route || '-'}</td>
                                            <td style="padding: 12px 16px;">${item.goods || '-'}</td>
                                            <td style="padding: 12px 16px; text-align: center;">
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div style="padding: 12px 24px; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #64748b;">
                        <div>共 ${waybills.length} 条记录，每页 20 条</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                             <button style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; cursor: pointer;"><i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i></button>
                             <span style="padding: 4px 12px; background: #4f46e5; color: white; border-radius: 4px;">1</span>
                             <button style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: #fff; cursor: pointer;"><i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i></button>
                        </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '货量利润表') {
            mainContent = `
                <div id="workbench-content-area" style="height: 100%; overflow: auto; background: #fff;">
                    ${window.renderVolumeProfitReport()}
                </div>
            `;
        } else if (activeTab === '任务中心') {
            mainContent = `
                <div id="workbench-content-area" style="height: 100%; overflow: auto; background: var(--bg-main);">
                    ${window.renderTaskCenter()}
                </div>
            `;
        } else if (activeTab === '对账单' || activeTab === '应收对账' || activeTab === '应付对账') {
            const isSidebarTab = activeTab === '应收对账' || activeTab === '应付对账';
            const sidebarTitle = activeTab === '应付对账' ? '供应商列表' : '客户列表';
            const sidebarSearchPlaceholder = activeTab === '应付对账' ? '搜索供应商' : '搜索客户名称';

            const sidebarHtml = isSidebarTab ? `
                <div class="customer-sidebar">
                    <div class="sidebar-header">${sidebarTitle}</div>
                    <div class="sidebar-search">
                        <div class="search-input-group">
                            <input type="text" placeholder="${sidebarSearchPlaceholder}">
                                <i data-lucide="search" class="search-icon"></i>
                        </div>
                        <button class="more-btn" style="white-space: nowrap;">更多</button>
                    </div>
                    <div class="customer-list">
                        <div class="customer-item active" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">全部 (94)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">萨姆达拉 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">深圳市远航达国际货运代理有限公司 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">深圳市路路通运输有限公司 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">深圳市好运来货运代理有限公司 (1)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">深圳运物云物流科技有限公司 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">贝塔测试科技有限公司 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">拖车公司 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">全部多个 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">22333344 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">杭州娃哈哈集团有限公司 (0)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">马士基（中国）航运有限公司深圳分公司 (1)</span>
                        </div>
                        <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">欣旺达新能源动力汽车有限公司 (0)</span>
                        </div>
                    </div>
                </div>
            ` : '';

            mainContent = `
                <div class="statement-main" style="display: flex; flex-direction: row; width: 100%; height: 100%;">
                    ${sidebarHtml}
                    <!-- Right Main Area -->
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white;">
                        <!-- List View Wrapper -->
                        <div id="statement-list-view" style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                        <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; flex-shrink: 0;">
                        <div class="internal-tabs">
                            <div class="internal-tab active" onclick="switchInternalTab('reminder')">对账提醒 <span class="badge" id="badge-reminder-count">0</span></div>
                            <div class="internal-tab" onclick="switchInternalTab('list')">对账单 <span class="badge" id="badge-list-count">0</span></div>
                        </div>

                        <!-- Reconciliation Reminder Content (Default) -->
                        <div id="reconciliation-reminder-content">
                            <div class="internal-filter-bar">
                                <div class="internal-input-group">
                                    <label>公司</label>
                                    <div class="relative-container">
                                        <div class="select-box" style="width: 280px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                            <span id="reconciliation-reminder-company" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 240px;" title="请选择">请选择</span>
                                            <i data-lucide="chevron-down" style="flex-shrink: 0;"></i>
                                        </div>
                                        <div class="dropdown-menu-custom hidden" style="width: 280px; max-height: 250px; overflow-y: auto;">
                                            <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="深圳市远航达国际货运代理有限公司" onclick="selectOption('reconciliation-reminder-company', '深圳市远航达国际货运代理有限公司')">深圳市远航达国际货运代理有限公司</div>
                                            <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="马士基（中国）航运有限公司深圳分公司" onclick="selectOption('reconciliation-reminder-company', '马士基（中国）航运有限公司深圳分公司')">马士基（中国）航运有限公司深圳分公司</div>
                                            <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="欣旺达新能源动力汽车有限公司" onclick="selectOption('reconciliation-reminder-company', '欣旺达新能源动力汽车有限公司')">欣旺达新能源动力汽车有限公司</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="internal-input-group">
                                     <label>结算单位</label>
                                    <input type="text" placeholder="请输入" style="width: 140px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px;" />
                                </div>
                                <div class="internal-input-group">
                                    <label>结算单位简称</label>
                                    <input type="text" placeholder="请输入" style="width: 140px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px;" />
                                </div>
                                <div class="internal-input-group">
                                    <label>对账期间</label>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="date" placeholder="开始日期" style="width: 130px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px;" />
                                        <span>-</span>
                                        <input type="date" placeholder="结束日期" style="width: 130px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px;" />
                                    </div>
                                </div>
                                <button class="primary-btn" style="height: 34px; padding: 0 16px;">
                                    <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                </button>
                            </div>
                        </div>

                        <!-- Statement List Content (Hidden) -->
                        <div id="statement-list-content" style="display: none;">
                            <div class="internal-filter-bar">
                                <div class="internal-input-group">
                                     <label>结算单位</label>
                                    <input type="text" placeholder="请输入" style="width: 200px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px;" />
                                </div>
                                <div class="internal-input-group">
                                    <label>对账单号</label>
                                    <input type="text" placeholder="请输入" style="width: 200px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px;" />
                                </div>
                                <div class="internal-input-group">
                                    <label>超期</label>
                                    <div class="relative-container">
                                        <div class="select-box" style="width: 200px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                            <span id="statement-overdue-status">请选择</span>
                                            <i data-lucide="chevron-down"></i>
                                        </div>
                                        <div class="dropdown-menu-custom hidden" style="width: 200px;">
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-overdue-status', '包含超期')">包含超期</div>
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-overdue-status', '只显示超期且有余额')">只显示超期且有余额</div>
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-overdue-status', '只显示超期且没有余额')">只显示超期且没有余额</div>
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-overdue-status', '不含超期')">不含超期</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="internal-input-group">
                                    <label>销账状态</label>
                                    <div class="relative-container">
                                        <div class="select-box" style="width: 200px; height: 34px; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                            <span id="statement-writeoff-status">请选择</span>
                                            <i data-lucide="chevron-down"></i>
                                        </div>
                                         <div class="dropdown-menu-custom hidden" style="width: 200px;">
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-writeoff-status', '未核销')">未核销</div>
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-writeoff-status', '部分核销')">部分核销</div>
                                            <div class="dropdown-item-custom" onclick="selectOption('statement-writeoff-status', '已核销')">已核销</div>
                                        </div>
                                    </div>
                                </div>
                                 <div class="internal-input-group">
                                    <input type="checkbox" id="only-my-creation" />
                                    <label for="only-my-creation">仅显示我创建的</label>
                                </div>
                                <button class="primary-btn" style="height: 34px; padding: 0 16px;">
                                    <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                </button>
                                <button class="primary-btn" style="height: 34px; padding: 0 16px; background-color: #ef4444; border-color: #ef4444; margin-left: 8px;" onclick="deleteSelectedItems()">
                                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i> 删除
                                </button>
                                <button class="primary-btn" style="height: 34px; padding: 0 16px; margin-left: 8px;" onclick="showCreateStatement()">
                                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i> 新建
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Area for Tables -->
                    <div style="flex-grow: 1; overflow: auto; padding: 16px 24px; background: #f8fafc;">
                        
                        <!-- Reminder Table -->
                        <div id="reminder-table-wrapper">
                            <div class="statement-table-container" style="padding: 0; background: transparent;">
                                <table class="statement-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px; text-align: center;">#</th>
                                            <th>结算单位</th>
                                            <th>结算单位简称</th>
                                            <th>类型</th>
                                            <th>账期</th>
                                            <th>结算日期类型</th>
                                            <th>对账单号提醒条件</th>
                                            <th>应对账日期</th>
                                            <th>对账期间起</th>
                                            <th>对账期间止</th>
                                            <th>所属公司</th>
                                            <th style="width: 80px; text-align: center;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;">1</td>
                                            <td>贝塔测试有限公司/渠道部</td>
                                            <td></td>
                                            <td>月结</td>
                                            <td>1个月</td>
                                            <td>工作单日期</td>
                                            <td>每月8号</td>
                                            <td>2025-12-08</td>
                                            <td>2025-11-01</td>
                                            <td>2025-11-30</td>
                                            <td>贝塔测试有限公司</td>
                                            <td style="text-align: center;"><a href="#" style="color: #4f46e5; text-decoration: none;" onclick="showCreateStatement(); return false;">生成对账单</a></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;">2</td>
                                            <td>深圳市远航达国际货运代理有限公司</td>
                                            <td>远航达</td>
                                            <td>月结</td>
                                            <td>1个月</td>
                                            <td>工作单日期</td>
                                            <td>每月10号</td>
                                            <td>2025-12-10</td>
                                            <td>2025-11-01</td>
                                            <td>2025-11-30</td>
                                            <td>丰源物流</td>
                                            <td style="text-align: center;"><a href="#" style="color: #4f46e5; text-decoration: none;" onclick="showCreateStatement(); return false;">生成对账单</a></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;">3</td>
                                            <td>马士基（中国）航运有限公司深圳分公司</td>
                                            <td>MSK</td>
                                            <td>月结</td>
                                            <td>1个月</td>
                                            <td>开票日期</td>
                                            <td>每月15号</td>
                                            <td>2025-12-15</td>
                                            <td>2025-11-01</td>
                                            <td>2025-11-30</td>
                                            <td>马士基深圳</td>
                                            <td style="text-align: center;"><a href="#" style="color: #4f46e5; text-decoration: none;" onclick="showCreateStatement(); return false;">生成对账单</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Statement List Table -->
                        <div id="statement-list-table-wrapper" style="display: none;">
                            <div class="statement-table-container" style="padding: 0; background: transparent;">
                                <table class="statement-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px; text-align: center;"><input type="checkbox" id="statement-check-all" onchange="window.toggleAllStatementCheckboxes(this)" /></th>
                                            <th style="width: 40px; text-align: center;">#</th>
                                            <th>客户确认</th>
                                            <th>收付类型</th>
                                            <th>对账单号</th>
                                            <th>结算单位</th>
                                            <th>结算单位简称</th>
                                            <th>对账月份</th>
                                            <th>结算规则</th>
                                            <th>对账期间起</th>
                                            <th>对账期间止</th>
                                            <th>对账方式</th>
                                            <th style="width: 140px; text-align: center;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox" class="statement-row-checkbox" onchange="window.updateStatementCheckAllState()"></td>
                                            <td style="text-align: center;">1</td>
                                            <td>已确认</td>
                                            <td>AR</td>
                                            <td>DZ2025120001</td>
                                            <td>贝塔测试有限公司</td>
                                            <td>贝塔</td>
                                            <td>2025-11</td>
                                            <td>月结30天</td>
                                            <td>2025-11-01</td>
                                            <td>2025-11-30</td>
                                            <td>邮件确认</td>
                                            <td style="text-align: center;"><a href="#" style="color: #4f46e5; text-decoration: none;">详情</a> <a href="#" onclick="showAIReconciliationModal('DZ2025120001'); return false;" style="color: #10b981; text-decoration: none; margin-left: 8px;">AI对账</a></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox" class="statement-row-checkbox" onchange="window.updateStatementCheckAllState()"></td>
                                            <td style="text-align: center;">2</td>
                                            <td>待确认</td>
                                            <td>AR</td>
                                            <td>DZ2025120002</td>
                                            <td>深圳市远航达国际货运代理有限公司</td>
                                            <td>远航达</td>
                                            <td>2025-11</td>
                                            <td>月结15天</td>
                                            <td>2025-11-01</td>
                                            <td>2025-11-30</td>
                                            <td>平台确认</td>
                                            <td style="text-align: center;"><a href="#" style="color: #4f46e5; text-decoration: none;">详情</a> <a href="#" onclick="showAIReconciliationModal('DZ2025120002'); return false;" style="color: #10b981; text-decoration: none; margin-left: 8px;">AI对账</a></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox" class="statement-row-checkbox" onchange="window.updateStatementCheckAllState()"></td>
                                            <td style="text-align: center;">3</td>
                                            <td>已作废</td>
                                            <td>AR</td>
                                            <td>DZ2025120003</td>
                                            <td>拖车公司</td>
                                            <td>拖车</td>
                                            <td>2025-11</td>
                                            <td>现结</td>
                                            <td>2025-11-01</td>
                                            <td>2025-11-30</td>
                                            <td>微信确认</td>
                                            <td style="text-align: center;"><a href="#" style="color: #4f46e5; text-decoration: none;">详情</a> <a href="#" onclick="showAIReconciliationModal('DZ2025120003'); return false;" style="color: #10b981; text-decoration: none; margin-left: 8px;">AI对账</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </div> <!-- End of statement-list-view -->

                    <!-- Create Statement View (Hidden) -->
                     <div id="statement-create-view" style="display: none; flex-direction: column; width: 100%; height: 100%; background: #f8fafc;">
                        <!-- Header -->
                        <div style="height: 50px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;">
                            <div style="font-size: 14px; color: #64748b;">对账单号: <span style="color: #94a3b8;">自动生成</span></div>
                            <div style="display: flex; gap: 8px;">
                                <button class="primary-btn" style="height: 30px; padding: 0 16px;">保存</button>
                                <button class="secondary-btn" style="height: 30px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #64748b;" onclick="hideCreateStatement()">返回</button>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px;">
                            <!-- Form Section -->
                            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                <div style="display: flex; gap: 24px;">
                                    <!-- Left Column -->
                                    <div style="flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px 24px;">
                                        <!-- Row 1 -->
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">结算单位</label>
                                            <div style="flex: 1; display: flex; gap: 8px;">
                                                <div class="relative-container" style="flex: 1;">
                                                    <div class="select-box" style="width: 100%; height: 32px; display: flex; align-items: center; justify-content: space-between;" onclick="window.toggleDropdown(this); event.stopPropagation();">
                                                        <span id="create-statement-settlement-unit" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;" title="请选择">请选择</span>
                                                        <i data-lucide="chevron-down" style="flex-shrink: 0;"></i>
                                                    </div>
                                                    <div class="dropdown-menu-custom hidden" style="width: 100%; max-height: 250px; overflow-y: auto; z-index: 50;">
                                                        <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="深圳市远航达国际货运代理有限公司" onclick="window.selectOption('create-statement-settlement-unit', '深圳市远航达国际货运代理有限公司'); event.stopPropagation();">深圳市远航达国际货运代理有限公司</div>
                                                        <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="广州市远航达国际货运代理有限公司" onclick="window.selectOption('create-statement-settlement-unit', '广州市远航达国际货运代理有限公司'); event.stopPropagation();">广州市远航达国际货运代理有限公司</div>
                                                        <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="上海市远航达国际货运代理有限公司" onclick="window.selectOption('create-statement-settlement-unit', '上海市远航达国际货运代理有限公司'); event.stopPropagation();">上海市远航达国际货运代理有限公司</div>
                                                    </div>
                                                </div>
                                                <div style="display: flex; align-items: center; background: #f1f5f9; border-radius: 4px; padding: 0 8px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0;">NL</div>
                                                <div style="display: flex; align-items: center; background: #f1f5f9; border-radius: 4px; padding: 0 8px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0;">月结</div>
                                            </div>
                                        </div>
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">工作单日期</label>
                                             <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                                <input type="date" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                                <span style="color: #94a3b8;">-</span>
                                                 <input type="date" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                            </div>
                                        </div>

                                        <!-- Row 2 -->
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">对账方式</label>
                                            <div class="relative-container" style="flex: 1;">
                                                <div class="select-box" style="width: 100%; height: 32px; display: flex; align-items: center; justify-content: space-between;" onclick="window.toggleDropdown(this); event.stopPropagation();">
                                                    <span id="create-statement-recon-type">按费用对账</span>
                                                    <i data-lucide="chevron-down"></i>
                                                </div>
                                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: 100%; left: 0; z-index: 50;">
                                                    <div class="dropdown-item-custom" onclick="window.selectOption('create-statement-recon-type', '按费用对账'); event.stopPropagation();">按费用对账</div>
                                                    <div class="dropdown-item-custom" onclick="window.selectOption('create-statement-recon-type', '按账单对账'); event.stopPropagation();">按账单对账</div>
                                                    <div class="dropdown-item-custom" onclick="window.selectOption('create-statement-recon-type', '按运单对账'); event.stopPropagation();">按运单对账</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">折合金额</label>
                                              <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                                <div class="select-box" style="width: 70px; height: 32px;"><span>CNY</span><i data-lucide="chevron-down"></i></div>
                                                <input type="text" value="未收: 0.00" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; background: #f8fafc; color: #94a3b8; font-size: 13px;" disabled />
                                            </div>
                                        </div>

                                        <!-- Row 3 -->
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">预收款余额</label>
                                            <div style="flex: 1;"></div>
                                        </div>
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">预付款余额</label>
                                            <div style="flex: 1;"></div>
                                        </div>

                                        <!-- Row 4 -->
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">公司抬头</label>
                                            <div class="relative-container" style="flex: 1;">
                                                <div class="select-box" style="width: 100%; height: 32px; display: flex; align-items: center; justify-content: space-between;" onclick="window.toggleDropdown(this); event.stopPropagation();">
                                                    <span id="create-statement-company-head" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;" title="请选择">请选择</span>
                                                    <i data-lucide="chevron-down" style="flex-shrink: 0;"></i>
                                                </div>
                                                <div class="dropdown-menu-custom hidden" style="width: 100%; max-height: 250px; overflow-y: auto; z-index: 50;">
                                                    <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="深圳市远航达国际货运代理有限公司" onclick="window.selectOption('create-statement-company-head', '深圳市远航达国际货运代理有限公司'); event.stopPropagation();">深圳市远航达国际货运代理有限公司</div>
                                                    <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="马士基（中国）航运有限公司深圳分公司" onclick="window.selectOption('create-statement-company-head', '马士基（中国）航运有限公司深圳分公司'); event.stopPropagation();">马士基（中国）航运有限公司深圳分公司</div>
                                                    <div class="dropdown-item-custom" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="欣旺达新能源动力汽车有限公司" onclick="window.selectOption('create-statement-company-head', '欣旺达新能源动力汽车有限公司'); event.stopPropagation();">欣旺达新能源动力汽车有限公司</div>
                                                </div>
                                            </div>
                                        </div>
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">说明</label>
                                            <input type="text" placeholder="请输入" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;">
                                        </div>
                                    </div>

                                    <!-- Middle Column -->
                                    <div style="width: 320px; border-left: 1px solid #f1f5f9; padding-left: 20px;">
                                         <div style="margin-bottom: 12px; display: flex; gap: 16px;">
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #64748b; cursor: pointer;">
                                                <input type="radio" name="recon-type" /> 按参考兑换率对账
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #64748b; cursor: pointer;">
                                                <input type="radio" name="recon-type" checked /> 按账单兑换率对账
                                            </label>
                                        </div>
                                         <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; margin-bottom: 12px; height: 80px; background: #f8fafc; display: flex; align-items: center; justify-content: center;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; color: #cbd5e1;">
                                                <i data-lucide="search" style="width: 20px; height: 20px;"></i>
                                                <span style="font-size: 12px;">No data</span>
                                            </div>
                                         </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div style="width: 280px; padding-left: 20px;">
                                         <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 8px;">
                                             <label style="width: 60px; text-align: right; color: #64748b; font-size: 13px; line-height: 32px;">银行账户</label>
                                             <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; display: flex; flex-direction: column;">
                                                 <div style="padding: 8px 12px; min-height: 50px; color: #cbd5e1; font-size: 13px; background: white; border-bottom: 1px solid #e2e8f0; border-top-left-radius: 4px; border-top-right-radius: 4px;">
                                                     请选择
                                                 </div>
                                                 <div style="padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                                                     <span style="color: #64748b;">已选: 0个账户</span>
                                                     <a href="#" onclick="window.openBankAccountModal(); return false;" style="color: #3b82f6; text-decoration: none; cursor: pointer;">选择账户</a>
                                                 </div>
                                             </div>
                                         </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Filter & Table Section -->
                            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column;">
                                 <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                                     <div style="display: flex; gap: 12px; font-size: 13px; color: #475569; margin-right: 8px;">
                                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type" checked /> 应收</label>
                                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type" /> 应付</label>
                                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type" /> 收付</label>
                                     </div>
                                     <input type="text" placeholder="请输入运单号" style="width: 240px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                     <span style="font-size: 13px; color: #64748b;">费用名称</span>
                                     <div class="select-box" style="width: 100px; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                     <button class="primary-btn" style="height: 32px; padding: 0 12px;">
                                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                     </button>
                                     <button class="secondary-btn" style="height: 32px; padding: 0 12px; display: flex; align-items: center; gap: 4px; background: white; border: 1px solid #e2e8f0; color: #64748b;">
                                        更多(1) <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                                     </button>
                                      <div style="display: flex; align-items: center; gap: 12px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; height: 32px; background: white;">
                                         <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #475569; cursor: pointer;">
                                            <input type="radio" name="display-mode" /> 仅显示已勾选
                                         </label>
                                         <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #475569; cursor: pointer;">
                                            <input type="radio" name="display-mode" checked /> 全部
                                         </label>
                                      </div>
                                 </div>

                                 <div class="statement-table-container" style="flex: 1; padding: 0; background: transparent;">
                                    <table class="statement-table">
                                        <thead>
                                            <tr>
                                                 <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="window.toggleAllStatementGenCheckboxes(this)" /></th>
                                                 <th style="width: 40px; text-align: center;">#</th>
                                                 <th>AR/AP</th>
                                                 <th>对账状态</th>
                                                 <th>工作单号</th>
                                                 <th>账单号</th>
                                                 <th>计费日期</th>
                                                 <th>工作单日期</th>
                                                 <th>账单日期</th>
                                                 <th>审核状态</th>
                                                 <th>费用项</th>
                                                 <th>币别</th>
                                                 <th>数量</th>
                                                 <th>单价</th>
                                                 <th>原币金额</th>
                                                 <th>对账金额</th>
                                                 <th>折合金额</th>
                                                 <th>账单创建日期</th>
                                                 <th>账单金额</th>
                                                 <th>未核销</th>
                                                 <th>所属公司</th>
                                                 <th>结算单位</th>
                                                 <th>委托人/换单人</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox"></td>
                                            <td style="text-align: center;">1</td>
                                            <td>AR</td>
                                            <td>未对账</td>
                                            <td>OTH202312009</td>
                                            <td>BILL20231201</td>
                                            <td>2023-12-01</td>
                                            <td>2023-12-05</td>
                                            <td>2023-12-10</td>
                                            <td>已审核</td>
                                            <td>运费</td>
                                            <td>CNY</td>
                                            <td>1</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>2023-12-31</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>丰源物流</td>
                                            <td>深圳分公司</td>
                                            <td>张三</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox"></td>
                                            <td style="text-align: center;">2</td>
                                            <td>AP</td>
                                            <td>部分对账</td>
                                            <td>OTH202312010</td>
                                            <td>BILL20231202</td>
                                            <td>2023-12-02</td>
                                            <td>2023-12-06</td>
                                            <td>2023-12-11</td>
                                            <td>审核中</td>
                                            <td>派车费</td>
                                            <td>CNY</td>
                                            <td>1</td>
                                            <td>1200.00</td>
                                            <td>1200.00</td>
                                            <td>1200.00</td>
                                            <td>1200.00</td>
                                            <td>2023-12-31</td>
                                            <td>1200.00</td>
                                            <td>600.00</td>
                                            <td>丰源物流</td>
                                            <td>广州分公司</td>
                                            <td>李四</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox"></td>
                                            <td style="text-align: center;">3</td>
                                            <td>AR</td>
                                            <td>已对账</td>
                                            <td>OTH202312011</td>
                                            <td>BILL20231203</td>
                                            <td>2023-12-03</td>
                                            <td>2023-12-07</td>
                                            <td>2023-12-12</td>
                                            <td>未审核</td>
                                            <td>文件费</td>
                                            <td>CNY</td>
                                            <td>1</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>2023-12-31</td>
                                            <td>500.00</td>
                                            <td>0.00</td>
                                            <td>丰源物流</td>
                                            <td>上海分公司</td>
                                            <td>王五</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else if (activeTab === '接收账单') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Status Tabs -->
                <div style="border-bottom: 1px solid #e2e8f0; padding: 0 24px;">
                    <div class="status-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569; overflow-x: auto;">
                        <div class="status-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">全部</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">待审核</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">同意</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">拒绝</div>
                    </div>
                </div>

                <!-- Filter Area -->
                <div class="filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px; background: #fff;">
                    <div class="persistent-filter-row" style="display: flex; flex-wrap: wrap; align-items: center; gap: 12px;">
                        <!-- Date Range -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>账单日期</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                                <input type="text" placeholder="开始日期" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                                <span style="color: #cbd5e1;">-</span>
                                <input type="text" placeholder="结束日期" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                            </div>
                        </div>

                        <!-- Customer Input -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.85rem; color: #475569; white-space: nowrap;">客户</span>
                            <input type="text" placeholder="请输入" style="width: 250px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                        <!-- Keyword Input -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 80px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>关键字</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <input type="text" placeholder="请输入" style="width: 250px; height: 32px; border: none; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                        <!-- Search Button -->
                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                    </div>
                </div>

                <!-- Table Content Area -->
                <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto;">
                    <table class="statement-table" style="min-width: max-content;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>状态</th>
                                <th>收付方向</th>
                                <th>账单类型</th>
                                <th>结算单位</th>
                                <th>原币金额</th>
                                <th>折合币制</th>
                                <th>折合金额</th>
                                <th>账单号</th>
                                <th>账单日期</th>
                                <th>我方工作单号</th>
                                <th>对方工作单号</th>
                                <th>推送日期</th>
                                <th>推送人</th>
                                <th>审核日期</th>
                                <th>审核人</th>
                                <th style="width: 80px; text-align: center;">操作 <i data-lucide="settings" style="width: 12px; height: 12px; display: inline;"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Mock Data -->
                            <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 8px; text-align: center;">1</td>
                                <td style="padding: 8px;"><span style="color: #f59e0b;">待审核</span></td>
                                <td style="padding: 8px;">应付</td>
                                <td style="padding: 8px;">标准</td>
                                <td style="padding: 8px;">深圳市远航达</td>
                                <td style="padding: 8px;">USD 100.00</td>
                                <td style="padding: 8px;">CNY</td>
                                <td style="padding: 8px;">710.00</td>
                                <td style="padding: 8px;">ZD20231201001</td>
                                <td style="padding: 8px;">2023-12-01</td>
                                <td style="padding: 8px;">JOB20231201</td>
                                <td style="padding: 8px;">OPP20231201</td>
                                <td style="padding: 8px;">2023-12-02</td>
                                <td style="padding: 8px;">李四</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px; text-align: center;">
                                    <button style="border: none; background: none; color: #4f46e5; cursor: pointer;">详情</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                     <div class="table-empty-state" style="display:none;">
                        <img src="https://img.icons8.com/ios/100/94a3b8/search--v1.png" alt="no data" style="width: 64px; opacity: 0.5;">
                        <p>暂无数据</p>
                        <span style="font-size: 0.7rem;">No data</span>
                    </div>
                </div>
            </div>`;
        } else if (activeTab === '费用明细') {
            // Expense Detail Content
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Filter Area -->
                <div class="expense-detail-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #fff;">
                    <!-- Date Group -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                            <span>工作单日期</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none;">
                            <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                            <span style="color: #cbd5e1;">-</span>
                            <input type="text" placeholder="结束日期" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none;">
                            <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                        </div>
                    </div>

                    <!-- Keyword -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div class="select-box-filter" style="width: 80px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                            <span>关键字</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <input type="text" placeholder="请输入系统单号/工作单号/客户名称" style="width: 250px; height: 32px; border: none; padding: 0 12px; font-size: 0.8rem; outline: none;">
                    </div>

                    <!-- Verification Status -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">销账状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="expense-verification-status">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; position: absolute; top: 100%; left: 0; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-verification-status', '未核销')">未核销</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-verification-status', '部分核销')">部分核销</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-verification-status', '已核销')">已核销</div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Status -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">开票状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="expense-invoice-status">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; position: absolute; top: 100%; left: 0; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-invoice-status', '未开票')">未开票</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-invoice-status', '已开票')">已开票</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bill Status -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">账单状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="expense-bill-status">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; position: absolute; top: 100%; left: 0; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-bill-status', '未出账单')">未出账单</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('expense-bill-status', '已出账单')">已出账单</div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                    </button>

                    <!-- Generate Bill Button -->
                    <button id="expense-detail-generate-bill-btn" disabled class="secondary-btn" onclick="showGenerateBillModal()" style="height: 32px; padding: 0 16px; background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: not-allowed; transition: all 0.2s;">
                        <i data-lucide="file-plus" style="width: 14px; height: 14px;"></i> 按票生成账单
                    </button>
                </div>

                 <!-- Table Content Area -->
                <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto;">
                    <table class="statement-table" style="min-width: max-content;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="toggleAllExpenseCheckboxes(this)"></th>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>来源</th>
                                <th>AR/AP</th>
                                <th>单据类型</th>
                                <th>系统单号</th>
                                <th>结算公司</th>
                                <th>工作单日期</th>
                                <th>计费日期</th>
                                <th>币制</th>
                                <th>税率</th>
                                <th>数量</th>
                                <th>单位</th>
                                <th>金额</th>
                                <th>不含税金额</th>
                                <th>本位币金额</th>
                                <th>汇率</th>
                                <th>增减</th>
                                <th>备注</th>
                                <th>收付款状态</th>
                                <th>录入人</th>
                                <th>录入时间</th>
                                <th>修改人</th>
                                <th>修改时间</th>
                                <th>审核人</th>
                                <th>审核时间</th>
                                <th>审核状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 8px; text-align: center;"><input type="checkbox" class="expense-row-checkbox" onclick="updateGenerateBillButtonState()"></td>
                                <td style="padding: 8px; text-align: center;">1</td>
                                <td style="padding: 8px;">费用</td>
                                <td style="padding: 8px;">应收</td>
                                <td style="padding: 8px;">运费</td>
                                <td style="padding: 8px;">S20231201001</td>
                                <td style="padding: 8px;">深圳市远航达</td>
                                <td style="padding: 8px;">2023-12-01</td>
                                <td style="padding: 8px;">2023-12-01</td>
                                <td style="padding: 8px;">USD</td>
                                <td style="padding: 8px;">6%</td>
                                <td style="padding: 8px;">1</td>
                                <td style="padding: 8px;">BOX</td>
                                <td style="padding: 8px;">1000.00</td>
                                <td style="padding: 8px;">943.40</td>
                                <td style="padding: 8px;">7100.00</td>
                                <td style="padding: 8px;">7.1</td>
                                <td style="padding: 8px;">0.00</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">未收付</td>
                                <td style="padding: 8px;">张三</td>
                                <td style="padding: 8px;">2023-12-01 10:00</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;"><span style="color: #f59e0b;">待审核</span></td>
                                <td style="padding: 8px;">
                                    <button style="border: none; background: none; color: #4f46e5; cursor: pointer;">详情</button>
                                </td>
                            </tr>
                        </tbody>
                     </table>
                </div>
                </div>
                </div>
            </div>`;
        } else if (activeTab === '储值管理') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: #f8fafc; padding: 24px;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i data-lucide="users" style="width: 24px; height: 24px; color: var(--text-primary);"></i>
                        <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">储值管理</h2>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; background: white; padding: 6px 16px 6px 6px; border-radius: 50px; box-shadow: var(--shadow-sm);">
                        <div style="width: 32px; height: 32px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8rem;">管</div>
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary);">管理员</span>
                            <span style="font-size: 0.7rem; color: var(--text-secondary);">系统管理员</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr) 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- Balance -->
                    <div class="stats-card" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 24px;">
                        <div>
                            <div class="card-label" style="margin-bottom: 8px;">总账户余额</div>
                            <div class="card-value" style="font-size: 1.8rem;">¥1,248,500</div>
                        </div>
                        <div class="icon-box" style="width: 56px; height: 56px; background: #dbeafe; color: #3b82f6; border-radius: 12px;">
                            <i data-lucide="wallet" style="width: 28px; height: 28px;"></i>
                        </div>
                    </div>
                    <!-- Today Recharge -->
                    <div class="stats-card" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 24px;">
                        <div>
                            <div class="card-label" style="margin-bottom: 8px;">今日充值总额</div>
                            <div class="card-value" style="font-size: 1.8rem;">¥42,800</div>
                        </div>
                        <div class="icon-box" style="width: 56px; height: 56px; background: #dcfce7; color: #22c55e; border-radius: 12px;">
                            <i data-lucide="trending-up" style="width: 28px; height: 28px;"></i>
                        </div>
                    </div>
                    <!-- Active Users -->
                    <div class="stats-card" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 24px;">
                        <div>
                            <div class="card-label" style="margin-bottom: 8px;">活跃账户数</div>
                            <div class="card-value" style="font-size: 1.8rem;">1,248</div>
                        </div>
                        <div class="icon-box" style="width: 56px; height: 56px; background: #ffedd5; color: #f97316; border-radius: 12px;">
                            <i data-lucide="users" style="width: 28px; height: 28px;"></i>
                        </div>
                    </div>
                    <!-- Low Balance -->
                    <div class="stats-card" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 24px;">
                        <div>
                            <div class="card-label" style="margin-bottom: 8px;">低余额账户</div>
                            <div class="card-value" style="font-size: 1.8rem;">24</div>
                        </div>
                        <div class="icon-box" style="width: 56px; height: 56px; background: #f3e8ff; color: #a855f7; border-radius: 12px;">
                            <i data-lucide="alert-circle" style="width: 28px; height: 28px;"></i>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; align-items: center;">
                    <div style="position: relative; flex-grow: 1; max-width: 400px;">
                        <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #94a3b8;"></i>
                        <input type="text" placeholder="搜索用户ID、用户名或公司名称..." style="width: 100%; height: 42px; padding: 0 12px 0 36px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; outline: none; background: white;">
                    </div>
                     <div style="flex-grow: 1;"></div>
                    <div class="relative-container" style="width: 140px; height: 42px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; cursor: pointer; position: relative;">
                        <span id="backend-status-select">所有状态</span>
                        <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: #64748b;"></i>
                        <div class="dropdown-menu-custom hidden" style="position: absolute; top: calc(100% + 4px); left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; overflow: hidden;">
                            <div class="dropdown-item-custom" onclick="selectOption('backend-status-select', '所有状态')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">所有状态</div>
                            <div class="dropdown-item-custom" onclick="selectOption('backend-status-select', '活跃账户')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">活跃账户</div>
                            <div class="dropdown-item-custom" onclick="selectOption('backend-status-select', '冻结账户')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">冻结账户</div>
                            <div class="dropdown-item-custom" onclick="selectOption('backend-status-select', '低余额账户')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">低余额账户</div>
                        </div>
                    </div>
                    <div class="relative-container" style="width: 160px; height: 42px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; cursor: pointer; position: relative;">
                        <span id="backend-sort-select">余额从高到低</span>
                        <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: #64748b;"></i>
                        <div class="dropdown-menu-custom hidden" style="position: absolute; top: calc(100% + 4px); left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; overflow: hidden;">
                            <div class="dropdown-item-custom" onclick="selectOption('backend-sort-select', '余额从高到低')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">余额从高到低</div>
                            <div class="dropdown-item-custom" onclick="selectOption('backend-sort-select', '余额从低到高')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">余额从低到高</div>
                            <div class="dropdown-item-custom" onclick="selectOption('backend-sort-select', '最近充值')" style="padding: 10px 12px; font-size: 0.85rem; color: #1e293b; cursor: pointer;">最近充值</div>
                        </div>
                    </div>
                     <button class="primary-btn" style="height: 42px; padding: 0 20px; border-radius: 8px; display: flex; align-items: center; gap: 8px; background: #3b82f6; color: white; border: none; font-weight: 500; cursor: pointer;">
                        <i data-lucide="file-down" style="width: 18px; height: 18px;"></i> 导出数据
                    </button>
                </div>

                <!-- User Table Section -->
                <div style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">用户账户管理</h3>
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">共 1,248 个账户</span>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table" style="width: 100%; position: relative;">
                            <thead style="position: sticky; top: 0; z-index: 10;">
                                <tr style="background: #f8fafc;">
                                    <th rowspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11;">用户信息</th>
                                    <th rowspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11;">用户ID</th>
                                    <th rowspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11;">公司</th>
                                    <th colspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: center; font-weight: 600; color: #64748b; border-bottom: 1px solid #e2e8f0; z-index: 11;">账户余额</th>
                                    <th rowspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11;">账户状态</th>
                                    <th rowspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11;">最后充值时间</th>
                                    <th rowspan="2" style="position: sticky; top: 0; background: #f8fafc; padding: 16px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11;">操作</th>
                                </tr>
                                <tr style="background: #f8fafc;">
                                    <th style="position: sticky; top: 54px; background: #f8fafc; padding: 10px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11; box-shadow: 0 1px 2px -1px rgba(0,0,0,0.1);">人民币</th>
                                    <th style="position: sticky; top: 54px; background: #f8fafc; padding: 10px 24px; text-align: left; font-weight: 600; color: #64748b; z-index: 11; box-shadow: 0 1px 2px -1px rgba(0,0,0,0.1);">美元</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Row 1 -->
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">张</div>
                                            <div>
                                                <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">张三</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">ERP-2023-0582</td>
                                    <td style="padding: 16px 24px; color: #64748b;">创新科技有限公司</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">¥8,450</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">$1,200</td>
                                    <td style="padding: 16px 24px;">
                                        <span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;">活跃</span>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">2023-10-15</td>
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-recharge" onclick="window.openBackendRechargeModal('ERP-2023-0582', '张三', '创新科技有限公司', '8,450')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button class="btn-view-details" onclick="window.openBackendDetailsModal('ERP-2023-0582', '张三', '创新科技有限公司', '8,450')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 2 -->
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">李</div>
                                            <div>
                                                <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">李四</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">ERP-2023-0421</td>
                                    <td style="padding: 16px 24px; color: #64748b;">未来科技有限公司</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">¥15,200</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">$2,500</td>
                                    <td style="padding: 16px 24px;">
                                        <span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;">活跃</span>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">2023-10-14</td>
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-recharge" onclick="window.openBackendRechargeModal('ERP-2023-0421', '李四', '未来科技有限公司', '15,200')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button onclick="window.openBackendDetailsModal('ERP-2023-0421', '李四', '未来科技有限公司', '15,200')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 3 -->
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">王</div>
                                            <div>
                                                <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">王五</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">ERP-2023-0367</td>
                                    <td style="padding: 16px 24px; color: #64748b;">智云网络有限公司</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">¥3,200</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">$500</td>
                                    <td style="padding: 16px 24px;">
                                        <span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;">活跃</span>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">2023-10-12</td>
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="window.openBackendRechargeModal('ERP-2023-0367', '王五', '智云网络有限公司', '3,200')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button onclick="window.openBackendDetailsModal('ERP-2023-0367', '王五', '智云网络有限公司', '3,200')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                 <!-- Row 4 -->
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">赵</div>
                                            <div>
                                                <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">赵六</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">ERP-2023-0198</td>
                                    <td style="padding: 16px 24px; color: #64748b;">星辰信息技术</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #ef4444; font-size: 1rem;">¥120</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #ef4444; font-size: 1rem;">$0</td>
                                    <td style="padding: 16px 24px;">
                                        <span style="background: #fef3c7; color: #b45309; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;">低余额</span>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">2023-09-28</td>
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="window.openBackendRechargeModal('ERP-2023-0198', '赵六', '星辰信息技术', '120')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button onclick="window.openBackendDetailsModal('ERP-2023-0198', '赵六', '星辰信息技术', '120')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 5 -->
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">刘</div>
                                            <div>
                                                <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">刘七</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">ERP-2023-0789</td>
                                    <td style="padding: 16px 24px; color: #64748b;">华通集团</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">¥25,600</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #10b981; font-size: 1rem;">$3,800</td>
                                    <td style="padding: 16px 24px;">
                                        <span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;">活跃</span>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">2023-10-16</td>
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="window.openBackendRechargeModal('ERP-2023-0789', '刘七', '华通集团', '25,600')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button onclick="window.openBackendDetailsModal('ERP-2023-0789', '刘七', '华通集团', '25,600')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 6 -->
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">陈</div>
                                            <div>
                                                <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">陈八</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">ERP-2023-0654</td>
                                    <td style="padding: 16px 24px; color: #64748b;">易联科技有限公司</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #ef4444; font-size: 1rem;">¥0</td>
                                    <td style="padding: 16px 24px; font-weight: 700; color: #ef4444; font-size: 1rem;">$0</td>
                                    <td style="padding: 16px 24px;">
                                        <span style="background: #fee2e2; color: #b91c1c; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;">冻结</span>
                                    </td>
                                    <td style="padding: 16px 24px; color: #64748b;">2023-08-15</td>
                                    <td style="padding: 16px 24px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="window.openBackendRechargeModal('ERP-2023-0654', '陈八', '易联科技有限公司', '0')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button onclick="window.openBackendDetailsModal('ERP-2023-0654', '陈八', '易联科技有限公司', '0')" style="width: 32px; height: 32px; border-radius: 6px; border: none; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                            </button>
                                            <button style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                         <div style="padding: 12px 24px; display: flex; justify-content: center; border-top: 1px solid #e2e8f0;">
                            <span style="font-size: 0.8rem; color: #94a3b8; cursor: pointer;">加载更多...</span>
                        </div>
                    </div>
                </div>

                <!-- Recharge Modal -->
                <div id="backend-recharge-modal-v2" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; width: 300px; padding: 24px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">账户充值</h3>
                            <button onclick="closeBackendRechargeModal()" style="background: none; border: none; cursor: pointer; color: #64748b;">
                                <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                            </button>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #f1f5f9;">
                            <div id="modal-user-avatar" style="width: 56px; height: 56px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.25rem;">
                                张
                            </div>
                            <div>
                                <h4 id="modal-user-name" style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 4px;">张三</h4>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 2px;">用户ID: <span id="modal-user-id">ERP-2023-0582</span></div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 2px;">公司名称: <span id="modal-user-company">创新科技有限公司</span></div>
                                <div style="font-size: 0.85rem; color: #64748b;">当前余额: <span id="modal-user-balance" style="font-weight: 700; color: #64748b;">¥10,450</span></div>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 500; color: #64748b; margin-bottom: 8px;">充值金额 (元)</label>
                                <input id="recharge-amount-input" type="number" value="1000" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 500; color: #64748b; margin-bottom: 8px;">支付方式</label>
                                <div class="relative-container" style="width: 100%; height: 40px; border: 1px solid #e2e8f0; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; cursor: pointer; position: relative;" onclick="document.getElementById('modal-payment-menu').classList.toggle('hidden'); event.stopPropagation();">
                                    <span id="modal-payment-select">支付宝</span>
                                    <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: #94a3b8;"></i>
                                    <div id="modal-payment-menu" class="dropdown-menu-custom hidden" style="position: absolute; top: calc(100% + 4px); left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; overflow: hidden;">
                                        <div class="dropdown-item-custom" onclick="selectOption('modal-payment-select', '支付宝')" style="padding: 10px 12px; font-size: 0.9rem; color: #1e293b; cursor: pointer;">支付宝</div>
                                        <div class="dropdown-item-custom" onclick="selectOption('modal-payment-select', '微信支付')" style="padding: 10px 12px; font-size: 0.9rem; color: #1e293b; cursor: pointer;">微信支付</div>
                                        <div class="dropdown-item-custom" onclick="selectOption('modal-payment-select', '银行转账')" style="padding: 10px 12px; font-size: 0.9rem; color: #1e293b; cursor: pointer;">银行转账</div>
                                        <div class="dropdown-item-custom" onclick="selectOption('modal-payment-select', '手动调整')" style="padding: 10px 12px; font-size: 0.9rem; color: #1e293b; cursor: pointer;">手动调整</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: 0.85rem; font-weight: 500; color: #64748b; margin-bottom: 8px;">备注信息</label>
                            <textarea placeholder="请输入充值备注信息..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; font-size: 0.9rem; resize: none;"></textarea>
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 12px;">
                            <button onclick="closeBackendRechargeModal()" style="height: 40px; padding: 0 20px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; cursor: pointer; font-size: 0.9rem;">取消</button>
                            <button id="btn-confirm-recharge" onclick="confirmBackendRecharge()" style="height: 40px; padding: 0 20px; border: none; border-radius: 6px; background: #10b981; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 500;">确认充值</button>
                        </div>
                    </div>
                </div>
            </div>
                <!-- Account Details Modal -->
                <div id="backend-account-details-modal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; width: 600px; padding: 32px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">账户详情</h3>
                            <button onclick="closeBackendDetailsModal()" style="background: none; border: none; cursor: pointer; color: #64748b;">
                                <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                            </button>
                        </div>

                        <div style="display: flex; gap: 24px; margin-bottom: 32px;">
                            <div id="details-user-avatar" style="width: 80px; height: 80px; background: #3b82f6; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 2rem; flex-shrink: 0;">张</div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <h4 id="details-user-name" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">张三</h4>
                                </div>
                                <div style="color: #64748b; margin-bottom: 4px;">用户ID: <span id="details-user-id">ERP-2023-0582</span></div>
                                <div style="color: #64748b; margin-bottom: 4px;">公司名称: <span id="details-user-company">创新科技有限公司</span></div>
                                <div style="color: #64748b; margin-bottom: 4px;">账户状态: <span style="background: #dcfce7; color: #15803d; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">活跃</span></div>
                                <div style="color: #64748b; margin-bottom: 4px;">当前余额: <span id="details-user-balance" style="font-weight: 700; color: #1e293b; font-size: 1.1rem;">¥10,450</span></div>
                                <div style="color: #64748b;">账户等级: VIP 2级</div>
                            </div>
                        </div>

                        <h4 style="font-size: 1.1rem; font-weight: 600; color: #1e293b; margin-bottom: 16px;">最近交易记录</h4>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 24px;">
                            <thead>
                                <tr style="background: #f8fafc; color: #64748b; font-size: 0.85rem; text-align: left;">
                                    <th style="padding: 12px;">时间</th>
                                    <th style="padding: 12px;">类型</th>
                                    <th style="padding: 12px;">金额</th>
                                    <th style="padding: 12px;">支付方式</th>
                                    <th style="padding: 12px;">备注</th>
                                </tr>
                            </thead>
                            <tbody id="details-transaction-list" style="font-size: 0.9rem; color: #1e293b;">
                                <!-- Mock Data rows will be injected here -->
                            </tbody>
                        </table>

                        <div style="display: flex; justify-content: flex-end;">
                            <button id="btn-details-recharge" onclick="switchToRechargeFromDetails()" style="height: 48px; padding: 0 32px; border: none; border-radius: 6px; background: #3b82f6; color: white; cursor: pointer; font-size: 1rem; font-weight: 500;">为此账户充值</button>
                        </div>
                    </div>
                </div>
            </div>`;
        } else if (activeTab === '油卡管理') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Status Tabs -->
                <div style="border-bottom: 1px solid #e2e8f0; padding: 0 24px;">
                    <div class="status-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569; overflow-x: auto; align-items: center;">
                        <div class="status-tab" data-status="待发放" style="padding: 12px 0; cursor: pointer; position: relative;" onclick="switchFuelCardTab(this)">待发放<span id="pending-fuel-card-badge" style="position: absolute; top: 4px; right: -16px; background: #ef4444; color: white; font-size: 0.65rem; padding: 1px 5px; border-radius: 10px; min-width: 16px; text-align: center; font-weight: 600;"></span></div>
                        <div style="width: 1px; height: 16px; background: #e2e8f0; margin: 0 -4px;"></div>
                        <div class="status-tab active" data-status="全部" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;" onclick="switchFuelCardTab(this)">全部</div>
                        <div class="status-tab" data-status="在库" style="padding: 12px 0; cursor: pointer;" onclick="switchFuelCardTab(this)">在库</div>
                        <div class="status-tab" data-status="已发放" style="padding: 12px 0; cursor: pointer;" onclick="switchFuelCardTab(this)">已发放</div>
                        <div class="status-tab" data-status="已注销" style="padding: 12px 0; cursor: pointer;" onclick="switchFuelCardTab(this)">已注销</div>
                    </div>
                </div>

                <!-- Filter Area -->
                <div class="fuel-card-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #fff; position: relative; z-index: 10;">
                    <!-- 归属网点 -->
                    <div style="display: flex; align-items: center; gap: 8px; position: relative;">
                        <label style="font-size: 0.8rem; color: #475569;">归属网点</label>
                        <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="event.stopPropagation(); window.toggleFuelCardDropdown('branch-dropdown')">
                            <span id="fuel-card-branch-val">所有网点</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div id="branch-dropdown" class="dropdown-menu-custom hidden" style="position: absolute; top: 100%; left: 60px; z-index: 1000; min-width: 120px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-branch-val', '所有网点', 'branch-dropdown')">所有网点</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-branch-val', '孝感总部', 'branch-dropdown')">孝感总部</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-branch-val', '快省供应链', 'branch-dropdown')">快省供应链</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-branch-val', '满满运', 'branch-dropdown')">满满运</div>
                        </div>
                    </div>
                    <!-- 油卡编号 -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569;">油卡编号</label>
                        <input type="text" placeholder="请输入" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                    </div>
                    <!-- 油卡类型 -->
                    <div style="display: flex; align-items: center; gap: 8px; position: relative;">
                        <label style="font-size: 0.8rem; color: #475569;">油卡类型</label>
                        <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="event.stopPropagation(); window.toggleFuelCardDropdown('type-dropdown')">
                            <span id="fuel-card-type-val">所有类型</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div id="type-dropdown" class="dropdown-menu-custom hidden" style="position: absolute; top: 100%; left: 60px; z-index: 1000; min-width: 120px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-type-val', '所有类型', 'type-dropdown')">所有类型</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-type-val', '公司卡', 'type-dropdown')">公司卡</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-type-val', '客户卡', 'type-dropdown')">客户卡</div>
                        </div>
                    </div>
                    <!-- 油卡状态 -->
                    <div style="display: flex; align-items: center; gap: 8px; position: relative;">
                        <label style="font-size: 0.8rem; color: #475569;">油卡状态</label>
                        <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="event.stopPropagation(); window.toggleFuelCardDropdown('status-dropdown')">
                            <span id="fuel-card-status-val">所有状态</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div id="status-dropdown" class="dropdown-menu-custom hidden" style="position: absolute; top: 100%; left: 60px; z-index: 1000; min-width: 100px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-status-val', '所有状态', 'status-dropdown')">所有状态</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-status-val', '在库', 'status-dropdown')">在库</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-status-val', '已发放', 'status-dropdown')">已发放</div>
                            <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.8rem; cursor: pointer;" onclick="window.selectFuelCardOption('fuel-card-status-val', '已注销', 'status-dropdown')">已注销</div>
                        </div>
                    </div>
                    <!-- 登记日期 -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569;">登记日期</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #475569;">
                            <span style="color: #94a3b8; font-size: 0.8rem;">-</span>
                            <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #475569;">
                        </div>
                    </div>
                    <!-- 注销日期 -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569;">注销日期</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #475569;">
                            <span style="color: #94a3b8; font-size: 0.8rem;">-</span>
                            <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #475569;">
                        </div>
                    </div>
                    <!-- Search/Reset buttons -->
                    <div style="display: flex; gap: 8px; margin-left: auto;">
                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                        <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">重置</button>
                    </div>
                </div>

                <!-- Action Button Area -->
                <div id="fuel-card-action-bar" style="padding: 8px 24px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 8px; flex-wrap: wrap; background: #fff;">
                    <button class="action-btn-custom" onclick="window.showFuelCardImportModal()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="upload" style="width: 12px; height: 12px;"></i> 油卡导入
                    </button>
                    <button class="action-btn-custom" onclick="window.showFuelCardRechargeModal()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="plus-square" style="width: 12px; height: 12px;"></i> 充值
                    </button>
                    <button class="action-btn-custom" onclick="window.showIssueFuelCardModal()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="arrow-right-circle" style="width: 12px; height: 12px;"></i> 发放
                    </button>
                    <button class="action-btn-custom" onclick="window.showRecoverFuelCardModal()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="rotate-ccw" style="width: 12px; height: 12px;"></i> 回收
                    </button>
                    <button class="action-btn-custom" onclick="window.logoutFuelCards()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #ef4444; color: #ef4444; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i> 注销
                    </button>
                    <button class="action-btn-custom" onclick="window.restoreFuelCards()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #10b981; color: #10b981; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="refresh-cw" style="width: 12px; height: 12px;"></i> 恢复
                    </button>
                    <button class="action-btn-custom" onclick="window.showFuelCardRecordModal()" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="history" style="width: 12px; height: 12px;"></i> 油卡记录查询
                    </button>
                    <button class="action-btn-custom" style="height: 28px; padding: 0 12px; background: #fff; border: 1px solid #64748b; color: #64748b; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="download" style="width: 12px; height: 12px;"></i> 导出
                    </button>
                </div>

                <!-- Table Content -->
                <div style="flex-grow: 1; overflow: auto; background: #fff; padding: 0 24px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 1600px; font-size: 0.8rem;">
                        <thead style="background: #f8fafc; color: #1e293b; position: sticky; top: 0; z-index: 5;">
                            <tr>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox" id="fuel-card-select-all" onchange="window.toggleAllFuelCardCheckboxes(this)"></th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 50px;">序号</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">系统编号</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">油卡编号</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">油卡类型</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">油卡名称</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">油卡状态</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: right;">油卡余额</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: right;">油卡押金</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">登记日期</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">发放日期</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">发放运单号</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">车牌号码</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">联系电话</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">备注</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="fuel-card-table-body">
                            <!-- Data populated by renderFuelCardTableBody -->
                        </tbody>
                    </table>
                </div>
            </div>`;
        } else if (activeTab === '应收明细') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- List View Wrapper -->
                <div id="statement-list-view" style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                    <!-- Status Tabs -->
                    <div style="border-bottom: 1px solid #e2e8f0; padding: 0 24px;">
                        <div class="status-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569; overflow-x: auto;">
                            <div class="status-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">全部</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">待出账单 (89)</div>
                             <div class="status-tab" style="padding: 12px 0; cursor: pointer;">待对账(月结) (14)</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">未开票 (133)</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">申请开票中 (0)</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">已开票 (5)</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">未核销 (115)</div>
                             <div class="status-tab" style="padding: 12px 0; cursor: pointer;">预销待到账 (0)</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">部分核销 (0)</div>
                            <div class="status-tab" style="padding: 12px 0; cursor: pointer;">已核销 (23)</div>
                        </div>
                    </div>

                    <!-- Filter Area -->
                    <div class="receivables-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #fff;">
                        <!-- Date -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>工作单日期</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                                <input type="date" placeholder="开始日期" style="width: 105px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #475569; background: transparent;">
                                <span style="color: #cbd5e1;">-</span>
                                <input type="date" placeholder="结束日期" style="width: 105px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #475569; background: transparent;">
                            </div>
                        </div>

                        <!-- Keyword -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 80px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>关键字</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <input type="text" placeholder="请输入系统单号/工作单号/客户名称" style="width: 280px; height: 32px; border: none; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                        <!-- Status Dropdowns -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">销账状态</label>
                            <div class="relative-container">
                                <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                    <span id="receivables-verification-status-selected">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-verification-status-selected', '未核销')">未核销</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-verification-status-selected', '部分核销')">部分核销</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-verification-status-selected', '已核销')">已核销</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">开票状态</label>
                            <div class="relative-container">
                                <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                    <span id="receivables-invoice-status-selected">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-invoice-status-selected', '未开票')">未开票</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-invoice-status-selected', '已开票')">已开票</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">账单状态</label>
                            <div class="relative-container">
                                <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                    <span id="receivables-bill-status-selected">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-bill-status-selected', '未出账单')">未出账单</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-bill-status-selected', '已出账单')">已出账单</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">对账状态</label>
                            <div class="relative-container">
                                <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                    <span id="receivables-reconciliation-status-selected">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-reconciliation-status-selected', '未对账')">未对账</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-reconciliation-status-selected', '已对账')">已对账</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">费用审核</label>
                            <div class="relative-container">
                                <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                    <span id="receivables-fee-audit-status-selected">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-fee-audit-status-selected', '未提交')">未提交</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-fee-audit-status-selected', '审核中')">审核中</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-fee-audit-status-selected', '审核通过')">审核通过</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('receivables-fee-audit-status-selected', '审核驳回')">审核驳回</div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Button -->
                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>

                        <!-- Create Bill Button -->
                        <button id="receivables-create-bill-btn" class="primary-btn" onclick="showCreateStatement()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: 1px solid #4f46e5; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-left: 8px; transition: all 0.2s;">
                            <i data-lucide="plus" style="width: 14px; height: 14px;"></i> 创建账单
                        </button>

                        <!-- Generate Bill by Ticket Button -->
                        <button id="receivables-generate-bill-btn" disabled class="secondary-btn" onclick="showGenerateBillModal()" style="height: 32px; padding: 0 16px; background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: not-allowed; margin-left: 8px; transition: all 0.2s;">
                            <i data-lucide="file-plus" style="width: 14px; height: 14px;"></i> 按票生成账单
                        </button>

                    </div>



                     <!-- Table Content Area -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto; min-height: 0;">
                        <table class="statement-table" style="min-width: max-content;">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox" onchange="toggleAllReceivablesCheckboxes(this)"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>来源</th>
                                    <th>AR/AP</th>
                                    <th>单据类型</th>
                                    <th>系统单号</th>
                                    <th>结算公司</th>
                                    <th>工作单日期</th>
                                    <th>计费日期</th>
                                    <th>币制</th>
                                    <th>税率</th>
                                    <th>数量</th>
                                    <th>单位</th>
                                    <th>金额</th>
                                    <th>不含税金额</th>
                                    <th>本位币金额</th>
                                    <th>汇率</th>
                                    <th>增减</th>
                                    <th>备注</th>
                                    <th>收付款状态</th>
                                    <th>录入人</th>
                                    <th>录入时间</th>
                                    <th>修改人</th>
                                    <th>修改时间</th>
                                    <th>审核人</th>
                                    <th>审核时间</th>
                                    <th>审核状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                 <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 8px; text-align: center;"><input type="checkbox" class="receivables-row-checkbox" onchange="updateReceivablesGenerateBillButtonState()"></td>
                                    <td style="padding: 8px; text-align: center;">1</td>
                                    <td style="padding: 8px;">费用</td>
                                    <td style="padding: 8px;">AR</td>
                                    <td style="padding: 8px;">整车</td>
                                    <td style="padding: 8px;">S20231201001</td>
                                    <td style="padding: 8px;">深圳市远航达</td>
                                    <td style="padding: 8px;">2023-12-01</td>
                                    <td style="padding: 8px;">2023-12-01</td>
                                    <td style="padding: 8px;">USD</td>
                                    <td style="padding: 8px;">6%</td>
                                    <td style="padding: 8px;">1</td>
                                    <td style="padding: 8px;">BOX</td>
                                    <td style="padding: 8px;">1000.00</td>
                                    <td style="padding: 8px;">943.40</td>
                                    <td style="padding: 8px;">7100.00</td>
                                    <td style="padding: 8px;">7.1</td>
                                    <td style="padding: 8px;">0.00</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">未收付</td>
                                    <td style="padding: 8px;">张三</td>
                                    <td style="padding: 8px;">2023-12-01 10:00</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;"><span style="color: #f59e0b;">待审核</span></td>
                                    <td style="padding: 8px;">
                                        <button style="border: none; background: none; color: #4f46e5; cursor: pointer;">详情</button>
                                    </td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div> <!-- End of statement-list-view -->

                <!-- Create Statement View (Hidden) -->
                <div id="statement-create-view" style="display: none; flex-direction: column; width: 100%; height: 100%; background: #f8fafc;">
                    <!-- Header -->
                    <div style="height: 50px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;">
                        <div style="font-size: 14px; color: #64748b;">对账单号: <span style="color: #94a3b8;">自动生成</span></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="primary-btn" style="height: 30px; padding: 0 16px;">保存</button>
                            <button class="secondary-btn" style="height: 30px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #64748b;" onclick="hideCreateStatement()">返回</button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px;">
                        <!-- Form Section -->
                        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 24px;">
                                <!-- Left Column -->
                                <div style="flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px 24px;">
                                    <!-- Row 1 -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">结算单位</label>
                                        <div style="flex: 1; display: flex; gap: 8px;">
                                            <div class="select-box" style="flex: 1; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                            <div style="display: flex; align-items: center; background: #f1f5f9; border-radius: 4px; padding: 0 8px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0;">NL</div>
                                            <div style="display: flex; align-items: center; background: #f1f5f9; border-radius: 4px; padding: 0 8px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0;">月结</div>
                                        </div>
                                    </div>
                                     <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">工作单日期</label>
                                         <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                            <input type="date" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                            <span style="color: #94a3b8;">-</span>
                                             <input type="date" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                        </div>
                                    </div>

                                    <!-- Row 2 -->
                                     <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">对账方式</label>
                                        <div class="relative-container" style="flex: 1;">
                                            <div class="select-box" style="width: 100%; height: 32px; display: flex; align-items: center; justify-content: space-between;" onclick="toggleDropdown(this)">
                                                <span id="create-statement-recon-type-receivables">按费用对账</span>
                                                <i data-lucide="chevron-down"></i>
                                            </div>
                                            <div class="dropdown-menu-custom hidden" style="width: 100%; top: 100%; left: 0;">
                                                <div class="dropdown-item-custom" onclick="selectOption('create-statement-recon-type-receivables', '按费用对账')">按费用对账</div>
                                                <div class="dropdown-item-custom" onclick="selectOption('create-statement-recon-type-receivables', '按账单对账')">按账单对账</div>
                                                <div class="dropdown-item-custom" onclick="selectOption('create-statement-recon-type-receivables', '按运单对账')">按运单对账</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">折合金额</label>
                                         <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <div class="select-box" style="width: 70px; height: 32px;"><span>CNY</span><i data-lucide="chevron-down"></i></div>
                                            <input type="text" value="未收: 0.00" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; background: #f8fafc; color: #94a3b8; font-size: 13px;" disabled />
                                        </div>
                                    </div>

                                    <!-- Row 3 -->
                                     <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">预收款余额</label>
                                        <div style="flex: 1;"></div>
                                    </div>
                                     <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">预付款余额</label>
                                        <div style="flex: 1;"></div>
                                    </div>

                                    <!-- Row 4 -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">公司抬头</label>
                                        <div class="select-box" style="flex: 1; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                    </div>
                                     <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">说明</label>
                                        <input type="text" placeholder="请输入" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                    </div>
                                </div>

                                <!-- Middle Column -->
                                <div style="width: 320px; border-left: 1px solid #f1f5f9; padding-left: 20px;">
                                    <div style="margin-bottom: 12px; display: flex; gap: 16px;">
                                        <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #64748b; cursor: pointer;">
                                            <input type="radio" name="recon-type-receivables" /> 按参考凭证号对账
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #64748b; cursor: pointer;">
                                            <input type="radio" name="recon-type-receivables" checked /> 按账单号对账
                                        </label>
                                    </div>
                                     <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; margin-bottom: 12px; height: 80px; background: #f8fafc; display: flex; align-items: center; justify-content: center;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; color: #cbd5e1;">
                                            <i data-lucide="search" style="width: 20px; height: 20px;"></i>
                                            <span style="font-size: 12px;">No data</span>
                                        </div>
                                     </div>
                                </div>

                                <!-- Right Column -->
                                <div style="width: 280px; padding-left: 20px;">
                                     <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 8px;">
                                         <label style="width: 60px; text-align: right; color: #64748b; font-size: 13px; line-height: 32px;">银行账户</label>
                                         <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; display: flex; flex-direction: column;">
                                             <div style="padding: 8px 12px; min-height: 50px; color: #cbd5e1; font-size: 13px; background: white; border-bottom: 1px solid #e2e8f0; border-top-left-radius: 4px; border-top-right-radius: 4px;">
                                                 请选择
                                             </div>
                                             <div style="padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                                                 <span style="color: #64748b;">已选: 0个账户</span>
                                                 <a href="#" onclick="window.openBankAccountModal(); return false;" style="color: #3b82f6; text-decoration: none; cursor: pointer;">选择账户</a>
                                             </div>
                                         </div>
                                     </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter & Table Section -->
                        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column;">
                             <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                                 <div style="display: flex; gap: 12px; font-size: 13px; color: #475569; margin-right: 8px;">
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type-receivables" checked /> 应收</label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type-receivables" /> 应付</label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type-receivables" /> 收付</label>
                                 </div>
                                 <input type="text" placeholder="请输入运单号" style="width: 240px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                 <span style="font-size: 13px; color: #64748b;">费用名称</span>
                                 <div class="select-box" style="width: 100px; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                 <button class="primary-btn" style="height: 32px; padding: 0 12px;">
                                    <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                 </button>
                                 <button class="secondary-btn" style="height: 32px; padding: 0 12px; display: flex; align-items: center; gap: 4px; background: white; border: 1px solid #e2e8f0; color: #64748b;">
                                    更多(1) <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                                 </button>
                                  <div style="display: flex; align-items: center; gap: 12px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; height: 32px; background: white;">
                                     <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #475569; cursor: pointer;">
                                        <input type="radio" name="display-mode-receivables" /> 仅显示已勾选
                                     </label>
                                     <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #475569; cursor: pointer;">
                                        <input type="radio" name="display-mode-receivables" checked /> 全部
                                     </label>
                                  </div>
                             </div>

                             <div class="statement-table-container" style="flex: 1; padding: 0; background: transparent;">
                                <table class="statement-table">
                                    <thead>
                                        <tr>
                                             <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="window.toggleAllStatementGenCheckboxes(this)" /></th>
                                             <th style="width: 40px; text-align: center;">#</th>
                                             <th>AR/AP</th>
                                             <th>对账状态</th>
                                             <th>工作单号</th>
                                             <th>账单号</th>
                                             <th>计费日期</th>
                                             <th>工作单日期</th>
                                             <th>账单日期</th>
                                             <th>审核状态</th>
                                             <th>费用项</th>
                                             <th>币别</th>
                                             <th>数量</th>
                                             <th>单价</th>
                                             <th>原币金额</th>
                                             <th>对账金额</th>
                                             <th>折合金额</th>
                                             <th>账单创建日期</th>
                                             <th>账单金额</th>
                                             <th>未核销</th>
                                             <th>所属公司</th>
                                             <th>结算单位</th>
                                             <th>委托人/换单人</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td style="text-align: center;"><input type="checkbox" /></td>
                                        <td style="text-align: center;">1</td>
                                        <td>AR</td>
                                        <td>未对账</td>
                                        <td>OTH202312009</td>
                                        <td>BILL20231201</td>
                                        <td>2023-12-01</td>
                                        <td>2023-12-05</td>
                                        <td>2023-12-10</td>
                                        <td>已审核</td>
                                        <td>运费</td>
                                        <td>USD</td>
                                        <td>1</td>
                                        <td>500.00</td>
                                        <td>500.00</td>
                                        <td>3500.00</td>
                                        <td>2023-12-31</td>
                                        <td>3500.00</td>
                                        <td>3500.00</td>
                                        <td>丰源物流</td>
                                        <td>深圳分公司</td>
                                        <td>张三</td>
                                        <td>张三</td>
                                    </tr>
                                    </tbody>
                                </table>
                             </div>
                        </div>
                    </div>
                </div>
            </div>`;
        } else if (activeTab === '应付明细') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Status Tabs -->
                <div style="border-bottom: 1px solid #e2e8f0; padding: 0 24px;">
                     <div class="status-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569; overflow-x: auto;">
                        <div class="status-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">全部</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">待收账单 (66)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">待对账(月结) (5)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">未收票 (80)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">已收票 (2)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">待请款 (64)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">已请款 (7)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">未核销 (74)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">预销待到账 (0)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">部分核销 (0)</div>
                        <div class="status-tab" style="padding: 12px 0; cursor: pointer;">已核销 (8)</div>
                    </div>
                </div>

                 <!-- Filter Area -->
                <div class="payables-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #fff;">
                    <!-- Date -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                            <span>工作单日期</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                            <input type="date" placeholder="开始日期" style="width: 105px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #475569; background: transparent;">
                            <span style="color: #cbd5e1;">-</span>
                            <input type="date" placeholder="结束日期" style="width: 105px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #475569; background: transparent;">
                        </div>
                    </div>

                    <!-- Keyword -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div class="select-box-filter" style="width: 80px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                            <span>关键字</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <input type="text" placeholder="请输入系统单号/工作单号/客户名称" style="width: 280px; height: 32px; border: none; padding: 0 12px; font-size: 0.8rem; outline: none;">
                    </div>

                    <!-- Status Dropdowns -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">销账状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                <span id="payables-verification-status-selected">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-verification-status-selected', '未核销')">未核销</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-verification-status-selected', '部分核销')">部分核销</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-verification-status-selected', '已核销')">已核销</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">开票状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                <span id="payables-invoice-status-selected">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-invoice-status-selected', '未开票')">未开票</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-invoice-status-selected', '已开票')">已开票</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">账单状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                <span id="payables-bill-status-selected">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-bill-status-selected', '未出账单')">未出账单</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-bill-status-selected', '已出账单')">已出账单</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">对账状态</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                <span id="payables-reconciliation-status-selected">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-reconciliation-status-selected', '未对账')">未对账</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-reconciliation-status-selected', '已对账')">已对账</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">费用审核</label>
                        <div class="relative-container">
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                <span id="payables-fee-audit-status-selected">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-fee-audit-status-selected', '未提交')">未提交</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-fee-audit-status-selected', '审核中')">审核中</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-fee-audit-status-selected', '审核通过')">审核通过</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payables-fee-audit-status-selected', '审核驳回')">审核驳回</div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                    </button>

                    <!-- Generate Bill by Ticket Button -->
                    <button id="payables-generate-bill-btn" disabled class="secondary-btn" onclick="showGenerateBillModal()" style="height: 32px; padding: 0 16px; background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: not-allowed; transition: all 0.2s;">
                        <i data-lucide="file-plus" style="width: 14px; height: 14px;"></i> 按票生成账单
                    </button>
                </div>

                 <!-- Table Content Area -->
                <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto; min-height: 0;">
                    <table class="statement-table" style="min-width: max-content;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;"><input type="checkbox" onchange="toggleAllPayablesCheckboxes(this)"></th>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>来源</th>
                                <th>AR/AP</th>
                                <th>单据类型</th>
                                <th>系统单号</th>
                                <th>结算公司</th>
                                <th>工作单日期</th>
                                <th>计费日期</th>
                                <th>币制</th>
                                <th>税率</th>
                                <th>数量</th>
                                <th>单位</th>
                                <th>金额</th>
                                <th>不含税金额</th>
                                <th>本位币金额</th>
                                <th>汇率</th>
                                <th>增减</th>
                                <th>备注</th>
                                <th>收付款状态</th>
                                <th>录入人</th>
                                <th>录入时间</th>
                                <th>修改人</th>
                                <th>修改时间</th>
                                <th>审核人</th>
                                <th>审核时间</th>
                                <th>审核状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 8px; text-align: center;"><input type="checkbox" class="payables-row-checkbox" onchange="updatePayablesGenerateBillButtonState()"></td>
                                <td style="padding: 8px; text-align: center;">1</td>
                                <td style="padding: 8px;">费用</td>
                                <td style="padding: 8px;">AP</td>
                                <td style="padding: 8px;">整车</td>
                                <td style="padding: 8px;">S20231201001</td>
                                <td style="padding: 8px;">深圳市远航达</td>
                                <td style="padding: 8px;">2023-12-01</td>
                                <td style="padding: 8px;">2023-12-01</td>
                                <td style="padding: 8px;">USD</td>
                                <td style="padding: 8px;">6%</td>
                                <td style="padding: 8px;">1</td>
                                <td style="padding: 8px;">BOX</td>
                                <td style="padding: 8px;">1000.00</td>
                                <td style="padding: 8px;">943.40</td>
                                <td style="padding: 8px;">7100.00</td>
                                <td style="padding: 8px;">7.1</td>
                                <td style="padding: 8px;">0.00</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">未收付</td>
                                <td style="padding: 8px;">张三</td>
                                <td style="padding: 8px;">2023-12-01 10:00</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;">-</td>
                                <td style="padding: 8px;"><span style="color: #f59e0b;">待审核</span></td>
                                <td style="padding: 8px;">
                                    <button style="border: none; background: none; color: #4f46e5; cursor: pointer;">详情</button>
                                </td>
                            </tr>
                        </tbody>
                     </table>
                </div>
            </div>`;
        } else if (activeTab === '业务员成本明细' || activeTab === '代收代付明细') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                 <!-- Filter Area -->
                <div class="salesman-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #fff;">
                    <!-- Date -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                            <span>工作单日期</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none;" />
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                                <span style="color: #cbd5e1;">-</span>
                                <input type="text" placeholder="结束日期" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none;" />
                                    <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                                </div>
                        </div>

                        <!-- Keyword -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 80px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>关键字</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                                <input type="text" placeholder="请输入工作单号" style="width: 320px; height: 32px; border: none; padding: 0 12px; font-size: 0.8rem; outline: none;" />
                        </div>

                        <!-- Salesman Dropdown -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">结算代理</label>
                            <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span>请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>

                        <!-- Search Button -->
                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                </div>

                    <!-- Table Content Area -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto;">
                        <table class="statement-table" style="min-width: max-content;">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>单据类型</th>
                                    <th>系统单号</th>
                                    <th>结算公司</th>
                                    <th>工作单日期</th>
                                    <th>计费日期</th>
                                    <th>币制</th>
                                    <th>单位</th>
                                    <th>金额</th>
                                    <th>本位币金额</th>
                                    <th>汇率</th>
                                    <th>核销</th>
                                    <th>备注</th>
                                    <th>收付状态</th>
                                    <th>录入人</th>
                                    <th>录入时间</th>
                                    <th>修改人</th>
                                    <th>修改时间</th>
                                    <th>审核人</th>
                                    <th>审核时间</th>
                                    <th style="width: 40px; text-align: center;"><i data-lucide="settings" style="width: 14px; height: 14px; color: #64748b;"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 8px; text-align: center;"><input type="checkbox" class="payables-row-checkbox" onchange="updatePayablesGenerateBillButtonState()"></td>
                                    <td style="padding: 8px; text-align: center;">1</td>
                                    <td style="padding: 8px;">整车</td>
                                    <td style="padding: 8px;">S20231201001</td>
                                    <td style="padding: 8px;">深圳市远航达</td>
                                    <td style="padding: 8px;">2023-12-01</td>
                                    <td style="padding: 8px;">2023-12-01</td>
                                    <td style="padding: 8px;">CNY</td>
                                    <td style="padding: 8px;">票</td>
                                    <td style="padding: 8px;">500.00</td>
                                    <td style="padding: 8px;">500.00</td>
                                    <td style="padding: 8px;">1.00</td>
                                    <td style="padding: 8px;">未核销</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">未收付</td>
                                    <td style="padding: 8px;">张三</td>
                                    <td style="padding: 8px;">2023-12-01 11:30</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px; text-align: center;">
                                        <i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
        } else if (activeTab === '收付款') {
            mainContent = `
            <div id="payment-list-view" class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: #fff;">
                <!-- Header Actions Area -->
                <div style="padding: 12px 24px; display: flex; align-items: center; justify-content: flex-end; gap: 8px; background: #fbfcfe; border-bottom: 1px solid #e2e8f0;">
                    <button class="primary-btn" onclick="window.openReceiptCreateView()" style="height: 32px; padding: 0 12px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                        <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> 新建收款
                    </button>
                    <button class="primary-btn" onclick="window.goToPaymentApplication()" style="height: 32px; padding: 0 12px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                        <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> 新建付款
                    </button>
                    <div class="relative-container">
                        <button class="primary-btn" style="height: 32px; padding: 0 12px; background: #e0f2fe; border: none; border-radius: 4px; color: #0369a1; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                            批量销账<i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>
                    <button class="primary-btn" style="height: 32px; padding: 0 12px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 4px; color: #475569; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                        <i data-lucide="upload-cloud" style="width: 14px; height: 14px;"></i> 导出
                    </button>
                    <button style="width: 32px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>

                <!-- Filter Area -->
                <!-- Filter Area -->
                <div class="receipt-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #fff;">
                    
                    <!-- Direction Filter -->
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 0.8rem; color: #475569;">收付方向</span>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="direction" checked /> 全部</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="direction" /> 收</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="direction" /> 付</label>
                        </div>
                    </div>

                    <!-- Date Group -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 0.8rem; color: #475569;">收付日期</span>
                        <input type="date" style="width: 130px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; cursor: pointer;">
                        <span style="color: #cbd5e1;">-</span>
                        <input type="date" style="width: 130px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; cursor: pointer;">
                    </div>

                    <!-- Large Search Input -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; flex-grow: 1; min-width: 200px;">
                            <input type="text" placeholder="请输入结算单位/流水号/发票号/工作单号/工作单参考号/核销单号" style="width: 100%; height: 32px; border: none; padding: 0 12px; font-size: 0.8rem; outline: none;" />
                    </div>

                    <!-- Write-off No -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500; white-space: nowrap;">核销单号</label>
                            <input type="text" placeholder="请输入核销单号" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none;" />
                    </div>

                    <!-- Status Dropdown -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500; white-space: nowrap;">流水状态</label>
                        <select id="receipt-status-filter" style="width: 130px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                            <option value="all">全部</option>
                            <option value="incomplete">未销完</option>
                            <option value="complete">已销完</option>
                            <option value="pending">预销待到账</option>
                        </select>
                    </div>

                    <!-- Search Button Area -->
                    <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                    </button>
                    
                </div>

                <!-- Table Area Placeholder -->
                <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto;">
                    <table class="statement-table" style="min-width: max-content;">
                        <thead>
                            <tr>
                                 <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="window.toggleAllPaymentCheckboxes(this)" /></th>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>收付方向</th>
                                <th>票据类型</th>
                                <th>状态</th>
                                <th>制单日期</th>
                                <th>结算单位</th>
                                <th>银行账户/现金账户</th>
                                <th>币种</th>
                                <th>收付金额</th>
                                <th>已销金额</th>
                                <th>未销金额</th>
                                <th>收付时间</th>
                                <th>凭证号</th>
                                <th>流水号</th>
                                <th>支票号</th>
                                <th>结算方式</th>
                                <th>人员</th>
                                <th>所属公司</th>
                                <th style="width: 40px; text-align: center;"><i data-lucide="settings" style="width: 14px; height: 14px; color: #64748b;"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                 <td style="padding: 8px; text-align: center;"><input type="checkbox" /></td>
                                <td style="padding: 8px; text-align: center;">1</td>
                                <td style="padding: 8px;">收</td>
                                <td style="padding: 8px;">支票</td>
                                <td style="padding: 8px;"><span style="background: #ecfdf5; color: #059669; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem;">已确认</span></td>
                                <td style="padding: 8px;">2023-12-01</td>
                                <td style="padding: 8px;">深圳市远航达国际货运代理有限公司</td>
                                <td style="padding: 8px;">招商银行 123456789</td>
                                <td style="padding: 8px;">CNY</td>
                                <td style="padding: 8px;">1,200.00</td>
                                <td style="padding: 8px;">1,200.00</td>
                                <td style="padding: 8px;">0.00</td>
                                <td style="padding: 8px;">2023-12-01 14:00</td>
                                <td style="padding: 8px;">V001</td>
                                <td style="padding: 8px;">LS202312010001</td>
                                <td style="padding: 8px;">CHQ123</td>
                                <td style="padding: 8px;">贷款结算</td>
                                <td style="padding: 8px;">管理员</td>
                                <td style="padding: 8px;">丰园集团</td>                                <td style="padding: 8px; text-align: center;">
                                    <i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i>
                                </td>
                            </tr>
                        </tbody>
                     </table>
                </div>
            </div>`;
            mainContent += `
            <div id="receipt-create-view" style="display: none; flex-direction: column; width: 100%; height: 100%; background: #f8fafc;">
                <!-- Header -->
                <div style="height: 48px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0;">
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #334155;">
                        <span>核销单号:</span>
                        <span style="background: #4f46e5; color: white; padding: 1px 4px; border-radius: 2px; font-size: 11px;">收</span>
                        <span style="color: #64748b;">自动生成</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #4f46e5; border: none; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; gap: 4px;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                        <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #4f46e5; border: none; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; gap: 4px;"><i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存</button>
                        <button onclick="closeReceiptCreateView()" style="height: 28px; padding: 0 12px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 4px; font-size: 12px; cursor: pointer;">返回</button>
                    </div>
                </div>

                <!-- Content Area -->
                <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; padding: 12px;">
                    <!-- Top Panels -->
                    <div style="display: flex; gap: 12px; height: 200px; margin-bottom: 12px; flex-shrink: 0;">
                        <!-- Basic Info -->
                        <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 60px; font-size: 0.75rem; color: #64748b;">结算单位</label>
                                <div class="select-box" style="flex: 1; display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; align-items: center; justify-content: space-between; height: 28px;">
                                    <span style="font-size: 0.75rem; color: #cbd5e1;">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <span style="background: #f1f5f9; padding: 2px 4px; border-radius: 2px; font-size: 0.7rem; color: #64748b;">NL</span>
                                <span style="background: #f1f5f9; padding: 2px 4px; border-radius: 2px; font-size: 0.7rem; color: #64748b;">月结</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">资金类型</label>
                                    <div class="select-box" style="flex: 1; height: 28px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.75rem; position: relative;">
                                        <select style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="this.previousElementSibling.previousElementSibling.innerText = this.options[this.selectedIndex].text">
                                            <option>现金</option>
                                            <option>银行存款</option>
                                            <option>预收账款</option>
                                            <option>押金</option>
                                        </select>
                                        <span style="pointer-events: none;">现金</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8; pointer-events: none;"></i>
                                    </div>
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">票据类型</label>
                                    <div class="select-box" style="flex: 1; display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; align-items: center; justify-content: space-between; height: 28px;">
                                        <span style="font-size: 0.75rem; color: #cbd5e1;">请选择</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 8px; flex-grow: 1;">
                                <label style="width: 60px; font-size: 0.75rem; color: #64748b; margin-top: 4px;">摘要</label>
                                <textarea placeholder="请输入" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px; font-size: 0.75rem; outline: none; height: 100%; resize: none;"></textarea>
                            </div>
                        </div>

                        <!-- Bank Transaction Flow -->
                        <div style="flex: 2; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; flex-direction: column;">
                            <div style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 4px 12px; font-size: 0.75rem; text-align: center; color: #64748b;">银行交易流水</div>
                            <div style="padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">银行账户</label>
                                    <div class="select-box" style="flex: 1; display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; align-items: center; justify-content: space-between; height: 28px;">
                                        <span style="font-size: 0.75rem; color: #cbd5e1;">请选择</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">收付时间</label>
                                    <input type="date" value="2025-12-26" style="flex: 1; height: 28px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.75rem; outline: none; padding: 0 8px; font-family: inherit;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">流水号</label>
                                    <input type="text" placeholder="请输入" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; height: 28px; font-size: 0.75rem; outline: none;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">支票号</label>
                                    <input type="text" placeholder="请输入" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; height: 28px; font-size: 0.75rem; outline: none;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">收付金额</label>
                                    <input type="text" value="0.00" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; height: 28px; font-size: 0.75rem; outline: none; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">可销余额</label>
                                    <input type="text" value="0.00" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; height: 28px; font-size: 0.75rem; outline: none; background: #fbfcfe; text-align: right;">
                                </div>
                                <div style="grid-column: span 2; display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 60px; font-size: 0.75rem; color: #64748b;">其它费用</label>
                                    <div style="display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; align-items: center; height: 28px; width: 200px;">
                                        <input type="text" value="0" style="border: none; outline: none; flex: 1; font-size: 0.75rem; text-align: right;">
                                        <i data-lucide="calculator" style="width: 14px; height: 14px; color: #94a3b8; margin-left: 8px; cursor: pointer;"></i>
                                    </div>
                                    <i data-lucide="help-circle" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Clearance Strategy & Attachments (Merged into Flex 1.5) -->
                        <div style="flex: 1.5; display: flex; gap: 12px;">
                            <!-- Standard Matching Layout with the Old Modal -->
                            <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; gap: 16px; font-size: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 4px; color: #64748b; cursor: pointer;"><input type="radio" name="clear_type"> 按参考兑换率核销</label>
                                    <label style="display: flex; align-items: center; gap: 4px; color: #64748b; cursor: pointer;"><input type="radio" name="clear_type" checked> 按账单兑换率核销</label>
                                </div>
                                <div style="flex-grow: 1; border: 1px solid #f1f5f9; background: #f8fafc; position: relative; display: flex; flex-direction: column;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                                        <thead style="background: #f1f5f9; color: #64748b;">
                                            <tr>
                                                <th style="padding: 4px; border-bottom: 1px solid #e2e8f0;">原币</th>
                                                <th style="padding: 4px; border-bottom: 1px solid #e2e8f0;">核销金额</th>
                                                <th style="padding: 4px; border-bottom: 1px solid #e2e8f0;">折算符</th>
                                                <th style="padding: 4px; border-bottom: 1px solid #e2e8f0;">参考兑换率</th>
                                                <th style="padding: 4px; border-bottom: 1px solid #e2e8f0;">折合(本币)</th>
                                            </tr>
                                        </thead>
                                    </table>
                                    <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                                        <i data-lucide="search" style="width: 48px; height: 48px; color: #e2e8f0;"></i>
                                    </div>
                                    <div style="background: #fff; padding: 4px 12px; border-top: 1px solid #e2e8f0; font-size: 0.7rem; color: #64748b; display: flex; justify-content: space-between;">
                                        <span>合计</span>
                                        <span>0.00</span>
                                    </div>
                                </div>
                            </div>
                            <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; flex-direction: column;">
                                <div style="display: flex; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                                    <div id="receipt-attachment-tab-view" style="padding: 4px 12px; font-size: 0.75rem; border-right: 1px solid #e2e8f0; border-bottom: 2px solid #4f46e5; color: #4f46e5; cursor: pointer;">水单附件(<span id="receipt-attachment-count-view">0</span>)</div>
                                    <div style="padding: 4px 12px; font-size: 0.75rem; color: #64748b; cursor: pointer;">发票附件(0)</div>
                                </div>
                                <div style="flex-grow: 1; padding: 12px; display: flex; flex-direction: column; overflow: hidden;">
                                    <!-- 上传区域 -->
                                    <div style="text-align: center; border: 1px dashed #cbd5e1; background: #eff6ff; border-radius: 4px; padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; min-height: 80px;">
                                        <i data-lucide="paperclip" style="width: 18px; height: 18px; color: #4f46e5; margin-bottom: 6px;"></i>
                                        <div style="font-size: 0.75rem; color: #4f46e5; font-weight: 500;">附件</div>
                                        <i data-lucide="upload-cloud" style="width: 28px; height: 28px; color: #94a3b8; margin-top: 8px;"></i>
                                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 4px;">点击上传 JPG / Excel / PDF</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Table Section Header -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 0 4px; flex-shrink: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0; border-radius: 16px; padding: 2px 12px; font-size: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #334155;"><input type="radio" name="pay-recv-type" checked> 应收</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #64748b;"><input type="radio" name="pay-recv-type"> 应付</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #64748b;"><input type="radio" name="pay-recv-type"> 收付</label>
                        </div>
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; height: 28px; background: white; padding-right: 8px; width: 240px;">
                            <input type="text" placeholder="工作号/参考号/发票号/核销单号" style="border: none; outline: none; padding: 0 8px; font-size: 0.75rem; flex: 1; height: 100%;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.75rem; color: #64748b;">对账单号</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; height: 28px; background: white; padding: 0 8px; width: 120px;">
                                <input type="text" placeholder="请输入" style="border: none; outline: none; padding: 0; font-size: 0.75rem; flex: 1; height: 100%;">
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.75rem; color: #64748b;">费用类型</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; height: 28px; background: white; padding: 0 8px; width: 100px;">
                                <span style="font-size: 0.75rem; color: #cbd5e1;">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8; margin-left: auto;"></i>
                            </div>
                        </div>
                        <button class="primary-btn" style="background: #4f46e5; height: 28px; padding: 0 16px; font-size: 0.75rem; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                        <a href="#" style="color: #4f46e5; font-size: 0.75rem; text-decoration: none; margin-left: 4px;">更多(0) <i data-lucide="chevron-down" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i></a>
                        
                        <div style="flex-grow: 1;"></div>
                        
                        <div style="display: flex; align-items: center; gap: 12px; font-size: 0.75rem; color: #64748b;">
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #4f46e5;"><input type="radio" name="show-type" checked> 全部</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="show-type"> 仅显示已勾选</label>
                        </div>

                        <div style="position: relative;">
                            <div class="select-box" style="height: 28px; border: 1px solid #bed2fc; background: #e0e7ff; color: #4f46e5; border-radius: 4px; display: flex; align-items: center; padding: 0 12px; gap: 8px; cursor: pointer; font-size: 0.8rem;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                <span id="verification-type-val-view">按费用明细核销</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                            </div>
                            <div class="hidden dropdown-menu" style="position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); width: 100%; z-index: 50;">
                                <div class="dropdown-item-custom" onclick="event.stopPropagation(); document.getElementById('verification-type-val-view').innerText = '按费用明细核销'; this.parentElement.classList.add('hidden');" style="padding: 10px 14px; font-size: 0.8rem; color: #1e293b; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">按费用明细核销 <i data-lucide="check" style="width: 14px; height: 14px; color: #3b82f6;"></i></div>
                                <div class="dropdown-item-custom" onclick="event.stopPropagation(); document.getElementById('verification-type-val-view').innerText = '按账单核销'; this.parentElement.classList.add('hidden');" style="padding: 10px 14px; font-size: 0.8rem; color: #1e293b; cursor: pointer;">按账单核销</div>
                                <div class="dropdown-item-custom" onclick="event.stopPropagation(); document.getElementById('verification-type-val-view').innerText = '按运单核销'; this.parentElement.classList.add('hidden');" style="padding: 10px 14px; font-size: 0.8rem; color: #1e293b; cursor: pointer;">按运单核销</div>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div style="flex-grow: 1; border: 1px solid #e2e8f0; border-radius: 4px; overflow: auto; background: #fff;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 2500px; font-size: 0.75rem;">
                            <thead style="background: #f8fafc; color: #1e293b; position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 40px;">#</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox" onclick="window.toggleAllPaymentCheckboxes(this)"></th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">工作单号</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">账单号</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">发票号</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">计费日期</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">费用</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">原币</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">未销金额</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">核销金额(原币)</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">折算符</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">汇率</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">核销金额(折合)</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核算币种</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #f1f5f9; background: #fffbeb;">
                                    <td style="padding: 8px; text-align: center;">1</td>
                                    <td style="padding: 8px; text-align: center;"><input type="checkbox"></td>
                                    <td style="padding: 8px; color: #4f46e5; font-weight: 500;">Y0231201-001</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">ST231201-001</td>
                                    <td style="padding: 8px;">2023-12-01</td>
                                    <td style="padding: 8px;">运费</td>
                                    <td style="padding: 8px; text-align: right;">1,200.00</td>
                                    <td style="padding: 8px; text-align: right;">1,200.00</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">0.00</td>
                                    <td style="padding: 8px; text-align: center;">*</td>
                                    <td style="padding: 8px; text-align: right;">1.00</td>
                                    <td style="padding: 8px; text-align: right;">0.00</td>
                                    <td style="padding: 8px;">CNY</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        } else if (activeTab === '客户账单') {
            // For '客户账单', integrate list view and creation view
            mainContent = `
                <div class="statement-main" style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                    <!-- List View Wrapper -->
                    <div id="statement-list-view" style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                        <!-- Status Tabs Header -->
                        <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px;">
                            <div class="status-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569; overflow-x: auto;">
                                <div class="status-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">全部</div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">待收款 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">21</span></div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">待付款 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">8</span></div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">已收款 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">6</span></div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">已付款 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">1</span></div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">待业务员确认 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">21</span></div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">已提交预销 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">4</span></div>
                                <div class="status-separator" style="padding: 12px 0; color: #cbd5e1;">|</div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">待确认销账 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">8</span></div>
                                <div class="status-tab" style="padding: 12px 0; cursor: pointer;">账单提醒</div>
                            </div>
                        </div>

                        <!-- Filter Area -->
                        <div class="bill-filter-area" style="padding: 16px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px;">
                            <div class="persistent-filter-row" style="display: flex; flex-wrap: wrap; align-items: center; gap: 12px;">
                                <!-- Date Group -->
                                <div style="display: flex; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div class="select-box-filter" style="width: 110px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; white-space: nowrap; cursor: pointer;">
                                        <span>账单日期</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                    <input type="date" placeholder="开始日期" style="width: 105px; height: 32px; border: none; padding: 0 8px; font-size: 0.8rem; outline: none; color: #475569; background: transparent;" />
                                    <span style="display: flex; align-items: center; color: #cbd5e1;">-</span>
                                    <input type="date" placeholder="结束日期" style="width: 105px; height: 32px; border: none; padding: 0 8px; font-size: 0.8rem; outline: none; color: #475569; background: transparent;" />
                                </div>

                                <!-- Keyword Input -->
                                <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px;">
                                    <div style="width: 60px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; background: #f8fafc; font-size: 0.8rem;">
                                        <span>关键字</span>
                                    </div>
                                    <input type="text" placeholder="订单号" style="width: 200px; height: 32px; border: none; padding: 0 8px; font-size: 0.8rem; outline: none;" />
                                </div>

                                <!-- Overdue -->
                                <div class="input-label-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.8rem; font-weight: bold;">超期</label>
                                    <select id="bill-overdue-filter" style="width: 180px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                        <option value="">请选择</option>
                                        <option value="include">包含超期</option>
                                        <option value="only-with-balance">只显示超期且有余额</option>
                                        <option value="exclude">不含超期</option>
                                    </select>
                                </div>

                                <!-- Salesman -->
                                <div class="input-label-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.8rem; font-weight: bold;">业务员</label>
                                    <select id="bill-salesman-filter" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                        <option value="">请选择</option>
                                        <option value="张三">张三</option>
                                        <option value="李四">李四</option>
                                        <option value="王五">王五</option>
                                    </select>
                                </div>

                                <!-- Department -->
                                <div class="input-label-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.8rem; font-weight: bold;">销售部门</label>
                                    <select id="bill-department-filter" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                        <option value="">请选择</option>
                                        <option value="华南销售部">华南销售部</option>
                                        <option value="华东销售部">华东销售部</option>
                                        <option value="华北销售部">华北销售部</option>
                                    </select>
                                </div>

                                <!-- Customer Confirmation -->
                                <div class="input-label-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.8rem; font-weight: bold;">客户确认</label>
                                    <select id="bill-customer-confirm-filter" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                        <option value="">请选择</option>
                                        <option value="confirmed">已确认</option>
                                        <option value="unconfirmed">未确认</option>
                                    </select>
                                </div>


                                <div style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #475569;">
                                    <input type="checkbox" id="bill-only-me" />
                                        <label for="bill-only-me">仅显示我创建的</label>
                                </div>

                                <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                </button>
                                 <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #10b981; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-left: 8px;" onclick="showPreWriteOffModal()">
                                     <i data-lucide="check-square" style="width: 14px; height: 14px;"></i> 提交预销
                                 </button>
                                <button id="customer-bill-create-btn" class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: 1px solid #4f46e5; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-left: 8px; transition: all 0.2s;" onclick="showCreateStatement()">
                                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i> 创建账单
                                </button>
                                <button id="customer-bill-generate-stmt-btn" class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: 1px solid #4f46e5; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-left: 8px; transition: all 0.2s;" onclick="showCreateStatement()">
                                    <i data-lucide="file-text" style="width: 14px; height: 14px;"></i> 生成对账单
                                </button>
                            </div>

                        </div>

                        <!-- Empty Table / Content Area -->
                        <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto; min-height: 0;">
                            <table class="statement-table" style="min-width: max-content;">
                                <thead>
                                    <tr>
                                        <th style="width: 40px; text-align: center;"><input type="checkbox" onchange="toggleAllCustomerBillCheckboxes(this)" /></th>
                                        <th style="width: 40px; text-align: center;">#</th>
                                        <th>收付方向</th>
                                        <th>账单状态</th>
                                        <th>账单号</th>
                                        <th>结算公司</th>
                                        <th>原币金额</th>
                                        <th>折合币制</th>
                                        <th>折合金额</th>
                                        <th>账单日期</th>
                                        <th>发送日期</th>
                                        <th>工作单号</th>
                                        <th>业务员</th>
                                        <th>操作员</th>
                                        <th>结算日规则</th>
                                        <th>结算日<i data-lucide="help-circle" style="width: 12px; height: 12px; display: inline; vertical-align: middle; color: #94a3b8;"></i></th>
                                        <th>收款/付款完成日</th>
                                        <th>超期天数</th>
                                        <th>业务员确认</th>
                                        <th>业务员确认时间</th>
                                        <th>客户确认时间</th>
                                        <th>账单参考号</th>
                                        <th>发票号码</th>
                                        <th>核销单号</th>
                                        <th>客户确认</th>
                                        <th>备注</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 8px; text-align: center;"><input type="checkbox" class="customer-bill-row-checkbox" /></td>
                                        <td style="padding: 8px; text-align: center;">1</td>
                                        <td style="padding: 8px;">收</td>
                                        <td style="padding: 8px;"><span style="background: #ecfdf5; color: #059669; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem;">已确认</span></td>
                                        <td style="padding: 8px;">BILL20231201</td>
                                        <td style="padding: 8px;">深圳市远航达国际货运代理有限公司</td>
                                        <td style="padding: 8px;">USD 500.00</td>
                                        <td style="padding: 8px;">CNY</td>
                                        <td style="padding: 8px;">3,560.00</td>
                                        <td style="padding: 8px;">2023-12-10</td>
                                        <td style="padding: 8px;">2023-12-11</td>
                                        <td style="padding: 8px;">OTH202312009</td>
                                        <td style="padding: 8px;">张三</td>
                                        <td style="padding: 8px;">管理员</td>
                                        <td style="padding: 8px;">月结</td>
                                        <td style="padding: 8px;">2023-12-31</td>
                                        <td style="padding: 8px;">2023-12-30</td>
                                        <td style="padding: 8px;">0</td>
                                        <td style="padding: 8px;">已确认</td>
                                        <td style="padding: 8px;">2023-12-12</td>
                                        <td style="padding: 8px;">2023-12-13</td>
                                        <td style="padding: 8px;">REF123456</td>
                                        <td style="padding: 8px;">INV-001</td>
                                        <td style="padding: 8px;">HX202312001</td>
                                        <td style="padding: 8px;">已确认</td>
                                        <td style="padding: 8px;">-</td>
                                    </tr>
                                    <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 8px; text-align: center;"><input type="checkbox" /></td>
                                        <td style="padding: 8px; text-align: center;">2</td>
                                        <td style="padding: 8px;">付</td>
                                        <td style="padding: 8px;"><span style="background: #fffbeb; color: #d97706; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem;">待付款</span></td>
                                        <td style="padding: 8px;">BILL20231202</td>
                                        <td style="padding: 8px;">丰源物流有限公司</td>
                                        <td style="padding: 8px;">CNY 1,200.00</td>
                                        <td style="padding: 8px;">CNY</td>
                                        <td style="padding: 8px;">1,200.00</td>
                                        <td style="padding: 8px;">2023-12-15</td>
                                        <td style="padding: 8px;">2023-12-16</td>
                                        <td style="padding: 8px;">OTH202312010</td>
                                        <td style="padding: 8px;">李四</td>
                                        <td style="padding: 8px;">管理员</td>
                                        <td style="padding: 8px;">周结</td>
                                        <td style="padding: 8px;">2023-12-22</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">5</td>
                                        <td style="padding: 8px;">待确认</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">REF789012</td>
                                        <td style="padding: 8px;">INV-002</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">待确认</td>
                                        <td style="padding: 8px;">紧急支付</td>
                                    </tr>
                                    <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 8px; text-align: center;"><input type="checkbox" /></td>
                                        <td style="padding: 8px; text-align: center;">3</td>
                                        <td style="padding: 8px;">收</td>
                                        <td style="padding: 8px;"><span style="background: #fef2f2; color: #dc2626; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem;">已逾期</span></td>
                                        <td style="padding: 8px;">BILL20231128</td>
                                        <td style="padding: 8px;">环球贸易有限公司</td>
                                        <td style="padding: 8px;">USD 1,000.00</td>
                                        <td style="padding: 8px;">CNY</td>
                                        <td style="padding: 8px;">7,120.00</td>
                                        <td style="padding: 8px;">2023-11-28</td>
                                        <td style="padding: 8px;">2023-11-29</td>
                                        <td style="padding: 8px;">OTH202311025</td>
                                        <td style="padding: 8px;">王五</td>
                                        <td style="padding: 8px;">管理员</td>
                                        <td style="padding: 8px;">月结</td>
                                        <td style="padding: 8px;">2023-12-25</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">15</td>
                                        <td style="padding: 8px;">已确认</td>
                                        <td style="padding: 8px;">2023-11-30</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">REF654321</td>
                                        <td style="padding: 8px;">INV-003</td>
                                        <td style="padding: 8px;">-</td>
                                        <td style="padding: 8px;">待确认</td>
                                        <td style="padding: 8px;">催款中</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div> <!-- End of statement-list-view -->

                    <!-- Create Statement View (Hidden) -->
                    <div id="statement-create-view" style="display: none; flex-direction: column; width: 100%; height: 100%; background: #f8fafc;">
                        <!-- Header -->
                        <div style="height: 50px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;">
                            <div style="font-size: 14px; color: #64748b;">对账单号: <span style="color: #94a3b8;">自动生成</span></div>
                            <div style="display: flex; gap: 8px;">
                                <button class="primary-btn" style="height: 30px; padding: 0 16px;">保存</button>
                                <button class="secondary-btn" style="height: 30px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #64748b;" onclick="hideCreateStatement()">返回</button>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px;">
                            <!-- Form Section -->
                            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                <div style="display: flex; gap: 24px;">
                                    <!-- Left Column -->
                                    <div style="flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px 24px;">
                                        <!-- Row 1 -->
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">结算单位</label>
                                            <div style="flex: 1; display: flex; gap: 8px;">
                                                <div class="select-box" style="flex: 1; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                                <div style="display: flex; align-items: center; background: #f1f5f9; border-radius: 4px; padding: 0 8px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0;">NL</div>
                                                <div style="display: flex; align-items: center; background: #f1f5f9; border-radius: 4px; padding: 0 8px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0;">月结</div>
                                            </div>
                                        </div>
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">工作单日期</label>
                                             <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                                <input type="date" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                                <span style="color: #94a3b8;">-</span>
                                                 <input type="date" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                            </div>
                                        </div>

                                        <!-- Row 2 -->
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">对账方式</label>
                                            <div class="relative-container" style="flex: 1;">
                                                <div class="select-box" style="width: 100%; height: 32px; display: flex; align-items: center; justify-content: space-between;" onclick="toggleDropdown(this)">
                                                    <span id="create-statement-recon-type-bill">按费用对账</span>
                                                    <i data-lucide="chevron-down"></i>
                                                </div>
                                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: 100%; left: 0;">
                                                    <div class="dropdown-item-custom" onclick="selectOption('create-statement-recon-type-bill', '按费用对账')">按费用对账</div>
                                                    <div class="dropdown-item-custom" onclick="selectOption('create-statement-recon-type-bill', '按账单对账')">按账单对账</div>
                                                    <div class="dropdown-item-custom" onclick="selectOption('create-statement-recon-type-bill', '按运单对账')">按运单对账</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">折合金额</label>
                                             <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                                <div class="select-box" style="width: 70px; height: 32px;"><span>CNY</span><i data-lucide="chevron-down"></i></div>
                                                <input type="text" value="未收: 0.00" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; background: #f8fafc; color: #94a3b8; font-size: 13px;" disabled />
                                            </div>
                                        </div>

                                        <!-- Row 3 -->
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">预收款余额</label>
                                            <div style="flex: 1;"></div>
                                        </div>
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">预付款余额</label>
                                            <div style="flex: 1;"></div>
                                        </div>

                                        <!-- Row 4 -->
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 70px; text-align: right; color: #64748b; font-size: 13px;">公司抬头</label>
                                            <div class="select-box" style="flex: 1; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                        </div>
                                         <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="width: 80px; text-align: right; color: #64748b; font-size: 13px;">说明</label>
                                            <input type="text" placeholder="请输入" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                        </div>
                                    </div>

                                    <!-- Middle Column -->
                                    <div style="width: 320px; border-left: 1px solid #f1f5f9; padding-left: 20px;">
                                        <div style="margin-bottom: 12px; display: flex; gap: 16px;">
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #64748b; cursor: pointer;">
                                                <input type="radio" name="recon-type-bill" /> 按参考凭证号对账
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #64748b; cursor: pointer;">
                                                <input type="radio" name="recon-type-bill" checked /> 按账单号对账
                                            </label>
                                        </div>
                                         <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; margin-bottom: 12px; height: 80px; background: #f8fafc; display: flex; align-items: center; justify-content: center;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; color: #cbd5e1;">
                                                <i data-lucide="search" style="width: 20px; height: 20px;"></i>
                                                <span style="font-size: 12px;">No data</span>
                                            </div>
                                         </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div style="width: 280px; padding-left: 20px;">
                                         <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 8px;">
                                             <label style="width: 60px; text-align: right; color: #64748b; font-size: 13px; line-height: 32px;">银行账户</label>
                                             <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; display: flex; flex-direction: column;">
                                                 <div style="padding: 8px 12px; min-height: 50px; color: #cbd5e1; font-size: 13px; background: white; border-bottom: 1px solid #e2e8f0; border-top-left-radius: 4px; border-top-right-radius: 4px;">
                                                     请选择
                                                 </div>
                                                 <div style="padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                                                     <span style="color: #64748b;">已选: 0个账户</span>
                                                     <a href="#" onclick="window.openBankAccountModal(); return false;" style="color: #3b82f6; text-decoration: none; cursor: pointer;">选择账户</a>
                                                 </div>
                                             </div>
                                         </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Filter & Table Section -->
                            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column;">
                                 <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                                     <div style="display: flex; gap: 12px; font-size: 13px; color: #475569; margin-right: 8px;">
                                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type-bill" checked /> 应收</label>
                                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type-bill" /> 应付</label>
                                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="fee-type-bill" /> 收付</label>
                                     </div>
                                     <input type="text" placeholder="请输入运单号" style="width: 240px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 13px;" />
                                     <span style="font-size: 13px; color: #64748b;">费用名称</span>
                                     <div class="select-box" style="width: 100px; height: 32px;"><span>请选择</span><i data-lucide="chevron-down"></i></div>
                                     <button class="primary-btn" style="height: 32px; padding: 0 12px;">
                                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                     </button>
                                     <button class="secondary-btn" style="height: 32px; padding: 0 12px; display: flex; align-items: center; gap: 4px; background: white; border: 1px solid #e2e8f0; color: #64748b;">
                                        更多(1) <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                                     </button>
                                      <div style="display: flex; align-items: center; gap: 12px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; height: 32px; background: white;">
                                         <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #475569; cursor: pointer;">
                                            <input type="radio" name="display-mode-bill" /> 仅显示已勾选
                                         </label>
                                         <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; color: #475569; cursor: pointer;">
                                            <input type="radio" name="display-mode-bill" checked /> 全部
                                         </label>
                                      </div>
                                 </div>

                                 <div class="statement-table-container" style="flex: 1; padding: 0; background: transparent;">
                                    <table class="statement-table">
                                        <thead>
                                            <tr>
                                                 <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="window.toggleAllStatementGenCheckboxes(this)" /></th>
                                                 <th style="width: 40px; text-align: center;">#</th>
                                                 <th>AR/AP</th>
                                                 <th>对账状态</th>
                                                 <th>工作单号</th>
                                                 <th>账单号</th>
                                                 <th>计费日期</th>
                                                 <th>工作单日期</th>
                                                 <th>账单日期</th>
                                                 <th>审核状态</th>
                                                 <th>费用项</th>
                                                 <th>币别</th>
                                                 <th>数量</th>
                                                 <th>单价</th>
                                                 <th>原币金额</th>
                                                 <th>对账金额</th>
                                                 <th>折合金额</th>
                                                 <th>账单创建日期</th>
                                                 <th>账单金额</th>
                                                 <th>未核销</th>
                                                 <th>所属公司</th>
                                                 <th>结算单位</th>
                                                 <th>委托人/换单人</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox" /></td>
                                            <td style="text-align: center;">1</td>
                                            <td>AR</td>
                                            <td>未对账</td>
                                            <td>OTH202312009</td>
                                            <td>BILL20231201</td>
                                            <td>2023-12-01</td>
                                            <td>2023-12-05</td>
                                            <td>2023-12-10</td>
                                            <td>已审核</td>
                                            <td>运费</td>
                                            <td>USD</td>
                                            <td>1</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>3500.00</td>
                                            <td>2023-12-31</td>
                                            <td>3500.00</td>
                                            <td>3500.00</td>
                                            <td>丰源物流</td>
                                            <td>深圳分公司</td>
                                            <td>张三</td>
                                            <td>张三</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox" /></td>
                                            <td style="text-align: center;">2</td>
                                            <td>AP</td>
                                            <td>部分对账</td>
                                            <td>OTH202312010</td>
                                            <td>BILL20231202</td>
                                            <td>2023-12-02</td>
                                            <td>2023-12-06</td>
                                            <td>2023-12-11</td>
                                            <td>审核中</td>
                                            <td>派车费</td>
                                            <td>CNY</td>
                                            <td>1</td>
                                            <td>1200.00</td>
                                            <td>1200.00</td>
                                            <td>1200.00</td>
                                            <td>1200.00</td>
                                            <td>2023-12-31</td>
                                            <td>1200.00</td>
                                            <td>600.00</td>
                                            <td>丰源物流</td>
                                            <td>广州分公司</td>
                                            <td>李四</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;"><input type="checkbox" /></td>
                                            <td style="text-align: center;">3</td>
                                            <td>AR</td>
                                            <td>已对账</td>
                                            <td>OTH202312011</td>
                                            <td>BILL20231203</td>
                                            <td>2023-12-03</td>
                                            <td>2023-12-07</td>
                                            <td>2023-12-12</td>
                                            <td>未审核</td>
                                            <td>文件费</td>
                                            <td>CNY</td>
                                            <td>1</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>500.00</td>
                                            <td>2023-12-31</td>
                                            <td>500.00</td>
                                            <td>0.00</td>
                                            <td>丰源物流</td>
                                            <td>上海分公司</td>
                                            <td>王五</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else if (activeTab === '开票申请') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; position: relative;">
                    <!-- List View -->
                    <div id="invoice-application-list-view" style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                <!-- Top Tabs Header & Add Button -->
                <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px; display: flex; justify-content: space-between; align-items: center;">
                    <div class="status-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569; overflow-x: auto;">
                        <div class="status-tab active" onclick="window.switchInvoiceApplicationTab(this)" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">全部</div>
                        <div class="status-tab" onclick="window.switchInvoiceApplicationTab(this)" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">草稿 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">1</span></div>
                        <div class="status-tab" onclick="window.switchInvoiceApplicationTab(this)" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">审核中 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">1</span></div>
                        <div class="status-tab" onclick="window.switchInvoiceApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">已批准</div>
                        <div class="status-tab" onclick="window.switchInvoiceApplicationTab(this)" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">已开票 <span style="background:#e2e8f0; color:#475569; padding: 1px 6px; border-radius: 99px; font-size: 0.7rem;">1</span></div>
                        <div class="status-tab" onclick="window.switchInvoiceApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">已驳回/已取消</div>
                    </div>
                    <button class="primary-btn" onclick="document.getElementById('invoice-application-list-view').style.display='none';document.getElementById('invoice-application-create-view').style.display='flex';document.querySelector('.customer-sidebar').style.display='none';" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> 新增
                    </button>
                </div>

                <!-- Filter Area -->
                <div class="bill-filter-area" style="padding: 16px 24px; background: white; border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <!-- Application Date -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: bold;">申请日期</label>
                            <div style="display: flex; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                     <input type="text" placeholder="开始日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="width: 110px; height: 32px; border: none; border-right: 1px solid #e2e8f0; padding: 0 8px; font-size: 0.8rem; outline: none;" />
                                     <input type="text" placeholder="结束日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="width: 110px; height: 32px; border: none; padding: 0 8px; font-size: 0.8rem; outline: none;" />
                                    <div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-left: 1px solid #e2e8f0;">
                                        <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                                    </div>
                            </div>
                        </div>

                        <!-- Keyword -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: bold;">关键字</label>
                             <input type="text" placeholder="请输入结算单位/申请单号" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;" />
                        </div>

                        <!-- Applicant -->
                         <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: bold;">申请人</label>
                             <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;">
                                <span style="color: #cbd5e1; font-size: 0.8rem;">请选择</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                         </div>

                          <!-- Bill Status -->
                         <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: bold;">单据状态</label>
                             <div class="relative-container">
                                 <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="window.toggleDropdown(this); event.stopPropagation();">
                                    <span id="invoice-app-status-selected" style="color: #64748b; font-size: 0.8rem;">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; z-index: 50;">
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('invoice-app-status-selected', '草稿'); event.stopPropagation();">草稿</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('invoice-app-status-selected', '审核中'); event.stopPropagation();">审核中</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('invoice-app-status-selected', '已驳回'); event.stopPropagation();">已驳回</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('invoice-app-status-selected', '已退回'); event.stopPropagation();">已退回</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('invoice-app-status-selected', '已批准'); event.stopPropagation();">已批准</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('invoice-app-status-selected', '已取消'); event.stopPropagation();">已取消</div>
                                </div>
                            </div>
                         </div>

                         <!-- Only Me -->
                         <div style="display: flex; align-items: center; gap: 4px;">
                             <input type="checkbox" id="only-me-inv" style="width: 14px; height: 14px;" />
                            <label for="only-me-inv" style="font-size: 0.8rem; color: #475569;">仅显示我创建的</label>
                         </div>

                         <!-- Work Order No -->
                         <div style="display: flex; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; align-items: center;">
                               <div class="select-box-filter" style="width: 90px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; cursor: pointer;">
                                    <span style="font-size: 0.8rem;">工作单号</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                               </div>
                                <input type="text" placeholder="请输入" style="width: 120px; height: 32px; border: none; padding: 0 8px; font-size: 0.8rem; outline: none;" />
                         </div>
                         
                         <!-- Customer Contact -->
                         <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: bold;">客户联系人</label>
                              <input type="text" placeholder="请输入" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;" />
                         </div>

                        <button class="primary-btn" style="height: 32px; padding: 0 24px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.85rem;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>

                         <button class="action-btn" style="height: 32px; padding: 0 16px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            查看我已处理的
                         </button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0;">
                    <table class="statement-table">
                        <thead>
                            <tr>
                                 <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="window.toggleAllInvoiceAppCheckboxes(this)" /></th>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>状态</th>
                                <th>发票号</th>
                                <th>发票类型</th>
                                <th>结算单位</th>
                                <th>开票日期</th>
                                <th>币制</th>
                                <th>金额</th>
                                <th>税额</th>
                                <th>价税合计</th>
                                <th>本币金额</th>
                                <th>工作单号</th>
                                <th>账单号</th>
                                <th>录入人</th>
                                <th>录入时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                 <td style="padding: 10px; text-align: center;"><input type="checkbox" /></td>
                                <td style="padding: 10px; text-align: center;">1</td>
                                <td style="padding: 10px;"><span style="background: #fef3c7; color: #d97706; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">待审核</span></td>
                                <td style="padding: 10px;">-</td>
                                <td style="padding: 10px;">普票</td>
                                <td style="padding: 10px;">深圳市好运来货运代理有限公司</td>
                                <td style="padding: 10px;">2023-12-05</td>
                                <td style="padding: 10px;">CNY</td>
                                <td style="padding: 10px; text-align: right;">2,000.00</td>
                                <td style="padding: 10px; text-align: right;">120.00</td>
                                <td style="padding: 10px; text-align: right;">2,120.00</td>
                                <td style="padding: 10px; text-align: right;">2,120.00</td>
                                <td style="padding: 10px;">YO2512-0023</td>
                                <td style="padding: 10px;">B2023120501</td>
                                <td style="padding: 10px;">赵六</td>                                <td style="padding: 10px;">2023-12-05 11:00</td>
                                <td style="padding: 10px; text-align: center;"><i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 10px; text-align: center;"><input type="checkbox"></td>
                                <td style="padding: 10px; text-align: center;">2</td>
                                <td style="padding: 10px;"><span style="background: #dbeafe; color: #4f46e5; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">已开票</span></td>
                                <td style="padding: 10px;">INV20231206001</td>
                                <td style="padding: 10px;">专票(6%)</td>
                                <td style="padding: 10px;">北京京华物流有限公司</td>                                <td style="padding: 10px;">2023-12-06</td>
                                <td style="padding: 10px;">CNY</td>
                                <td style="padding: 10px; text-align: right;">8,000.00</td>
                                <td style="padding: 10px; text-align: right;">480.00</td>
                                <td style="padding: 10px; text-align: right;">8,480.00</td>
                                <td style="padding: 10px; text-align: right;">8,480.00</td>
                                <td style="padding: 10px;">YO2512-0024</td>
                                <td style="padding: 10px;">B2023120601</td>
                                <td style="padding: 10px;">孙七</td>                                <td style="padding: 10px;">2023-12-06 15:20</td>
                                <td style="padding: 10px; text-align: center;"><i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 10px; text-align: center;"><input type="checkbox"></td>
                                <td style="padding: 10px; text-align: center;">3</td>
                                <td style="padding: 10px;"><span style="background: #e2e8f0; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">草稿</span></td>
                                <td style="padding: 10px;">-</td>
                                <td style="padding: 10px;">专票(13%)</td>
                                <td style="padding: 10px;">天津港保税区物流</td>                                <td style="padding: 10px;">2023-12-07</td>
                                <td style="padding: 10px;">USD</td>
                                <td style="padding: 10px; text-align: right;">1,500.00</td>
                                <td style="padding: 10px; text-align: right;">0.00</td>
                                <td style="padding: 10px; text-align: right;">1,500.00</td>
                                <td style="padding: 10px; text-align: right;">10,800.00</td>
                                <td style="padding: 10px;">YO2512-0025</td>
                                <td style="padding: 10px;">B2023120701</td>
                                <td style="padding: 10px;">周八</td>                                <td style="padding: 10px;">2023-12-07 09:45</td>
                                <td style="padding: 10px; text-align: center;"><i data-lucide="more-horizontal" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Creation View (New) -->
            <div id="invoice-application-create-view" style="display: none; flex-direction: column; width: 100%; height: 100%; background: #f8fafc; overflow: auto;">
                         <!-- Top Action Bar -->
                        <div style="width: 100%; padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; justify-content: space-between; align-items: center;">
                             <div style="font-size: 0.85rem; color: #334155; font-weight: 600;">申请单号: 自动生成</div>
                             <div style="display: flex; gap: 8px;">
                                 <button class="primary-btn" onclick="window.submitInvoiceApplication()" style="height: 30px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px;">提交审核</button>
                                 <button style="height: 30px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #475569; border-radius: 4px;">暂存草稿</button>
                                 <button onclick="document.getElementById('invoice-application-list-view').style.display='flex';document.getElementById('invoice-application-create-view').style.display='none';document.querySelector('.customer-sidebar').style.display='flex';" style="height: 30px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #475569; border-radius: 4px;">返回</button>
                            </div>
                        </div>

                         <!-- Form Section -->
                        <div style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                            <!-- Row 1 -->
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 16px; align-items: center;">
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label class="required" style="white-space: nowrap; font-size: 0.8rem; color: #475569;">客户</label>
                                    <select id="invoice-create-customer-select" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; background: white; cursor: pointer; outline: none;">
                                        <option value="" disabled selected>请选择</option>
                                        <option value="深圳市丰源物流有限公司">深圳市丰源物流有限公司</option>
                                        <option value="上海顺丰速运有限公司">上海顺丰速运有限公司</option>
                                        <option value="北京京东世纪贸易有限公司">北京京东世纪贸易有限公司</option>
                                    </select>
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <div style="display: flex; gap: 8px; width: 100%;">
                                        <div class="select-box" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; background: white;"><span style="font-size: 0.75rem;">NL</span></div>
                                        <div class="select-box" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; background: white;"><span style="font-size: 0.75rem;">月结</span></div>
                                    </div>
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label class="required" style="white-space: nowrap; font-size: 0.8rem; color: #475569;">发票类型</label>
                                     <div class="select-box" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between; background: white; cursor: pointer;">
                                        <span>普通发票</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">发票介质</label>
                                    <div style="display: flex; gap: 12px; align-items: center; height: 32px;">
                                        <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; margin: 0; cursor: pointer; color: #475569;"><input type="radio" name="inv-medium"> 纸质发票</label>
                                        <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; margin: 0; cursor: pointer; color: #475569;"><input type="radio" name="inv-medium" checked> 电子发票</label>
                                    </div>
                                </div>
                                 <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">发票形式</label>
                                    <div style="display: flex; gap: 12px; align-items: center; height: 32px;">
                                        <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; margin: 0; cursor: pointer; color: #475569;"><input type="radio" name="inv-form" checked> 税务发票</label>
                                        <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; margin: 0; cursor: pointer; color: #475569;"><input type="radio" name="inv-form"> INVOICE</label>
                                    </div>
                                </div>
                            </div>
                             <!-- Row 2 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 2fr; gap: 16px;">
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">联系人</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none; transition: border-color 0.2s;">
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">电话</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none; transition: border-color 0.2s;">
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">邮箱</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none; transition: border-color 0.2s;">
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">邮寄地址</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none; transition: border-color 0.2s;">
                                </div>
                            </div>
                             <!-- Purchaser Details (Gray box) -->
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 4px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                 <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label class="required" style="white-space: nowrap; font-size: 0.8rem; color: #475569;">抬头</label>
                                    <div class="select-box" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between; background: white; cursor: pointer;">
                                        <span>请选择</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                </div>
                                 <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label class="required" style="white-space: nowrap; font-size: 0.8rem; color: #475569;">纳税人识别号</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="background: white; width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">地址</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="background: white; width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                     <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">电话</label>
                                    <input type="text" placeholder="请输入" class="form-input" style="background: white; width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                                </div>
                                <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label style="white-space: nowrap; font-size: 0.8rem; color: #475569;">开户行及账号</label>
                                     <div class="select-box" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between; background: white; cursor: pointer;">
                                        <span>请选择</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                </div>
                            </div>

                             <!-- Middle Controls -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <button class="primary-btn" style="height: 32px; padding: 0 16px; font-size: 0.8rem;">选择开票费用</button>
                                    <span style="font-size: 0.85rem; color: #64748b;">已选工作单 0项，费用 0项</span>
                                </div>
                                 <div style="display: flex; gap: 12px; align-items: center;">
                                     <div class="input-label-group" style="display: flex; align-items: center; gap: 8px;">
                                        <label style="font-size: 0.8rem; color: #475569;">申请金额折合</label>
                                        <div style="display: flex; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; height: 32px;">
                                             <div style="width: 50px; background: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">CNY</div>
                                              <input type="text" value="0.00" style="width: 80px; border: none; padding: 0 8px; font-size: 0.85rem; text-align: right; outline: none; font-weight: 500;">
                                        </div>
                                    </div>
                                     <div class="input-label-group" style="display: flex; align-items: center; gap: 8px;">
                                        <label style="font-size: 0.8rem; color: #475569;">汇率</label>
                                         <input type="text" class="form-input" style="width: 60px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none; text-align: right;">
                                    </div>
                                </div>
                            </div>

                             <!-- Expense Table -->
                            <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; background: white;">
                                <table class="statement-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px; text-align: center;">#</th>
                                            <th style="text-align: left;">费用名称</th>
                                            <th style="text-align: left;">费用开票名称</th>
                                            <th style="text-align: center;">单位</th>
                                            <th style="text-align: right;">数量</th>
                                            <th style="text-align: right;">不含税单价</th>
                                            <th style="text-align: right;">不含税金额</th>
                                            <th style="text-align: center;">税率</th>
                                            <th style="text-align: right;">单价税额</th>
                                            <th style="text-align: right;">含税单价</th>
                                            <th style="text-align: right;">含税金额</th>
                                            <th style="text-align: center;">币种</th>
                                            <th style="text-align: left;">说明</th>
                                            <th style="text-align: left;">备注</th>
                                            <th style="text-align: center;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;">1</td>
                                            <td>运输费</td>
                                            <td>*运输服务*货运服务费</td>
                                            <td style="text-align: center;">次</td>
                                            <td style="text-align: right;">1.00</td>
                                            <td style="text-align: right;">1,000.00</td>
                                            <td style="text-align: right;">1,000.00</td>
                                            <td style="text-align: center;">9%</td>
                                            <td style="text-align: right;">90.00</td>
                                            <td style="text-align: right;">1,090.00</td>
                                            <td style="text-align: right;">1,090.00</td>
                                            <td style="text-align: center;">CNY</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td style="text-align: center;"><i data-lucide="trash-2" style="width: 14px; height: 14px; color: #ef4444; cursor: pointer;"></i></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;">2</td>
                                            <td>装卸费</td>
                                            <td>*物流辅助服务*装卸搬运</td>
                                            <td style="text-align: center;">吨</td>
                                            <td style="text-align: right;">10.00</td>
                                            <td style="text-align: right;">50.00</td>
                                            <td style="text-align: right;">500.00</td>
                                            <td style="text-align: center;">6%</td>
                                            <td style="text-align: right;">30.00</td>
                                            <td style="text-align: right;">530.00</td>
                                            <td style="text-align: right;">530.00</td>
                                            <td style="text-align: center;">CNY</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td style="text-align: center;"><i data-lucide="trash-2" style="width: 14px; height: 14px; color: #ef4444; cursor: pointer;"></i></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center;">3</td>
                                            <td>保险费</td>
                                            <td>*金融服务*保险服务</td>
                                            <td style="text-align: center;">项</td>
                                            <td style="text-align: right;">1.00</td>
                                            <td style="text-align: right;">200.00</td>
                                            <td style="text-align: right;">200.00</td>
                                            <td style="text-align: center;">6%</td>
                                            <td style="text-align: right;">12.00</td>
                                            <td style="text-align: right;">212.00</td>
                                            <td style="text-align: right;">212.00</td>
                                            <td style="text-align: center;">CNY</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td style="text-align: center;"><i data-lucide="trash-2" style="width: 14px; height: 14px; color: #ef4444; cursor: pointer;"></i></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Bottom Summaries -->
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; border-top: 1px solid #e2e8f0; padding-top: 12px;">
                                 <div style="font-weight: bold;">原币合计: 1,832.00</div>
                                 <div style="font-weight: bold;">不含税金额合计: 1,700.00</div>
                                 <div style="font-weight: bold;">纳税金额合计: 1,832.00</div>
                                 <div style="font-weight: bold;">税额合计: 132.00</div>
                            </div>

                             <!-- Footer Info -->
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 12px; border-top: 1px solid #e2e8f0; padding-top: 16px;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                     <label style="font-size: 0.8rem; color: #64748b;">备注</label>
                                     <textarea placeholder="请输入" style="width: 100%; height: 60px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px; font-size: 0.8rem; resize: none;"></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                     <div style="display: flex; gap: 24px;">
                                        <div style="display: flex; gap: 8px; font-size: 0.8rem; color: #64748b;">
                                            <span>创建日期</span>
                                            <span style="color: #334155;">2025-12-31</span>
                                        </div>
                                         <div style="display: flex; gap: 8px; font-size: 0.8rem; color: #64748b;">
                                            <span>创建人</span>
                                            <span style="color: #334155;">limquan</span>
                                        </div>
                                    </div>
                                    <!-- 附件上传区域 -->
                                    <div style="margin-top: 8px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <input type="file" id="invoice-attachment-input" multiple accept=".jpg,.jpeg,.png,.pdf,.xls,.xlsx" style="display: none;" onchange="handleInvoiceAttachmentUpload(event)">
                                            <div onclick="document.getElementById('invoice-attachment-input').click()" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: 1px dashed #cbd5e1; border-radius: 4px; cursor: pointer; font-size: 0.8rem; color: #4f46e5; background: #f8fafc; transition: all 0.2s;" onmouseover="this.style.borderColor='#4f46e5'; this.style.background='#eff6ff';" onmouseout="this.style.borderColor='#cbd5e1'; this.style.background='#f8fafc';">
                                                <i data-lucide="paperclip" style="width: 14px; height: 14px;"></i>
                                                附件
                                            </div>
                                            <span style="font-size: 0.75rem; color: #94a3b8;">支持 JPG / Excel / PDF，最大 10MB</span>
                                            <span id="invoice-attachment-count" style="font-size: 0.75rem; color: #64748b;"></span>
                                        </div>
                                        <div id="invoice-attachment-list" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                                    </div>
                                </div>
                             </div>

                        </div>
                        </div>
                    </div>
                </div>
            </div>`;
        } else if (activeTab === '发票管理') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Internal Tabs Row -->
                <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px; display: flex; justify-content: space-between; align-items: center;">
                    <div class="internal-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">
                        <div class="internal-tab active" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">待开票</div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer;">未出票</div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer;">出票中</div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer;">出票失败</div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">已出票<span style="background: #4f46e5; color: white; border-radius: 10px; padding: 0 6px; font-size: 0.7rem;">5</span></div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer; display: flex; align-items: center; gap: 4px;">已红冲<span style="background: #94a3b8; color: white; border-radius: 10px; padding: 0 6px; font-size: 0.7rem;">?</span></div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer;">红字发票</div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer;">作废中</div>
                        <div class="internal-tab" onclick="window.switchInvoiceManagementTab(this)" style="padding: 12px 0; cursor: pointer;">已作废</div>
                    </div>
                    <button class="primary-btn" style="height: 32px; padding: 0 12px; background: #4f46e5; border: none; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                        收款发票 <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>

                <!-- Filter Area -->
                <div class="invoice-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                        <!-- Date range with selector -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 80px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.75rem; cursor: pointer;">
                                <span>工作日期</span>
                                <i data-lucide="chevron-down" style="width: 12px; height: 12px; color: #94a3b8;"></i>
                            </div>
                            <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                                <input type="text" placeholder="开始日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="width: 100px; height: 32px; border: none; font-size: 0.75rem; outline: none;">
                                <i data-lucide="calendar" style="width: 12px; height: 12px; color: #cbd5e1;"></i>
                                <span style="color: #cbd5e1;">-</span>
                                <input type="text" placeholder="结束日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="width: 100px; height: 32px; border: none; font-size: 0.75rem; outline: none;">
                                <i data-lucide="calendar" style="width: 12px; height: 12px; color: #cbd5e1;"></i>
                            </div>
                        </div>

                        <!-- Keyword -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.75rem; color: #475569; font-weight: 500;">关键字</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; width: 220px; height: 32px;">
                                <input type="text" placeholder="请输入结算单位/工作单号" style="border: none; outline: none; flex: 1; font-size: 0.75rem;">
                            </div>
                        </div>

                        <!-- Applicant -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.75rem; color: #475569; font-weight: 500;">申请人</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; width: 120px; height: 32px; background: white; cursor: pointer;">
                                <span style="color: #cbd5e1; font-size: 0.75rem; flex: 1;">请选择</span>
                                <i data-lucide="chevron-down" style="width: 12px; height: 12px; color: #94a3b8;"></i>
                            </div>
                        </div>

                        <!-- Invoice Status -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.75rem; color: #475569; font-weight: 500;">开票状态</label>
                            <select style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.75rem; outline: none; background: white; color: #334155; cursor: pointer;">
                                <option value="">请选择</option>
                                <option value="已出票">已出票</option>
                                <option value="已作废">已作废</option>
                                <option value="作废中">作废中</option>
                                <option value="未出票">未出票</option>
                                <option value="出票中">出票中</option>
                                <option value="出票失败">出票失败</option>
                                <option value="已冲红">已冲红</option>
                                <option value="红字发票">红字发票</option>
                            </select>
                        </div>

                        <!-- Checkbox -->
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem; color: #475569; cursor: pointer;">
                            <input type="checkbox"> 仅显示我创建的
                        </label>
                        
                        <!-- Work No search -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; height: 32px;">
                            <div style="padding: 0 8px; border-right: 1px solid #e2e8f0; font-size: 0.75rem; background: #f8fafc; height: 100%; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                工作单号 <i data-lucide="chevron-down" style="width: 12px; height: 12px; color: #94a3b8;"></i>
                            </div>
                            <input type="text" placeholder="请输入" style="border: none; outline: none; padding: 0 8px; font-size: 0.75rem; width: 120px;">
                        </div>

                        <!-- Contact -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.75rem; color: #475569; font-weight: 500; white-space: nowrap;">客户联系人</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; width: 120px; height: 32px;">
                                <input type="text" placeholder="请输入" style="border: none; outline: none; flex: 1; font-size: 0.75rem;">
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 Buttons -->
                    <div style="display: flex; gap: 8px;">
                        <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                        <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; cursor: pointer;">
                            录入发票
                        </button>
                        <button class="ghost-btn" style="height: 28px; padding: 0 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.75rem; background: white; cursor: pointer;">查看我待处理的</button>
                        <button class="ghost-btn" style="height: 28px; padding: 0 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.75rem; background: white; cursor: pointer;">查看我已处理的</button>
                    </div>
                </div>

                <!-- Table Content Area -->
                <div id="invoice-management-table-container" class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto;">
                    <table class="statement-table" style="min-width: max-content;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;"><input type="checkbox"></th>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>状态</th>
                                <th>发票号</th>
                                <th>发票类型</th>
                                <th>结算单位</th>
                                <th>开票日期</th>
                                <th>币制</th>
                                <th>金额</th>
                                <th>税额</th>
                                <th>价税合计</th>
                                <th>本币金额</th>
                                <th>工作单号</th>
                                <th>账单号</th>
                                <th>录入人</th>
                                <th>录入时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                             <!-- Content rendered via window.renderInvoiceManagementList -->
                        </tbody>
                    </table>
                </div>
            </div>`;
            setTimeout(() => {
                if (window.renderInvoiceManagementList) {
                    window.renderInvoiceManagementList('待开票');
                }
            }, 0);
        } else if (activeTab === '开票费用配置') {
            let rowsHtml = '';
            if (window.invoiceExpenseConfigs && window.invoiceExpenseConfigs.length > 0) {
                rowsHtml = window.invoiceExpenseConfigs.map((config, index) => `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="text-align: center; padding: 10px;">${index + 1}</td>
                        <td style="padding: 10px;">${config.name}</td>
                        <td style="padding: 10px;">${config.taxName} (${config.code})</td>
                        <td style="padding: 10px; text-align: right;">${config.rate}%</td>
                        <td style="padding: 10px; text-align: center;">${config.isTaxFree}</td>
                        <td style="padding: 10px; text-align: center;">
                            <i data-lucide="trash-2" onclick="deleteInvoiceExpenseConfig(${index})" style="width: 16px; height: 16px; color: #ef4444; cursor: pointer;"></i>
                        </td>
                    </tr>
                `).join('');
            } else {
                rowsHtml = `
                    <tr>
                        <td colspan="6" style="height: 300px; text-align: center; color: #94a3b8; vertical-align: middle;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                 <div style="width: 64px; height: 64px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="search" style="width: 32px; height: 32px; color: #cbd5e1;"></i>
                                 </div>
                                 <span>暂无数据</span>
                            </div>
                        </td>
                    </tr>`;
            }

            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Top Action Bar -->
                     <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 12px 24px; display: flex; justify-content: flex-end; align-items: center;">
                         <button class="primary-btn" onclick="showInvoiceExpenseModal()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.85rem; cursor: pointer;">
                            <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> 新增
                        </button>
                    </div>

                    <!-- Table -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #fff; padding: 0;">
                         <table class="statement-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                    <th style="width: 40px; text-align: center; padding: 10px;">#</th>
                                    <th style="padding: 10px; text-align: left;">货物或应税劳务、服务名称</th>
                                    <th style="padding: 10px; text-align: left;">税收分类</th>
                                    <th style="padding: 10px; text-align: right;">税率</th>
                                    <th style="padding: 10px; text-align: center;">是否免税</th>
                                    <th style="padding: 10px; text-align: center;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                 ${rowsHtml}
                            </tbody>
                         </table>
                    </div>
                </div>`;
        } else if (activeTab === '红字申请确认单') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                     <!-- Status Tabs -->
                    <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px;">
                        <div class="internal-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">
                            <div class="internal-tab active" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">待冲红</div>
                            <div class="internal-tab" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; cursor: pointer;">待购方确认</div>
                            <div class="internal-tab" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; cursor: pointer;">待销方确认</div>
                            <div class="internal-tab" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; cursor: pointer;">申请中</div>
                            <div class="internal-tab" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; cursor: pointer;">申请失败</div>
                            <div class="internal-tab" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; cursor: pointer;">作废</div>
                            <div class="internal-tab" onclick="window.switchRedLetterTab(this)" style="padding: 12px 0; cursor: pointer;">已冲红</div>
                        </div>
                    </div>

                    <!-- Filter Area -->
                    <div class="bill-filter-area" style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                         <!-- Application Time -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">申请时间</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                <input type="text" placeholder="开始日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="width: 105px; height: 32px; border: none; font-size: 0.8rem; outline: none; padding-left: 8px;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                                <span style="color: #cbd5e1; padding: 0 4px;">-</span>
                                <input type="text" placeholder="结束日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="width: 105px; height: 32px; border: none; font-size: 0.8rem; outline: none;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1; padding-right: 8px;"></i>
                            </div>
                        </div>

                        <!-- Invoice Type -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">发票类型</label>
                            <div class="relative-container">
                                <select id="red-letter-invoice-type" style="width: 150px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                    <option value="">全部</option>
                                    <option value="normal">普通发票</option>
                                    <option value="vat_special">增值税专用发票</option>
                                </select>
                            </div>
                        </div>

                         <!-- Invoice Medium -->
                         <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">发票介质</label>
                            <div class="relative-container">
                                <select id="red-letter-invoice-medium" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                    <option value="">全部</option>
                                    <option value="paper">纸质发票</option>
                                    <option value="electronic">电子发票</option>
                                </select>
                            </div>
                        </div>

                         <!-- Search Input -->
                        <div style="display: flex; align-items: center;">
                            <input type="text" placeholder="请输入购买方名称/蓝字发票号码" style="width: 240px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                         <!-- Applicant -->
                         <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">申请人</label>
                            <div class="relative-container">
                                <select id="red-letter-applicant" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                    <option value="">请选择</option>
                                    <option value="张三">张三</option>
                                    <option value="李四">李四</option>
                                    <option value="王五">王五</option>
                                    <option value="赵六">赵六</option>
                                    <option value="陈七">陈七</option>
                                </select>
                            </div>
                        </div>

                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                    </div>

                    <!-- Table -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #fff; padding: 0; overflow: auto;">
                         <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>信息表编码</th>
                                    <th>蓝字发票号码</th>
                                    <th>购方名称</th>
                                    <th>购方税号</th>
                                    <th>发票类型</th>
                                    <th>发票介质</th>
                                    <th>申请人</th>
                                    <th>申请时间</th>
                                    <th>撤销人</th>
                                    <th>撤销发起时间</th>
                                    <th>撤销成功时间</th>
                                    <th>所属公司</th>
                                    <th>描述</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                 <tr>
                                    <td colspan="14" style="height: 300px; text-align: center; color: #94a3b8; vertical-align: middle;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                             <div style="width: 64px; height: 64px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i data-lucide="search" style="width: 32px; height: 32px; color: #cbd5e1;"></i>
                                             </div>
                                             <span>暂无数据</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div>`;
        } else if (activeTab === '结算单位') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Filter Area -->
                    <div class="bill-filter-area" style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
                         <!-- Settlement Unit Search -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">结算单位</label>
                            <div style="position: relative; width: 200px;">
                                <input type="text" placeholder="请输入" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 32px 0 12px; font-size: 0.8rem; outline: none;">
                                <i data-lucide="search" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>

                        <!-- Nature -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">性质</label>
                            <div class="relative-container">
                                <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white;" onclick="window.toggleDropdown(this); event.stopPropagation();">
                                    <span id="settlement-unit-nature-selected" style="color: #334155; font-size: 0.8rem;">全部</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; z-index: 50;">
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '全部'); event.stopPropagation();">全部</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '客户'); event.stopPropagation();">客户</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '供应商'); event.stopPropagation();">供应商</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '公司'); event.stopPropagation();">公司</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '部门'); event.stopPropagation();">部门</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '员工'); event.stopPropagation();">员工</div>
                                    <div class="dropdown-item-custom" style="padding: 8px 12px; font-size: 0.75rem;" onclick="window.selectOption('settlement-unit-nature-selected', '司机'); event.stopPropagation();">司机</div>
                                </div>
                            </div>
                        </div>

                         <!-- Type -->
                         <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">类型</label>
                            <div style="display: flex; gap: 12px; align-items: center; font-size: 0.8rem; color: #334155;">
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="radio" name="unit-type" checked style="accent-color: #4f46e5;"> 全部
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="radio" name="unit-type" style="accent-color: #4f46e5;"> 外部
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="radio" name="unit-type" style="accent-color: #4f46e5;"> 内部
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #fff; padding: 0; overflow: auto;">
                         <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>结算单位</th>
                                    <th>名称(英)</th>
                                    <th>所属公司</th>
                                    <th>类型</th>
                                    <th>性质</th>
                                    <th>关联结算单位</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bank-payment-tbody">
                                 <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px; color: #334155;">深圳市远通物流有限公司</td>
                                    <td style="padding: 12px; color: #64748b;">SHENZHEN YUANTONG LOGISTICS CO., LTD</td>
                                    <td style="padding: 12px; color: #64748b;">丰华物流</td>
                                    <td style="padding: 12px; color: #64748b;">外部</td>
                                    <td style="padding: 12px; color: #64748b;">企业</td>
                                    <td style="padding: 12px; color: #64748b;">-</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">编辑</a>
                                        <a href="#" style="color: #ef4444;">删除</a>
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f1f5f9; background-color: #f8fafc;">
                                    <td style="padding: 12px; color: #334155;">广州快运达货运代理有限公司</td>
                                    <td style="padding: 12px; color: #64748b;">GUANGZHOU FAST FREIGHT AGENCY CO., LTD</td>
                                    <td style="padding: 12px; color: #64748b;">丰华物流</td>
                                    <td style="padding: 12px; color: #64748b;">外部</td>
                                    <td style="padding: 12px; color: #64748b;">企业</td>
                                    <td style="padding: 12px; color: #64748b;">-</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">编辑</a>
                                        <a href="#" style="color: #ef4444;">删除</a>
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px; color: #334155;">内部结算中心</td>
                                    <td style="padding: 12px; color: #64748b;">INTERNAL SETTLEMENT CENTER</td>
                                    <td style="padding: 12px; color: #64748b;">丰华物流</td>
                                    <td style="padding: 12px; color: #64748b;">内部</td>
                                    <td style="padding: 12px; color: #64748b;">部门</td>
                                    <td style="padding: 12px; color: #64748b;">-</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">编辑</a>
                                        <a href="#" style="color: #ef4444;">删除</a>
                                    </td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div>`;
        } else if (activeTab === '银行收款流水') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Top Bar: Status Tabs & Actions -->
                    <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <!-- Status Tabs -->
                        <div class="internal-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">
                            <div class="internal-tab active" onclick="window.switchBankReceiptTab(this)" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">销账待确认</div>
                            <div class="internal-tab" onclick="window.switchBankReceiptTab(this)" style="padding: 12px 0; cursor: pointer;">待认领</div>
                            <div class="internal-tab" onclick="window.switchBankReceiptTab(this)" style="padding: 12px 0; cursor: pointer;">已销账</div>
                            <div class="internal-tab" onclick="window.switchBankReceiptTab(this)" style="padding: 12px 0; cursor: pointer;">其他</div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; padding-bottom: 8px;">
                            <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer;">
                                下载流水
                            </button>
                            <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer;">
                                导入
                            </button>
                        </div>
                    </div>
                    <div class="bill-filter-area" style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                         <!-- Keyword Input -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">关键字</label>
                            <input type="text" placeholder="付款方户名/付款银行账号/摘要/流水号" style="width: 260px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                        <!-- Receiving Account -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">收款账户</label>
                            <div class="relative-container">
                                <select id="bank-receipt-account" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                    <option value="">请选择</option>
                                    <option value="icbc">中国工商银行 6222****0001</option>
                                    <option value="cmb">招商银行 6225****0002</option>
                                    <option value="boc">中国银行 6217****0003</option>
                                </select>
                            </div>
                        </div>

                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                    </div>

                    <!-- Table -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #fff; padding: 0; overflow: auto;">
                         <table class="statement-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>收款户名</th>
                                    <th>收款支行</th>
                                    <th>收款银行账号</th>
                                    <th>币制</th>
                                    <th>银行流水号</th>
                                    <th>收款金额</th>
                                    <th>收款时间</th>
                                    <th>付款方户名</th>
                                    <th>结算单位</th>
                                    <th>付款银行账号</th>
                                    <th>付款摘要</th>
                                    <th>匹配单号</th>
                                    <th>电子回执</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bank-receipt-tbody">
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px; text-align: center; color: #64748b;">1</td>
                                    <td style="padding: 12px; color: #334155;">深圳市远通物流有限公司</td>
                                    <td style="padding: 12px; color: #64748b;">招商银行深圳分行</td>
                                    <td style="padding: 12px; color: #64748b;">755912345678901</td>
                                    <td style="padding: 12px; color: #64748b;">CNY</td>
                                    <td style="padding: 12px; color: #64748b;">202512270001</td>
                                    <td style="padding: 12px; color: #334155; font-weight: 500;">50,000.00</td>
                                    <td style="padding: 12px; color: #64748b;">2025-12-27 10:30</td>
                                    <td style="padding: 12px; color: #64748b;">ABC TRADING LTD</td>
                                    <td style="padding: 12px; color: #64748b;">总公司</td>
                                    <td style="padding: 12px; color: #64748b;">6222021234567890</td>
                                    <td style="padding: 12px; color: #64748b;">货款</td>
                                    <td style="padding: 12px; color: #64748b;">ORDER-001</td>
                                    <td style="padding: 12px; color: #64748b;">已生成</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                                        <a href="#" style="color: #4f46e5;">认领</a>
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f1f5f9; background-color: #f8fafc;">
                                    <td style="padding: 12px; text-align: center; color: #64748b;">2</td>
                                    <td style="padding: 12px; color: #334155;">广州快运达货运代理有限公司</td>
                                    <td style="padding: 12px; color: #64748b;">中国银行广州分行</td>
                                    <td style="padding: 12px; color: #64748b;">621234567890123</td>
                                    <td style="padding: 12px; color: #64748b;">USD</td>
                                    <td style="padding: 12px; color: #64748b;">202512270002</td>
                                    <td style="padding: 12px; color: #334155; font-weight: 500;">10,000.00</td>
                                    <td style="padding: 12px; color: #64748b;">2025-12-27 11:15</td>
                                    <td style="padding: 12px; color: #64748b;">XYZ LOGISTICS INC</td>
                                    <td style="padding: 12px; color: #64748b;">广州分公司</td>
                                    <td style="padding: 12px; color: #64748b;">4567890123456789</td>
                                    <td style="padding: 12px; color: #64748b;">运费</td>
                                    <td style="padding: 12px; color: #64748b;">-</td>
                                    <td style="padding: 12px; color: #64748b;">-</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                                        <a href="#" style="color: #4f46e5;">认领</a>
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px; text-align: center; color: #64748b;">3</td>
                                    <td style="padding: 12px; color: #334155;">深圳市远通物流有限公司</td>
                                    <td style="padding: 12px; color: #64748b;">工商银行深圳分行</td>
                                    <td style="padding: 12px; color: #64748b;">955880123456789</td>
                                    <td style="padding: 12px; color: #64748b;">CNY</td>
                                    <td style="padding: 12px; color: #64748b;">202512270003</td>
                                    <td style="padding: 12px; color: #334155; font-weight: 500;">2,500.00</td>
                                    <td style="padding: 12px; color: #64748b;">2025-12-27 14:00</td>
                                    <td style="padding: 12px; color: #64748b;">GLOBAL TRADERS</td>
                                    <td style="padding: 12px; color: #64748b;">总公司</td>
                                    <td style="padding: 12px; color: #64748b;">1234567890123456</td>
                                    <td style="padding: 12px; color: #64748b;">服务费</td>
                                    <td style="padding: 12px; color: #64748b;">ORDER-002</td>
                                    <td style="padding: 12px; color: #64748b;">已生成</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                                        <a href="#" style="color: #4f46e5;">认领</a>
                                    </td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div>`;
        } else if (activeTab === '银行付款流水') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Top Bar: Status Tabs & Actions -->
                    <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <!-- Status Tabs -->
                        <div class="internal-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">
                            <div class="internal-tab active" onclick="window.switchBankPaymentTab(this)" style="padding: 12px 0; border-bottom: 2px solid #ef4444; color: #ef4444; font-weight: 500; cursor: pointer;">待提交</div>
                            <div class="internal-tab" onclick="window.switchBankPaymentTab(this)" style="padding: 12px 0; cursor: pointer;">付款处理中</div>
                            <div class="internal-tab" onclick="window.switchBankPaymentTab(this)" style="padding: 12px 0; cursor: pointer;">已付款</div>
                            <div class="internal-tab" onclick="window.switchBankPaymentTab(this)" style="padding: 12px 0; cursor: pointer;">已核销</div>
                            <div class="internal-tab" onclick="window.switchBankPaymentTab(this)" style="padding: 12px 0; cursor: pointer;">其他</div>
                        </div>
                        
                         <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; padding-bottom: 8px;">
                            <button class="action-btn" style="height: 32px; padding: 0 16px; background: #ef4444; color: white; border: none; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer;">
                                删除
                            </button>
                             <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer;">
                                导入
                            </button>
                            <button class="primary-btn" onclick="window.submitBankPayment()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer;">
                                提交付款
                            </button>
                        </div>
                    </div>

                    <!-- Filter Area -->
                    <div class="bill-filter-area" style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                         <!-- Keyword Input -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                             <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">关键字</label>
                            <input type="text" placeholder="收款方户名/收款银行账号" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                        <!-- Currency -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">币制</label>
                            <div class="relative-container">
                                <select id="bank-payment-currency" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                    <option value="">请选择</option>
                                    <option value="CNY">CNY</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="HKD">HKD</option>
                                    <option value="JPY">JPY</option>
                                </select>
                            </div>
                        </div>

                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                    </div>

                    <!-- Table -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #fff; padding: 0; overflow: auto;">
                         <table class="statement-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox" onclick="window.toggleAllBankPaymentCheckboxes(this)"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>付款申请单号</th>
                                    <th>付款申请人</th>
                                    <th>结算单位</th>
                                    <th>收款方户名</th>
                                    <th>对方收款支行</th>
                                    <th>币制</th>
                                    <th>付款金额</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bank-payment-tbody">
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px; text-align: center;"><input type="checkbox"></td>
                                    <td style="padding: 12px; text-align: center; color: #64748b;">1</td>
                                    <td style="padding: 12px; color: #334155;">PAY-20251227-001</td>
                                    <td style="padding: 12px; color: #64748b;">张三</td>
                                    <td style="padding: 12px; color: #64748b;">总公司</td>
                                    <td style="padding: 12px; color: #334155;">深圳市供应商A有限公司</td>
                                    <td style="padding: 12px; color: #64748b;">建设银行深圳分行</td>
                                    <td style="padding: 12px; color: #64748b;">CNY</td>
                                    <td style="padding: 12px; color: #334155; font-weight: 500;">12,000.00</td>
                                    <td style="padding: 12px; color: #64748b;">采购款</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                                        <a href="#" style="color: #ef4444;">删除</a>
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f1f5f9; background-color: #f8fafc;">
                                    <td style="padding: 12px; text-align: center;"><input type="checkbox"></td>
                                    <td style="padding: 12px; text-align: center; color: #64748b;">2</td>
                                    <td style="padding: 12px; color: #334155;">PAY-20251227-002</td>
                                    <td style="padding: 12px; color: #64748b;">李四</td>
                                    <td style="padding: 12px; color: #64748b;">广州分公司</td>
                                    <td style="padding: 12px; color: #334155;">GLOBAL COMMERCE INC</td>
                                    <td style="padding: 12px; color: #64748b;">HSBC HK</td>
                                    <td style="padding: 12px; color: #64748b;">USD</td>
                                    <td style="padding: 12px; color: #334155; font-weight: 500;">5,000.00</td>
                                    <td style="padding: 12px; color: #64748b;">Service Fee</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                                        <a href="#" style="color: #ef4444;">删除</a>
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px; text-align: center;"><input type="checkbox"></td>
                                    <td style="padding: 12px; color: #64748b;">3</td>
                                    <td style="padding: 12px; color: #334155;">PAY-20251227-003</td>
                                    <td style="padding: 12px; color: #64748b;">王五</td>
                                    <td style="padding: 12px; color: #64748b;">总公司</td>
                                    <td style="padding: 12px; color: #334155;">上海物流合作伙伴</td>
                                    <td style="padding: 12px; color: #64748b;">农业银行上海分行</td>
                                    <td style="padding: 12px; color: #64748b;">CNY</td>
                                    <td style="padding: 12px; color: #334155; font-weight: 500;">3,500.00</td>
                                    <td style="padding: 12px; color: #64748b;">运费补贴</td>
                                    <td style="padding: 12px;">
                                        <a href="#" style="color: #4f46e5; margin-right: 8px;">详情</a>
                                        <a href="#" style="color: #ef4444;">删除</a>
                                    </td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div>`;
        } else if (activeTab === '银企直连配置') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Top Status Tabs -->
                    <div style="width: 100%; border-bottom: 1px solid #e2e8f0; background: white; padding: 0 24px;">
                        <div class="internal-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">
                            <div id="tab-bank-account" class="internal-tab active" onclick="toggleBankConfigTab('account')" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">银行账户</div>
                            <div id="tab-params-config" class="internal-tab" onclick="toggleBankConfigTab('params')" style="padding: 12px 0; cursor: pointer;">参数配置</div>
                        </div>
                    </div>

                    <!-- View: Bank Account -->
                    <div id="bank-account-view" style="display: flex; flex-direction: column; flex-grow: 1;">
                        <!-- Filter Area -->
                        <div class="bill-filter-area" style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                 <!-- Keyword Input -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                     <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">关键字</label>
                                    <input type="text" placeholder="银行账户/账户名称/开户支行" style="width: 280px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                                </div>

                                <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                                    <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                                </button>
                            </div>
                            
                            <a href="#" style="font-size: 0.8rem; color: #4f46e5; text-decoration: none;">怎样开通银企直连？</a>
                        </div>

                        <!-- Table -->
                        <div class="statement-table-container" style="flex-grow: 1; background: #fff; padding: 0; overflow: auto;">
                             <table class="statement-table">
                                <thead>
                                    <tr>
                                        <th>开户行名称</th>
                                        <th>账户名称</th>
                                        <th>银行账户</th>
                                        <th>币制</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                     <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 12px; color: #334155;">微信</td>
                                        <td style="padding: 12px; color: #334155;">深圳运输云物流科技有限公司A</td>
                                        <td style="padding: 12px; color: #334155;">342546578687980</td>
                                        <td style="padding: 12px; color: #64748b;">USD</td>
                                        <td style="padding: 12px; color: #64748b; display: flex; align-items: center; gap: 6px;">
                                            <div style="width: 6px; height: 6px; border-radius: 50%; background-color: #4f46e5;"></div> 未激活
                                        </td>
                                        <td style="padding: 12px;">
                                            <a href="#" style="color: #4f46e5;">激活</a>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f1f5f9; background-color: #f8fafc;">
                                        <td style="padding: 12px; color: #334155;">招商银行</td>
                                        <td style="padding: 12px; color: #334155;">深圳运输云物流科技有限公司A</td>
                                        <td style="padding: 12px; color: #334155;">31425465782423</td>
                                        <td style="padding: 12px; color: #64748b;">CNY</td>
                                        <td style="padding: 12px; color: #64748b; display: flex; align-items: center; gap: 6px;">
                                            <div style="width: 6px; height: 6px; border-radius: 50%; background-color: #4f46e5;"></div> 未激活
                                        </td>
                                        <td style="padding: 12px;">
                                            <a href="#" style="color: #4f46e5;">激活</a>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 12px; color: #334155;">招商银行</td>
                                        <td style="padding: 12px; color: #334155;">深圳运输云物流科技有限公司A</td>
                                        <td style="padding: 12px; color: #334155;">12423546789809</td>
                                        <td style="padding: 12px; color: #64748b;">USD</td>
                                        <td style="padding: 12px; color: #64748b; display: flex; align-items: center; gap: 6px;">
                                            <div style="width: 6px; height: 6px; border-radius: 50%; background-color: #4f46e5;"></div> 未激活
                                        </td>
                                        <td style="padding: 12px;">
                                            <a href="#" style="color: #4f46e5;">激活</a>
                                        </td>
                                    </tr>
                                </tbody>
                             </table>
                        </div>
                    </div>

                    <!-- View: Parameter Config -->
                    <div id="parameter-config-view" style="display: none; padding: 24px; flex-direction: column; gap: 20px; max-width: 800px;">
                        
                        <div style="display: flex; align-items: center;">
                            <label style="width: 100px; text-align: right; padding-right: 16px; font-size: 0.9rem; color: #334155; font-weight: bold;"><span style="color: #ef4444;">* </span>客户号</label>
                            <input type="text" placeholder="请输入" style="flex: 1; height: 36px; background-color: #ffe4e6; border: 1px solid #fda4af; border-radius: 4px; padding: 0 12px; outline: none;">
                        </div>

                        <div style="display: flex; align-items: flex-start;">
                            <label style="width: 100px; text-align: right; padding-right: 16px; font-size: 0.9rem; color: #334155; font-weight: bold; margin-top: 8px;"><span style="color: #ef4444;">* </span>私钥</label>
                            <textarea placeholder="请输入" style="flex: 1; height: 120px; background-color: #ffe4e6; border: 1px solid #fda4af; border-radius: 4px; padding: 12px; outline: none; resize: vertical;"></textarea>
                        </div>

                        <div style="display: flex; align-items: center;">
                            <label style="width: 100px; text-align: right; padding-right: 16px; font-size: 0.9rem; color: #334155; font-weight: bold;"><span style="color: #ef4444;">* </span>appkey</label>
                            <input type="text" placeholder="请输入" style="flex: 1; height: 36px; background-color: #ffe4e6; border: 1px solid #fda4af; border-radius: 4px; padding: 0 12px; outline: none;">
                        </div>

                        <div style="display: flex; align-items: center;">
                            <label style="width: 100px; text-align: right; padding-right: 16px; font-size: 0.9rem; color: #334155; font-weight: bold;"><span style="color: #ef4444;">* </span>单位代码</label>
                            <input type="text" placeholder="请输入" style="flex: 1; height: 36px; background-color: #ffe4e6; border: 1px solid #fda4af; border-radius: 4px; padding: 0 12px; outline: none;">
                        </div>

                        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                            <button style="display: flex; align-items: center; gap: 6px; background-color: #4f46e5; color: white; padding: 8px 24px; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">
                                <i data-lucide="save" style="width: 16px; height: 16px;"></i> 保存
                            </button>
                        </div>

                    </div>
                </div>
                `;





        } else if (activeTab === '费用单') {
            document.querySelector('.page-content').innerHTML = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- 顶部过滤栏 -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: white;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569;">工作单日期</label>
                            <input type="date" placeholder="开始日期" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b;">
                            <span style="color: #94a3b8;">-</span>
                            <input type="date" placeholder="结束日期" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569;">结算单位</label>
                            <select style="height: 32px; width: 140px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                <option value="">请选择</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569;">费用单号</label>
                            <input type="text" placeholder="请输入" style="height: 32px; width: 140px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569;">付款状态</label>
                            <select style="height: 32px; width: 100px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                <option value="">全部</option>
                                <option value="">待付款</option>
                                <option value="">已付款</option>
                                <option value="">部分付款</option>
                            </select>
                        </div>
                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem; margin-right: 12px;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>
                        <div style="flex-grow: 1;"></div>
                        <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; color: #3b82f6; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                            <i data-lucide="upload" style="width: 14px; height: 14px;"></i> 导入
                        </button>
                        <button class="primary-btn" onclick="addTab('新增费用申请')" style="height: 32px; padding: 0 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                            <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> 新增
                        </button>
                    </div>
                    
                    <!-- 表格区域 -->
                    <div style="flex: 1; overflow: auto; background: white;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox"></th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #64748b; font-weight: 500;">#</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">费用单号</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">工作单日期</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">结算单位</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">用途</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">关联账户</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">关联工作单</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; color: #64748b; font-weight: 500;">金额</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">付款状态</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">核销单号</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">发票号码</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">费用申请单号</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">对账单号</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">创建人</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">创建时间</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">修改人</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">修改时间</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #64748b; font-weight: 500;">操作 <i data-lucide="settings" style="width: 12px; height: 12px; display: inline-block;"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="19" style="padding: 120px 0; text-align: center; color: #94a3b8;">
                                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
                                            <img src="https://img.icons8.com/ios/100/94a3b8/search--v1.png" style="width: 48px; opacity: 0.3; margin-bottom: 4px;">
                                            <span style="font-size: 0.85rem;">暂无数据</span>
                                            <span style="font-size: 0.7rem; color: #cbd5e1; transform: scale(0.9);">No data</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 底部统计与分页 -->
                    <div style="padding: 12px 24px; border-top: 1px solid #e2e8f0; background: white; display: flex; flex-direction: column; gap: 8px;">
                        <div style="font-size: 0.8rem; color: #334155; font-weight: 500;">
                            <span>合计：</span>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 0.8rem; color: #475569;">批量操作:</span>
                                <button style="height: 26px; padding: 0 10px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.8rem; color: #475569; cursor: pointer;">批量删除</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 0.8rem; color: #475569;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i data-lucide="chevrons-left" style="width: 16px; height: 16px; color: #cbd5e1; cursor: not-allowed;"></i>
                                    <i data-lucide="chevron-left" style="width: 16px; height: 16px; color: #cbd5e1; cursor: not-allowed;"></i>
                                    <span style="color: #3b82f6; font-weight: 500; padding: 0 4px;">1</span>
                                    <i data-lucide="chevron-right" style="width: 16px; height: 16px; color: #cbd5e1; cursor: not-allowed;"></i>
                                    <i data-lucide="chevrons-right" style="width: 16px; height: 16px; color: #cbd5e1; cursor: not-allowed;"></i>
                                </div>
                                <select style="border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 4px; font-size: 0.8rem; background: white; height: 26px;">
                                    <option>100条/页</option>
                                </select>
                                <span>前往 <input type="text" value="1" style="width: 32px; height: 26px; text-align: center; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 4px;"> 页</span>
                                <span>共 0 条记录</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) {
                window.lucide.createIcons();
            }
        } else if (activeTab === '费用申请') {
            document.querySelector('.page-content').innerHTML = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- 顶部二级标签页栏 -->
                    <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; padding: 0 24px;">
                        <div style="display: flex; align-items: center; gap: 24px;" id="expense-sub-tabs">
                            <div class="expense-sub-tab active" style="padding: 12px 0; color: #3b82f6; font-size: 0.9rem; font-weight: 500; border-bottom: 2px solid #3b82f6; cursor: pointer;">全部</div>
                            <div class="expense-sub-tab" style="padding: 12px 0; color: #64748b; font-size: 0.9rem; cursor: pointer;">草稿/退回</div>
                            <div class="expense-sub-tab" style="padding: 12px 0; color: #64748b; font-size: 0.9rem; cursor: pointer;">审核中</div>
                            <div class="expense-sub-tab" style="padding: 12px 0; color: #64748b; font-size: 0.9rem; cursor: pointer;">已批准</div>
                            <div class="expense-sub-tab" style="padding: 12px 0; color: #64748b; font-size: 0.9rem; cursor: pointer;">部分核销</div>
                            <div class="expense-sub-tab" style="padding: 12px 0; color: #64748b; font-size: 0.9rem; cursor: pointer;">已核销</div>
                            <div class="expense-sub-tab" style="padding: 12px 0; color: #64748b; font-size: 0.9rem; cursor: pointer;">已驳回/已取消</div>
                        </div>
                        <button onclick="if(window.addTab) window.addTab('新增费用申请');" style="height: 32px; padding: 0 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> 新增
                        </button>
                    </div>

                    <!-- 过滤条件区域 -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px; background: white;">
                        <!-- 第一行搜索条件 -->
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">申请日期</label>
                                <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; background: white; padding: 0 4px;">
                                    <input type="text" placeholder="开始日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="height: 28px; width: 110px; border: none; padding: 0 4px; font-size: 0.85rem; color: #64748b; outline: none; background: transparent; cursor: pointer;">
                                    <span style="color: #e2e8f0; margin: 0 4px;">|</span>
                                    <input type="text" placeholder="结束日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="height: 28px; width: 110px; border: none; padding: 0 4px; font-size: 0.85rem; color: #64748b; outline: none; background: transparent; cursor: pointer;">
                                </div>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">关键字</label>
                                <input type="text" placeholder="请输入结算单位/申请单号" style="height: 30px; width: 180px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">申请人</label>
                                <select style="height: 30px; width: 100px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                    <option>请选择</option>
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">单据状态</label>
                                <select style="height: 30px; width: 100px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                    <option value="">请选择</option>
                                    <option value="草稿">草稿</option>
                                    <option value="审核中">审核中</option>
                                    <option value="已撤回">已撤回</option>
                                    <option value="已驳回">已驳回</option>
                                    <option value="已批准">已批准</option>
                                    <option value="已核销">已核销</option>
                                    <option value="部分核销">部分核销</option>
                                    <option value="已取消">已取消</option>
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">水单状态</label>
                                <select style="height: 30px; width: 80px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                    <option>全部</option>
                                    <option>未上传</option>
                                    <option>已上传</option>
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">发票附件状态</label>
                                <select style="height: 30px; width: 80px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                    <option>全部</option>
                                    <option>未上传</option>
                                    <option>已上传</option>
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">开票方式</label>
                                <select style="height: 30px; width: 100px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; color: #64748b; background: white;">
                                    <option>请选择</option>
                                    <option>先付后票</option>
                                    <option>先票后付</option>
                                    <option>不开票</option>
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">费用单号</label>
                                <input type="text" placeholder="请输入" style="height: 30px; width: 120px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                            </div>
                            
                        </div>

                        <!-- 第二行操作条件 -->
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #475569;">
                                <input type="checkbox" id="chk-wait-handle" style="margin: 0;">
                                <label for="chk-wait-handle" style="cursor: pointer;">仅看需待我处理的</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #475569;">
                                <input type="checkbox" id="chk-handled" style="margin: 0;">
                                <label for="chk-handled" style="cursor: pointer;">仅看我已处理的</label>
                            </div>
                            
                            <button class="primary-btn" style="height: 30px; padding: 0 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                                <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                            </button>
                            <button class="primary-btn" style="height: 30px; padding: 0 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                                付款发票
                            </button>
                        </div>
                    </div>
                    
                    <!-- 表格区域 -->
                    <div style="flex: 1; overflow: auto; background: white; position: relative;">
                        <!-- 右上角小图标 -->
                        <div style="position: absolute; right: 8px; top: 8px; display: flex; gap: 8px; z-index: 2;">
                            <i data-lucide="download" style="width: 16px; height: 16px; color: #94a3b8; cursor: pointer;"></i>
                            <i data-lucide="settings" style="width: 16px; height: 16px; color: #94a3b8; cursor: pointer;"></i>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap;">
                            <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox"></th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #64748b; font-weight: 500;">#</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">付款申请单号</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">单据状态</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">付款水单附件</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">水单上传时间</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">发票附件状态</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">发票上传时间</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">结算单位</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">开票方式</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">申请日期</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">应支付日期</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; color: #64748b; font-weight: 500;">申请金额</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; color: #64748b; font-weight: 500;">费用金额</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; color: #64748b; font-weight: 500;">已核销金额</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; color: #64748b; font-weight: 500;">未销金额</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; color: #64748b; font-weight: 500;">折合金额</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; color: #64748b; font-weight: 500;">申请人</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #64748b; font-weight: 500; min-width: 120px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="19" style="padding: 120px 0; text-align: center; color: #94a3b8;">
                                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
                                            <div style="position: relative;">
                                                <i data-lucide="search" style="width: 32px; height: 32px; color: #e2e8f0;"></i>
                                                <div style="position: absolute; bottom: 0; right: -12px; font-size: 0.6rem; color: #cbd5e1; background: white; padding: 2px;">No Data</div>
                                            </div>
                                            <span style="font-size: 0.85rem; color: #94a3b8;">暂无数据</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 底部统计与分页 -->
                    <div style="padding: 12px 24px; border-top: 1px solid #e2e8f0; background: white; display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; gap: 16px; font-size: 0.8rem; color: #475569;">
                                <span>合计: </span>
                                <span>折合金额: 0.00</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 0.8rem; color: #475569;">
                                <select style="border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 4px; font-size: 0.8rem; background: white; height: 26px; color: #64748b;">
                                    <option>100条/页</option>
                                </select>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i data-lucide="chevrons-left" style="width: 14px; height: 14px; color: #cbd5e1; cursor: not-allowed;"></i>
                                    <i data-lucide="chevron-left" style="width: 14px; height: 14px; color: #cbd5e1; cursor: not-allowed;"></i>
                                    <span style="color: #3b82f6; font-weight: 500; padding: 0 4px;">1</span>
                                    <i data-lucide="chevron-right" style="width: 14px; height: 14px; color: #cbd5e1; cursor: not-allowed;"></i>
                                    <i data-lucide="chevrons-right" style="width: 14px; height: 14px; color: #cbd5e1; cursor: not-allowed;"></i>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span>前往 <input type="text" value="1" style="width: 24px; height: 24px; text-align: center; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0;"> 页</span>
                                </div>
                                <span>共 0 条记录</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) {
                window.lucide.createIcons();
            }

            // 绑定子标签切换事件
            const subTabs = document.querySelectorAll('#expense-sub-tabs .expense-sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    subTabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.color = '#64748b';
                        t.style.fontWeight = 'normal';
                        t.style.borderBottom = 'none';
                    });
                    this.classList.add('active');
                    this.style.color = '#3b82f6';
                    this.style.fontWeight = '500';
                    this.style.borderBottom = '2px solid #3b82f6';
                });
            });
        } else if (activeTab === '新增费用申请') {
            document.querySelector('.page-content').innerHTML = `
                <div class="expense-apply-detail" style="height: 100%; width: 100%; display: flex; flex-direction: column; background: #f1f5f9; overflow: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- 顶部操作栏 -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                        <div style="font-size: 0.85rem; color: #64748b;">单号：自动生成</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem;">
                                <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> 新增
                            </button>
                            <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem;">
                                <i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存
                            </button>
                            <button onclick="closeTab('新增费用申请')" style="height: 28px; padding: 0 12px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; color: #64748b; font-size: 0.8rem;">返回</button>
                        </div>
                    </div>

                    <!-- 选项卡导航 -->
                    <div style="background: white; padding: 0 24px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 32px; flex-shrink: 0;">
                        <div style="padding: 12px 0; border-bottom: 2px solid #3b82f6; color: #3b82f6; font-size: 0.85rem; font-weight: 500; cursor: pointer;">基本信息</div>
                        <div style="padding: 12px 0; color: #64748b; font-size: 0.85rem; cursor: pointer;">电子文档</div>
                    </div>

                    <div style="flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 16px;">
                        <!-- 基本信息板块 -->
                        <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 6px;">
                                <div style="width: 4px; height: 16px; background: #3b82f6; border-radius: 2px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 600; color: #1e293b;">基本信息</span>
                            </div>
                            <div style="padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px 40px; font-size: 0.8rem;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 85px; text-align: right;"><span style="color: #ef4444;">*</span> 结算单位</label>
                                    <select style="flex: 1; height: 32px; border: 1px solid #fecaca; background: #fef2f2; border-radius: 4px; padding: 0 8px; color: #94a3b8;">
                                        <option>请选择</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 85px; text-align: right;"><span style="color: #ef4444;">*</span> 工作单日期</label>
                                    <div style="flex: 1; position: relative; display: flex; align-items: center;">
                                        <input type="text" value="2026-02-25" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 32px 0 8px; color: #475569;">
                                        <i data-lucide="calendar" style="position: absolute; right: 8px; width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 85px; text-align: right;">关联工作单</label>
                                    <select style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; color: #94a3b8;">
                                        <option>请选择</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 85px; text-align: right;">关联客户</label>
                                    <select style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; color: #94a3b8;">
                                        <option>请选择</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; grid-column: span 2;">
                                    <label style="width: 85px; text-align: right;">用途</label>
                                    <div style="flex: 1; position: relative;">
                                        <input type="text" placeholder="请输入" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 45px 0 8px;">
                                        <span style="position: absolute; right: 8px; top: 9px; font-size: 0.7rem; color: #cbd5e1;">0 / 500</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; grid-column: span 3;">
                                    <label style="width: 85px; text-align: right;"><span style="color: #ef4444;">*</span> 核算对象</label>
                                    <div style="display: flex; align-items: center; gap: 20px; color: #475569;">
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="target" checked style="margin: 0; accent-color: #3b82f6;"> 个人</label>
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="target" style="margin: 0; accent-color: #3b82f6;"> 部门</label>
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="target" style="margin: 0; accent-color: #3b82f6;"> 公司</label>
                                        <select style="width: 200px; height: 30px; border: 1px solid #fecaca; background: #fef2f2; border-radius: 4px; padding: 0 8px; color: #94a3b8; font-size: 0.75rem;">
                                            <option>请选择</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 费用明细板块 -->
                        <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0; flex: 1; display: flex; flex-direction: column; min-height: 400px; position: relative;">
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 4px; height: 16px; background: #3b82f6; border-radius: 2px;"></div>
                                    <span style="font-size: 0.85rem; font-weight: 600; color: #1e293b;">费用明细</span>
                                </div>
                                <i data-lucide="settings" style="width: 14px; height: 14px; color: #94a3b8; cursor: pointer;"></i>
                            </div>
                            
                            <!-- 子页签 (应付) -->
                            <div style="padding: 0 12px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 20px;">
                                <div style="display: flex; align-items: center; gap: 4px; padding: 10px 0; border-bottom: 2px solid #3b82f6; color: #3b82f6; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                    <i data-lucide="minus-circle" style="width: 14px; height: 14px;"></i> 应付
                                </div>
                            </div>

                            <!-- 表格容器 -->
                            <div style="flex: 1; overflow: auto; background: white;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap; table-layout: fixed;">
                                    <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 1;">
                                        <tr>
                                            <th style="width: 40px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: center;">#</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">开票状态</th>
                                            <th style="width: 100px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">* 计费日期</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">* 费用</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">* 币种</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">单价</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">* 数量</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">单位</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">* 金额</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">税率</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">税额</th>
                                            <th style="width: 100px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">不含税金额</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">汇率</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">折合CNY</th>
                                            <th style="width: 120px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">有付款需求</th>
                                            <th style="width: 120px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">核销单号</th>
                                            <th style="width: 80px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">已销账</th>
                                            <th style="width: 100px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">未核销余额</th>
                                            <th style="width: 100px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">发票号码</th>
                                            <th style="width: 120px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">费用参考号</th>
                                            <th style="width: 100px; padding: 8px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">对账单号</th>
                                            <th style="width: 150px; padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">结算公司</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 空状态占位 -->
                                        <tr>
                                            <td colspan="22" style="height: 300px; text-align: center; vertical-align: middle;">
                                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: #94a3b8;">
                                                    <div style="position: relative; width: 64px; height: 64px;">
                                                        <i data-lucide="search" style="width: 64px; height: 64px; opacity: 0.1;"></i>
                                                        <div style="position: absolute; bottom: 0; right: 0; background: white; border-radius: 50%; padding: 2px;">
                                                            <i data-lucide="file-x" style="width: 20px; height: 20px; color: #cbd5e1;"></i>
                                                        </div>
                                                    </div>
                                                    <span style="font-size: 0.85rem;">暂无数据</span>
                                                    <button style="padding: 4px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.8rem;">
                                                        <i data-lucide="plus" style="width: 14px; height: 14px;"></i> 新增
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 分摊明细板块 -->
                        <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0; flex-shrink: 0;">
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 6px;">
                                <div style="width: 4px; height: 16px; background: #3b82f6; border-radius: 2px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 600; color: #1e293b;">分摊明细</span>
                            </div>
                            <div style="padding: 12px 24px; border-bottom: 1px solid #f1f5f9; background: #f8fafc;">
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #1e293b; font-weight: 500; cursor: pointer;">
                                    <input type="checkbox" checked style="width: 16px; height: 16px; accent-color: #3b82f6;"> 按人数均摊
                                </label>
                            </div>
                            <div style="max-height: 200px; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                    <thead style="background: #f8fafc;">
                                        <tr>
                                            <th style="width: 120px; padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">姓名</th>
                                            <th style="width: 120px; padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">币别</th>
                                            <th style="width: 120px; padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #64748b; font-weight: 500;">金额</th>
                                            <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" style="padding: 30px; text-align: center; color: #94a3b8;">
                                                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                                    <i data-lucide="ghost" style="width: 32px; height: 32px; opacity: 0.2;"></i>
                                                    <span>暂无数据</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) {
                window.lucide.createIcons();
            }
        } else if (activeTab === '批量确认') {
            document.querySelector('.page-content').innerHTML = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Filter Area (Merged into one row) -->
                <div class="batch-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: white;">
                        <!-- Date Group -->
                        <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>计费日期</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                                <input type="text" value="2025-12-01" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #334155;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                                <span style="color: #cbd5e1;">-</span>
                                <input type="text" value="2025-12-31" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #334155;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                            </div>
                        </div>

                        <!-- Keyword -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">关键字</label>
                            <input type="text" placeholder="工作号" style="width: 150px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                        </div>

                        <!-- Confirm Status -->
                        <div style="display: flex; align-items: center; gap: 8px; position: relative;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">确认状态</label>
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="batch-confirm-status">全部</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100px; position: absolute; top: 100%; left: 58px; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-confirm-status', '全部')">全部</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-confirm-status', '已确认')">已确认</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-confirm-status', '未确认')">未确认</div>
                            </div>
                        </div>

                        <!-- Type -->
                        <div style="display: flex; align-items: center; gap: 8px; position: relative;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">类型</label>
                            <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="batch-type">全部</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100px; position: absolute; top: 100%; left: 32px; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-type', '全部')">全部</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-type', '费用单')">费用单</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-type', '整车')">整车</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-type', '零担')">零担</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-type', '短驳')">短驳</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-type', '其他')">其他</div>
                            </div>
                        </div>

                        <!-- Range -->
                        <div style="display: flex; align-items: center; gap: 8px; position: relative;">
                            <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">范围</label>
                            <div class="select-box" style="width: 130px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="batch-range">只看我负责的</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 130px; position: absolute; top: 100%; left: 32px; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-range', '只看我负责的')">只看我负责的</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-range', '只看有费用的')">只看有费用的</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('batch-range', '只看无费用的')">只看无费用的</div>
                            </div>
                        </div>

                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                            <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                        </button>

                        <div style="height: 32px; width: 1px; background: #e2e8f0; margin: 0 8px;"></div>

                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                            批量确认
                        </button>
                        <button class="ghost-btn" style="height: 32px; padding: 0 12px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.8rem; background: white; cursor: pointer;">批量导出</button>
                </div>

                    <!-- Table Content Area -->
                    <div class="statement-table-container" style="flex-grow: 1; background: #f8fafc; padding: 0; overflow: auto;">
                        <table class="statement-table" style="width: max-content; min-width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">工作号</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">工作单日期</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">委托人(英)</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">签收日期</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">运单类型</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">业务员</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">操作员</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应收</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应收（增减）</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应付</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应付（增减）</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应收</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">费用确认</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">费用确认人</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应付</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">费用确认时间</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">增减费用确认</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">业务员成本</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">增减费用确认人</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">增减费用确认时间</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">公司毛利</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">客服确认</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">客服确认人</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">业务员毛利客服确认时间</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">业务员确认</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应收完成</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">业务员确认人</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">应付完成</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">业务员确认时间</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">收款状态</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">付款状态</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">所属公司</th>
                                    <th style="white-space: nowrap; padding: 0 12px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: white;">
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                    <td style="text-align: center;">1</td>
                                    <td>YO2512-0019</td>
                                    <td>2025-12-25</td>
                                    <td>MSC ISABELLA</td>
                                    <td>2025-12-26</td>
                                    <td>整车</td>
                                    <td>张三</td>
                                    <td>李四</td>
                                    <td style="color: #4f46e5; font-weight: 500;">1200.00</td>
                                    <td>0.00</td>
                                    <td style="color: #ef4444; font-weight: 500;">1000.00</td>
                                    <td>0.00</td>
                                    <td>1200.00</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>-</td>
                                    <td>1000.00</td>
                                    <td>-</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>800.00</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>400.00</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>否</td>
                                    <td>-</td>
                                    <td>否</td>
                                    <td>-</td>
                                    <td>未收款</td>
                                    <td>未付款</td>
                                    <td>丰源物流</td>
                                    <td><button style="color: #4f46e5; background: none; border: none; cursor: pointer; font-size: 0.75rem;">查看</button></td>
                                </tr>
                                <tr style="background: #f8fafc;">
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                    <td style="text-align: center;">2</td>
                                    <td>YO2512-0020</td>
                                    <td>2025-12-26</td>
                                    <td>EVER GIVEN</td>
                                    <td>2025-12-27</td>
                                    <td>零担</td>
                                    <td>马六</td>
                                    <td>赵八</td>
                                    <td style="color: #4f46e5; font-weight: 500;">530.00</td>
                                    <td>30.00</td>
                                    <td style="color: #ef4444; font-weight: 500;">400.00</td>
                                    <td>10.00</td>
                                    <td>500.00</td>
                                    <td><span style="color: #10b981;">已确认</span></td>
                                    <td>陈七</td>
                                    <td>400.00</td>
                                    <td>2025-12-26 15:30</td>
                                    <td><span style="color: #10b981;">已确认</span></td>
                                    <td>350.00</td>
                                    <td>陈七</td>
                                    <td>2025-12-26 15:30</td>
                                    <td>180.00</td>
                                    <td><span style="color: #10b981;">已确认</span></td>
                                    <td>陈七</td>
                                    <td>2025-12-26 15:30</td>
                                    <td><span style="color: #10b981;">已确认</span></td>
                                    <td>是</td>
                                    <td>马六</td>
                                    <td>是</td>
                                    <td>2025-12-26 16:00</td>
                                    <td>已收款</td>
                                    <td>已付款</td>
                                    <td>丰源物流</td>
                                    <td><button style="color: #4f46e5; background: none; border: none; cursor: pointer; font-size: 0.75rem;">查看</button></td>
                                </tr>
                                <tr style="background: white;">
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                    <td style="text-align: center;">3</td>
                                    <td>YO2512-0021</td>
                                    <td>2025-12-27</td>
                                    <td>COSCO SHIPPING</td>
                                    <td>2025-12-28</td>
                                    <td>费用单</td>
                                    <td>王五</td>
                                    <td>张三</td>
                                    <td style="color: #4f46e5; font-weight: 500;">356.17</td>
                                    <td>0.00</td>
                                    <td style="color: #ef4444; font-weight: 500;">300.00</td>
                                    <td>0.00</td>
                                    <td>356.17</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>-</td>
                                    <td>300.00</td>
                                    <td>-</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>250.00</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>106.17</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td><span style="color: #ef4444;">未确认</span></td>
                                    <td>否</td>
                                    <td>-</td>
                                    <td>否</td>
                                    <td>-</td>
                                    <td>部分收款</td>
                                    <td>未付款</td>
                                    <td>丰源物流</td>
                                    <td><button style="color: #4f46e5; background: none; border: none; cursor: pointer; font-size: 0.75rem;">查看</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
        } else if (activeTab === '费用审核') {
            document.querySelector('.page-content').innerHTML = `
                    <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                <!-- Filter Area (Merged into one row) -->
                <div class="audit-filter-area" style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: white;">
                    <!-- Billing Date Group -->
                    <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div class="select-box-filter" style="width: 95px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                            <span>计费日期</span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                        </div>
                        <div style="display: flex; align-items: center; padding: 0 8px; gap: 4px;">
                            <input type="text" value="2025-12-01" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #334155;">
                            <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                            <span style="color: #cbd5e1;">-</span>
                            <input type="text" value="2025-12-31" style="width: 85px; height: 32px; border: none; font-size: 0.8rem; outline: none; color: #334155;">
                            <i data-lucide="calendar" style="width: 14px; height: 14px; color: #cbd5e1;"></i>
                        </div>
                    </div>

                    <!-- Type Group -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">类型</label>
                        <div class="relative-container">
                            <div class="select-box-filter" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: white; font-size: 0.8rem; cursor: pointer;">
                                <span id="audit-type-val" style="color: #334155;">全部</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown-menu-custom hidden" style="width: 100px; position: absolute; top: 100%; left: 0; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-type-val', '全部')">全部</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-type-val', '整车')">整车</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-type-val', '零担')">零担</div>
                                <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-type-val', '短驳')">短驳</div>
                            </div>
                        </div>
                    </div>

                    <!-- Keywords -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">关键字</label>
                        <input type="text" placeholder="工作单号" style="width: 150px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.8rem; outline: none;">
                    </div>

                    <!-- Expense Audit Select -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.8rem; color: #475569; font-weight: 500;">费用审核</label>
                        <div style="display: flex; border: 1px solid #e2e8f0; border-radius: 4px;">
                            <div class="select-box-filter" style="width: 70px; height: 32px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: #f8fafc; font-size: 0.8rem; cursor: pointer;">
                                <span>包含</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                            <div class="relative-container">
                                <div class="select-box-filter" style="width: 120px; height: 32px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: white; font-size: 0.8rem; cursor: pointer;">
                                    <span id="audit-status-val" style="color: #cbd5e1;">请选择</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div class="dropdown-menu-custom hidden" style="width: 120px; position: absolute; top: 100%; left: 0; z-index: 100; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-status-val', '未提交')">未提交</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-status-val', '审核中')">审核中</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-status-val', '审核通过')">审核通过</div>
                                    <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('audit-status-val', '审核驳回')">审核驳回</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                    </button>
                </div>

                    <!-- Table Content Area -->
                    <div class="statement-table-container" style="flex: none; height: auto; max-height: 150px; background: #f8fafc; padding: 0; overflow: auto;">
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>工作号</th>
                                    <th>工作单日期</th>
                                    <th>签收日期</th>
                                    <th>件数</th>
                                    <th>运单类型</th>
                                    <th>毛重</th>
                                    <th>业务员</th>
                                    <th>体积</th>
                                    <th>操作员</th>
                                    <th>应收</th>
                                    <th>应收（增减）</th>
                                    <th>应付</th>
                                    <th>应付（增减）</th>
                                    <th>审核状态</th>
                                    <th>客服</th>
                                    <th>审核时间</th>
                                    <th>收款状态</th>
                                    <th>付款状态</th>
                                    <th>所属公司</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${window.expenseAuditData.map((req, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'white' : '#f8fafc'};">
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td style="text-align: center;">${index + 1}</td>
                                        <td>${req.id}</td>
                                        <td>${req.date}</td>
                                        <td>${req.signDate}</td>
                                        <td>${req.pieces}</td>
                                        <td>${req.type}</td>
                                        <td>${req.weight}</td>
                                        <td>${req.salesman}</td>
                                        <td>${req.volume}</td>
                                        <td>${req.operator}</td>
                                        <td>${req.revenue.toFixed(2)}</td>
                                        <td>0.00</td>
                                        <td>${req.cost.toFixed(2)}</td>
                                        <td>0.00</td>
                                        <td><span style="color: ${req.status === '审核通过' ? '#10b981' : (req.status === '审核中' ? '#3b82f6' : '#64748b')}">${req.status}</span></td>
                                        <td>王五</td>
                                        <td>${req.status === '审核通过' ? '2025-12-28 10:00' : '-'}</td>
                                        <td>部分收款</td>
                                        <td>未付款</td>
                                        <td>${req.customer}</td>
                                        <td style="text-align: center;">
                                            ${req.status === '未提交' ? `<a href="javascript:void(0)" onclick="window.submitExpenseAudit('${req.id}')" style="color: #4f46e5;">审核</a>` : `<a href="javascript:void(0)" style="color: #94a3b8; cursor: not-allowed; text-decoration: none;">已审核</a>`}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>


                    <!-- Expense Detail Section -->
                    <div class="expense-detail-section" style="border-top: 1px solid #e2e8f0; background: white; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <!-- Control Bar -->
                        <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: white;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <a href="#" style="color: #4f46e5; display: flex; align-items: center; gap: 4px; text-decoration: none; font-size: 0.9rem;">
                                    收起应收应付单<i data-lucide="chevron-up" style="width: 14px; height: 14px;"></i>
                                </a>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem; color: #475569;">
                                    <input type="checkbox" checked> 显示增减费用
                                </label>
                                <div style="display: flex; gap: 8px;">
                                    <button style="background: #22c55e; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">审核通过</button>
                                    <button style="background: #f97316; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">驳回</button>
                                    <button style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">撤销审核</button>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 24px; font-size: 0.9rem; color: #1e293b;">
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <span style="font-size: 0.8rem; color: #64748b;">毛利率</span>
                                    <span style="font-weight: 600;">0%</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: start;">
                                    <span style="font-size: 0.8rem; color: #64748b;">折合币制 <i data-lucide="help-circle" style="width: 12px; height: 12px;"></i></span>
                                    <select style="border: 1px solid #e2e8f0; border-radius: 2px; font-size: 0.8rem; padding: 1px 4px;">
                                        <option>CNY</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end;">
                                    <span style="font-size: 0.8rem; color: #64748b;">应收</span>
                                    <span style="font-weight: 600;">700.00</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end;">
                                    <span style="font-size: 0.8rem; color: #64748b;">应付</span>
                                    <span style="font-weight: 600;">112.00</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end;">
                                    <span style="font-size: 0.8rem; color: #64748b;">公司利润</span>
                                    <span style="font-weight: 600;">588.00</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end;">
                                    <span style="font-size: 0.8rem; color: #64748b;">其他费用</span>
                                    <span style="font-weight: 600;">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Details Split View -->
                        <div style="flex-grow: 1; display: flex; overflow: hidden;">
                            <!-- Receivables Column -->
                            <div style="flex: 1; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 12px;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #65a30d; margin-bottom: 8px;">应收 (2) 增减 (0)</div>
                                <div style="flex-grow: 1; overflow: auto; border: 1px solid #e2e8f0; border-radius: 4px;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                                            <tr>
                                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e2e8f0;"><input type="checkbox"></th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">审核状态</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">计费日期</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">费用代码</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">费用名称</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">原币</th>
                                                <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">金额</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">客户代码</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">客户名称</th>
                                                <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">数量</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                                <td style="padding: 8px; text-align: center;"><input type="checkbox" class="payables-row-checkbox" onchange="updatePayablesGenerateBillButtonState()"></td>
                                                <td style="padding: 8px;"></td>
                                                <td style="padding: 8px;">2025-12-04</td>
                                                <td style="padding: 8px;">DOFC</td>
                                                <td style="padding: 8px;">文件单证费</td>
                                                <td style="padding: 8px;">CNY</td>
                                                <td style="padding: 8px; text-align: right;">200.00</td>
                                                <td style="padding: 8px;"></td>
                                                <td style="padding: 8px;">麦格亿-操作部</td>
                                                <td style="padding: 8px; text-align: right;"></td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                                <td style="padding: 8px; text-align: center;"><input type="checkbox" class="payables-row-checkbox" onchange="updatePayablesGenerateBillButtonState()"></td>
                                                <td style="padding: 8px;"></td>
                                                <td style="padding: 8px;">2025-12-04</td>
                                                <td style="padding: 8px;">DOFC</td>
                                                <td style="padding: 8px;">文件单证费</td>
                                                <td style="padding: 8px;">CNY</td>
                                                <td style="padding: 8px; text-align: right;">500.00</td>
                                                <td style="padding: 8px;"></td>
                                                <td style="padding: 8px;">麦格亿-操作部</td>
                                                <td style="padding: 8px; text-align: right;"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div style="margin-top: 8px; font-size: 0.85rem; color: #16a34a; font-weight: 600;">
                                    CNY: 700.00
                                </div>
                            </div>

                            <!-- Payables Column -->
                            <div style="flex: 1; display: flex; flex-direction: column; padding: 12px;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #dc2626; margin-bottom: 8px;">应付 (1) 增减 (0)</div>
                                <div style="flex-grow: 1; overflow: auto; border: 1px solid #e2e8f0; border-radius: 4px;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                                            <tr>
                                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e2e8f0;"><input type="checkbox"></th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">审核状态</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">计费日期</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">费用代码</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">费用名称</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">原币</th>
                                                <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">金额</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">客户代码</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">客户名称</th>
                                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">客户名称</th>
                                                <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">数量</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                                <td style="padding: 8px; text-align: center;"><input type="checkbox" class="payables-row-checkbox" onchange="updatePayablesGenerateBillButtonState()"></td>
                                                <td style="padding: 8px;"></td>
                                                <td style="padding: 8px;">2025-12-04</td>
                                                <td style="padding: 8px;">TRNF</td>
                                                <td style="padding: 8px;">交通费</td>
                                                <td style="padding: 8px;">CNY</td>
                                                <td style="padding: 8px; text-align: right;">112.00</td>
                                                <td style="padding: 8px;">YIXING</td>
                                                <td style="padding: 8px;">ZIM</td>
                                                <td style="padding: 8px;">以星综合航运...</td>
                                                <td style="padding: 8px; text-align: right;"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div style="margin-top: 8px; font-size: 0.85rem; color: #dc2626; font-weight: 600;">
                                    CNY: 112.00
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

        } else if (activeTab === '付款申请') {
            mainContent = `
            <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: #fff;">
                <!-- List View -->
                <div id="payment-application-list-view" style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                    <!-- Status Tabs (Simplified based on Image 1) -->
                    <div style="background: #fff; padding: 0 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">

                            <div class="active" onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">全部</div>
                            <div onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">草稿/驳回</div>
                            <div onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">审核中 <span style="background:#f1f5f9; padding: 0 4px; border-radius: 4px;">56</span></div>
                            <div onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">已批准 <span style="background:#f1f5f9; padding: 0 4px; border-radius: 4px;">4</span></div>
                             <div onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">部分核销</div>
                             <div onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">已核销 <span style="background:#f1f5f9; padding: 0 4px; border-radius: 4px;">1</span></div>
                             <div onclick="window.switchPaymentApplicationTab(this)" style="padding: 12px 0; cursor: pointer;">已过期已取消 <span style="background:#f1f5f9; padding: 0 4px; border-radius: 4px;">1</span></div>
                        </div>
                    </div>

                    <!-- Filter Area -->
                     <div style="padding: 12px 24px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px;">
                        <!-- Row 1 -->
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 0.8rem;">
                             <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">申请日期</label>
                                <div style="border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; height: 32px; background: #fff;">
                                    <input type="text" placeholder="开始日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="border: none; width: 100px; outline: none; font-size: 0.8rem;">
                                    <span style="color: #cbd5e1;">-</span>
                                    <input type="text" placeholder="结束日期" onfocus="(this.type='date')" onblur="(this.value==''?this.type='text':this.type='date')" style="border: none; width: 100px; outline: none; font-size: 0.8rem;">
                                </div>
                            </div>
                            <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">关键字</label>
                                <input type="text" placeholder="请输入结算单位/申请号" style="border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; height: 32px; width: 200px; outline: none;">
                            </div>
                             <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">申请人</label>
                                <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;"><span>请选择</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                            </div>
                             <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">单据状态</label>
                                <div class="relative-container">
                                    <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                        <span id="payment-doc-status-selected">请选择</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                    <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-doc-status-selected', '审核中')">审核中</div>
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-doc-status-selected', '已审核')">已审核</div>
                                    </div>
                                </div>
                            </div>
                             <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">水单状态</label>
                                <div class="relative-container">
                                    <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                        <span id="payment-slip-status-selected">全部</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                    <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-slip-status-selected', '未上传')">未上传</div>
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-slip-status-selected', '已上传')">已上传</div>
                                    </div>
                                </div>
                            </div>
                             <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">发票附件状态</label>
                                <div class="relative-container">
                                    <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                        <span id="payment-invoice-attachment-status-selected">全部</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                    <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-invoice-attachment-status-selected', '未上传')">未上传</div>
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-invoice-attachment-status-selected', '已上传')">已上传</div>
                                    </div>
                                </div>
                            </div>
                             <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">开票方式</label>
                                <div class="relative-container">
                                    <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;" onclick="this.nextElementSibling.classList.toggle('hidden'); event.stopPropagation();">
                                        <span id="payment-invoice-type-selected">请选择</span>
                                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                    </div>
                                    <div class="dropdown-menu-custom hidden" style="width: 100%; top: calc(100% + 4px); left: 0; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50;">
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-invoice-type-selected', '先票后付')">先票后付</div>
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-invoice-type-selected', '先付后票')">先付后票</div>
                                        <div class="dropdown-item-custom" style="font-size: 0.75rem; padding: 8px 12px; cursor: pointer;" onclick="selectOption('payment-invoice-type-selected', '不开票')">不开票</div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Row 2 -->
                         <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 0.8rem;">
                            <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b;">所属公司</label>
                                <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer;"><span>请选择</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                            </div>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #64748b;">
                                <input type="checkbox"> 仅查看待我处理的
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #64748b;">
                                <input type="checkbox"> 仅查看已过期已失效
                            </label>
                             <button style="background: #4f46e5; color: white; border: none; padding: 0 16px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                 <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                             </button>
                             <div style="flex: 1;"></div>
                             <!-- Action Buttons (List View) -->
                             <button onclick="openPaymentApplicationCreateView()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                 <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> 新增
                            </button>
                            <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer;">提交审核</button>
                            <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 4px; cursor: pointer;">按付款对象合并</button>
                         </div>
                    </div>

                    <!-- Table -->
                    <div style="flex: 1; overflow: auto; background: #f8fafc; padding: 0;">
                         <table class="statement-table" style="width: 100%; min-width: max-content;">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th style="text-align: left;">付款申请单号</th>
                                    <th style="text-align: left;">单据状态</th>
                                    <th style="text-align: center;">付款单附件</th>
                                    <th style="text-align: left;">水单上传时间</th>
                                    <th style="text-align: left;">发票预核状态</th>
                                    <th style="text-align: left;">结算单位</th>
                                    <th style="text-align: left;">开票方式</th>
                                    <th style="text-align: left;">申请日期</th>
                                    <th style="text-align: left;">应支付日期</th>
                                    <th style="text-align: right;">申请金额</th>
                                    <th style="text-align: right;">费用金额</th>
                                    <th style="text-align: right;">已核销金额</th>
                                    <th style="text-align: right;">本期金额</th>
                                    <th style="text-align: right;">折合金额</th>
                                    <th style="text-align: left;">申请人</th>
                                    <th style="text-align: left;">所属公司</th>
                                    <th style="text-align: left;">工作单号</th>
                                    <th style="text-align: left;">账单号</th>
                                    <th style="text-align: left;">对账单号</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: white; border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 8px; text-align: center;"><input type="checkbox"></td>
                                    <td style="padding: 8px; text-align: center;">1</td>
                                    <td style="padding: 8px; color: #4f46e5;">PAY20231201001</td>
                                    <td style="padding: 8px;"><span style="background: #fef9c3; color: #ca8a04; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">待审批</span></td>
                                    <td style="padding: 8px; text-align: center;"><i data-lucide="file-text" style="width: 14px; height: 14px; color: #cbd5e1;"></i></td>
                                    <td style="padding: 8px;">未上传</td>
                                    <td style="padding: 8px;">-</td>
                                    <td style="padding: 8px;">深圳市好运来货运代理有限公司</td>
                                    <td style="padding: 8px;">专票(6%)</td>
                                    <td style="padding: 8px;">2023-12-01</td>
                                    <td style="padding: 8px;">2023-12-15</td>
                                    <td style="padding: 8px; text-align: right;">5,000.00</td>
                                    <td style="padding: 8px; text-align: right;">5,000.00</td>
                                    <td style="padding: 8px; text-align: right;">0.00</td>
                                     <td style="padding: 8px; text-align: right; color: #dc2626;">5,000.00</td>
                                      <td style="padding: 8px; text-align: right;">5,000.00</td>
                                    <td style="padding: 8px;">业务员A</td>
                                    <td style="padding: 8px;">丰源集团</td>
                                    <td style="padding: 8px;">Y02512-0019</td>
                                    <td style="padding: 8px;">B20231201</td>
                                    <td style="padding: 8px;">S20231201</td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div>

                <!-- Create View (Hidden) - Redesigned based on Image 2 -->
                <div id="payment-application-create-view" style="display: none; flex-direction: column; width: 100%; height: 100%; background: #f8fafc;">
                    <!-- Header -->
                    <div style="height: 48px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #334155;">
                            <span>申请单号:</span>
                            <span style="background: #4f46e5; color: white; padding: 1px 4px; border-radius: 2px; font-size: 11px;">付</span>
                            <span style="color: #64748b;">自动生成</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="primary-btn" style="height: 28px; padding: 0 12px; background: #4f46e5; border: none; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; gap: 4px;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 新增</button>
                            <button style="height: 28px; padding: 0 12px; background: white; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 4px;"><i data-lucide="check-square" style="width: 14px; height: 14px;"></i> 提交审核</button>
                            <button style="height: 28px; padding: 0 12px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 4px; font-size: 12px;">暂存草稿</button>
                            <button onclick="closePaymentApplicationCreateView()" style="height: 28px; padding: 0 12px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 4px; font-size: 12px;">返回</button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 12px;">
                        <!-- Form Area -->
                         <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0; padding: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px 24px; align-items: start;">
                                <!-- Row 1 -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 70px; text-align: right; color: #64748b; font-size: 12px;"><span style="color: red">*</span> 结算单位</label>
                                    <div style="flex: 1; display: flex; gap: 4px;">
                                        <div class="select-box" style="flex: 1; height: 28px; border: 1px solid #fee2e2; background: #fff1f2; border-radius: 2px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 12px;"><span>请选择</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                                        <span style="background: #f1f5f9; padding: 0 4px; border-radius: 2px; font-size: 11px; color: #64748b; display: flex; align-items: center;">NL</span>
                                        <span style="background: #f1f5f9; padding: 0 4px; border-radius: 2px; font-size: 11px; color: #64748b; display: flex; align-items: center;">月结</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="color: #64748b; font-size: 12px;">预付账余额</label>
                                    <span style="font-size: 12px;">-</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="color: #64748b; font-size: 12px;">应支付日期</label>
                                    <input type="date" value="2026-02-26" style="flex: 1; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; font-size: 12px; outline: none; padding: 0 8px; font-family: inherit;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="color: #64748b; font-size: 12px;">发票文件</label>
                                    <a href="#" style="color: #4f46e5; display: flex; align-items: center; gap: 4px; font-size: 12px;"><i data-lucide="paperclip" style="width: 14px; height: 14px;"></i> 附件</a>
                                </div>

                                <!-- Row 2 -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 70px; text-align: right; color: #64748b; font-size: 12px;">类型</label>
                                    <div style="flex: 1; display: flex; gap: 4px;">
                                        <div class="select-box" style="width: 60px; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; display: flex; align-items: center; justify-content: space-between; padding: 0 4px; font-size: 12px;"><span>折合</span><i data-lucide="chevron-down" style="width: 12px; height: 12px; color: #94a3b8;"></i></div>
                                        <div class="select-box" style="width: 60px; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; display: flex; align-items: center; justify-content: space-between; padding: 0 4px; font-size: 12px;"><span>CNY</span><i data-lucide="chevron-down" style="width: 12px; height: 12px; color: #94a3b8;"></i></div>
                                        <input type="text" value="0" style="width: 40px; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; text-align: right; outline: none; font-size: 12px;">
                                        <a href="#" style="color: #4f46e5; font-size: 11px; display: flex; align-items: center;">汇率</a>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="color: #64748b; font-size: 12px;">对方银行账户</label>
                                    <div class="select-box" style="flex: 1; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 12px;"><span>请选择</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; grid-column: span 2;">
                                    <label style="color: #64748b; font-size: 12px;">开票方式</label>
                                    <div style="display: flex; gap: 12px; font-size: 12px; color: #334155;">
                                        <label style="display: flex; align-items: center; gap: 4px;"><input type="radio" name="pay-inv-type" checked> 先票后付</label>
                                        <label style="display: flex; align-items: center; gap: 4px;"><input type="radio" name="pay-inv-type"> 先付后票</label>
                                        <label style="display: flex; align-items: center; gap: 4px;"><input type="radio" name="pay-inv-type"> 不开票</label>
                                    </div>
                                </div>

                                <!-- Row 3 & 4 spanning -->
                                <div style="display: flex; gap: 8px; grid-row: span 2;">
                                    <label style="width: 70px; text-align: right; color: #64748b; font-size: 12px; line-height: 28px;">备注</label>
                                    <textarea placeholder="请输入" style="flex: 1; height: 68px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 8px; font-size: 12px; outline: none; resize: none;"></textarea>
                                </div>
                                <div style="display: flex; gap: 8px; grid-row: span 2;">
                                    <textarea readonly placeholder="对方银行账户" style="flex: 1; height: 68px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 8px; font-size: 12px; outline: none; resize: none; background: #f8fafc; color: #94a3b8; margin-left: 80px;"></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="color: #64748b; font-size: 12px; width: 60px;">发票号</label>
                                        <input type="text" placeholder="请输入" style="flex: 1; height客: 28px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 8px; font-size: 12px; outline: none;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="color: #64748b; font-size: 12px; width: 60px;">开票日期</label>
                                        <input type="date" style="flex: 1; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; font-size: 12px; outline: none; padding: 0 8px; font-family: inherit;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Toolbar -->
                        <div style="display: flex; align-items: center; gap: 16px; background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #e2e8f0; font-size: 12px; flex-shrink: 0;">
                            <div style="display: flex; gap: 12px; color: #64748b;">
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="pay-item-type"> 应收</label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="pay-item-type"> 应付</label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="pay-item-type" checked> 收付</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; flex: 1;">
                                 <input type="text" placeholder="工作号/帐单号/工作单号" style="flex: 1; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none;">
                                 <button style="height: 32px; background: #4f46e5; border: none; border-radius: 4px; color: white; padding: 0 16px; display: flex; align-items: center; gap: 4px; cursor: pointer;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                            </div>
                            <a href="#" style="color: #4f46e5; white-space: nowrap;">更多(0) <i data-lucide="chevron-down" style="width: 10px; height: 10px; display: inline;"></i></a>
                            <div style="border-left: 1px solid #e2e8f0; height: 20px; margin: 0 8px;"></div>
                            <div style="display: flex; align-items: center; gap: 12px; color: #64748b; white-space: nowrap;">
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="pay-view-type"> 仅显示已勾选</label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio" name="pay-view-type" checked> 全部</label>
                                <div class="select-box" style="width: 100px; height: 28px; border: 1px solid #e2e8f0; border-radius: 2px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: white; position: relative;">
                                    <span style="pointer-events: none;">按费用明细</span>
                                    <i data-lucide="chevron-down" style="width: 12px; height: 12px; color: #94a3b8; pointer-events: none;"></i>
                                    <select style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="this.previousElementSibling.previousElementSibling.innerText = this.options[this.selectedIndex].text">
                                        <option value="expense">按费用明细</option>
                                        <option value="bill">按账单</option>
                                        <option value="waybill">按运单</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <div style="flex: 1; background: white; border: 1px solid #e2e8f0; border-radius: 4px; overflow: auto;">
                             <table style="width: 100%; border-collapse: collapse; min-width: 2200px; font-size: 12px;">
                                <thead style="background: #f8fafc; color: #64748b; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 40px;">#</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox"></th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">账单号</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">工作单号</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">结算单位</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">计费日期</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">币种</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">业务项</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: right;">数量</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: center;">单位</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: right;">金额</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: right;">本期应收余额</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: right; background: #fffbeb;">本期应付(原币)</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: right; background: #fffbeb;">本期折算额(折合)</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">工作单日期</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">费用参考号</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">工作单参考号</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">中转单号</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">所属公司</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: left;">委托人</th>
                                    </tr>
                                </thead>
                                <tbody>
                                     <tr style="border-bottom: 1px solid #f1f5f9;">
                                         <td style="padding: 10px; text-align: center;">1</td>
                                         <td style="padding: 10px; text-align: center;"><input type="checkbox"></td>
                                         <td style="padding: 10px; color: #4f46e5;">B2023120101</td>
                                         <td style="padding: 10px;">Y02512-0030</td>
                                         <td style="padding: 10px;">上海市东方国际物流集团</td>
                                         <td style="padding: 10px;">2023-12-01</td>
                                         <td style="padding: 10px;">USD</td>
                                         <td style="padding: 10px;">运费</td>
                                         <td style="padding: 10px; text-align: right;">1.00</td>
                                         <td style="padding: 10px; text-align: center;">UNIT</td>
                                         <td style="padding: 10px; text-align: right;">500.00</td>
                                         <td style="padding: 10px; text-align: right;">500.00</td>
                                         <td style="padding: 10px; text-align: right; background: #fffbeb;">500.00</td>
                                         <td style="padding: 10px; text-align: right; background: #fffbeb;">3500.00</td>
                                         <td style="padding: 10px;">2023-12-01</td>
                                         <td style="padding: 10px;">-</td>
                                         <td style="padding: 10px;">REF123456</td>
                                         <td style="padding: 10px;">-</td>
                                         <td style="padding: 10px;">丰源集团</td>
                                         <td style="padding: 10px;">-</td>
                                     </tr>
                                </tbody>
                             </table>
                        </div>
                    </div>
                </div>
            </div>
            
            </div>`;

        } else if (activeTab === '结算设置') {
            document.querySelector('.page-content').innerHTML = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: flex-end; background: white;">
                        <button class="primary-btn" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存
                        </button>
                    </div>
                    <div style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #334155; cursor: pointer;">
                            <input type="checkbox" style="width: 16px; height: 16px; border: 1px solid #cbd5e1; border-radius: 4px;">
                            全业态工作单的应付费用需要经过付款申请审核通过后才能进行核销
                        </label>
                         <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #334155; cursor: pointer;">
                            <input type="checkbox" style="width: 16px; height: 16px; border: 1px solid #cbd5e1; border-radius: 4px;">
                            费用单的费用需要经过费用申请审核通过后才能进行核销
                        </label>
                    </div>
                </div>`;

        } else if (activeTab === '录入运单') {
            mainContent = `
                <div style="display: flex; flex-direction: column; width: 100%; height: 100%; background: #f1f5f9; gap: 12px; padding: 12px; font-family: inherit; box-sizing: border-box; overflow-y: auto;">
                     <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 12px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                        <h2 style="font-size: 1.1rem; color: #1e293b; font-weight: 600; margin: 0;">录入运单</h2>
                        <button onclick="window.saveWaybillEntry()" style="background: #10b981; color: white; border: none; border-radius: 4px; padding: 0 16px; height: 32px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存
                        </button>
                    </div>
                    ${window.getFinancialPanelHTML()}
                </div>
            `;
        } else if (activeTab === '录入订单') {
            mainContent = `
                <div class="order-entry-form" style="display: flex; flex-direction: column; height: 100%; background: #f1f5f9; gap: 12px; padding: 12px; font-family: inherit; overflow-y: auto;">
                    <!-- Header Section: Tabs and Top Controls -->
                    <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 12px; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; gap: 2px;">
                                <div style="background: #4f46e5; color: white; padding: 6px 16px; border-radius: 4px 4px 0 0; font-size: 0.85rem; font-weight: 600; cursor: pointer;">货物、费用</div>
                                <div style="background: #f8fafc; color: #64748b; padding: 6px 16px; border-radius: 4px 4px 0 0; font-size: 0.85rem; cursor: pointer; border: 1px solid #e2e8f0; border-bottom: none;">其他信息</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.8rem; color: #ef4444; font-weight: 600;">里程 (KM):</label>
                                    <input id="entry-mileage" type="text" style="width: 100px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none; text-align: center; font-weight: 600;">
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="window.calculateFreight()" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; height: 32px; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; cursor: pointer;"><i data-lucide="calculator" style="width: 14px; height: 14px; color: #4f46e5;"></i> 计算运费</button>
                                    <button onclick="window.calculateItemizedBilling()" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; height: 32px; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; cursor: pointer;"><i data-lucide="plus-circle" style="width: 14px; height: 14px; color: #10b981;"></i> 单品计费</button>
                                    <button id="save-order-btn" onclick="window.saveOrderEntry()" style="background: #10b981; color: white; border: none; border-radius: 4px; padding: 0 16px; height: 32px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                        <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i> 保存订单
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Basic Info Row -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding-top: 12px; border-top: 1px solid #f1f5f9;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.8rem; color: #64748b; width: 64px; text-align: right;">订单日期:</label>
                                <input id="entry-date" type="date" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.8rem; color: #64748b; width: 64px; text-align: right;">客户名称:</label>
                                <input id="entry-customer" type="text" placeholder="选择客户" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.8rem; color: #64748b; width: 64px; text-align: right;">始发地:</label>
                                <input id="entry-origin" type="text" placeholder="省/市/区" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.8rem; color: #64748b; width: 64px; text-align: right;">目的地:</label>
                                <input id="entry-destination" type="text" placeholder="省/市/区" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Cargo Table Grid -->
                    <div style="flex-grow: 1; min-height: 200px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden; display: flex; flex-direction: column; flex-shrink: 0;">
                        <div style="overflow: auto; flex-grow: 1;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1200px;">
                                <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="width: 40px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px;">#</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: left;">货物名称</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: left;">商品类型</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: right;">件数</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: left;">包装</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: left;">规格</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: right; color: #000000;">重量小计</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: right; color: #000000;">体积小计</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: left;">计价方式</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: right;">车长</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 8px; text-align: right;">运费单价</th>
                                        <th style="border-bottom: 1px solid #e2e8f0; padding: 8px; text-align: right; background: #f8fafc; color: #000000;">运费小计</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="text-align: center; border-right: 1px solid #f1f5f9; padding: 6px; background: #f8fafc; font-weight: 600;">1</td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-name-1" type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-type-1" type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-count-1" type="text" class="cargo-count" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-package-1" type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-spec-1" type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0; background: #fafafa;"><input id="cargo-weight-1" type="text" class="cargo-weight" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; color: #000000; font-weight: 600;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0; background: #fafafa;"><input id="cargo-volume-1" type="text" class="cargo-volume" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; color: #000000; font-weight: 600;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;">
                                            <select id="cargo-pricing-method-1" class="cargo-pricing-method" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; font-size: 0.8rem; cursor: pointer;">
                                                <option value="按件数">按件数</option>
                                                <option value="按重量">按重量</option>
                                                <option value="按体积">按体积</option>
                                                <option value="按计费重量">按计费重量</option>
                                                <option value="按车">按车</option>
                                                <option value="按吨公里">按吨公里</option>
                                            </select>
                                        </td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-truck-len-1" type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input id="cargo-unit-price-1" type="text" class="cargo-unit-price" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="padding: 0;"><input id="cargo-freight-subtotal-1" type="text" class="cargo-freight-subtotal" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; font-weight: 600; color: #000000;"></td>
                                    </tr>
                                    <!-- Additional 2 empty rows just for visuals -->
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="text-align: center; border-right: 1px solid #f1f5f9; padding: 6px; background: #f8fafc; font-weight: 600;">2</td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" class="cargo-count" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0; background: #fafafa;"><input type="text" class="cargo-weight" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; color: #000000; font-weight: 600;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0; background: #fafafa;"><input type="text" class="cargo-volume" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; color: #000000; font-weight: 600;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;">
                                            <select class="cargo-pricing-method" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; font-size: 0.8rem; cursor: pointer;">
                                                <option value="按件数">按件数</option>
                                                <option value="按重量">按重量</option>
                                                <option value="按体积">按体积</option>
                                                <option value="按计费重量">按计费重量</option>
                                                <option value="按车">按车</option>
                                                <option value="按吨公里">按吨公里</option>
                                            </select>
                                        </td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" class="cargo-unit-price" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="padding: 0;"><input type="text" class="cargo-freight-subtotal" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; font-weight: 600; color: #000000;"></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="text-align: center; border-right: 1px solid #f1f5f9; padding: 6px; background: #f8fafc; font-weight: 600;">3</td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" class="cargo-count" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0; background: #fafafa;"><input type="text" class="cargo-weight" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; color: #000000; font-weight: 600;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0; background: #fafafa;"><input type="text" class="cargo-volume" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; color: #000000; font-weight: 600;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;">
                                            <select class="cargo-pricing-method" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; font-size: 0.8rem; cursor: pointer;">
                                                <option value="按件数">按件数</option>
                                                <option value="按重量">按重量</option>
                                                <option value="按体积">按体积</option>
                                                <option value="按计费重量">按计费重量</option>
                                                <option value="按车">按车</option>
                                                <option value="按吨公里">按吨公里</option>
                                            </select>
                                        </td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="border-right: 1px solid #f1f5f9; padding: 0;"><input type="text" class="cargo-unit-price" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right;"></td>
                                        <td style="padding: 0;"><input type="text" class="cargo-freight-subtotal" style="width: 100%; height: 32px; border: none; padding: 0 8px; outline: none; background: transparent; text-align: right; font-weight: 600; color: #000000;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- NEW: Cargo Summary Panel (Top) -->
                    <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 12px 16px; margin-bottom: 12px; display: flex; gap: 24px;">
                        <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <label style="font-size: 0.8rem; color: #475569;">数量合计</label>
                            <input id="summary-count" type="text" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none; font-weight: 600;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <label style="font-size: 0.8rem; color: #475569;">重量合计</label>
                            <input id="summary-weight" type="text" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none; font-weight: 600;">
                        </div>
                         <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <label style="font-size: 0.8rem; color: #475569;">体积合计</label>
                            <input id="summary-volume" type="text" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none; font-weight: 600;">
                        </div>
                         <div style="display: flex; flex-direction: column; gap: 4px; flex: 1.5;">
                            <label style="font-size: 0.8rem; color: #475569;">货物分类</label>
                            <select id="entry-cargo-classification" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; outline: none; padding: 0 8px; background: white;"><option></option></select>
                        </div>
                         <div style="display: flex; flex-direction: column; gap: 4px; flex: 1.5;">
                            <label style="font-size: 0.8rem; color: #475569;">计价方式</label>
                            <select id="summary-pricing-method" onchange="window.syncPricingMethod()" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; outline: none; padding: 0 8px; background: white;">
                                <option value="按件数">按件数</option>
                                <option value="按重量">按重量</option>
                                <option value="按体积">按体积</option>
                                <option value="按计费重量">按计费重量</option>
                                <option value="按车">按车</option>
                                <option value="按吨公里">按吨公里</option>
                            </select>
                        </div>
                    </div>

                    <!-- Summary & Calculation Section (Bottom) -->
                    <div style="display: flex; flex-direction: column; gap: 12px; flex-shrink: 0;">
                        <!-- Middle Calculation Summary -->
                        <div style="width: 100%; background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; overflow: auto; position: relative;">
                            <!-- Config Button -->
                            <div onclick="window.showConfigModal()" style="position: absolute; top: 6px; left: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                                <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px 24px;">
                                <!-- Row 1 -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600;">运  费:</label>
                                    <input id="entry-freight" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">客户计费重:</label>
                                    <input id="entry-billable-weight" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">客户单价:</label>
                                    <input id="entry-unit-price" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                                </div>
                                <!-- Row 2 -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">送 货 费:</label>
                                    <input id="entry-delivery-fee" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">装 货 费:</label>
                                    <input id="entry-loading-fee" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">卸 货 费:</label>
                                    <input id="entry-unloading-fee" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                                </div>
                                <!-- Row 3 -->
                                 <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">附 加 费:</label>
                                    <input id="entry-additional-fee" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">收入合计:</label>
                                    <input id="entry-revenue-total" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #1e293b; font-weight: 700; text-align: right; background: #f1f5f9; cursor: not-allowed;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">待垫合计:</label>
                                    <input id="entry-advance-total" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>

                        <!-- Right Side Mini Tables -->
                        <div style="width: 100%; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                             <!-- Toolbar -->
                             <div style="padding: 8px 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: flex-start; background: #f8fafc;">
                                 <button onclick="window.showExpenseModal()" style="background: #4f46e5; color: white; border: none; border-radius: 4px; padding: 4px 12px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                     <i data-lucide="plus" style="width: 14px; height: 14px;"></i> 新增费用
                                 </button>
                             </div>
                             <!-- Table 1 -->
                             <div style="flex: 1; overflow: auto; border-bottom: 2px solid #e2e8f0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                        <tr>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">费用项目</th>
                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">收入金额</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 35%;">备注</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">状态</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'revenue').map(e => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.itemName || e.id}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;">${e.revenue.toFixed(2)}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.customer}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; white-space: nowrap;">${e.date}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.remark || '-'}</td>
                                                <td style="padding: 4px 8px;"><span style="color: ${e.status === '审核通过' ? '#10b981' : e.status === '审核驳回' ? '#ef4444' : '#f59e0b'}">${e.status}</span></td>
                                            </tr>
                                        `).join('')}
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'revenue').length < 8 ? Array(8 - window.expenseAuditData.filter(e => e.expenseType === 'revenue').length).fill(0).map(() => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px;"></td>
                                            </tr>
                                        `).join('') : ''}
                                    </tbody>
                                </table>
                             </div>
                             <!-- Table 2 -->
                             <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                        <tr>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">费用项目</th>
                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">代垫金额</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">联系人</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">电话</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">备注</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">状态</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'advance').map(e => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.itemName || e.id}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;">${e.cost.toFixed(2)}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.customer}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; white-space: nowrap;">${e.date}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">-</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">-</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.remark || '-'}</td>
                                                <td style="padding: 4px 8px;"><span style="color: ${e.status === '审核通过' ? '#10b981' : e.status === '审核驳回' ? '#ef4444' : '#f59e0b'}">${e.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                    </div>



                    <!-- Bottom Settlement Footer -->
                    <div style="background: #fdf2f2; border: 1px solid #fee2e2; border-radius: 8px; padding: 12px 24px; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.9rem; font-weight: 700; color: #1e293b;">* 结算方式:</label>
                                <div style="display: flex; align-items: center; background: white; border: 1px solid #4f46e5; border-radius: 4px; padding: 0; height: 36px; min-width: 120px;">
                                    <select id="settlementMethod" style="width: 100%; height: 100%; border: none; outline: none; background: transparent; color: #4f46e5; font-weight: 600; padding: 0 12px; cursor: pointer;">
                                        <option value="现付">现付</option>
                                        <option value="到付">到付</option>
                                        <option value="双付">双付</option>
                                        <option value="月结">月结</option>
                                        <option value="回单付">回单付</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: #db2777; font-weight: 600;">现付金额:</label>
                                    <input id="cashAmount" type="text" style="width: 100px; height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; font-weight: 700; color: #000000; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: #db2777; font-weight: 600;">到付金额:</label>
                                    <input id="deliveryAmount" type="text" style="width: 100px; height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; font-weight: 700; color: #000000; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: #db2777; font-weight: 600;">欠付金额:</label>
                                    <input type="text" style="width: 100px; height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; font-weight: 700; color: #000000; text-align: right;">
                                </div>

                                <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #4f46e5; font-weight: 600; cursor: pointer;">
                                    <input type="checkbox" style="width: 18px; height: 18px;"> 到付款月结
                                </label>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else if (activeTab === '运单录入(新)') {
            mainContent = `
                <div style="height: 100%; width: 100%; display: flex; flex-direction: column; background: #f1f5f9;">
                    <!-- Top Tab Bar -->
                    <div style="padding: 0 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 32px;">
                        <div class="waybill-new-tab active" onclick="window.switchWaybillNewTab(this, 'basic')" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer; font-size: 0.9rem;">基本信息</div>
                        <div class="waybill-new-tab" onclick="window.switchWaybillNewTab(this, 'expense')" style="padding: 12px 0; border-bottom: 2px solid transparent; color: #64748b; font-weight: 500; cursor: pointer; font-size: 0.9rem;">费用详情</div>
                    </div>

                    <!-- Content Area -->
                    <div id="waybill-new-content" style="flex: 1; overflow: auto; padding: 16px;">
                        <!-- Default Basic Info Content -->
                        <div id="waybill-new-basic" style="display: block; height: 100%;">
                             <div style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Flex Container for Fees and Expenses -->
                                <!-- Main Container with Vertical Layout -->
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    
                                    <!-- Row 1: Receivable + Expense Table -->
                                    <div style="display: flex; gap: 12px; align-items: stretch;">
                                        <!-- Left: Receivable Panel (35%) -->
                                        <div style="width: 850px; min-width: 850px; max-width: 850px; flex: none; display: flex; flex-direction: column;">
                                            <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; position: relative; height: 100%;">
                                                <div onclick="window.showConfigModal()" style="position: absolute; top: 6px; right: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                                                    <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                                                </div>
                                                <div style="display: grid; grid-template-columns: repeat(3, 264px); gap: 12px; margin-top: 0;">
                                                    <!-- Grid Items -->
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600; white-space: nowrap;">应收运费:</label>
                                                        <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">客户计费重:</label>
                                                        <input id="record-customer-weight" oninput="let target = document.getElementById('record-carrier-weight'); if(target) target.value = this.value;" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">客户单价:</label>
                                                        <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">送 货 费:</label>
                                                        <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">装 货 费:</label>
                                                        <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">卸 货 费:</label>
                                                        <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">附 加 费:</label>
                                                        <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">收入合计:</label>
                                                        <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #1e293b; font-weight: 700; text-align: right; background: #f1f5f9; cursor: not-allowed; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">待垫合计:</label>
                                                        <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right: Expense Table 1 (Flex 1) -->
                                        <div style="flex: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                                            <div style="flex: 1; overflow: auto; min-height: 140px;">
                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                                        <tr>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">费用项目</th>
                                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">费用金额</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">费用类型</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">计费日期</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">联系人</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">电话</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">备注</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 7%;">状态</th>
                                                            <th style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 8%;">操作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                         ${Array(4).fill(0).map(() => `
                                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                                <td style="padding: 4px 8px; text-align: center;">
                                                                    <button style="border: none; background: transparent; color: #ef4444; cursor: pointer; padding: 2px;">
                                                                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                <!-- Settlement Module (Bottom) -->
                                <div id="financial-settlement-module" style="background: #fdf2f2; border: 1px solid #fee2e2; border-radius: 8px; padding: 8px 16px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 0.85rem; font-weight: 700; color: #1e293b;">* 结算方式:</label>
                                            <div style="display: flex; align-items: center; background: white; border: 1px solid #4f46e5; border-radius: 4px; padding: 0; height: 30px; min-width: 100px;">
                                                <select style="width: 100%; height: 100%; border: none; outline: none; background: transparent; color: #4f46e5; font-weight: 600; padding: 0 8px; cursor: pointer; font-size: 0.85rem;">
                                                    <option value="现付">现付</option>
                                                    <option value="到付">到付</option>
                                                    <option value="双付">双付</option>
                                                    <option value="月结">月结</option>
                                                    <option value="回单付">回单付</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; align-items: center; gap: 16px;">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 0.8rem; color: #db2777; font-weight: 600;">现付金额:</label>
                                                <input type="text" style="width: 80px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; font-weight: 700; color: #000000; text-align: right;">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 0.8rem; color: #db2777; font-weight: 600;">到付金额:</label>
                                                <input type="text" style="width: 80px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; font-weight: 700; color: #000000; text-align: right;">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 0.8rem; color: #db2777; font-weight: 600;">欠付金额:</label>
                                                <input type="text" style="width: 80px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; font-weight: 700; color: #000000; text-align: right;">
                                            </div>

                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #4f46e5; font-weight: 600; cursor: pointer;">
                                                <input type="checkbox" style="width: 16px; height: 16px;"> 到付款月结
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Payable + Expense Table 2 (Moved down) -->
                                <div style="display: flex; gap: 12px; align-items: stretch;">
                                    <!-- Left: Payable Panel (35%) -->
                                    <div style="width: 850px; min-width: 850px; max-width: 850px; flex: none; display: flex; flex-direction: column;">
                                        <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; position: relative; height: 100%;">
                                            <div onclick="window.showConfigModal()" style="position: absolute; top: 6px; right: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                                                <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 264px); gap: 12px; margin-top: 0;">
                                                <!-- Row 1 -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600; white-space: nowrap;">应付运费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">承运计费重:</label>
                                                    <input id="record-carrier-weight" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">承运单价:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <!-- Row 2 -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">预付车费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">到付车费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">回付车费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                 <!-- Row 3 -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">信 息 费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">拦 标 价:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right: Expense Table 2 (Duplicate, Flex 1) -->
                                    <div style="flex: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                                        <div style="flex: 1; overflow: auto; min-height: 140px;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                                    <tr>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">费用项目</th>
                                                        <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">费用金额</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">费用类型</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">计费日期</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">联系人</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">电话</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">备注</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 7%;">状态</th>
                                                        <th style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 8%;">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                     ${Array(4).fill(0).map(() => `
                                                        <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                            <td style="padding: 4px 8px; text-align: center;">
                                                                <button style="border: none; background: transparent; color: #ef4444; cursor: pointer; padding: 2px;">
                                                                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </div>
                        <!-- Expense Content (Hidden by default) -->
                         <div id="waybill-new-expense" style="display: none; height: 100%; flex-direction: column; gap: 16px;">
                                <!-- Receivable Section -->
                                <div style="display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <!-- Toolbar -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f0f9ff; border-bottom: 1px solid #e2e8f0;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 600; color: #0284c7; cursor: pointer;">
                                                <input type="radio" name="expense-tab-type" checked style="accent-color: #0284c7;"> 应收
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #475569; cursor: pointer;">
                                                <input type="checkbox" style="border-radius: 2px;"> 完成收款
                                            </label>
                                            
                                            <!-- Buttons -->
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                                    新增 <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
                                                </button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">开票申请</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">生成账单</button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量修改</button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量删除</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">自动计算</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">参考费用</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">费用模板</button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                                    提交审核 <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.75rem; color: #64748b; display: flex; gap: 12px;">
                                            <span>客户报价: 0.00/KG</span>
                                            <span>结算单计费重量: 0.000</span>
                                        </div>
                                    </div>
                                    <!-- Copied Receivable Panel from Basic Info (Image 1) -->
                                    <div style="padding: 12px; background: white; border-bottom: 1px solid #e2e8f0;">
                                        <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; position: relative;">
                                            <div onclick="window.showConfigModal()" style="position: absolute; top: 6px; right: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                                                <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 264px); gap: 12px; margin-top: 0;">
                                                <!-- Grid Items -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600; white-space: nowrap;">应收运费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">客户计费重:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">客户单价:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                </div>
                                                
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">送 货 费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">装 货 费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">卸 货 费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                </div>
                                                
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">附 加 费:</label>
                                                    <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">收入合计:</label>
                                                    <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #1e293b; font-weight: 700; text-align: right; background: #f1f5f9; cursor: not-allowed; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">待垫合计:</label>
                                                    <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Table -->
                                    <div style="overflow-x: auto; min-height: 150px;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap;">
                                            <thead style="background: #f8fafc;">
                                                <tr>
                                                    <th style="padding: 6px 4px; border-bottom: 1px solid #e2e8f0; width: 30px; text-align: center;"><input type="checkbox" onclick="window.toggleAllExpenseRows(this, 'receivable')"></th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 30px;">#</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">类别</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">结算公司</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">费用</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">金额</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">单价</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">数量</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">计费日期</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">币别</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">备注</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">汇率</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">税率</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">本币金额</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">关联状态</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">已销账</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">未销余额</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">实收实付</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销时间</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">对账单号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">形单号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">核销状态</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销单号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">发票号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Empty State -->
                                                <tr>
                                                    <td colspan="25" style="padding: 40px 0; text-align: center; color: #94a3b8;">
                                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                            <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                                            <span>暂无数据</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Payable Section -->
                                <div style="display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <!-- Toolbar -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f0f9ff; border-bottom: 1px solid #e2e8f0;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 600; color: #0284c7; cursor: pointer;">
                                                <input type="radio" name="expense-tab-type-pay" checked style="accent-color: #0284c7;"> 应付
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #475569; cursor: pointer;">
                                                <input type="checkbox" style="border-radius: 2px;"> 完成付款
                                            </label>
                                            
                                            <!-- Buttons -->
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                                    新增 <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
                                                </button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">
                                                    复制到应付 <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
                                                </button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">付款申请</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">生成账单</button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量修改</button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量删除</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">自动计算</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">参考费用</button>
                                                <button style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">费用模板</button>
                                                <button style="padding: 4px 10px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                                    提交审核 <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.75rem; color: #64748b; display: flex; gap: 12px;">
                                            <span>承运商报价: 0.00/KG</span>
                                            <span>订单计费重量: 0.000</span>
                                        </div>
                                    </div>
                                    <!-- Table -->
                                    <div style="overflow-x: auto; min-height: 150px;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap;">
                                            <thead style="background: #f8fafc;">
                                                <tr>
                                                    <th style="padding: 6px 4px; border-bottom: 1px solid #e2e8f0; width: 30px; text-align: center;"><input type="checkbox" onclick="window.toggleAllExpenseRows(this, 'receivable')"></th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 30px;">#</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">类别</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">结算公司</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">费用</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">金额</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">单价</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">数量</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">计费日期</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">币别</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">备注</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">汇率</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">税率</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">本币金额</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">关联状态</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">已销账</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">未销余额</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">实收实付</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销时间</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">对账单号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">形单号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">核销状态</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销单号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">发票号</th>
                                                    <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Empty State -->
                                                <tr>
                                                    <td colspan="25" style="padding: 40px 0; text-align: center; color: #94a3b8;">
                                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                            <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                                            <span>暂无数据</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // Helper function for switching tabs within this page
            if (!window.switchWaybillNewTab) {
                window.switchWaybillNewTab = function (el, type) {
                    // Update tab styles
                    document.querySelectorAll('.waybill-new-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.borderBottomColor = 'transparent';
                        t.style.color = '#64748b';
                    });
                    el.classList.add('active');
                    el.style.borderBottomColor = '#4f46e5';
                    el.style.color = '#4f46e5';

                    // Toggle content
                    const basicContent = document.getElementById('waybill-new-basic');
                    const expenseContent = document.getElementById('waybill-new-expense');

                    if (basicContent && expenseContent) {
                        if (type === 'basic') {
                            basicContent.style.display = 'block';
                            expenseContent.style.display = 'none';
                        } else {
                            basicContent.style.display = 'none';
                            expenseContent.style.display = 'flex';
                        }
                    }
                };
            }
        } else if (activeTab === '费用录入') {
            mainContent = `
                <div style="height: 100%; width: 100%; display: flex; flex-direction: column; background: #f1f5f9; overflow: auto; padding: 16px;">
                    <div style="margin-bottom: 8px;">
                        <button onclick="window.saveExpenseEntryAndSyncToPanel()" style="background: #4f46e5; color: white; padding: 6px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                            <i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存
                        </button>
                    </div>
                    <div id="expense-entry-basic" style="display: block; height: 100%;">
                             <div style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Flex Container for Fees and Expenses -->
                                <!-- Main Container with Vertical Layout -->
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    
                                    <!-- Row 1: Receivable + Expense Table -->
                                    <div style="display: flex; gap: 12px; align-items: stretch;">
                                        <!-- Left: Receivable Panel (35%) -->
                                        <div style="width: 850px; min-width: 850px; max-width: 850px; flex: none; display: flex; flex-direction: column;">
                                            <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; position: relative; height: 100%;">
                                                <div onclick="window.showConfigModal('receivable')" style="position: absolute; top: 6px; right: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                                                    <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                                                </div>
                                                <div id="expense-entry-receivable-grid" style="display: grid; grid-template-columns: repeat(3, 264px); gap: 12px; margin-top: 0;">
                                                    <!-- Grid Items -->
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600; white-space: nowrap;">应收运费:</label>
                                                        <input id="expense-entry-receivable-freight" onchange="window.handleFreightCalc('receivable', 'freight'); window.handleAdvanceTotal()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">客户计费重:</label>
                                                        <input id="expense-entry-customer-weight" oninput="let target = document.getElementById('expense-entry-carrier-weight'); if(target) target.value = this.value;" onchange="window.handleFreightCalc('payable', 'weight'); window.handleFreightCalc('receivable', 'weight');" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">客户单价:</label>
                                                        <input id="expense-entry-customer-unit-price" onchange="window.handleFreightCalc('receivable', 'price')" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">送 货 费:</label>
                                                        <input id="expense-entry-delivery-fee" onchange="window.handleAdvanceTotal()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">装 货 费:</label>
                                                        <input id="expense-entry-loading-fee" onchange="window.handleAdvanceTotal()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">卸 货 费:</label>
                                                        <input id="expense-entry-unloading-fee" onchange="window.handleAdvanceTotal()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right; min-width: 0;">
                                                    </div>
                                                    
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">附 加 费:</label>
                                                        <input id="expense-entry-additional-fee" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">收入合计:</label>
                                                         <input id="expense-entry-income-total" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                        <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">待垫合计:</label>
                                                        <input id="expense-entry-advance-total" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed; min-width: 0;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right: Expense Table 1 (Flex 1) -->
                                        <div style="flex: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                                            <div style="padding: 6px 12px; background: #f0f9ff; border-bottom: 1px solid #e2e8f0; font-size: 0.8rem; font-weight: 600; color: #0369a1;">应收附加费</div>
                                            <div style="overflow-y: auto; height: 135px;">
                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                                        <tr>
                                                            <th style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 30px;"><button onclick="window.addFeeEntryRow('income')" style="width: 20px; height: 20px; padding: 0; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="新增"><i data-lucide="plus" style="width: 14px; height: 14px;"></i></button></th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">费用</th>
                                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">费用金额</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">类别</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">计费日期</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">联系人</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">电话</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">备注</th>
                                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 7%;">状态</th>
                                                            <th style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 8%;">操作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="fee-entry-income-tbody">
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                <!-- Settlement Module (Bottom) -->
                                <div id="financial-settlement-module" style="background: #fdf2f2; border: 1px solid #fee2e2; border-radius: 8px; padding: 8px 16px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 0.85rem; font-weight: 700; color: #1e293b;">* 结算方式:</label>
                                            <div style="display: flex; align-items: center; background: white; border: 1px solid #4f46e5; border-radius: 4px; padding: 0; height: 30px; min-width: 100px;">
                                                <select id="settlement-mode-select" onchange="window.handleSettlementModeChange()" style="width: 100%; height: 100%; border: none; outline: none; background: transparent; color: #4f46e5; font-weight: 600; padding: 0 8px; cursor: pointer; font-size: 0.85rem;">
                                                    <option value="现付">现付</option>
                                                    <option value="到付">到付</option>
                                                    <option value="双付">双付</option>
                                                    <option value="月结">月结</option>
                                                    <option value="回单付">回单付</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; align-items: center; gap: 16px;">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 0.8rem; color: #db2777; font-weight: 600;">现付金额:</label>
                                                <input id="spot-pay-input" type="text" style="width: 80px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; font-weight: 700; color: #000000; text-align: right;">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 0.8rem; color: #db2777; font-weight: 600;">到付金额:</label>
                                                <input id="freight-collect-input" type="text" style="width: 80px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; font-weight: 700; color: #000000; text-align: right;">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 0.8rem; color: #db2777; font-weight: 600;">欠付金额:</label>
                                                <input type="text" style="width: 80px; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; font-weight: 700; color: #000000; text-align: right;">
                                            </div>

                                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #4f46e5; font-weight: 600; cursor: pointer;">
                                                <input type="checkbox" style="width: 16px; height: 16px;"> 到付款月结
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Payable + Expense Table 2 (Moved down) -->
                                <div style="display: flex; gap: 12px; align-items: stretch;">
                                    <!-- Left: Payable Panel (35%) -->
                                    <div style="width: 850px; min-width: 850px; max-width: 850px; flex: none; display: flex; flex-direction: column;">
                                        <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; position: relative; height: 100%;">
                                            <div onclick="window.showConfigModal('payable')" style="position: absolute; top: 6px; right: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                                                <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                                            </div>
                                            <div id="expense-entry-payable-grid" style="display: grid; grid-template-columns: repeat(3, 264px); gap: 12px; margin-top: 0;">
                                                <!-- Row 1 -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600; white-space: nowrap;">应付运费:</label>
                                                    <input id="expense-entry-payable-freight" onchange="window.handleFreightCalc('payable', 'freight')" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">承运计费重:</label>
                                                    <input id="expense-entry-carrier-weight" onchange="window.handleFreightCalc('payable', 'weight')" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">承运单价:</label>
                                                    <input id="expense-entry-carrier-unit-price" onchange="window.handleFreightCalc('payable', 'price')" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <!-- Row 2 -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">油费:</label>
                                                    <input id="expense-entry-oil-fee" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">到付车费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">回付车费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                 <!-- Row 3 -->
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">信 息 费:</label>
                                                    <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">拦 标 价:</label>
                                                    <input type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0; background: #f8fafc; cursor: not-allowed;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right: Expense Table 2 (Duplicate, Flex 1) -->
                                    <div style="flex: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                                        <div style="padding: 6px 12px; background: #fef2f2; border-bottom: 1px solid #fecaca; font-size: 0.8rem; font-weight: 600; color: #dc2626;">应付附加费</div>
                                        <div style="overflow-y: auto; height: 135px;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                                    <tr>
                                                        <th style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 30px;"><button onclick="window.addFeeEntryRow('cost')" style="width: 20px; height: 20px; padding: 0; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="新增"><i data-lucide="plus" style="width: 14px; height: 14px;"></i></button></th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">费用</th>
                                                        <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">费用金额</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">类别</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 12%;">计费日期</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">联系人</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 8%;">电话</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">备注</th>
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 7%;">状态</th>
                                                        <th style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 8%;">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="fee-entry-cost-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </div>
                </div>`;
        } else if (activeTab === '费用面板') {
            mainContent = `
                <div style="height: 100%; width: 100%; display: flex; flex-direction: column; background: #f1f5f9; padding: 16px; gap: 16px; overflow: auto;">
                    <!-- Receivable Section -->
                    <div style="display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                        <!-- Summary Strip -->
                        <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="primary-btn" onclick="window.saveExpensePanelData()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px;">保存</button>
                                <button onclick="window.completeExpensePanel()" style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; color: #475569;">完结</button>
                            </div>
                            <div style="display: flex; gap: 32px; text-align: center;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">毛利率</span>
                                    <span id="summary-gross-margin" style="font-weight: 700; font-size: 1.1rem; color: #1e293b;">0%</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">应收</span>
                                    <span id="summary-receivable" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">应付</span>
                                    <span id="summary-payable" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">分摊成本</span>
                                    <span id="summary-allocated-cost" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">分摊收入</span>
                                    <span id="summary-allocated-income" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">公司利润</span>
                                    <span id="summary-profit" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">其它费用</span>
                                    <span id="summary-other-expense" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Toolbar -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f0f9ff; border-bottom: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 600; color: #0284c7; cursor: pointer;">
                                    <input type="radio" name="expense-panel-tab-type" checked style="accent-color: #0284c7;"> 应收
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #475569; cursor: pointer;">
                                    <input type="checkbox" style="border-radius: 2px;"> 完成应收
                                </label>
                                
                                <!-- Buttons -->
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <button class="primary-btn" onclick="window.addExpenseRow('receivable')" style="height: 32px; padding: 0 16px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">新增</button>
                                    <button onclick="window.copyToReceivableRow()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">复制到应收</button>
                                    <button onclick="window.goToInvoiceApplication()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">开票申请</button>
                                    <button onclick="window.jumpToStatementCreationFromExpensePanel()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">生成账单</button>
                                    <button onclick="window.batchModifyRow('receivable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量修改</button>
                                    <button onclick="window.batchDeleteRow('receivable')" style="padding: 4px 10px; background: white; color: #dc2626; border: 1px solid #fecaca; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量删除</button>
                                    <button onclick="window.openFeeTemplateModal([], 'receivable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">费用模版</button>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b; display: flex; gap: 12px;">
                                <span>客户报价: 0.00/KG</span>
                                <span>结算单计费重量: 0.000</span>
                            </div>
                        </div>
                        <!-- Table -->
                        <div style="overflow-x: auto; min-height: 200px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap;">
                                <thead style="background: #f8fafc;">
                                    <tr>
                                        <th style="padding: 6px 4px; border-bottom: 1px solid #e2e8f0; width: 30px; text-align: center;"><input type="checkbox" onclick="window.toggleAllExpenseRows(this, 'receivable')"></th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 30px;">#</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">类别</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">结算公司</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">费用</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">金额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">单价</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">数量</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">计费日期</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">币别</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">备注</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">汇率</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">税率</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">本币金额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">关联状态</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">已销账</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">未销余额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">实收实付</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销时间</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">对账单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">账单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">核销状态</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">发票号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-receivable-tbody">
                                    <!-- Empty State -->
                                    <tr>
                                        <td colspan="25" style="padding: 40px 0; text-align: center; color: #94a3b8;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                                <span>暂无数据</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Payable Section -->
                    <div style="display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                        <!-- Toolbar -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f0f9ff; border-bottom: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 600; color: #0284c7; cursor: pointer;">
                                    <input type="radio" name="expense-panel-tab-type-pay" checked style="accent-color: #0284c7;"> 应付
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #475569; cursor: pointer;">
                                    <input type="checkbox" style="border-radius: 2px;"> 完成应付
                                </label>
                                
                                <!-- Buttons -->
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <button class="primary-btn" onclick="window.addExpenseRow('payable')" style="height: 32px; padding: 0 16px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">新增</button>
                                    <button onclick="window.copyToPayableRow()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">复制到应付</button>
                                    <button onclick="window.goToPaymentApplication()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">付款申请</button>
                                    <button onclick="window.jumpToStatementCreationFromExpensePanel()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">生成账单</button>
                                    <button onclick="window.batchModifyRow('payable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量修改</button>
                                    <button onclick="window.batchDeleteRow('payable')" style="padding: 4px 10px; background: white; color: #dc2626; border: 1px solid #fecaca; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量删除</button>
                                    <button onclick="window.openFeeTemplateModal([], 'payable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">费用模版</button>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b; display: flex; gap: 12px;">
                                <span>承运商报价: 0.00/KG</span>
                                <span>订单计费重量: 0.000</span>
                            </div>
                        </div>
                        <!-- Table -->
                        <div style="overflow-x: auto; min-height: 200px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap;">
                                <thead style="background: #f8fafc;">
                                    <tr>
                                        <th style="padding: 6px 4px; border-bottom: 1px solid #e2e8f0; width: 30px; text-align: center;"><input type="checkbox" onclick="window.toggleAllExpenseRows(this, 'payable')"></th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 30px;">#</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">类别</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">结算公司</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">费用</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">金额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">单价</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">数量</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">计费日期</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">币别</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">备注</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">汇率</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">税率</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">本币金额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">关联状态</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">已销账</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">未销余额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">实收实付</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销时间</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">对账单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">账单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">核销状态</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">发票号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-payable-tbody">
                                    <!-- Empty State -->
                                    <tr>
                                        <td colspan="25" style="padding: 40px 0; text-align: center; color: #94a3b8;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                                <span>暂无数据</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        } else if (activeTab === '配载费用') {
            mainContent = `
                <div style="height: 100%; width: 100%; display: flex; flex-direction: column; background: #f1f5f9; padding: 16px; gap: 16px; overflow: auto;">
                    <!-- Payable Section Only -->
                    <div style="display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                        <!-- Summary Strip -->
                        <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="primary-btn" onclick="window.saveExpensePanelData()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px;">保存</button>
                                <button onclick="window.completeExpensePanel()" style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; color: #475569;">完结</button>
                            </div>
                            <div style="display: flex; gap: 32px; text-align: center;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">毛利率</span>
                                    <span id="summary-gross-margin" style="font-weight: 700; font-size: 1.1rem; color: #1e293b;">0%</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">应收</span>
                                    <span id="summary-receivable" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">应付</span>
                                    <span id="summary-payable" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">分摊成本</span>
                                    <span id="summary-allocated-cost" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">分摊收入</span>
                                    <span id="summary-allocated-income" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">公司利润</span>
                                    <span id="summary-profit" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                                 <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #64748b; font-size: 0.75rem;">其它费用</span>
                                    <span id="summary-other-expense" style="font-weight: 600; color: #1e293b;">0.00</span>
                                </div>
                            </div>
                        </div>
                        <!-- Toolbar -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f0f9ff; border-bottom: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; font-weight: 600; color: #0284c7; cursor: pointer;">
                                    <input type="radio" name="expense-panel-tab-type-pay-dispatch" checked style="accent-color: #0284c7;"> 应付
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #475569; cursor: pointer;">
                                    <input type="checkbox" style="border-radius: 2px;"> 完成应付
                                </label>
                                
                                <!-- Buttons -->
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <button class="primary-btn" onclick="window.addExpenseRow('payable')" style="height: 32px; padding: 0 16px; background: #dbeafe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 2px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">新增</button>
                                    <button onclick="window.copyToPayableRow()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">复制到应付</button>
                                    <button onclick="window.goToPaymentApplication()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">付款申请</button>
                                    <button onclick="window.jumpToStatementCreationFromExpensePanel()" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">生成账单</button>
                                    <button onclick="window.batchModifyRow('payable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量修改</button>
                                    <button onclick="window.batchDeleteRow('payable')" style="padding: 4px 10px; background: white; color: #dc2626; border: 1px solid #fecaca; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量删除</button>
                                    <button onclick="window.batchAllocateExpense('payable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">批量分摊</button>
                                    <button onclick="window.openFeeTemplateModal([], 'payable')" style="padding: 4px 10px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 0.75rem; cursor: pointer;">费用模版</button>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b; display: flex; gap: 12px;">
                                <span>承运商报价: 0.00/KG</span>
                                <span>订单计费重量: 0.000</span>
                            </div>
                        </div>
                        <!-- Table -->
                        <div style="overflow-x: auto; min-height: 200px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap;">
                                <thead style="background: #f8fafc;">
                                    <tr>
                                        <th style="padding: 6px 4px; border-bottom: 1px solid #e2e8f0; width: 30px; text-align: center;"><input type="checkbox" onclick="window.toggleAllExpenseRows(this, 'payable')"></th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center; width: 30px;">#</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">类别</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">结算公司</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">费用</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">金额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">单价</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">数量</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">计费日期</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">币别</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">备注</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">汇率</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">税率</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">本币金额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">关联状态</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">已销账</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">未销余额</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: right;">实收实付</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销时间</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">对账单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">账单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">核销状态</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">核销单号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: left;">发票号</th>
                                        <th style="padding: 6px 8px; border-bottom: 1px solid #e2e8f0; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-payable-tbody">
                                    <!-- Empty State -->
                                    <tr>
                                        <td colspan="25" style="padding: 40px 0; text-align: center; color: #94a3b8;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                                <span>暂无数据</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        } else if (activeTab === '订单回显') {
            // Sample order data for display
            const orderDisplayData = window.orderDisplayData || [
                { orderNo: 'WB20250101001', receivable: 1500.00, payable: 1000.00, profit: 500.00 },
                { orderNo: 'WB20250101002', receivable: 2800.00, payable: 2000.00, profit: 800.00 },
                { orderNo: 'WB20250101003', receivable: 3200.00, payable: 2500.00, profit: 700.00 },
                { orderNo: 'WB20250101004', receivable: 1800.00, payable: 1200.00, profit: 600.00 },
                { orderNo: 'WB20250101005', receivable: 4500.00, payable: 3800.00, profit: 700.00 }
            ];

            // Calculate totals
            const totalOrders = orderDisplayData.length;
            const totalReceivable = orderDisplayData.reduce((sum, o) => sum + o.receivable, 0);
            const totalPayable = orderDisplayData.reduce((sum, o) => sum + o.payable, 0);
            const totalProfit = orderDisplayData.reduce((sum, o) => sum + o.profit, 0);
            const grossMargin = totalReceivable > 0 ? ((totalProfit / totalReceivable) * 100).toFixed(2) : 0;

            // Build table rows
            let tableRows = '';
            orderDisplayData.forEach(order => {
                tableRows += '<tr style="border-bottom: 1px solid #f1f5f9;">' +
                    '<td style="width: 25%; padding: 12px 16px; color: #4f46e5; font-weight: 500;">' + order.orderNo + '</td>' +
                    '<td style="width: 25%; padding: 12px 16px; text-align: right; color: #10b981; font-weight: 600;">' + order.receivable.toFixed(2) + '</td>' +
                    '<td style="width: 25%; padding: 12px 16px; text-align: right; color: #ef4444; font-weight: 600;">' + order.payable.toFixed(2) + '</td>' +
                    '<td style="width: 25%; padding: 12px 16px; text-align: right; color: #1e293b; font-weight: 700;">' + order.profit.toFixed(2) + '</td>' +
                    '</tr>';
            });

            mainContent = `
                <div style="height: 100%; width: 100%; display: flex; flex-direction: column; background: #f8fafc; padding: 24px; align-items: center;">
                    <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden; display: flex; flex-direction: column; width: 1500px; height: 250px;">
                        <!-- Header -->
                        <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                            <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1e293b;">订单回显</h3>
                        </div>
                        
                        <!-- Table -->
                        <div style="flex: 1; overflow: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                    <tr>
                                        <th style="width: 25%; padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #475569;">运单号</th>
                                        <th style="width: 25%; padding: 12px 16px; text-align: right; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #475569;">应收</th>
                                        <th style="width: 25%; padding: 12px 16px; text-align: right; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #475569;">应付</th>
                                        <th style="width: 25%; padding: 12px 16px; text-align: right; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #475569;">利润</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary Footer -->
                        <div style="padding: 16px 24px; border-top: 2px solid #e2e8f0; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 0.9rem; font-weight: 600; color: #1e293b;">合计</span>
                                <span style="font-size: 0.85rem; color: #64748b;">共 <strong style="color: #4f46e5;">${totalOrders}</strong> 个运单</span>
                            </div>
                            <div style="display: flex; gap: 24px; align-items: center;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                    <span style="font-size: 0.75rem; color: #64748b;">总应收</span>
                                    <span style="font-size: 1rem; font-weight: 700; color: #10b981;">${totalReceivable.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                    <span style="font-size: 0.75rem; color: #64748b;">总应付</span>
                                    <span style="font-size: 1rem; font-weight: 700; color: #ef4444;">${totalPayable.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                    <span style="font-size: 0.75rem; color: #64748b;">总利润</span>
                                    <span style="font-size: 1rem; font-weight: 700; color: #1e293b;">${totalProfit.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px; padding-left: 16px; border-left: 1px solid #e2e8f0;">
                                    <span style="font-size: 0.75rem; color: #64748b;">毛利率</span>
                                    <span style="font-size: 1.1rem; font-weight: 700; color: #4f46e5;">${grossMargin}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else if (activeTab === '任务中心') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Filter Area -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px;">
                        <div class="internal-tabs" style="display: flex; gap: 24px; font-size: 0.85rem; color: #475569;">
                            <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 500; cursor: pointer;">待处理</div>
                            <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">我发起的</div>
                            <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已处理</div>
                            <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">关于我的</div>
                        </div>
                    </div>

                    <!-- Table List -->
                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>申请单号</th>
                                    <th>分类</th>
                                    <th>业务说明</th>
                                    <th>所属公司</th>
                                    <th>处理单位</th>
                                    <th>申请金额</th>
                                    <th>流程名称</th>
                                    <th>当前节点</th>
                                    <th>审核状态</th>
                                    <th>发起人</th>
                                    <th>申请时间</th>
                                    <th>流程开始时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${window.taskCenterData.length > 0 ? window.taskCenterData.map((task, index) => `
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="text-align: center; padding: 12px;">${index + 1}</td>
                                        <td style="padding: 12px; color: #4f46e5;">${task.title}</td>
                                        <td style="padding: 12px;">${task.type}</td>
                                        <td style="padding: 12px;">${task.content}</td>
                                        <td style="padding: 12px;">总公司</td>
                                        <td style="padding: 12px;">财务部</td>
                                        <td style="padding: 12px;">-</td>
                                        <td style="padding: 12px;">标准审批流</td>
                                        <td style="padding: 12px;">一级审批</td>
                                        <td style="padding: 12px;"><span style="background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${task.status}</span></td>
                                        <td style="padding: 12px;">${task.user}</td>
                                        <td style="padding: 12px;">${task.time}</td>
                                        <td style="padding: 12px;">${task.time}</td>
                                        <td style="padding: 12px;">
                                            <a href="#" style="color: #4f46e5;">办理</a>
                                        </td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="14" style="text-align: center; padding: 40px; color: #94a3b8;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                                <i data-lucide="inbox" style="width: 48px; height: 48px; color: #cbd5e1;"></i>
                                                暂无待办任务
                                            </div>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
             `;
        } else if (activeTab === '应收明细') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                    <!-- Status Bar (Responsive: Horizontal Scroll) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待出账单 (89)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待对账(月结) (14)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">未开票 (133)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">申请开票中 (0)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已开票 (5)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">未核销 (115)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">预收待到账 (0)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">部分核销 (0)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已核销 (23)</div>
                    </div>

                    <!-- Filter Bar (Responsive: Wrapping) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>工作单日期</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <div class="select-box" style="width: 80px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>关键字</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <input type="text" placeholder="请输入系统单号/工作单号/客户名称" style="width: 240px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white; color: #64748b;"><span>销账状态</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white; color: #64748b;"><span>账单状态</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white; color: #64748b;"><span>对账状态</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white; color: #64748b;"><span>费用审核</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>

                         <div style="flex: 1; min-width: 10px;"></div> <!-- Spacer -->

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 创建账单</button>
                         <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #cbd5e1; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: not-allowed; white-space: nowrap;"><i data-lucide="file-plus" style="width: 14px; height: 14px;"></i> 按票生成账单</button>
                    </div>

                    <!-- Table List -->
                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                         <table class="statement-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;"><input type="checkbox"></th>
                                    <th style="width: 40px; text-align: center;">#</th>
                                    <th>来源</th>
                                    <th>AR/AP</th>
                                    <th>单据类型</th>
                                    <th>系统单号</th>
                                    <th>结算公司</th>
                                    <th>工作单日期</th>
                                    <th>计费日期</th>
                                    <th>币制</th>
                                    <th>税率</th>
                                    <th>数量</th>
                                    <th>单位</th>
                                    <th>含税金额</th>
                                    <th>已销金额</th>
                                    <th>未销金额</th>
                                </tr>
                            </thead>
                            <tbody>
                                 <tr style="border-bottom: 1px solid #f1f5f9;">
                                     <td style="text-align: center; padding: 12px;"><input type="checkbox"></td>
                                     <td style="text-align: center; padding: 12px;">1</td>
                                     <td style="padding: 12px;">费用</td>
                                     <td style="padding: 12px;">AR</td>
                                     <td style="padding: 12px;">整车</td>
                                     <td style="padding: 12px; color: #4f46e5;">S20231201001</td>
                                     <td style="padding: 12px;">深圳市远航达</td>
                                     <td style="padding: 12px;">2023-12-01</td>
                                     <td style="padding: 12px;">2023-12-01</td>
                                     <td style="padding: 12px;">USD</td>
                                     <td style="padding: 12px;">6%</td>
                                     <td style="padding: 12px;">1</td>
                                     <td style="padding: 12px;">BOX</td>
                                     <td style="padding: 12px; text-align: right;">1000.00</td>
                                     <td style="padding: 12px; text-align: right;">0.00</td>
                                     <td style="padding: 12px; text-align: right;">1000.00</td>
                                 </tr>
                            </tbody>
                         </table>
                    </div>
                </div>
            `;
        } else if (activeTab === '应付明细') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                    <!-- Status Bar (Responsive) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待收票 (45)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待对账 (12)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待付款 (88)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">部分付款 (2)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已付款 (150)</div>
                    </div>

                     <!-- Filter Bar (Responsive) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>工作单日期</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <div class="select-box" style="width: 80px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>关键字</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <input type="text" placeholder="请输入系统单号/工作单号/供应商名称" style="width: 240px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         
                         <div style="flex: 1; min-width: 10px;"></div>

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                         <button style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #4f46e5; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="download" style="width: 14px; height: 14px;"></i> 导出</button>
                    </div>

                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                          <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                <span>暂无数据</span>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '客户账单') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                     <!-- Status Bar (Responsive) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待确认 (5)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待开票 (10)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">部分开票 (2)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已开票 (50)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已核销 (45)</div>
                    </div>

                     <!-- Filter Bar (Responsive) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>账单日期</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <input type="text" placeholder="账单号/客户名称" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         
                         <div style="flex: 1; min-width: 10px;"></div>

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                    </div>

                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                           <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                <span>暂无数据</span>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '收付款') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                    <!-- Status Bar (Responsive) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待核销 (15)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已核销 (120)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">部分核销 (3)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">预收待确认 (2)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">退款处理 (1)</div>
                    </div>

                     <!-- Filter Bar (Responsive) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>日期类型</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>收款账户</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <input type="text" placeholder="对方单位/流水号/摘要" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         
                         <div style="flex: 1; min-width: 10px;"></div>

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                         <button onclick="window.openReceiptCreateView()" style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; color: #4f46e5; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 新增收款</button>
                    </div>

                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                           <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i data-lucide="search-x" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                <span>暂无数据</span>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '付款申请') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                    <!-- Status Bar (Responsive) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待提交 (5)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">审核中 (8)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待付款 (10)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已付款 (150)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已驳回 (2)</div>
                    </div>

                     <!-- Filter Bar (Responsive) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>申请日期</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>申请人</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <input type="text" placeholder="单号/收款单位" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         
                         <div style="flex: 1; min-width: 10px;"></div>

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                         <button onclick="showPaymentApplicationModal()" style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 申请付款</button>
                    </div>

                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                           <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i data-lucide="file-check" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                <span>暂无数据</span>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '发票管理') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                    <!-- Status Bar (Responsive) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待开票 (12)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已开票 (130)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已作废 (2)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">红冲 (0)</div>
                    </div>

                     <!-- Filter Bar (Responsive) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>开票日期</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <div class="select-box" style="width: 120px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>开票单位</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <input type="text" placeholder="发票号码/客户名称" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         
                         <div style="flex: 1; min-width: 10px;"></div>

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 登记发票</button>
                    </div>

                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                           <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i data-lucide="receipt" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                <span>暂无数据</span>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        } else if (activeTab === '开票申请') {
            mainContent = `
                <div class="statement-main" style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden;">
                    <!-- Status Bar (Responsive) -->
                    <div style="padding: 12px 24px; border-bottom: 1px solid #e2e8f0; background: white; display: flex; align-items: center; gap: 24px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch;">
                         <div class="internal-tab active" style="padding: 12px 0; border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; cursor: pointer;">全部</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待审核 (5)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">待开票 (8)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已开票 (50)</div>
                         <div class="internal-tab" style="padding: 12px 0; cursor: pointer;">已驳回 (1)</div>
                    </div>

                     <!-- Filter Bar (Responsive) -->
                    <div style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; flex-shrink: 0;">
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>申请日期</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" placeholder="开始日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                            <span style="color: #64748b;">-</span>
                             <input type="text" placeholder="结束日期" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         </div>
                         <div class="select-box" style="width: 100px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; font-size: 0.85rem; background: white;"><span>申请人</span><i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i></div>
                         <input type="text" placeholder="单号/客户名称" style="width: 200px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; outline: none;">
                         
                         <div style="flex: 1; min-width: 10px;"></div>

                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
                         <button style="height: 32px; padding: 0 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> 申请开票</button>
                    </div>

                    <div style="flex-grow: 1; padding: 0; overflow: auto;">
                           <div style="padding: 40px; text-align: center; color: #94a3b8;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i data-lucide="file-plus" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                                <span>暂无数据</span>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        } else {
            mainContent = `
                <div style="background: white; padding: 2rem; border-radius: 8px; border: 1px solid #e2e8f0; height: 100%;">
The above content does NOT show the entire file contents. If you need to view any lines of the file which were not shown to complete your task, call this tool again to view those lines.

                <h2 style="color: #1e293b; margin-bottom: 1rem;">${activeTab} Content</h2>
                <p style="color: #64748b;">This is a demonstration of the ${activeTab} page view.</p>
                </div>`;
        }

        if (mainContent) {
            // Default to NO sidebar unless explicitly included (User Request: "Don't add customer list automatically")
            const showSidebar = ['对账单', '客户账单', '费用明细', '应收明细', '应付明细', '收付款', '付款申请', '发票管理', '开票申请', '批量确认', '费用审核'].includes(activeTab);
            let contentHTML = '';
            if (showSidebar) {
                contentHTML = `
                <div class="statement-container">
                    <div class="customer-sidebar">
                        <div class="sidebar-header">客户列表</div>
                        <div class="sidebar-search">
                            <div class="search-input-group">
                                <input type="text" placeholder="请输入">
                                    <i data-lucide="search" class="search-icon"></i>
                            </div>
                            <button class="more-btn" style="white-space: nowrap;">更多</button>
                        </div>
                        <div class="customer-list">
                            <div class="customer-item active" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">全部 (94)</span>
                            </div>
                            ${customers.map(c => `
                                <div class="customer-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">
                                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name} (${c.count})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${mainContent}
                </div>`;
            } else {
                // For '订单管理' and '运营概览', don't use the statement-container wrapper to allow full width
                const noWrapper = ['订单管理', '运营概览', '货量利润表', '费用录入', '费用面板', '配载费用'].includes(activeTab);
                if (noWrapper) {
                    contentHTML = mainContent;
                } else {
                    contentHTML = `
                    <div class="statement-container">
                        ${mainContent}
                    </div>`;
                }
            }

            const pageContent = document.querySelector('.page-content');
            if (['订单管理', '运营概览', '货量利润表', '费用录入', '费用面板', '配载费用'].includes(activeTab)) {
                pageContent.style.padding = '0';
                pageContent.style.height = '100%';
                pageContent.style.overflow = 'hidden';
            } else {
                pageContent.style.padding = '2rem';
                pageContent.style.height = '';
                pageContent.style.overflow = '';
            }
            pageContent.innerHTML = contentHTML;
        }

        lucide.createIcons();

        if (activeTab === '录入订单') {
            const settlementSelect = document.getElementById('settlementMethod');
            const cashInput = document.getElementById('cashAmount');
            const deliveryInput = document.getElementById('deliveryAmount');

            if (settlementSelect && cashInput && deliveryInput) {
                const handleSettlementChange = () => {
                    const method = settlementSelect.value;
                    if (method === '现付') {
                        deliveryInput.disabled = true;
                        deliveryInput.style.backgroundColor = '#f8fafc';
                        deliveryInput.style.cursor = 'not-allowed';
                        deliveryInput.value = '';
                        cashInput.disabled = false;
                        cashInput.style.backgroundColor = 'white';
                        cashInput.style.cursor = 'text';
                    } else if (method === '到付') {
                        cashInput.disabled = true;
                        cashInput.style.backgroundColor = '#f8fafc';
                        cashInput.style.cursor = 'not-allowed';
                        cashInput.value = '';
                        deliveryInput.disabled = false;
                        deliveryInput.style.backgroundColor = 'white';
                        deliveryInput.style.cursor = 'text';
                    } else {
                        cashInput.disabled = false;
                        cashInput.style.backgroundColor = 'white';
                        cashInput.style.cursor = 'text';
                        deliveryInput.disabled = false;
                        deliveryInput.style.backgroundColor = 'white';
                        deliveryInput.style.cursor = 'text';
                    }
                };
                settlementSelect.addEventListener('change', handleSettlementChange);
                // Initial call to set state
                handleSettlementChange();
            }

            // Sync totals for mini tables
            window.updateOrderEntryTotals();
        }

        // Dynamically update statement badges based on actual table rows
        if (activeTab === '对账单' || activeTab === '应收对账' || activeTab === '应付对账') {
            const reminderBadge = document.getElementById('badge-reminder-count');
            const listBadge = document.getElementById('badge-list-count');
            const reminderRows = document.querySelectorAll('#reminder-table-wrapper tbody tr');
            const listRows = document.querySelectorAll('#statement-list-table-wrapper tbody tr');

            if (reminderBadge) {
                // Determine length, if there is a 'no data' row, we should probably output 0
                // For simplicity, just count tr elements
                let count = reminderRows.length;
                if (count === 1 && reminderRows[0].textContent.includes('暂无数据')) count = 0;
                reminderBadge.textContent = count;
            }
            if (listBadge) {
                let count = listRows.length;
                if (count === 1 && listRows[0].textContent.includes('暂无数据')) count = 0;
                listBadge.textContent = count;
            }
        }


        if (activeTab === '费用明细') {
            updateGenerateBillButtonState();
        }

        if (activeTab === '应收明细') {
            // updateReceivablesCreateBillButtonState(); // Logic removed as per user request to make it permanently enabled
            updateReceivablesGenerateBillButtonState();
        }

        if (activeTab === '客户账单') {
            // updateCustomerBillCreateButtonState(); // Logic removed as per user request to make it permanently enabled
        }

        if (activeTab === '应付明细') {
            updatePayablesGenerateBillButtonState();
        }

        if (activeTab === '费用面板' || activeTab === '配载费用') {
            // Render any previously saved expense entry data
            setTimeout(() => {
                if (typeof window.renderExpensePanelFromSavedData === 'function') {
                    window.renderExpensePanelFromSavedData(activeTab);
                }
            }, 100);
        }

        if (activeTab === '后台管理') {
            // Attach listeners for Backend Recharge Modal
            const rechargeBtns = document.querySelectorAll('.btn-recharge');
            const modal = document.getElementById('backend-recharge-modal-v2');

            window.closeBackendRechargeModal = function () {
                if (modal) {
                    modal.style.display = 'none'; // Using style display for simplicity or class toggle
                    modal.classList.add('hidden');
                }
            };

            rechargeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const name = btn.getAttribute('data-name');
                    const id = btn.getAttribute('data-id');
                    const company = btn.getAttribute('data-company');
                    const balance = btn.getAttribute('data-balance');

                    if (modal) {
                        modal.style.display = 'flex';
                        modal.classList.remove('hidden');

                        // Store specific current row elements to update later
                        window.currentRowBalanceElement = btn.closest('tr').querySelector('td:nth-child(4)');
                        window.currentUserBalanceRaw = parseFloat(balance.replace(/,/g, ''));

                        document.getElementById('modal-user-name').textContent = name;
                        document.getElementById('modal-user-id').textContent = id;
                        document.getElementById('modal-user-company').textContent = company;
                        document.getElementById('modal-user-balance').textContent = '¥' + balance;
                    }
                });
            });

            window.confirmBackendRecharge = function () {
                const amountInput = document.getElementById('recharge-amount-input');
                const amount = parseFloat(amountInput.value);

                if (isNaN(amount) || amount <= 0) {
                    alert('请输入有效的充值金额');
                    return;
                }

                if (window.currentRowBalanceElement) {
                    const newBalance = window.currentUserBalanceRaw + amount;
                    // Format number with commas
                    const formattedBalance = newBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Assuming integer display based on previous
                    // Or strictly match existing format which seems to have comma but maybe no decimals based on "¥10,450"
                    // Let's safe bet check widely. Actually the example was "¥8,450". 
                    // Wait, if I look at my read file, it was ¥8,450. NO decimals.
                    window.currentRowBalanceElement.textContent = '¥' + newBalance.toLocaleString();

                    // Update data attribute on the button itself so next time it opens it has new balance
                    const btn = window.currentRowBalanceElement.parentElement.querySelector('.btn-recharge');
                    if (btn) {
                        btn.setAttribute('data-balance', newBalance.toLocaleString());
                    }
                }

                closeBackendRechargeModal();
                // Optional: Show success message
                // alert('充值成功');
            };

            // Account Details Modal Logic
            const detailsBtns = document.querySelectorAll('.btn-view-details');

            // Assuming the eye icon buttons are part of the table rows and need the class 'btn-view-details'.
            // This change is made by adding a placeholder for where such buttons would be generated,
            // as the actual HTML for the table rows is not present in the provided content.
            // If the table rows are dynamically generated, ensure the generation logic adds this class.
            // Example of how such a button might look in HTML:
            // <button class="btn-icon btn-view-details" title="查看详情"><i data-lucide="eye"></i></button>

            const detailsModal = document.getElementById('backend-account-details-modal');

            window.closeBackendDetailsModal = function () {
                if (detailsModal) {
                    detailsModal.style.display = 'none';
                    detailsModal.classList.add('hidden');
                }
            };

            window.switchToRechargeFromDetails = function () {
                closeBackendDetailsModal();
                // We need to trigger the recharge modal for the current user.
                // We stored the context in window.currentDetailsContext when opening details.
                if (window.currentDetailsContext) {
                    const { btn } = window.currentDetailsContext;
                    // Find the recharge button for this row
                    const rechargeBtn = btn.closest('tr').querySelector('.btn-recharge');
                    if (rechargeBtn) {
                        rechargeBtn.click();
                    }
                }
            };

            detailsBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tr = btn.closest('tr');
                    // Scrape data from the row or the sibling recharge button
                    const rechargeBtn = tr.querySelector('.btn-recharge');
                    const name = rechargeBtn.getAttribute('data-name');
                    const id = rechargeBtn.getAttribute('data-id');
                    const company = rechargeBtn.getAttribute('data-company');
                    // For balance, we should get the current live text content as it might have been updated
                    const balanceText = tr.querySelector('td:nth-child(3)').textContent.trim();

                    window.currentDetailsContext = { btn };

                    document.getElementById('details-user-avatar').textContent = name.charAt(0);
                    document.getElementById('details-user-name').textContent = name;
                    document.getElementById('details-user-id').textContent = id;
                    document.getElementById('details-user-company').textContent = company;
                    document.getElementById('details-user-balance').textContent = balanceText;

                    // Inject Mock Data
                    const mockData = [
                        { time: '2023-10-15 14:30', type: '充值', amount: '+¥2,000', method: '支付宝', note: '余额充值', color: '#10b981' },
                        { time: '2023-09-28 10:15', type: '充值', amount: '+¥1,500', method: '微信支付', note: '账户充值', color: '#10b981' },
                        { time: '2023-09-10 16:45', type: '充值', amount: '+¥3,000', method: '银行转账', note: '对公账户转账', color: '#10b981' },
                        { time: '2023-08-25 09:20', type: '充值', amount: '+¥1,000', method: '支付宝', note: '余额充值', color: '#10b981' },
                        { time: '2023-08-05 11:30', type: '消费', amount: '¥850', method: '系统扣费', note: '月度服务费', color: '#ef4444' }
                    ];

                    const tbody = document.getElementById('details-transaction-list');
                    tbody.innerHTML = mockData.map(item => `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                           <td style="padding: 12px;">${item.time}</td>
                           <td style="padding: 12px;">${item.type}</td>
                           <td style="padding: 12px; font-weight: 600; color: ${item.color};">${item.amount}</td>
                           <td style="padding: 12px;">${item.method}</td>
                           <td style="padding: 12px; color: #64748b;">${item.note}</td>
                        </tr>
                `).join('');

                    if (detailsModal) {
                        detailsModal.style.display = 'flex';
                        detailsModal.classList.remove('hidden');
                    }
                });
            });
        }

        // Add click listeners for customer selection
        if (activeTab === '客户账单' || activeTab === '对账单') {
            const customerItems = document.querySelectorAll('.customer-item');
            customerItems.forEach(item => {
                item.addEventListener('click', () => {
                    customerItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Update main content based on selection (optional but good for UX)
                    // const name = item.querySelector('span').textContent;
                    // document.querySelector('.statement-main').innerHTML = ... (removed)

                });
            });

            // Modal Open Logic
            const moreBtn = document.querySelector('.more-btn');
            const modal = document.getElementById('statement-modal');
            if (moreBtn && modal) {
                moreBtn.addEventListener('click', () => {
                    modal.classList.add('show');
                });
            }
        }
    }

    // Initialize Lucide icons
    if (window.lucide) {
        window.lucide.createIcons();
    }

    // Population table data initially for Fuel Card Management
    if (activeTab === '油卡管理' && window.renderFuelCardTableBody) {
        window.renderFuelCardTableBody('全部');
    }
}

function closeTab(title) {
    openTabs = openTabs.filter(t => t !== title);
    if (openTabs.length > 0) {
        renderTabs(openTabs[openTabs.length - 1]);
    } else {
        document.querySelector('.sub-sidebar').classList.remove('hidden');
        document.getElementById('menu-mask').classList.add('show');
        document.getElementById('tabs-bar').style.display = 'none';
        document.querySelector('.page-content').innerHTML = '';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Conflicting sidebar logic removed.


    // Mask Click to close
    document.getElementById('menu-mask').addEventListener('click', () => {
        document.querySelector('.sub-sidebar').classList.add('hidden');
        document.getElementById('menu-mask').classList.remove('show');
    });

    // Search Dropdown Logic
    const searchDropdown = document.getElementById('search-dropdown');
    const selectedTypeText = document.getElementById('selected-type');
    const dropdownItems = document.querySelectorAll('.dropdown-item');

    if (searchDropdown) {
        searchDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            searchDropdown.classList.toggle('open');
        });

        dropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const value = item.getAttribute('data-value');
                selectedTypeText.textContent = value;

                // Update active state
                dropdownItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                searchDropdown.classList.remove('open');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            searchDropdown.classList.remove('open');
        });
    }
    // Modal Close Logic
    const statementModal = document.getElementById('statement-modal');
    const closeModal = document.getElementById('close-modal');

    if (closeModal && statementModal) {
        closeModal.addEventListener('click', () => {
            statementModal.classList.remove('show');
        });

        statementModal.addEventListener('click', (e) => {
            if (e.target === statementModal) {
                statementModal.classList.remove('show');
            }
        });
    }
});
// Custom Dropdown Logic
document.addEventListener('click', function (e) {
    // Check if clicked inside a relative-container (dropdown trigger)
    const container = e.target.closest('.relative-container');

    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu-custom').forEach(menu => {
        if (!container || !container.contains(menu)) {
            menu.classList.add('hidden');
        }
    });

    if (container) {
        const menu = container.querySelector('.dropdown-menu-custom');
        if (menu) {
            // If clicking the item itself, don't toggle immediately (handled by selectOption)
            // But if clicking the header/box
            if (!e.target.classList.contains('dropdown-item-custom')) {
                menu.classList.toggle('hidden');
            }
        }
    }
});

function selectOption(spanId, value) {
    const span = document.getElementById(spanId);
    if (span) {
        span.textContent = value;
        // Close menu (handled by click listener or explicitly here)
        const menu = span.closest('.relative-container').querySelector('.dropdown-menu-custom');
        if (menu) menu.classList.add('hidden');
    }
}

// Modal Interaction Logic
document.addEventListener('DOMContentLoaded', () => {
    // Close Modal Button
    const closeBtn = document.getElementById('close-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            const modal = document.getElementById('statement-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        });
    }

    // Toggle Filters Button
    const toggleBtn = document.getElementById('toggle-filter-btn');
    const expandableArea = document.getElementById('expandable-filter-area');

    if (toggleBtn && expandableArea) {
        toggleBtn.addEventListener('click', () => {
            expandableArea.classList.toggle('collapsed');

            const isCollapsed = expandableArea.classList.contains('collapsed');

            // Simple text toggle, keep icon if possible
            if (isCollapsed) {
                toggleBtn.innerHTML = '更多(2) <i data-lucide="chevron-down"></i>';
            } else {
                toggleBtn.innerHTML = '收起 <i data-lucide="chevron-up"></i>';
            }
            if (window.lucide) window.lucide.createIcons();
        });
    }
});

// Function to handle internal tab switching
function switchInternalTab(tabType) {
    const tabs = document.querySelectorAll('.internal-tabs .internal-tab');
    const reminderContent = document.getElementById('reconciliation-reminder-content');
    const listContent = document.getElementById('statement-list-content');
    const reminderTable = document.getElementById('reminder-table-wrapper');
    const listTable = document.getElementById('statement-list-table-wrapper');

    if (tabType === 'reminder') {
        if (tabs.length > 0) {
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
        }

        if (reminderContent) reminderContent.style.display = 'block';
        if (listContent) listContent.style.display = 'none';

        if (reminderTable) reminderTable.style.display = 'block';
        if (listTable) listTable.style.display = 'none';

    } else if (tabType === 'list') {
        if (tabs.length > 0) {
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
        }

        if (reminderContent) reminderContent.style.display = 'none';
        if (listContent) listContent.style.display = 'block';

        if (reminderTable) reminderTable.style.display = 'none';
        if (listTable) listTable.style.display = 'block';
    }

    // Refresh icons since we made HTML changes could potentially affect lucide (newly visible)
    setTimeout(() => {
        if (window.lucide) window.lucide.createIcons();
    }, 50);
}

// Function to handle fuel card manager tab switching
function switchFuelCardTab(element) {
    const tabs = element.parentElement.querySelectorAll('.status-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
        tab.style.color = '#475569';
        tab.style.fontWeight = '400';
    });

    element.classList.add('active');
    element.style.borderBottom = '2px solid #4f46e5';
    element.style.color = '#4f46e5';
    element.style.fontWeight = '500';

    // Link tab to table filter
    // Use data-status if available (to ignore badge text), otherwise fallback to textContent
    const status = element.dataset.status || element.textContent.trim();
    if (window.renderFuelCardTableBody) {
        window.renderFuelCardTableBody(status);
    }

    // Toggle action bar visibility: hide for "待发放", show for others
    const actionBar = document.getElementById('fuel-card-action-bar');
    if (actionBar) {
        if (status === '待发放') {
            actionBar.style.display = 'none';
        } else {
            actionBar.style.display = 'flex';
        }
    }

    // Refresh icons just in case (though not strictly needed here as no icons are inside the tabs yet)
    if (window.lucide) window.lucide.createIcons();
}

// Function to toggle fuel card manager dropdowns
window.toggleFuelCardDropdown = function (dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    if (!dropdown) return;
    const isHidden = dropdown.classList.contains('hidden');

    // Close all other fuel card dropdowns first
    document.querySelectorAll('.fuel-card-filter-area .dropdown-menu-custom').forEach(d => {
        d.classList.add('hidden');
    });

    if (isHidden) {
        dropdown.classList.remove('hidden');
    }
};

// Function to handle option selection for fuel card dropdowns
window.selectFuelCardOption = function (targetId, value, dropdownId) {
    const target = document.getElementById(targetId);
    if (target) {
        target.textContent = value;
    }
    const dropdown = document.getElementById(dropdownId);
    if (dropdown) {
        dropdown.classList.add('hidden');
    }
};

// Mock Data for Fuel Cards
window.fuelCardData = [
    { id: 'W1', sysId: 'SY-W001', waybillNo: 'YD20260121001', waybillDate: '2026-01-21', fuelCost: '800.00', plateNo: '鄂A·12345', contactPhone: '13811112222', remarks: '测试运单1', status: '待发放' },
    { id: 'W2', sysId: 'SY-W002', waybillNo: 'YD20260121002', waybillDate: '2026-01-21', fuelCost: '1200.00', plateNo: '鄂B·67890', contactPhone: '13933334444', remarks: '测试运单2', status: '待发放' },
    { id: 'W3', sysId: 'SY-W003', waybillNo: 'YD20260121003', waybillDate: '2026-01-21', fuelCost: '500.00', plateNo: '鄂C·54321', contactPhone: '13755556666', remarks: '测试运单3', status: '待发放' },
    { id: 1, sysId: 'SY20250101003', cardNo: '6228 4801 2345 6789', type: '客户卡', name: '丰源中石油', status: '在库', balance: '1,500.00', deposit: '0.00', regDate: '2025-01-01', issueDate: '-', waybillNo: '-', plateNo: '-', contactPhone: '-', remarks: '暂无' },
    { id: 2, sysId: 'SY20250101004', cardNo: '6228 4801 9876 5432', type: '公司卡', name: '丰源中石化', status: '已发放', balance: '500.00', deposit: '100.00', regDate: '2025-01-02', issueDate: '2025-01-15', waybillNo: 'YD202501150001', plateNo: '鄂A·88888', contactPhone: '138 0000 0000', remarks: '-' },
    { id: 3, sysId: 'SY20250101005', cardNo: '6228 4801 1111 2222', type: '客户卡', name: '丰源特种油', status: '已注销', balance: '0.00', deposit: '0.00', regDate: '2024-12-20', issueDate: '-', waybillNo: '-', plateNo: '-', contactPhone: '-', remarks: '已退押金' },
    { id: 4, sysId: 'SY20250101006', cardNo: '6228 4801 3333 4444', type: '公司卡', name: '丰源中石油', status: '在库', balance: '2,800.00', deposit: '0.00', regDate: '2025-01-05', issueDate: '-', waybillNo: '-', plateNo: '-', contactPhone: '-', remarks: '-' },
    { id: 5, sysId: 'SY20250101007', cardNo: '6228 4801 5555 6666', type: '公司卡', name: '丰源中石化', status: '已发放', balance: '1,200.00', deposit: '50.00', regDate: '2025-01-10', issueDate: '2025-01-18', waybillNo: 'YD202501180099', plateNo: '鄂A·66666', contactPhone: '139 1111 2222', remarks: '司机反馈卡片消磁' }
];

// Function to update the pending fuel card badge
window.updatePendingFuelCardBadge = function () {
    const badge = document.getElementById('pending-fuel-card-badge');
    if (!badge || !window.fuelCardData) return;

    const pendingCount = window.fuelCardData.filter(item => item.status === '待发放').length;

    if (pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
};

// Function to render the fuel card table body based on status
window.renderFuelCardTableBody = function (status) {
    // Update badge whenever table is rendered
    window.updatePendingFuelCardBadge();
    const tbody = document.getElementById('fuel-card-table-body');
    if (!tbody) return;

    // Update headers dynamically based on status
    const table = tbody.closest('table');
    const thead = table ? table.querySelector('thead') : null;
    if (thead) {
        if (status === '待发放') {
            thead.innerHTML = `
                <tr>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox" id="fuel-card-select-all" onchange="window.toggleAllFuelCardCheckboxes(this)"></th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 50px;">序号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">运单号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">运单日期</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: right;">油费</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">车牌号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">联系电话</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">备注</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">操作</th>
                </tr>
            `;
        } else {
            thead.innerHTML = `
                <tr>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 40px;"><input type="checkbox" id="fuel-card-select-all" onchange="window.toggleAllFuelCardCheckboxes(this)"></th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center; width: 50px;">序号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">系统编号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">油卡编号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">油卡类型</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">油卡名称</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">油卡状态</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: right;">油卡余额</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: right;">油卡押金</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">登记日期</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">发放日期</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">发放运单号</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">车牌号码</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">联系电话</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">备注</th>
                    <th style="padding: 12px 8px; border-bottom: 2px solid #e2e8f0; text-align: center;">操作</th>
                </tr>
            `;
        }
    }

    const cardStatuses = ['在库', '已发放', '已注销'];
    const filteredData = status === '全部'
        ? window.fuelCardData.filter(item => cardStatuses.includes(item.status))
        : window.fuelCardData.filter(item => item.status === status);

    if (status === '待发放') {
        tbody.innerHTML = filteredData.map((item, index) => `
            <tr style="border-bottom: 1px solid #f1f5f9; ${index % 2 === 1 ? 'background: #fbfcfe;' : ''}">
                <td style="padding: 10px 8px; text-align: center;"><input type="checkbox" class="fuel-card-checkbox" data-sysid="${item.sysId}"></td>
                <td style="padding: 10px 8px; text-align: center;">${index + 1}</td>
                <td style="padding: 10px 8px;">${item.waybillNo || '-'}</td>
                <td style="padding: 10px 8px; text-align: center;">${item.waybillDate || '-'}</td>
                <td style="padding: 10px 8px; text-align: right;">${item.fuelCost || '-'}</td>
                <td style="padding: 10px 8px;">${item.plateNo || '-'}</td>
                <td style="padding: 10px 8px;">${item.contactPhone || '-'}</td>
                <td style="padding: 10px 8px; color: #94a3b8;">${item.remarks || '-'}</td>
                <td style="padding: 10px 8px; text-align: center;">
                    <a href="javascript:void(0)" style="color: #4f46e5; text-decoration: none; font-size: 0.75rem;" onclick="window.showIssueSelectionModal('${item.waybillNo}')">发放</a>
                </td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = filteredData.map((item, index) => `
            <tr style="border-bottom: 1px solid #f1f5f9; ${index % 2 === 1 ? 'background: #fbfcfe;' : ''}">
                <td style="padding: 10px 8px; text-align: center;"><input type="checkbox" class="fuel-card-checkbox" data-sysid="${item.sysId}"></td>
                <td style="padding: 10px 8px; text-align: center;">${index + 1}</td>
                <td style="padding: 10px 8px;">${item.sysId}</td>
                <td style="padding: 10px 8px;">${item.cardNo}</td>
                <td style="padding: 10px 8px;">${item.type}</td>
                <td style="padding: 10px 8px;">${item.name}</td>
                <td style="padding: 10px 8px; text-align: center;">
                    <span style="background: ${item.status === '在库' ? '#ecfdf5' : item.status === '已发放' ? '#eff6ff' : '#fff1f2'}; 
                                 color: ${item.status === '在库' ? '#059669' : item.status === '已发放' ? '#2563eb' : '#e11d48'}; 
                                 padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">
                        ${item.status}
                    </span>
                </td>
                <td style="padding: 10px 8px; text-align: right;">${item.balance}</td>
                <td style="padding: 10px 8px; text-align: right;">${item.deposit}</td>
                <td style="padding: 10px 8px; text-align: center;">${item.regDate}</td>
                <td style="padding: 10px 8px; text-align: center;">${item.issueDate || '-'}</td>
                <td style="padding: 10px 8px;">${item.waybillNo || '-'}</td>
                <td style="padding: 10px 8px;">${item.plateNo || '-'}</td>
                <td style="padding: 10px 8px;">${item.contactPhone || '-'}</td>
                <td style="padding: 10px 8px; color: #94a3b8;">${item.remarks || '-'}</td>
                <td style="padding: 10px 8px; text-align: center;">
                    <a href="javascript:void(0)" style="color: #4f46e5; text-decoration: none; font-size: 0.75rem;" onclick="window.showFuelCardDetailModal('${item.sysId}')">详情</a>
                </td>
            </tr>
        `).join('');
    }
};

// Function to show modal specifically for selecting an "In Stock" fuel card to issue
window.showIssueSelectionModal = function (waybillNo) {
    const availableCards = window.fuelCardData.filter(item => item.status === '在库');

    // Create modal if not exists
    let modal = document.getElementById('issue-selection-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'issue-selection-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div style="background: white; width: 800px; max-height: 80vh; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; background: #f8fafc;">
                <h3 style="margin: 0; font-size: 1.1rem; color: #1e293b;">选择油卡 - 运单: ${waybillNo}</h3>
                <i data-lucide="x" style="width: 20px; height: 20px; color: #64748b; cursor: pointer;" onclick="window.closeIssueSelectionModal()"></i>
            </div>
            <div style="padding: 24px; overflow: auto; flex-grow: 1;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead style="background: #f1f5f9;">
                        <tr>
                            <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">油卡编号</th>
                            <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">油卡名称</th>
                            <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">类型</th>
                            <th style="padding: 12px 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">余额</th>
                            <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid #e2e8f0;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${availableCards.length > 0 ? availableCards.map(card => `
                            <tr style="border-bottom: 1px solid #f1f5f9; hover: background: #f8fafc;">
                                <td style="padding: 12px 8px;">${card.cardNo}</td>
                                <td style="padding: 12px 8px;">${card.name}</td>
                                <td style="padding: 12px 8px;">${card.type}</td>
                                <td style="padding: 12px 8px; text-align: right;">${card.balance}</td>
                                <td style="padding: 12px 8px; text-align: center; display: flex; gap: 8px; justify-content: center;">
                                    <button style="padding: 4px 12px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" onclick="window.confirmIssueFuelCard('${waybillNo}', '${card.sysId}')">选择</button>
                                    <button style="padding: 4px 12px; background: #fff; border: 1px solid #4f46e5; color: #4f46e5; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" onclick="window.showFuelCardRechargeModal('${card.sysId}')">充值</button>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #94a3b8;">暂无在库油卡</td></tr>'}
                    </tbody>
                </table>
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                <button style="padding: 6px 16px; background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; color: #475569; cursor: pointer; font-size: 0.85rem;" onclick="window.closeIssueSelectionModal()">取消</button>
            </div>
        </div>
    `;

    if (window.lucide) window.lucide.createIcons();
};

window.closeIssueSelectionModal = function () {
    const modal = document.getElementById('issue-selection-modal');
    if (modal) modal.remove();
};

/**
 * Confirms the fuel card issuance and updates statuses.
 */
window.confirmIssueFuelCard = function (waybillNo, cardSysId) {
    const waybillEntry = window.fuelCardData.find(item => item.waybillNo === waybillNo && item.status === '待发放');
    const cardEntry = window.fuelCardData.find(item => item.sysId === cardSysId);

    if (!waybillEntry || !cardEntry) {
        alert('数据错误，无法完成发放');
        return;
    }

    // Validation: Check if card balance is enough for waybill fuel cost
    const fuelCost = parseFloat(waybillEntry.fuelCost.replace(/,/g, ''));
    const cardBalance = parseFloat(cardEntry.balance.replace(/,/g, ''));

    if (isNaN(fuelCost) || isNaN(cardBalance)) {
        alert('金额数据异常，无法校验余额');
        return;
    }

    if (cardBalance < fuelCost) {
        alert(`油卡余额不足，无法发放！\n所需油费: ${waybillEntry.fuelCost}\n当前余额: ${cardEntry.balance}`);
        return;
    }

    // Update waybill status
    waybillEntry.status = '已发放';

    // Update card data
    const now = new Date();
    cardEntry.status = '已发放';
    cardEntry.waybillNo = waybillEntry.waybillNo;
    cardEntry.plateNo = waybillEntry.plateNo;
    cardEntry.contactPhone = waybillEntry.contactPhone;
    cardEntry.issueDate = now.toLocaleDateString('zh-CN').replace(/\//g, '-');
    cardEntry.remarks = waybillEntry.remarks;

    alert(`成功为运单 ${waybillNo} 发放油卡 ${cardEntry.cardNo}`);
    window.closeIssueSelectionModal();

    // Refresh the table body
    if (window.renderFuelCardTableBody) {
        window.renderFuelCardTableBody('待发放');
    }
};

// Global click listener to close fuel card dropdowns when clicking outside
document.addEventListener('click', function (event) {
    if (!event.target.closest('.select-box') && !event.target.closest('.dropdown-menu-custom')) {
        document.querySelectorAll('.fuel-card-filter-area .dropdown-menu-custom').forEach(d => {
            d.classList.add('hidden');
        });
    }
});


// 存储已上传的文件
window.receiptUploadedFiles = [];

// 处理收款附件上传
function handleReceiptFileUpload(event) {
    const files = event.target.files;
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
    const allowedExtensions = ['.jpg', '.jpeg', '.png', '.pdf', '.xls', '.xlsx'];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        // 验证文件格式
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            alert('不支持的文件格式：' + file.name + '\n仅支持 JPG、PNG、PDF、Excel 格式');
            continue;
        }

        // 验证文件大小（最大10MB）
        if (file.size > 10 * 1024 * 1024) {
            alert('文件过大：' + file.name + '\n最大支持 10MB');
            continue;
        }

        // 添加到已上传列表
        window.receiptUploadedFiles.push({
            name: file.name,
            size: file.size,
            type: file.type,
            file: file,
            id: Date.now() + '_' + i
        });
    }

    // 渲染文件列表
    renderReceiptFileList();

    // 清空input以便可以重复选择同一文件
    event.target.value = '';
}

// 获取文件图标
function getFileIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png'].includes(ext)) {
        return 'image';
    } else if (['xls', 'xlsx'].includes(ext)) {
        return 'file-spreadsheet';
    } else if (ext === 'pdf') {
        return 'file-text';
    }
    return 'file';
}

// 获取文件图标颜色
function getFileIconColor(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png'].includes(ext)) {
        return '#10b981';  // 绿色 - 图片
    } else if (['xls', 'xlsx'].includes(ext)) {
        return '#22c55e';  // 深绿色 - Excel
    } else if (ext === 'pdf') {
        return '#ef4444';  // 红色 - PDF
    }
    return '#64748b';
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// 渲染收款附件文件列表
function renderReceiptFileList() {
    const listContainer = document.getElementById('receipt-file-list');
    const countSpan = document.getElementById('receipt-attachment-count');

    if (!listContainer) return;

    // 更新附件计数
    if (countSpan) {
        countSpan.textContent = window.receiptUploadedFiles.length;
    }

    if (window.receiptUploadedFiles.length === 0) {
        listContainer.innerHTML = '';
        return;
    }

    let html = '';
    window.receiptUploadedFiles.forEach((file, index) => {
        const icon = getFileIcon(file.name);
        const iconColor = getFileIconColor(file.name);
        html += `
            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px; font-size: 0.7rem;">
                <i data-lucide="${icon}" style="width: 14px; height: 14px; color: ${iconColor}; flex-shrink: 0;"></i>
                <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #1e293b;" title="${file.name}">${file.name}</span>
                <span style="color: #94a3b8; flex-shrink: 0;">${formatFileSize(file.size)}</span>
                <button onclick="removeReceiptFile('${file.id}')" style="border: none; background: transparent; cursor: pointer; padding: 2px; display: flex; align-items: center;">
                    <i data-lucide="x" style="width: 12px; height: 12px; color: #ef4444;"></i>
                </button>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    if (window.lucide) window.lucide.createIcons();
}

// 删除收款附件
function removeReceiptFile(fileId) {
    window.receiptUploadedFiles = window.receiptUploadedFiles.filter(f => f.id !== fileId);
    renderReceiptFileList();
}

// ==================== 付款申请弹窗及附件上传功能 ====================

// 存储付款申请的附件
window.paymentInvoiceFiles = [];  // 发票文件
window.paymentAttachmentFiles = [];  // 随件

// 显示付款申请弹窗
function showPaymentApplicationModal() {
    let modal = document.getElementById('payment-application-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'payment-application-modal';
        modal.className = 'modal-overlay';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal-container" style="width: 800px; max-width: 95vw; max-height: 90vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div class="modal-header" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i data-lucide="file-plus" style="width: 20px; height: 20px; color: #4f46e5;"></i>
                    <span style="font-size: 1rem; font-weight: 600; color: #1e293b;">申请付款</span>
                </div>
                <button onclick="closePaymentApplicationModal()" style="border: none; background: transparent; cursor: pointer; padding: 4px;">
                    <i data-lucide="x" style="width: 20px; height: 20px; color: #64748b;"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="modal-content" style="flex-grow: 1; padding: 20px; overflow-y: auto;">
                <!-- 基本信息 -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: #1e293b; margin-bottom: 12px;">基本信息</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="width: 70px; font-size: 0.8rem; color: #64748b;">收款单位</label>
                            <div style="flex: 1; display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; align-items: center; height: 32px;">
                                <input type="text" placeholder="请选择收款单位" style="border: none; outline: none; flex: 1; font-size: 0.8rem;">
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="width: 70px; font-size: 0.8rem; color: #64748b;">付款金额</label>
                            <input type="text" placeholder="0.00" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; height: 32px; font-size: 0.8rem; outline: none; text-align: right;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="width: 70px; font-size: 0.8rem; color: #64748b;">付款账户</label>
                            <div style="flex: 1; display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; align-items: center; height: 32px;">
                                <input type="text" placeholder="请选择付款账户" style="border: none; outline: none; flex: 1; font-size: 0.8rem;">
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="width: 70px; font-size: 0.8rem; color: #64748b;">申请日期</label>
                            <div style="flex: 1; display: flex; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; align-items: center; height: 32px;">
                                <input type="text" value="${new Date().toISOString().split('T')[0]}" style="border: none; outline: none; flex: 1; font-size: 0.8rem;">
                                <i data-lucide="calendar" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>
                        <div style="grid-column: span 2; display: flex; align-items: flex-start; gap: 8px;">
                            <label style="width: 70px; font-size: 0.8rem; color: #64748b; margin-top: 8px;">摘要</label>
                            <textarea placeholder="请输入付款摘要" style="flex: 1; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px 10px; font-size: 0.8rem; outline: none; height: 60px; resize: none;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 附件上传区域 -->
                <div style="border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden;">
                    <!-- 附件标签页 -->
                    <div style="display: flex; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                        <div id="payment-tab-invoice" onclick="switchPaymentAttachmentTab('invoice')" style="padding: 10px 16px; font-size: 0.8rem; border-bottom: 2px solid #4f46e5; color: #4f46e5; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 500;">
                            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                            发票文件 (<span id="payment-invoice-count">0</span>)
                        </div>
                        <div id="payment-tab-attachment" onclick="switchPaymentAttachmentTab('attachment')" style="padding: 10px 16px; font-size: 0.8rem; color: #64748b; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i data-lucide="paperclip" style="width: 14px; height: 14px;"></i>
                            随件 (<span id="payment-attachment-count">0</span>)
                        </div>
                    </div>

                    <!-- 发票文件上传区域 -->
                    <div id="payment-invoice-panel" style="padding: 16px;">
                        <input type="file" id="payment-invoice-input" multiple accept=".jpg,.jpeg,.png,.pdf,.xls,.xlsx" style="display: none;" onchange="handlePaymentFileUpload(event, 'invoice')">
                        <div onclick="document.getElementById('payment-invoice-input').click()" style="border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 6px; padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#4f46e5'; this.style.background='#eff6ff';" onmouseout="this.style.borderColor='#cbd5e1'; this.style.background='#f8fafc';">
                            <i data-lucide="upload-cloud" style="width: 32px; height: 32px; color: #94a3b8; margin-bottom: 8px;"></i>
                            <div style="font-size: 0.85rem; color: #4f46e5; font-weight: 500;">点击上传发票文件</div>
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">支持 JPG / Excel / PDF，最大 10MB</div>
                        </div>
                        <div id="payment-invoice-list" style="margin-top: 12px; max-height: 120px; overflow-y: auto;"></div>
                    </div>

                    <!-- 随件上传区域 -->
                    <div id="payment-attachment-panel" style="padding: 16px; display: none;">
                        <input type="file" id="payment-attachment-input" multiple accept=".jpg,.jpeg,.png,.pdf,.xls,.xlsx" style="display: none;" onchange="handlePaymentFileUpload(event, 'attachment')">
                        <div onclick="document.getElementById('payment-attachment-input').click()" style="border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 6px; padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#4f46e5'; this.style.background='#eff6ff';" onmouseout="this.style.borderColor='#cbd5e1'; this.style.background='#f8fafc';">
                            <i data-lucide="upload-cloud" style="width: 32px; height: 32px; color: #94a3b8; margin-bottom: 8px;"></i>
                            <div style="font-size: 0.85rem; color: #4f46e5; font-weight: 500;">点击上传随件</div>
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">支持 JPG / Excel / PDF，最大 10MB</div>
                        </div>
                        <div id="payment-attachment-list" style="margin-top: 12px; max-height: 120px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                <button onclick="closePaymentApplicationModal()" style="height: 36px; padding: 0 20px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">取消</button>
                <button onclick="submitPaymentApplication()" style="height: 36px; padding: 0 20px; background: #4f46e5; border: none; color: white; border-radius: 6px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="send" style="width: 14px; height: 14px;"></i>
                    提交申请
                </button>
            </div>
        </div>
    `;

    modal.classList.add('show');
    if (window.lucide) window.lucide.createIcons();
}

// 关闭付款申请弹窗
function closePaymentApplicationModal() {
    const modal = document.getElementById('payment-application-modal');
    if (modal) {
        modal.classList.remove('show');
    }
    // 清空已上传的文件列表
    window.paymentInvoiceFiles = [];
    window.paymentAttachmentFiles = [];
}

// 切换付款申请附件标签页
function switchPaymentAttachmentTab(tab) {
    const tabInvoice = document.getElementById('payment-tab-invoice');
    const tabAttachment = document.getElementById('payment-tab-attachment');
    const panelInvoice = document.getElementById('payment-invoice-panel');
    const panelAttachment = document.getElementById('payment-attachment-panel');

    if (tab === 'invoice') {
        tabInvoice.style.borderBottom = '2px solid #4f46e5';
        tabInvoice.style.color = '#4f46e5';
        tabInvoice.style.fontWeight = '500';
        tabAttachment.style.borderBottom = 'none';
        tabAttachment.style.color = '#64748b';
        tabAttachment.style.fontWeight = 'normal';
        panelInvoice.style.display = 'block';
        panelAttachment.style.display = 'none';
    } else {
        tabAttachment.style.borderBottom = '2px solid #4f46e5';
        tabAttachment.style.color = '#4f46e5';
        tabAttachment.style.fontWeight = '500';
        tabInvoice.style.borderBottom = 'none';
        tabInvoice.style.color = '#64748b';
        tabInvoice.style.fontWeight = 'normal';
        panelAttachment.style.display = 'block';
        panelInvoice.style.display = 'none';
    }
}

// 处理付款申请附件上传
function handlePaymentFileUpload(event, type) {
    const files = event.target.files;
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
    const allowedExtensions = ['.jpg', '.jpeg', '.png', '.pdf', '.xls', '.xlsx'];

    const targetArray = type === 'invoice' ? window.paymentInvoiceFiles : window.paymentAttachmentFiles;

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        // 验证文件格式
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            alert('不支持的文件格式：' + file.name + '\n仅支持 JPG、PNG、PDF、Excel 格式');
            continue;
        }

        // 验证文件大小（最大10MB）
        if (file.size > 10 * 1024 * 1024) {
            alert('文件过大：' + file.name + '\n最大支持 10MB');
            continue;
        }

        // 添加到已上传列表
        targetArray.push({
            name: file.name,
            size: file.size,
            type: file.type,
            file: file,
            id: Date.now() + '_' + i
        });
    }

    // 渲染文件列表
    renderPaymentFileList(type);

    // 清空input以便可以重复选择同一文件
    event.target.value = '';
}

// 渲染付款申请文件列表
function renderPaymentFileList(type) {
    const listContainer = document.getElementById(type === 'invoice' ? 'payment-invoice-list' : 'payment-attachment-list');
    const countSpan = document.getElementById(type === 'invoice' ? 'payment-invoice-count' : 'payment-attachment-count');
    const files = type === 'invoice' ? window.paymentInvoiceFiles : window.paymentAttachmentFiles;

    if (!listContainer) return;

    // 更新附件计数
    if (countSpan) {
        countSpan.textContent = files.length;
    }

    if (files.length === 0) {
        listContainer.innerHTML = '';
        return;
    }

    let html = '';
    files.forEach((file) => {
        const icon = getFileIcon(file.name);
        const iconColor = getFileIconColor(file.name);
        html += `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f8fafc; border-radius: 6px; margin-bottom: 6px; font-size: 0.8rem; border: 1px solid #e2e8f0;">
                <i data-lucide="${icon}" style="width: 16px; height: 16px; color: ${iconColor}; flex-shrink: 0;"></i>
                <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #1e293b;" title="${file.name}">${file.name}</span>
                <span style="color: #94a3b8; flex-shrink: 0; font-size: 0.75rem;">${formatFileSize(file.size)}</span>
                <button onclick="removePaymentFile('${file.id}', '${type}')" style="border: none; background: #fee2e2; cursor: pointer; padding: 4px; border-radius: 4px; display: flex; align-items: center;">
                    <i data-lucide="trash-2" style="width: 12px; height: 12px; color: #ef4444;"></i>
                </button>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    if (window.lucide) window.lucide.createIcons();
}

// 删除付款申请附件
function removePaymentFile(fileId, type) {
    if (type === 'invoice') {
        window.paymentInvoiceFiles = window.paymentInvoiceFiles.filter(f => f.id !== fileId);
    } else {
        window.paymentAttachmentFiles = window.paymentAttachmentFiles.filter(f => f.id !== fileId);
    }
    renderPaymentFileList(type);
}

// 提交付款申请
function submitPaymentApplication() {
    const invoiceCount = window.paymentInvoiceFiles.length;
    const attachmentCount = window.paymentAttachmentFiles.length;

    alert(`付款申请已提交！\n发票文件：${invoiceCount} 个\n随件：${attachmentCount} 个`);
    closePaymentApplicationModal();
}

// ==================== AI对账弹窗及附件上传功能 ====================

// 存储AI对账的附件
window.aiReconciliationFiles = [];
window.currentReconciliationNo = '';

// 显示AI对账弹窗
function showAIReconciliationModal(reconciliationNo) {
    window.currentReconciliationNo = reconciliationNo || '';
    window.aiReconciliationFiles = [];

    let modal = document.getElementById('ai-reconciliation-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'ai-reconciliation-modal';
        modal.className = 'modal-overlay';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal-container" style="width: 600px; max-width: 95vw; max-height: 80vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-bottom: none; padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="brain" style="width: 24px; height: 24px; color: white;"></i>
                    </div>
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: white;">AI 智能对账</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8);">对账单号: ${reconciliationNo || '新建对账'}</div>
                    </div>
                </div>
                <button onclick="closeAIReconciliationModal()" style="border: none; background: rgba(255,255,255,0.2); cursor: pointer; padding: 8px; border-radius: 8px;">
                    <i data-lucide="x" style="width: 18px; height: 18px; color: white;"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="modal-content" style="flex-grow: 1; padding: 24px; overflow-y: auto; background: #f8fafc;">
                <!-- 说明区域 -->
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <i data-lucide="info" style="width: 20px; height: 20px; color: #3b82f6; flex-shrink: 0; margin-top: 2px;"></i>
                        <div style="font-size: 0.85rem; color: #1e40af; line-height: 1.5;">
                            上传对账单文件，AI将自动识别并与系统数据进行比对，帮助您快速完成对账工作。
                        </div>
                    </div>
                </div>

                <!-- 上传区域 -->
                <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: white;">
                    <div style="padding: 12px 16px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="file-up" style="width: 16px; height: 16px; color: #10b981;"></i>
                            <span style="font-size: 0.85rem; font-weight: 500; color: #1e293b;">上传对账文件</span>
                        </div>
                        <span id="ai-file-count" style="font-size: 0.75rem; color: #64748b;">已上传 0 个文件</span>
                    </div>
                    
                    <div style="padding: 20px;">
                        <input type="file" id="ai-reconciliation-input" multiple accept=".jpg,.jpeg,.png,.pdf,.xls,.xlsx" style="display: none;" onchange="handleAIReconciliationUpload(event)">
                        <div onclick="document.getElementById('ai-reconciliation-input').click()" style="border: 2px dashed #cbd5e1; background: #fafafa; border-radius: 8px; padding: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#10b981'; this.style.background='#f0fdf4';" onmouseout="this.style.borderColor='#cbd5e1'; this.style.background='#fafafa';">
                            <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                                <i data-lucide="upload" style="width: 28px; height: 28px; color: white;"></i>
                            </div>
                            <div style="font-size: 0.9rem; color: #1e293b; font-weight: 500; margin-bottom: 4px;">点击或拖拽文件到此处</div>
                            <div style="font-size: 0.8rem; color: #64748b;">支持 JPG / Excel / PDF，最大 10MB</div>
                        </div>
                        
                        <!-- 已上传文件列表 -->
                        <div id="ai-reconciliation-file-list" style="margin-top: 16px;"></div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: white;">
                <div style="font-size: 0.8rem; color: #64748b;">
                    <i data-lucide="zap" style="width: 14px; height: 14px; display: inline; vertical-align: middle; color: #f59e0b;"></i>
                    AI处理通常需要10-30秒
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeAIReconciliationModal()" style="height: 40px; padding: 0 20px; background: white; border: 1px solid #e2e8f0; color: #64748b; border-radius: 8px; font-size: 0.85rem; cursor: pointer;">取消</button>
                    <button onclick="startAIReconciliation()" style="height: 40px; padding: 0 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; border-radius: 8px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                        <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
                        开始AI对账
                    </button>
                </div>
            </div>
        </div>
    `;

    modal.classList.add('show');
    if (window.lucide) window.lucide.createIcons();
}

// 关闭AI对账弹窗
function closeAIReconciliationModal() {
    const modal = document.getElementById('ai-reconciliation-modal');
    if (modal) {
        modal.classList.remove('show');
    }
    window.aiReconciliationFiles = [];
}

// 处理AI对账附件上传
function handleAIReconciliationUpload(event) {
    const files = event.target.files;
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
    const allowedExtensions = ['.jpg', '.jpeg', '.png', '.pdf', '.xls', '.xlsx'];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        // 验证文件格式
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            alert('不支持的文件格式：' + file.name + '\n仅支持 JPG、PNG、PDF、Excel 格式');
            continue;
        }

        // 验证文件大小（最大10MB）
        if (file.size > 10 * 1024 * 1024) {
            alert('文件过大：' + file.name + '\n最大支持 10MB');
            continue;
        }

        // 添加到已上传列表
        window.aiReconciliationFiles.push({
            name: file.name,
            size: file.size,
            type: file.type,
            file: file,
            id: Date.now() + '_' + i
        });
    }

    // 渲染文件列表
    renderAIReconciliationFileList();

    // 清空input以便可以重复选择同一文件
    event.target.value = '';
}

// 渲染AI对账文件列表
function renderAIReconciliationFileList() {
    const listContainer = document.getElementById('ai-reconciliation-file-list');
    const countSpan = document.getElementById('ai-file-count');

    if (!listContainer) return;

    // 更新附件计数
    if (countSpan) {
        countSpan.textContent = `已上传 ${window.aiReconciliationFiles.length} 个文件`;
    }

    if (window.aiReconciliationFiles.length === 0) {
        listContainer.innerHTML = '';
        return;
    }

    let html = '';
    window.aiReconciliationFiles.forEach((file) => {
        const icon = getFileIcon(file.name);
        const iconColor = getFileIconColor(file.name);
        html += `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                <div style="width: 36px; height: 36px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0;">
                    <i data-lucide="${icon}" style="width: 18px; height: 18px; color: ${iconColor};"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 0.85rem; color: #1e293b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">${formatFileSize(file.size)}</div>
                </div>
                <button onclick="removeAIReconciliationFile('${file.id}')" style="border: none; background: #fee2e2; cursor: pointer; padding: 6px; border-radius: 6px; display: flex; align-items: center;">
                    <i data-lucide="trash-2" style="width: 14px; height: 14px; color: #ef4444;"></i>
                </button>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    if (window.lucide) window.lucide.createIcons();
}

// 删除AI对账附件
function removeAIReconciliationFile(fileId) {
    window.aiReconciliationFiles = window.aiReconciliationFiles.filter(f => f.id !== fileId);
    renderAIReconciliationFileList();
}

// 开始AI对账
function startAIReconciliation() {
    if (window.aiReconciliationFiles.length === 0) {
        alert('请先上传对账文件！');
        return;
    }

    const fileCount = window.aiReconciliationFiles.length;
    const reconciliationNo = window.currentReconciliationNo || '新建对账';

    alert(`AI对账已启动！

对账单号：${reconciliationNo}
已上传文件：${fileCount} 个

AI正在处理中，请稍候...`);
    closeAIReconciliationModal();
}

// ==================== 开票申请附件上传功能 ====================

// 存储开票申请的附件
window.invoiceAttachmentFiles = [];

// 处理开票申请附件上传
function handleInvoiceAttachmentUpload(event) {
    const files = event.target.files;
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
    const allowedExtensions = ['.jpg', '.jpeg', '.png', '.pdf', '.xls', '.xlsx'];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        // 验证文件格式
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            alert('不支持的文件格式：' + file.name + '\n仅支持 JPG、PNG、PDF、Excel 格式');
            continue;
        }

        // 验证文件大小（最大10MB）
        if (file.size > 10 * 1024 * 1024) {
            alert('文件过大：' + file.name + '\n最大支持 10MB');
            continue;
        }

        // 添加到已上传列表
        window.invoiceAttachmentFiles.push({
            name: file.name,
            size: file.size,
            type: file.type,
            file: file,
            id: Date.now() + '_' + i
        });
    }

    // 渲染文件列表
    renderInvoiceAttachmentList();

    // 清空input以便可以重复选择同一文件
    event.target.value = '';
}

// 渲染开票申请文件列表
function renderInvoiceAttachmentList() {
    const listContainer = document.getElementById('invoice-attachment-list');
    const countSpan = document.getElementById('invoice-attachment-count');

    if (!listContainer) return;

    // 更新附件计数
    if (countSpan) {
        if (window.invoiceAttachmentFiles.length > 0) {
            countSpan.textContent = `(${window.invoiceAttachmentFiles.length}个文件)`;
        } else {
            countSpan.textContent = '';
        }
    }

    if (window.invoiceAttachmentFiles.length === 0) {
        listContainer.innerHTML = '';
        return;
    }

    let html = '';
    window.invoiceAttachmentFiles.forEach((file) => {
        const icon = getFileIcon(file.name);
        const iconColor = getFileIconColor(file.name);
        html += `
            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: #f8fafc; border-radius: 4px; border: 1px solid #e2e8f0; font-size: 0.75rem;">
                <i data-lucide="${icon}" style="width: 14px; height: 14px; color: ${iconColor};"></i>
                <span style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #1e293b;" title="${file.name}">${file.name}</span>
                <span style="color: #94a3b8;">${formatFileSize(file.size)}</span>
                <button onclick="removeInvoiceAttachmentFile('${file.id}')" style="border: none; background: transparent; cursor: pointer; padding: 2px; display: flex; align-items: center;">
                    <i data-lucide="x" style="width: 12px; height: 12px; color: #ef4444;"></i>
                </button>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    if (window.lucide) window.lucide.createIcons();
}

// 删除开票申请附件
function removeInvoiceAttachmentFile(fileId) {
    window.invoiceAttachmentFiles = window.invoiceAttachmentFiles.filter(f => f.id !== fileId);
    renderInvoiceAttachmentList();
}

// ==================== 油卡信息导入文件上传功能 ====================

// 存储油卡导入的文件
window.fuelCardImportFiles = [];

// 处理油卡文件上传
function handleFuelCardFileUpload(event) {
    const files = event.target.files;
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
    const allowedExtensions = ['.jpg', '.jpeg', '.png', '.pdf', '.xls', '.xlsx'];

    let uploadedCount = 0;
    let fileNames = [];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        // 验证文件格式
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            alert('不支持的文件格式：' + file.name + '\n仅支持 JPG、PNG、PDF、Excel 格式');
            continue;
        }

        // 验证文件大小（最大10MB）
        if (file.size > 10 * 1024 * 1024) {
            alert('文件过大：' + file.name + '\n最大支持 10MB');
            continue;
        }

        // 添加到已上传列表
        window.fuelCardImportFiles.push({
            name: file.name,
            size: file.size,
            type: file.type,
            file: file,
            id: Date.now() + '_' + i
        });

        uploadedCount++;
        fileNames.push(file.name);
    }

    // 清空input以便可以重复选择同一文件
    event.target.value = '';

    // 显示上传成功提示
    if (uploadedCount > 0) {
        const isExcel = fileNames.some(name => name.toLowerCase().endsWith('.xls') || name.toLowerCase().endsWith('.xlsx'));

        if (isExcel) {
            alert(`已选择 ${uploadedCount} 个Excel文件:\n${fileNames.join('\n')}\n\n系统将自动解析Excel数据填充到表格中.`);
        } else {
            alert(`已上传 ${uploadedCount} 个文件:\n${fileNames.join('\n')}\n\n支持的文件格式：JPG、PNG、PDF、Excel`);
        }
    }
}


// Helper function for Bank-Enterprise Direct Config tab switching
function toggleBankConfigTab(tab) {
    const tabAccount = document.getElementById('tab-bank-account');
    const tabParams = document.getElementById('tab-params-config');
    const viewAccount = document.getElementById('bank-account-view');
    const viewParams = document.getElementById('parameter-config-view');

    if (tab === 'account') {
        tabAccount.classList.add('active');
        tabAccount.style.color = '#4f46e5';
        tabAccount.style.borderBottom = '2px solid #4f46e5';

        tabParams.classList.remove('active');
        tabParams.style.color = '#475569';
        tabParams.style.borderBottom = 'none';

        viewAccount.style.display = 'flex';
        viewParams.style.display = 'none';
    } else {
        tabParams.classList.add('active');
        tabParams.style.color = '#4f46e5';
        tabParams.style.borderBottom = '2px solid #4f46e5';

        tabAccount.classList.remove('active');
        tabAccount.style.color = '#475569';
        tabAccount.style.borderBottom = 'none';

        viewParams.style.display = 'flex';
        viewAccount.style.display = 'none';
    }
}


/**
 * Switches between internal tabs (e.g., in the Reconciliation page).
 * @param {string} tab - The identifier of the tab to switch to.
 */
function switchInternalTab(tab) {
    const reminderContent = document.getElementById('reconciliation-reminder-content');
    const listContent = document.getElementById('statement-list-content');
    const reminderTable = document.getElementById('reminder-table-wrapper');
    const listTable = document.getElementById('statement-list-table-wrapper');
    const tabs = document.querySelectorAll('.internal-tab');

    if (tab === 'reminder') {
        if (reminderContent) reminderContent.style.display = 'block';
        if (listContent) listContent.style.display = 'none';
        if (reminderTable) reminderTable.style.display = 'block';
        if (listTable) listTable.style.display = 'none';
        if (tabs[0]) tabs[0].classList.add('active');
        if (tabs[1]) tabs[1].classList.remove('active');
    } else if (tab === 'list') {
        if (reminderContent) reminderContent.style.display = 'none';
        if (listContent) listContent.style.display = 'block';
        if (reminderTable) reminderTable.style.display = 'none';
        if (listTable) listTable.style.display = 'block';
        if (tabs[0]) tabs[0].classList.remove('active');
        if (tabs[1]) tabs[1].classList.add('active');
    }

    if (window.lucide) {
        window.lucide.createIcons();
    }
}

/**
 * Toggles the visibility of expanded filter areas in tabs.
 * @param {HTMLElement} btn - The button/element clicked to toggle.
 */
function toggleTabFilters(btn) {
    const filterArea = btn.closest('.internal-filter-bar') || btn.closest('.filter-area') || btn.closest('.expense-detail-filter-area') || btn.closest('.payables-filter-area');
    if (!filterArea) return;

    const expandableArea = filterArea.querySelector('.expandable-filter-area-tab');
    if (!expandableArea) return;

    const isCollapsed = expandableArea.classList.toggle('collapsed');

    if (isCollapsed) {
        btn.innerHTML = `更多(0) < i data - lucide="chevron-down" style = "width: 12px; display: inline;" ></i > `;
    } else {
        btn.innerHTML = `收起 < i data - lucide="chevron-up" style = "width: 12px; display: inline;" ></i > `;
    }

    if (window.lucide) {
        window.lucide.createIcons();
    }
}

// Global click listener for filter toggles (handles both modal and dynamic tabs)
document.addEventListener('click', (e) => {
    // Handle modal filter toggle
    if (e.target.id === 'toggle-filter-btn' || e.target.closest('#toggle-filter-btn')) {
        const btn = e.target.id === 'toggle-filter-btn' ? e.target : e.target.closest('#toggle-filter-btn');
        const expandableArea = document.getElementById('expandable-filter-area');
        if (expandableArea) {
            const isCollapsed = expandableArea.classList.toggle('collapsed');
            if (isCollapsed) {
                btn.innerHTML = `More(2) < i data - lucide="chevron-down" ></i > `;
            } else {
                btn.innerHTML = `Less < i data - lucide="chevron-up" ></i > `;
            }
            if (window.lucide) window.lucide.createIcons();
        }
        return;
    }

    // Handle tab filter toggle (using class for delegation if needed, but currently handled via onclick in HTML)
});

/**
 * Deletes selected items from the statement list table.
 */
window.deleteSelectedItems = function () {
    const tableWrapper = document.getElementById('statement-list-table-wrapper');
    if (!tableWrapper || tableWrapper.style.display === 'none') {
        alert('请先切换到列表视图');
        return;
    }

    // Find all checkboxes in the table body that are checked
    const checkboxes = tableWrapper.querySelectorAll('tbody tr td:first-child input[type="checkbox"]:checked');

    if (checkboxes.length === 0) {
        alert('请选择要删除的数据');
        return;
    }

    if (confirm(`确定要删除选中的 ${checkboxes.length} 条数据吗？`)) {
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) {
                row.remove();
            }
        });

        // Uncheck "select all" if it exists/checked
        const headerCheckbox = tableWrapper.querySelector('thead tr th:first-child input[type="checkbox"]');
        if (headerCheckbox) headerCheckbox.checked = false;
    }
};


/**
 * Shows the Create Statement view and hides the List view.
 */
window.showCreateStatement = function () {
    const listView = document.getElementById('statement-list-view');
    const createView = document.getElementById('statement-create-view');
    const sidebar = document.querySelector('.customer-sidebar');
    if (listView) listView.style.display = 'none';
    if (createView) createView.style.display = 'flex';
    if (sidebar) sidebar.style.display = 'none';
};

/**
 * Hides the Create Statement view and shows the List view.
 */
window.hideCreateStatement = function () {
    const listView = document.getElementById('statement-list-view');
    const createView = document.getElementById('statement-create-view');
    const sidebar = document.querySelector('.customer-sidebar');
    if (listView) listView.style.display = 'flex';
    if (createView) createView.style.display = 'none';
    if (sidebar) sidebar.style.display = 'flex';
};

/**
 * Shows the Payment Application Create view and hides the List view and Sidebar.
 */
window.openPaymentApplicationCreateView = function () {
    const listView = document.getElementById('payment-application-list-view');
    const createView = document.getElementById('payment-application-create-view');
    const sidebar = document.querySelector('.customer-sidebar');
    if (listView) listView.style.display = 'none';
    if (createView) createView.style.display = 'flex';
    if (sidebar) sidebar.style.display = 'none';
};

/**
 * Hides the Payment Application Create view and restores the List view and Sidebar.
 */
window.closePaymentApplicationCreateView = function () {
    const listView = document.getElementById('payment-application-list-view');
    const createView = document.getElementById('payment-application-create-view');
    const sidebar = document.querySelector('.customer-sidebar');
    if (listView) listView.style.display = 'flex';
    if (createView) createView.style.display = 'none';
    if (sidebar) sidebar.style.display = 'flex';
};

/**
 * Shows the Pre-write-off Modal.
 */
window.showPreWriteOffModal = function () {
    const modal = document.getElementById('pre-write-off-modal');
    if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
        if (window.lucide) window.lucide.createIcons();
    }
};

/**
 * Closes the Pre-write-off Modal.
 */
window.closePreWriteOffModal = function () {
    const modal = document.getElementById('pre-write-off-modal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
};

/**
 * Updates the state of the "按票生成账单" button based on checkbox selection.
 */
window.updateGenerateBillButtonState = function () {
    const checkboxes = document.querySelectorAll('.expense-row-checkbox:checked');
    const btn = document.getElementById('expense-detail-generate-bill-btn');
    if (btn) {
        if (checkboxes.length > 0) {
            btn.disabled = false;
            btn.style.background = '#4f46e5';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
            btn.style.borderColor = '#4f46e5';
        } else {
            btn.disabled = true;
            btn.style.background = '#f1f5f9';
            btn.style.color = '#94a3b8';
            btn.style.cursor = 'not-allowed';
            btn.style.borderColor = '#e2e8f0';
        }
    }
};

/**
 * Toggles all checkboxes in the expense detail table.
 */
window.toggleAllExpenseCheckboxes = function (master) {
    const checkboxes = document.querySelectorAll('.expense-row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = master.checked;
    });
    updateGenerateBillButtonState();
};

/**
 * Shows the "Generate Bill" Modal.
 */
window.showGenerateBillModal = function () {
    let modal = document.getElementById('generate-bill-modal');
    if (!modal) {
        // Create modal if it doesn't exist
        modal = document.createElement('div');
        modal.id = 'generate-bill-modal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
                <div class="modal-container" style="max-width: 1000px; height: auto; max-height: 90vh;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>账单信息</span>
                    </div>
                    <i data-lucide="x" class="header-icon" onclick="closeGenerateBillModal()"></i>
                </div>
                <div class="modal-content" style="padding: 24px; gap: 20px;">
                    <!-- Row 1 -->
                    <div style="display: flex; gap: 24px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">结算公司</label>
                            <div style="display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; background: white; height: 32px;">
                                <div class="select-box-inline" style="width: 250px; border: none; height: 100%; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                    <span id="bill-settlement-company">丰源物流有限公司</span>
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px; padding: 0 8px; border-left: 1px solid #e2e8f0; background: #f8fafc;">
                                    <span style="font-size: 0.75rem; color: #4b5563; font-weight: 600;">NL</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px; padding: 0 8px; border-left: 1px solid #e2e8f0; background: #f8fafc;">
                                    <span style="font-size: 0.75rem; color: #4b5563; font-weight: 600;">票结</span>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">账单类型</label>
                            <div class="select-box" style="width: 180px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <span id="bill-type">原币</span>
                                <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #94a3b8;"></i>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">账单日期</label>
                            <input type="date" id="bill-date" value="${new Date().toISOString().split('T')[0]}" style="height: 32px; width: 160px; padding: 0 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.8rem; outline: none; cursor: pointer;">
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div style="display: flex; gap: 24px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 300px;">
                            <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">抬头</label>
                            <select id="bill-header" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                <option value="贝塔测试科技有限公司">贝塔测试科技有限公司</option>
                                <option value="深圳市远航达国际货运代理有限公司">深圳市远航达国际货运代理有限公司</option>
                                <option value="广州顺丰速运有限公司">广州顺丰速运有限公司</option>
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 300px;">
                            <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">银行账号</label>
                            <select id="bill-bank-account" style="width: 100%; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.8rem; outline: none; cursor: pointer; background: white; color: #334155;">
                                <option value="">请选择</option>
                                <option value="6222021234567890123">中国工商银行 6222021234567890123</option>
                                <option value="6217001234567890456">中国建设银行 6217001234567890456</option>
                                <option value="6228481234567890789">中国农业银行 6228481234567890789</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #fff;">
                    <button class="secondary-btn" onclick="closeGenerateBillModal()" style="height: 32px; padding: 0 20px; border: 1px solid #e2e8f0; background: white; color: #475569; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">取消</button>
                    <button class="primary-btn" onclick="closeGenerateBillModal()" style="height: 32px; padding: 0 20px; border: none; background: #4f46e5; color: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">确认</button>
                </div>
            </div>
                `;
        document.body.appendChild(modal);
    }
    modal.classList.add('show');
    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();
};

/**
 * Closes the "Generate Bill" Modal.
 */
window.closeGenerateBillModal = function () {
    const modal = document.getElementById('generate-bill-modal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
};

/**
 * Updates the state of the "创建账单" button in Receivables Detail based on checkbox selection.
 */
window.updateReceivablesCreateBillButtonState = function () {
    const checkboxes = document.querySelectorAll('.receivables-row-checkbox:checked');
    const btn = document.getElementById('receivables-create-bill-btn');
    if (btn) {
        if (checkboxes.length > 0) {
            btn.disabled = false;
            btn.style.background = '#4f46e5';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
            btn.style.borderColor = '#4f46e5';
        } else {
            btn.disabled = true;
            btn.style.background = '#f1f5f9';
            btn.style.color = '#94a3b8';
            btn.style.cursor = 'not-allowed';
            btn.style.borderColor = '#e2e8f0';
        }
    }
};

/**
 * Toggles all checkboxes in the receivables detail table.
 */
window.toggleAllReceivablesCheckboxes = function (master) {
    const checkboxes = document.querySelectorAll('.receivables-row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = master.checked;
    });
    updateReceivablesGenerateBillButtonState();
};

/**
 * Updates the state of the "按票生成账单" button in Receivables Detail based on checkbox selection.
 */
window.updateReceivablesGenerateBillButtonState = function () {
    const checkboxes = document.querySelectorAll('.receivables-row-checkbox:checked');
    const btn = document.getElementById('receivables-generate-bill-btn');
    if (btn) {
        if (checkboxes.length > 0) {
            btn.disabled = false;
            btn.style.background = '#4f46e5';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
            btn.style.borderColor = '#4f46e5';
        } else {
            btn.disabled = true;
            btn.style.background = '#f1f5f9';
            btn.style.color = '#94a3b8';
            btn.style.cursor = 'not-allowed';
            btn.style.borderColor = '#e2e8f0';
        }
    }
};

/**
 * Updates the state of the "创建账单" button in Customer Bill based on checkbox selection.
 */
window.updateCustomerBillCreateButtonState = function () {
    const checkboxes = document.querySelectorAll('.customer-bill-row-checkbox:checked');
    const btn = document.getElementById('customer-bill-create-btn');
    if (btn) {
        if (checkboxes.length > 0) {
            btn.disabled = false;
            btn.style.background = '#4f46e5';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
            btn.style.borderColor = '#4f46e5';
        } else {
            btn.disabled = true;
            btn.style.background = '#f1f5f9';
            btn.style.color = '#94a3b8';
            btn.style.cursor = 'not-allowed';
            btn.style.borderColor = '#e2e8f0';
        }
    }
};

/**
 * Toggles all checkboxes in the customer bill table.
 */
window.toggleAllCustomerBillCheckboxes = function (master) {
    const checkboxes = document.querySelectorAll('.customer-bill-row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = master.checked;
    });
    // updateCustomerBillCreateButtonState();
};

/**
 * Updates the state of the "按票生成账单" button in Payables Detail based on checkbox selection.
 */
window.updatePayablesGenerateBillButtonState = function () {
    const checkboxes = document.querySelectorAll('.payables-row-checkbox:checked');
    const btn = document.getElementById('payables-generate-bill-btn');
    if (btn) {
        if (checkboxes.length > 0) {
            btn.disabled = false;
            btn.style.background = '#4f46e5';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
            btn.style.borderColor = '#4f46e5';
        } else {
            btn.disabled = true;
            btn.style.background = '#f1f5f9';
            btn.style.color = '#94a3b8';
            btn.style.cursor = 'not-allowed';
            btn.style.borderColor = '#e2e8f0';
        }
    }
};

/**
 * Toggles all checkboxes in the payables detail table.
 */
window.toggleAllPayablesCheckboxes = function (master) {
    const checkboxes = document.querySelectorAll('.payables-row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = master.checked;
    });
    updatePayablesGenerateBillButtonState();
};

/**
 * Shows the Invoicing Expense Configuration modal.
 */
window.showInvoiceExpenseModal = function () {
    const modal = document.getElementById('invoice-expense-modal');
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        // Initialize Lucide icons in the modal
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }
};

/**
 * Closes the Invoicing Expense Configuration modal.
 */
window.closeInvoiceExpenseModal = function () {
    const modal = document.getElementById('invoice-expense-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }
};

// Add event listener for close button after DOM loaded
document.addEventListener('DOMContentLoaded', () => {
    const closeBtn = document.getElementById('close-expense-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeInvoiceExpenseModal);
    }
});

/**
 * Saves the invoice expense configuration from the modal to the list.
 */
window.saveInvoiceExpenseConfig = function () {
    const code = document.getElementById('invoice-tax-code').value;
    const taxName = document.getElementById('invoice-tax-name').value;
    const name = document.getElementById('invoice-service-name').value;
    const rate = document.getElementById('invoice-tax-rate').value;
    const isTaxFree = document.querySelector('input[name="tax-free"]:checked').value;

    if (!code || !taxName || !name || !rate) {
        alert('请填写完整必填信息');
        return;
    }

    const newConfig = {
        code,
        taxName,
        name,
        rate,
        isTaxFree
    };

    window.invoiceExpenseConfigs.push(newConfig);

    // Close modal
    closeInvoiceExpenseModal();

    // Clear inputs for next time
    document.getElementById('invoice-tax-code').value = '';
    document.getElementById('invoice-tax-name').value = '';
    document.getElementById('invoice-service-name').value = '';
    document.getElementById('invoice-tax-rate').value = '';

    // Refresh the tab
    renderTabs('开票费用配置');
};

/**
 * Deletes an invoice expense configuration from the list.
 */
window.deleteInvoiceExpenseConfig = function (index) {
    if (confirm('确定要删除这条配置吗？')) {
        window.invoiceExpenseConfigs.splice(index, 1);
        renderTabs('开票费用配置');
    }
};

/**
 * Shows the "Oil Card Import" modal.
 */
window.showFuelCardImportModal = function () {
    let modal = document.getElementById('fuel-card-import-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fuel-card-import-modal';
        modal.className = 'modal-overlay';
        modal.style.display = 'none';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal-container" style="width: 90vw; max-width: 1200px; height: 85vh; display: flex; flex-direction: column; background: #f8fafc; border-radius: 8px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <!-- Toolbar -->
            <div style="background: #eef2ff; padding: 12px 16px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <input type="file" id="fuel-card-import-input" accept=".jpg,.jpeg,.png,.pdf,.xls,.xlsx" style="display: none;" onchange="handleFuelCardFileUpload(event)">
                <button onclick="document.getElementById('fuel-card-import-input').click()" class="action-btn-classic" style="background: #f0fdf4; border: 1px solid #22c55e; color: #15803d; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <i data-lucide="file-spreadsheet" style="width: 14px; height: 14px;"></i> 导入油卡
                </button>
                <button class="action-btn-classic" onclick="window.removeDuplicateFuelCards()" style="background: #f0fdf4; border: 1px solid #22c55e; color: #15803d; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <i data-lucide="database-zap" style="width: 14px; height: 14px;"></i> 剔除重复
                </button>
                <button class="action-btn-classic" onclick="window.clearFuelCardImport()" style="background: #f0fdf4; border: 1px solid #22c55e; color: #15803d; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i> 清空
                </button>
                
                <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                    <label style="font-size: 0.75rem; color: #475569;">油卡类型:</label>
                    <select style="height: 28px; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0 8px; font-size: 0.75rem; outline: none; background: white;">
                        <option>公司卡</option>
                        <option>客户卡</option>
                    </select>
                    <button style="background: #dcfce7; border: 1px solid #22c55e; color: #15803d; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">批量设置</button>
                </div>
            </div>

            <!-- Header Text -->
            <div style="text-align: center; padding: 18px 0; background: #fff;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; letter-spacing: 8px; margin: 0;">油卡信息导入</h2>
            </div>

            <!-- Table Area -->
            <div style="flex-grow: 1; padding: 0 16px 16px 16px; overflow: auto; background: #fff;">
                <table style="width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 0.8rem; border: 1px solid #e2e8f0;">
                    <thead style="background: #f1f5f9; color: #475569; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: left;">油卡编号</th>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: left;">油卡类型</th>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: left;">油卡名称</th>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: right;">油卡余额</th>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: right;">油卡押金</th>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #e2e8f0; text-align: left;">联系人员</th>
                            <th style="padding: 10px 8px; border-bottom: 2px solid #e2e8f0; text-align: left;">备注信息</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Array(14).fill(0).map((_, i) => `
                            <tr style="border-bottom: 1px solid #f1f5f9; ${i % 2 === 0 ? '' : 'background: #fbfcfe;'}">
                                <td style="padding: 0; border-right: 1px solid #f1f5f9; height: 32px;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b;">
                                </td>
                                <td style="padding: 0; border-right: 1px solid #f1f5f9;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b;">
                                </td>
                                <td style="padding: 0; border-right: 1px solid #f1f5f9;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b;">
                                </td>
                                <td style="padding: 0; border-right: 1px solid #f1f5f9;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b; text-align: right;">
                                </td>
                                <td style="padding: 0; border-right: 1px solid #f1f5f9;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b; text-align: right;">
                                </td>
                                <td style="padding: 0; border-right: 1px solid #f1f5f9;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b;">
                                </td>
                                <td style="padding: 0;">
                                    <input type="text" style="width: 100%; height: 32px; border: none; outline: none; background: transparent; padding: 0 8px; font-size: 0.8rem; color: #1e293b;">
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>

            <!-- Footer Toolbar -->
            <div style="background: #fff; padding: 12px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button class="action-btn-classic" onclick="window.closeFuelCardImportModal()" style="background: #fef2f2; border: 1px solid #ef4444; color: #b91c1c; padding: 6px 20px; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i> 取消
                </button>
                <button class="action-btn-classic" onclick="window.saveFuelCardImport()" style="background: #f0fdf4; border: 1px solid #22c55e; color: #15803d; padding: 6px 20px; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存
                </button>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();

    // Closer on click outside
    modal.onclick = (e) => {
        if (e.target === modal) window.closeFuelCardImportModal();
    };
};

/**
 * Closes the "Oil Card Import" modal.
 */
window.closeFuelCardImportModal = function () {
    const modal = document.getElementById('fuel-card-import-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

/**
 * Toggles all checkboxes in the fuel card management table.
 * @param {HTMLInputElement} selectAllCheckbox - The header checkbox element.
 */
window.toggleAllFuelCardCheckboxes = function (selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.fuel-card-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
};

/**
 * Saves the data from the import modal to the main fuel card list.
 */
window.saveFuelCardImport = function () {
    const modal = document.getElementById('fuel-card-import-modal');
    if (!modal) return;

    const tbody = modal.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    const newCards = [];
    const timestamp = new Date().getTime().toString();

    rows.forEach((row, index) => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length < 7) return;

        const cardNo = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const name = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const deposit = inputs[4].value.trim();
        const contact = inputs[5].value.trim();
        const remarks = inputs[6].value.trim();

        if (cardNo) {
            newCards.push({
                id: window.fuelCardData.length + newCards.length + 1,
                sysId: 'SY' + timestamp.slice(-8) + String(index).padStart(3, '0'),
                cardNo: cardNo,
                type: type || '公司卡',
                name: name || '-',
                status: '在库',
                balance: balance || '0.00',
                deposit: deposit || '0.00',
                regDate: new Date().toISOString().split('T')[0],
                issueDate: '-',
                waybill: '-',
                plate: '-',
                phone: contact || '-',
                remarks: remarks || '导入'
            });
        }
    });

    if (newCards.length > 0) {
        window.fuelCardData = [...newCards, ...window.fuelCardData];
        alert(`成功导入 ${newCards.length} 条油卡信息`);

        // Refresh the main table
        if (window.renderFuelCardTableBody) {
            const activeTab = document.querySelector('.status-tab.active');
            window.renderFuelCardTableBody(activeTab ? activeTab.textContent.trim() : '全部');
        }

        window.closeFuelCardImportModal();
    } else {
        alert('请至少填写一个油卡编号');
    }
};

/**
 * Clears all inputs in the import modal.
 */
window.clearFuelCardImport = function () {
    const modal = document.getElementById('fuel-card-import-modal');
    if (!modal) return;
    const inputs = modal.querySelectorAll('tbody input');
    inputs.forEach(input => {
        input.value = '';
    });
};

/**
 * Removes duplicate oil card numbers from the import modal list.
 */
window.removeDuplicateFuelCards = function () {
    const modal = document.getElementById('fuel-card-import-modal');
    if (!modal) return;

    const tbody = modal.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    const seenCards = new Set();
    let removedCount = 0;

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length > 0) {
            const cardNo = inputs[0].value.trim();
            if (cardNo) {
                if (seenCards.has(cardNo)) {
                    // Duplicate found, clear the row
                    inputs.forEach(input => input.value = '');
                    removedCount++;
                } else {
                    seenCards.add(cardNo);
                }
            }
        }
    });

    if (removedCount > 0) {
        alert(`已成功剔除 ${removedCount} 条重复数据`);
    } else {
        alert('未发现重复的油卡编号');
    }
};

/**
 * Logouts selected fuel cards (status: 在库 -> 注销).
 */
window.logoutFuelCards = function () {
    const checkedCheckboxes = document.querySelectorAll('.fuel-card-checkbox:checked');
    if (checkedCheckboxes.length === 0) {
        alert('请先勾选需要注销的油卡');
        return;
    }

    const sysIds = Array.from(checkedCheckboxes).map(cb => cb.dataset.sysid);
    const selectedCards = window.fuelCardData.filter(card => sysIds.includes(card.sysId));

    // Validation: only "在库" can be logged out
    const invalidCards = selectedCards.filter(card => card.status !== '在库');
    if (invalidCards.length > 0) {
        alert(`注销失败：勾选的数据中包含状态为“${invalidCards[0].status}”的卡，仅“在库”状态的油卡可以执行注销操作`);
        return;
    }

    // Perform logout
    selectedCards.forEach(card => {
        card.status = '已注销';
    });

    alert('操作成功');
    const activeTab = document.querySelector('.status-tab.active');
    window.renderFuelCardTableBody(activeTab ? activeTab.textContent.trim() : '全部');
};

/**
 * Restores selected fuel cards (status: 注销 -> 在库).
 */
window.restoreFuelCards = function () {
    const checkedCheckboxes = document.querySelectorAll('.fuel-card-checkbox:checked');
    if (checkedCheckboxes.length === 0) {
        alert('请先勾选需要恢复的油卡');
        return;
    }

    const sysIds = Array.from(checkedCheckboxes).map(cb => cb.dataset.sysid);
    const selectedCards = window.fuelCardData.filter(card => sysIds.includes(card.sysId));

    // Validation: only "注销" can be restored
    const invalidCards = selectedCards.filter(card => card.status !== '已注销');
    if (invalidCards.length > 0) {
        alert(`恢复失败：勾选的数据中包含状态为"${invalidCards[0].status}"的卡，仅"已注销"状态的油卡可以执行恢复操作`);
        return;
    }

    // Perform restore
    selectedCards.forEach(card => {
        card.status = '在库';
    });

    alert('操作成功');
    const activeTab = document.querySelector('.status-tab.active');
    window.renderFuelCardTableBody(activeTab ? activeTab.textContent.trim() : '全部');
};

/**
 * Shows the "Fuel Card Recharge" modal.
 */
window.showFuelCardRechargeModal = function (targetSysId) {
    let sysId = targetSysId;

    if (!sysId) {
        const checkedCheckboxes = document.querySelectorAll('.fuel-card-checkbox:checked');
        if (checkedCheckboxes.length === 0) {
            alert('请先选择一张需要充值的油卡');
            return;
        }
        if (checkedCheckboxes.length > 1) {
            alert('每次只能为一张油卡进行充值');
            return;
        }

        sysId = checkedCheckboxes[0].dataset.sysid;
    }
    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (!card) return;

    const now = new Date();
    const timeStr = now.toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');

    let modal = document.getElementById('fuel-card-recharge-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fuel-card-recharge-modal';
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10001; font-family: "Microsoft YaHei", sans-serif;';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div style="background: #fff; width: 600px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: #f8fafc; padding: 18px 0; border-bottom: 1px solid #e2e8f0; text-align: center;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; letter-spacing: 8px; margin: 0;">油卡充值</h2>
            </div>
            
            <!-- Body -->
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 80px 1fr 80px 1.5fr; gap: 16px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">系统编号:</label>
                    <input type="text" value="${card.sysId}" disabled style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">油卡编号:</label>
                    <input type="text" value="${card.cardNo}" disabled style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">油卡名称:</label>
                    <input type="text" value="${card.name}" disabled style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">油卡余额:</label>
                    <input type="text" value="${card.balance}" disabled style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; text-align: right; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">充值时间:</label>
                    <input type="text" value="${timeStr}" disabled style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right; font-weight: 600;">充值金额:</label>
                    <input type="number" id="recharge-amount" style="width: 100%; padding: 6px 10px; border: 1px solid #3b82f6; border-radius: 4px; background: #fff; color: #1e293b; font-size: 1.1rem; text-align: right; outline: none; font-weight: 600;" value="0.00" onfocus="this.select()">
                    
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right; align-self: start; margin-top: 8px;">备注信息:</label>
                    <textarea id="recharge-remarks" style="grid-column: span 3; width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 4px; background: #fff; color: #1e293b; font-size: 0.85rem; resize: none; outline: none; transition: border-color 0.2s;" placeholder="请输入充值备注..."></textarea>
                </div>
            </div>

            <!-- Footer -->
            <div style="background: #f8fafc; padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: center; gap: 24px;">
                <button onclick="window.closeFuelCardRechargeModal()" style="background: #fff; border: 1px solid #cbd5e1; color: #64748b; padding: 8px 30px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                    <i data-lucide="x-circle" style="width: 18px; height: 18px;"></i> 取消
                </button>
                <button onclick="window.saveFuelCardRecharge('${sysId}')" style="background: #3b82f6; border: 1px solid #2563eb; color: #fff; padding: 8px 30px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;">
                    <i data-lucide="save" style="width: 18px; height: 18px;"></i> 确认充值
                </button>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();

    // Focus amount input
    setTimeout(() => {
        const amountInput = document.getElementById('recharge-amount');
        if (amountInput) amountInput.focus();
    }, 100);

    // Modal click out to close
    modal.onclick = (e) => {
        if (e.target === modal) window.closeFuelCardRechargeModal();
    };
};

/**
 * Saves the fuel card recharge and updates the card balance.
 */
window.saveFuelCardRecharge = function (sysId) {
    const amountInput = document.getElementById('recharge-amount');
    if (!amountInput) return;
    const amount = parseFloat(amountInput.value);
    const remark = document.getElementById('recharge-remarks')?.value || '';

    if (isNaN(amount) || amount <= 0) {
        alert('请输入正确的充值金额');
        return;
    }

    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (card) {
        // Create a pending request instead of updating balance immediately
        const requestId = 'REQ-' + Date.now();
        const newRequest = {
            id: requestId,
            cardId: card.cardId,
            sysId: sysId,
            cardName: card.name,
            amount: amount,
            remark: remark,
            applicant: '张三', // Simulated applicant
            applyTime: new Date().toLocaleString(),
            status: 'pending'
        };

        window.pendingRechargeRequests.push(newRequest);

        alert('已提交付款申请至任务中心，审核通过后余额将自动增加');
        window.closeFuelCardRechargeModal();

        // Refresh fuel card table if visible
        const activeTab = document.querySelector('.status-tab.active');
        window.renderFuelCardTableBody(activeTab ? activeTab.textContent.trim() : '全部');
    }
};

/**
 * Closes the recharge modal.
 */
window.closeFuelCardRechargeModal = function () {
    const modal = document.getElementById('fuel-card-recharge-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

/**
 * Shows the "Issue Fuel Card" modal.
 */
window.showIssueFuelCardModal = function () {
    const checkedCheckboxes = document.querySelectorAll('.fuel-card-checkbox:checked');
    if (checkedCheckboxes.length === 0) {
        alert('请先选择一张需要发放的油卡');
        return;
    }
    if (checkedCheckboxes.length > 1) {
        alert('每次只能发放一张油卡');
        return;
    }

    const sysId = checkedCheckboxes[0].dataset.sysid;
    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (!card) return;

    // Validation: status check
    if (card.status === '已发放' || card.status === '已注销') {
        alert(`发放失败：该油卡已处于“${card.status}”状态，无法再次发放`);
        return;
    }

    // Validation: must have balance
    if (parseFloat(card.balance || 0) <= 0) {
        alert('发放失败：该油卡余额为0，无法发放');
        return;
    }

    const now = new Date();
    const dateStr = now.toLocaleDateString('zh-CN').replace(/\//g, '-');

    let modal = document.getElementById('fuel-card-issue-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fuel-card-issue-modal';
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; font-family: "Microsoft YaHei", sans-serif;';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div style="background: #fff; width: 500px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: #f8fafc; padding: 18px 0; border-bottom: 1px solid #e2e8f0; text-align: center;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; letter-spacing: 8px; margin: 0;">油卡发放</h2>
            </div>
            
            <!-- Body -->
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 100px 1fr; gap: 16px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">发放日期:</label>
                    <input type="text" value="${dateStr}" disabled style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right;">发放运单号:</label>
                    <input type="text" id="issue-waybill" placeholder="请输入运单号" style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right;">车牌号码:</label>
                    <input type="text" id="issue-plate" placeholder="请输入车牌号码" style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right;">联系电话:</label>
                    <input type="text" id="issue-phone" placeholder="请输入联系电话" style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right; align-self: start; margin-top: 8px;">备注:</label>
                    <textarea id="issue-remarks" placeholder="请输入备注信息" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; resize: none; outline: none; transition: border-color 0.2s;"></textarea>
                </div>
            </div>

            <!-- Footer -->
            <div style="background: #f8fafc; padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: center; gap: 24px;">
                <button onclick="window.closeIssueFuelCardModal()" style="background: #fff; border: 1px solid #cbd5e1; color: #64748b; padding: 8px 30px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                    <i data-lucide="x-circle" style="width: 18px; height: 18px;"></i> 取消
                </button>
                <button onclick="window.saveIssueFuelCard('${sysId}')" style="background: #3b82f6; border: 1px solid #2563eb; color: #fff; padding: 8px 30px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;">
                    <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i> 确认发放
                </button>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();

    // Focus waybill input
    setTimeout(() => {
        const waybillInput = document.getElementById('issue-waybill');
        if (waybillInput) waybillInput.focus();
    }, 100);

    // Modal click out to close
    modal.onclick = (e) => {
        if (e.target === modal) window.closeIssueFuelCardModal();
    };
};

/**
 * Saves fuel card issuance data.
 */
window.saveIssueFuelCard = function (sysId) {
    const waybill = document.getElementById('issue-waybill').value.trim();
    const plate = document.getElementById('issue-plate').value.trim();
    const phone = document.getElementById('issue-phone').value.trim();
    const remarks = document.getElementById('issue-remarks').value.trim();

    if (!waybill) {
        alert('请输入发放运单号');
        return;
    }

    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (!card) return;

    // Update card data
    const now = new Date();
    card.status = '已发放';
    card.issueDate = now.toLocaleDateString('zh-CN').replace(/\//g, '-');
    card.waybillNo = waybill;
    card.plateNo = plate;
    card.contactPhone = phone;
    card.remarks = remarks;

    alert('发放成功');
    window.closeIssueFuelCardModal();

    const activeTab = document.querySelector('.status-tab.active');
    window.renderFuelCardTableBody(activeTab ? activeTab.textContent.trim() : '全部');
};

/**
 * Closes the Issue Fuel Card modal.
 */
window.closeIssueFuelCardModal = function () {
    const modal = document.getElementById('fuel-card-issue-modal');
    if (modal) modal.style.display = 'none';
};

/**
 * Shows the "Recover Fuel Card" modal.
 */
window.showRecoverFuelCardModal = function () {
    const checkedCheckboxes = document.querySelectorAll('.fuel-card-checkbox:checked');
    if (checkedCheckboxes.length === 0) {
        alert('请先选择一张需要回收的油卡');
        return;
    }
    if (checkedCheckboxes.length > 1) {
        alert('每次只能回收一张油卡');
        return;
    }

    const sysId = checkedCheckboxes[0].dataset.sysid;
    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (!card) return;

    // Validation: status must be '已发放'
    if (card.status !== '已发放') {
        alert(`回收失败：该油卡当前状态为“${card.status}”，仅“发放”状态的油卡可以进行回收操作`);
        return;
    }

    const now = new Date();
    const dateStr = now.toLocaleDateString('zh-CN').replace(/\//g, '-');

    let modal = document.getElementById('fuel-card-recover-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fuel-card-recover-modal';
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; font-family: "Microsoft YaHei", sans-serif;';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div style="background: #fff; width: 400px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: #f8fafc; padding: 18px 0; border-bottom: 1px solid #e2e8f0; text-align: center;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; letter-spacing: 8px; margin: 0;">油卡回收</h2>
            </div>
            
            <!-- Body -->
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 80px 1fr; gap: 16px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #64748b; text-align: right;">回收日期:</label>
                    <input type="text" value="${dateStr}" disabled style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right;">油卡余额:</label>
                    <input type="number" id="recover-balance" value="${card.balance}" style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none;">
                    
                    <label style="font-size: 0.85rem; color: #1e293b; text-align: right; align-self: start; margin-top: 8px;">备注:</label>
                    <textarea id="recover-remarks" placeholder="请输入备注信息" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; resize: none; outline: none; transition: border-color 0.2s;"></textarea>
                </div>
            </div>

            <!-- Footer -->
            <div style="background: #f8fafc; padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: center; gap: 24px;">
                <button onclick="window.closeRecoverFuelCardModal()" style="background: #fff; border: 1px solid #cbd5e1; color: #64748b; padding: 8px 30px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                    <i data-lucide="x-circle" style="width: 18px; height: 18px;"></i> 取消
                </button>
                <button onclick="window.saveRecoverFuelCard('${sysId}')" style="background: #3b82f6; border: 1px solid #2563eb; color: #fff; padding: 8px 30px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;">
                    <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i> 确认回收
                </button>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();

    // Focus balance input
    setTimeout(() => {
        const balInput = document.getElementById('recover-balance');
        if (balInput) balInput.select();
    }, 100);

    // Modal click out to close
    modal.onclick = (e) => {
        if (e.target === modal) window.closeRecoverFuelCardModal();
    };
};

/**
 * Saves fuel card recovery data.
 */
window.saveRecoverFuelCard = function (sysId) {
    const balance = document.getElementById('recover-balance').value.trim();
    const remarks = document.getElementById('recover-remarks').value.trim();

    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (!card) return;

    // Update card data
    card.status = '在库';
    card.balance = parseFloat(balance).toFixed(2);
    // Clear issuance details
    card.waybillNo = '';
    card.plateNo = '';
    card.contactPhone = '';
    card.remarks = remarks; // Update remarks for the recovery action

    alert('回收成功');
    window.closeRecoverFuelCardModal();

    const activeTab = document.querySelector('.status-tab.active');
    window.renderFuelCardTableBody(activeTab ? activeTab.textContent.trim() : '全部');
};

/**
 * Closes the Recover Fuel Card modal.
 */
window.closeRecoverFuelCardModal = function () {
    const modal = document.getElementById('fuel-card-recover-modal');
    if (modal) modal.style.display = 'none';
};

// Mock Data for Fuel Card Records
window.fuelCardRecordMockData = [
    { cardNo: '5Y20250101001', status: '已回收', balance: '1500.00', issueDate: '2025-01-01', issuer: '张三', recoverDate: '2025-01-15', recoverer: '李四' },
    { cardNo: '5Y20250101002', status: '发放中', balance: '500.00', issueDate: '2025-01-10', issuer: '王五', recoverDate: '-', recoverer: '-' },
    { cardNo: '5Y20250101003', status: '已回收', balance: '0.00', issueDate: '2024-12-20', issuer: '赵六', recoverDate: '2025-01-05', recoverer: '孙七' },
    { cardNo: '5Y20250101004', status: '在库', balance: '2800.00', issueDate: '-', issuer: '-', recoverDate: '-', recoverer: '-' },
    { cardNo: '5Y20250101005', status: '发放中', balance: '1200.00', issueDate: '2025-01-18', issuer: '张三', recoverDate: '-', recoverer: '-' }
];

/**
 * Shows the "Fuel Card Record Query" modal.
 */
window.showFuelCardRecordModal = function () {
    let modal = document.getElementById('fuel-card-record-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fuel-card-record-modal';
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; font-family: "Microsoft YaHei", sans-serif;';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div style="background: #fff; width: 900px; height: 600px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: #f8fafc; padding: 18px 0; border-bottom: 1px solid #e2e8f0; text-align: center;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; letter-spacing: 8px; margin: 0;">油卡记录查询</h2>
            </div>
            
            <!-- Search Area -->
            <div style="padding: 20px 24px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; gap: 16px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 0.85rem; color: #64748b;">油卡编号:</label>
                    <input type="text" id="record-card-no" placeholder="输入油卡编号" style="padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none; width: 140px;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 0.85rem; color: #64748b;">充值日期:</label>
                    <input type="date" id="record-recharge-date" style="padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 0.85rem; color: #64748b;">发放日期:</label>
                    <input type="date" id="record-issue-date" style="padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; outline: none;">
                </div>
                <button onclick="window.searchFuelCardRecords()" style="margin-left: auto; background: #3b82f6; border: 1px solid #2563eb; color: #fff; padding: 6px 20px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询
                </button>
            </div>

            <!-- Table Area -->
            <div style="flex-grow: 1; overflow: auto; padding: 0;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">油卡编号</th>
                            <th style="padding: 12px 16px; text-align: center; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">油卡状态</th>
                            <th style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">油卡余额</th>
                            <th style="padding: 12px 16px; text-align: center; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">发放日期</th>
                            <th style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">发放人员</th>
                            <th style="padding: 12px 16px; text-align: center; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">回收日期</th>
                            <th style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #475569; font-weight: 600;">回收人员</th>
                        </tr>
                    </thead>
                    <tbody id="fuel-card-record-tbody">
                        <!-- Data rows will be rendered here -->
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div style="background: #f8fafc; padding: 12px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end;">
                <button onclick="window.closeFuelCardRecordModal()" style="background: #fff; border: 1px solid #cbd5e1; color: #64748b; padding: 6px 20px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">
                    <i data-lucide="x" style="width: 14px; height: 14px;"></i> 关闭
                </button>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();

    // Initial Render
    window.renderFuelCardRecordTable(window.fuelCardRecordMockData);

    // Modal click out to close
    modal.onclick = (e) => {
        if (e.target === modal) window.closeFuelCardRecordModal();
    };
};

/**
 * Renders the record table.
 */
window.renderFuelCardRecordTable = function (data) {
    const tbody = document.getElementById('fuel-card-record-tbody');
    if (!tbody) return;

    if (data.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="padding: 30px; text-align: center; color: #94a3b8;">
                    暂无相关记录
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = data.map(item => `
        <tr style="border-bottom: 1px solid #f1f5f9; hover: background-color: #f8fafc;">
            <td style="padding: 12px 16px;">${item.cardNo}</td>
            <td style="padding: 12px 16px; text-align: center;">
                 <span style="background: ${item.status === '在库' ? '#ecfdf5' : item.status === '发放中' ? '#eff6ff' : '#fef2f2'}; 
                             color: ${item.status === '在库' ? '#059669' : item.status === '发放中' ? '#2563eb' : '#ef4444'}; 
                             padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                    ${item.status}
                </span>
            </td>
            <td style="padding: 12px 16px; text-align: right; font-weight: 500;">${item.balance}</td>
            <td style="padding: 12px 16px; text-align: center;">${item.issueDate}</td>
            <td style="padding: 12px 16px;">${item.issuer}</td>
            <td style="padding: 12px 16px; text-align: center;">${item.recoverDate}</td>
            <td style="padding: 12px 16px;">${item.recoverer}</td>
        </tr>
    `).join('');
};

/**
 * Filters the mock records.
 */
window.searchFuelCardRecords = function () {
    const cardNo = document.getElementById('record-card-no').value.trim().toLowerCase();
    const issueDate = document.getElementById('record-issue-date').value;

    // We ignore recharge date for now as per mock data limits, or we could add a dummy filter
    const filtered = window.fuelCardRecordMockData.filter(item => {
        const matchCard = !cardNo || item.cardNo.toLowerCase().includes(cardNo);
        const matchIssue = !issueDate || item.issueDate === issueDate;
        return matchCard && matchIssue;
    });

    window.renderFuelCardRecordTable(filtered);
};

/**
 * Closes the record modal.
 */
window.closeFuelCardRecordModal = function () {
    const modal = document.getElementById('fuel-card-record-modal');
    if (modal) modal.style.display = 'none';
};

/**
 * Shows the "Fuel Card Detail" modal.
 */
window.showFuelCardDetailModal = function (sysId) {
    const card = window.fuelCardData.find(c => c.sysId === sysId);
    if (!card) return;

    let modal = document.getElementById('fuel-card-detail-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fuel-card-detail-modal';
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; font-family: "Microsoft YaHei", sans-serif;';
        document.body.appendChild(modal);
    }

    // Determine values for display
    const statusColor = card.status === '在库' ? '#059669' : card.status === '已发放' ? '#2563eb' : '#e11d48';

    modal.innerHTML = `
        <div style="background: #fff; width: 800px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div style="background: #fff; padding: 20px 0; text-align: center; position: relative; border-bottom: 2px solid #5fa55a;">
                 <h2 style="font-size: 1.8rem; font-weight: 700; color: #1e293b; letter-spacing: 4px; margin: 0;">油 卡 信 息 查 看</h2>
                  <button onclick="window.closeFuelCardDetailModal()" style="position: absolute; right: 10px; top: 10px; background: none; border: none; cursor: pointer; color: #64748b;">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            
            <div style="padding: 24px;">
                <!-- Section 1: Basic Info -->
                <div style="background: #84cc7f; color: white; font-weight: bold; padding: 8px 16px; border-radius: 4px 4px 0 0; display: inline-block;">基本信息</div>
                <div style="border: 2px solid #84cc7f; margin-top: -2px; margin-bottom: 24px;">
                     <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9rem;">
                        <tr>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff; width: 15%;">油卡编号</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; width: 35%;">${card.cardNo}</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff; width: 15%;">油卡名称</td>
                            <td style="padding: 10px; border-bottom: 1px solid #84cc7f; width: 35%;">${card.name}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff;">当前状态</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; color: ${statusColor}; font-weight: bold;">${card.status}</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff;">油卡余额</td>
                            <td style="padding: 10px; border-bottom: 1px solid #84cc7f;">${card.balance}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; background: #eef2ff;">登记日期</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f;">${card.regDate}</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; background: #eef2ff;">登记人员</td>
                            <td style="padding: 10px;">张三</td> <!-- Hardcoded as example/placeholder -->
                        </tr>
                     </table>
                </div>

                <!-- Section 2: Last Usage -->
                <div style="background: #84cc7f; color: white; font-weight: bold; padding: 8px 16px; border-radius: 4px 4px 0 0; display: inline-block;">上次使用</div>
                <div style="border: 2px solid #84cc7f; margin-top: -2px;">
                     <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9rem;">
                        <tr>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff; width: 15%;">充值时间</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; width: 35%;">- - : :</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff; width: 15%;">充值金额</td>
                            <td style="padding: 10px; border-bottom: 1px solid #84cc7f; width: 35%;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff;">发放时间</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f;">${card.issueDate || '- - : :'}</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; border-bottom: 1px solid #84cc7f; background: #eef2ff;">发放对象</td>
                            <td style="padding: 10px; border-bottom: 1px solid #84cc7f;">${card.plateNo || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; background: #eef2ff;">回收时间</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f;">- - : :</td>
                            <td style="padding: 10px; border-right: 1px solid #84cc7f; background: #eef2ff;">回收余额</td>
                            <td style="padding: 10px;"></td>
                        </tr>
                     </table>
                </div>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();

    // Modal click out to close
    modal.onclick = (e) => {
        if (e.target === modal) window.closeFuelCardDetailModal();
    };
};

/**
 * Closes the detail modal.
 */
window.closeFuelCardDetailModal = function () {
    const modal = document.getElementById('fuel-card-detail-modal');
    if (modal) modal.style.display = 'none';
};


/**
 * Switches the Workbench view.
 */
window.switchWorkbenchView = function (view, el) {
    // Update active menu item
    document.querySelectorAll('.workbench-menu-item').forEach(item => item.classList.remove('active'));
    if (el) el.classList.add('active');

    const contentArea = document.getElementById('workbench-content-area');
    if (!contentArea) return;

    if (view === 'overview') {
        contentArea.innerHTML = window.renderWorkbenchOverview();
    } else if (view === 'task-center') {
        contentArea.innerHTML = window.renderTaskCenter();
    }
    if (window.lucide) window.lucide.createIcons();
};

/**
 * Handles switching within the workbench overview (split layout).
 */
window.switchWorkbenchInternalTab = function (type) {
    const content = document.getElementById('workbench-internal-content');
    if (!content) return;

    // Update button states
    const buttons = document.querySelectorAll('.workbench-tab-btn');
    buttons.forEach(btn => {
        btn.style.background = '#f8fafc';
        btn.style.color = '#64748b';
        btn.style.border = '1px solid #e2e8f0';
    });

    const activeBtn = document.getElementById(`wb-btn-${type}`);
    if (activeBtn) {
        activeBtn.style.background = '#4f46e5';
        activeBtn.style.color = 'white';
        activeBtn.style.border = 'none';
    }

    if (type === 'task') {
        content.innerHTML = window.renderTaskCenter();
    } else if (type === 'report') {
        content.innerHTML = window.renderVolumeProfitReport();
    }

    if (window.lucide) window.lucide.createIcons();
};

/**
 * Returns the HTML for the Workbench Overview (Dashboard).
 */
window.renderWorkbenchOverview = function () {
    return `
        <div style="display: flex; height: 100%; overflow: hidden; background: #f1f5f9;">
            <!-- Left Sidebar (Internal) -->
            <div style="width: 380px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; padding: 24px;">
                <!-- Navigation Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px;">
                    <button id="wb-btn-task" class="workbench-tab-btn" onclick="window.switchWorkbenchInternalTab('task')" style="flex: 1; height: 36px; background: #4f46e5; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i data-lucide="layout-list" style="width: 16px; height: 16px;"></i> 任务中心
                    </button>
                    <button id="wb-btn-report" class="workbench-tab-btn" onclick="window.switchWorkbenchInternalTab('report')" style="flex: 1; height: 36px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i data-lucide="bar-chart-3" style="width: 16px; height: 16px;"></i> 报表
                    </button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 1.25rem; color: #1e293b; font-weight: 700; margin-bottom: 4px;">运营概览</h2>
                    <p style="color: #64748b; font-size: 0.8rem;">欢迎回来，这是您今日的数据分析。</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Metric Cards (Single Column) -->
                    <div style="background: #eff6ff; border-radius: 12px; padding: 16px; border: 1px solid #dbeafe; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #1e40af; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px;">今日发货量</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e3a8a;">128</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <span style="color: #059669; font-size: 0.75rem; font-weight: 600;">+12% <i data-lucide="trending-up" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i></span>
                            <div style="width: 36px; height: 36px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);"><i data-lucide="truck" style="width: 18px; height: 18px;"></i></div>
                        </div>
                    </div>

                    <div style="background: #f0fdf4; border-radius: 12px; padding: 16px; border: 1px solid #dcfce7; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #166534; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px;">在途车辆</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #14532d;">45</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <span style="color: #16a34a; font-size: 0.75rem; font-weight: 600;">+5% <i data-lucide="trending-up" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i></span>
                            <div style="width: 36px; height: 36px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #22c55e; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);"><i data-lucide="package" style="width: 18px; height: 18px;"></i></div>
                        </div>
                    </div>

                    <div style="background: #fffbeb; border-radius: 12px; padding: 16px; border: 1px solid #fef3c7; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #92400e; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px;">今日已完结</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #78350f;">86</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <span style="color: #d97706; font-size: 0.75rem; font-weight: 600;">+8% <i data-lucide="trending-up" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i></span>
                            <div style="width: 36px; height: 36px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #f59e0b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);"><i data-lucide="check-circle" style="width: 18px; height: 18px;"></i></div>
                        </div>
                    </div>

                    <div style="background: #fef2f2; border-radius: 12px; padding: 16px; border: 1px solid #fee2e2; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #991b1b; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px;">待结清金额</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #7f1d1d;">¥24.8k</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <span style="color: #dc2626; font-size: 0.75rem; font-weight: 600;">-2.4% <i data-lucide="trending-down" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i></span>
                            <div style="width: 36px; height: 36px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #ef4444; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);"><i data-lucide="banknote" style="width: 18px; height: 18px;"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content Area -->
            <div id="workbench-internal-content" style="flex: 1; overflow: auto; background: white; position: relative;">
                <!-- Default Content: Task Center -->
                ${window.renderTaskCenter()}
            </div>
        </div>
    `;
};

/**
 * Returns the HTML for the Volume and Profit Report.
 */
window.renderVolumeProfitReport = function () {
    return `
        <div style="height: 100%; display: flex; flex-direction: column; background: #fff;">
            <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="font-size: 1.1rem; font-weight: 600; color: #1e293b;">货量利润表</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="primary-btn" style="height: 32px; padding: 0 16px;"><i data-lucide="download" style="width: 14px; height: 14px;"></i> 导出报表</button>
                </div>
            </div>
            <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; display: flex; gap: 16px; align-items: flex-end;">
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 0.75rem; color: #64748b;">时间范围</label>
                    <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                </div>
                <span style="padding-bottom: 8px;">至</span>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                        <label style="font-size: 0.75rem; color: #64748b;">&nbsp;</label>
                    <input type="date" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 0.75rem; color: #64748b;">结算单位</label>
                    <input type="text" placeholder="请输入单位名称" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.85rem; width: 180px;">
                </div>
                <button class="primary-btn" style="height: 32px; padding: 0 16px;"><i data-lucide="search" style="width: 14px; height: 14px;"></i> 查询</button>
            </div>
            <div style="flex-grow: 1; overflow: auto; padding: 20px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead style="background: #f8fafc; color: #64748b; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0;">月份</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0;">工作单量</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">总重量 (T)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">总体积 (CBM)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">收入合计 (¥)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">成本合计 (¥)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #10b981; font-weight: 600;">利润合计 (¥)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">利润率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px;">2024-01</td>
                            <td style="padding: 12px;">156</td>
                            <td style="padding: 12px; text-align: right;">1,245.50</td>
                            <td style="padding: 12px; text-align: right;">450.20</td>
                            <td style="padding: 12px; text-align: right;">856,400.00</td>
                            <td style="padding: 12px; text-align: right;">642,300.00</td>
                            <td style="padding: 12px; text-align: right; color: #10b981; font-weight: 600;">214,100.00</td>
                            <td style="padding: 12px; text-align: right;">25.0%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px;">2023-12</td>
                            <td style="padding: 12px;">142</td>
                            <td style="padding: 12px; text-align: right;">1,120.80</td>
                            <td style="padding: 12px; text-align: right;">380.50</td>
                            <td style="padding: 12px; text-align: right;">782,100.00</td>
                            <td style="padding: 12px; text-align: right;">594,400.00</td>
                            <td style="padding: 12px; text-align: right; color: #10b981; font-weight: 600;">187,700.00</td>
                            <td style="padding: 12px; text-align: right;">24.0%</td>
                        </tr>
                        <tr style="background: #f8fafc; font-weight: 600;">
                            <td style="padding: 12px;">合计</td>
                            <td style="padding: 12px;">298</td>
                            <td style="padding: 12px; text-align: right;">2,366.30</td>
                            <td style="padding: 12px; text-align: right;">830.70</td>
                            <td style="padding: 12px; text-align: right;">1,638,500.00</td>
                            <td style="padding: 12px; text-align: right;">1,236,700.00</td>
                            <td style="padding: 12px; text-align: right; color: #10b981;">401,800.00</td>
                            <td style="padding: 12px; text-align: right;">24.5%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
};

/**
 * Returns the HTML for the Task Center.
 */
window.renderTaskCenter = function () {
    return `
        <div style="display: flex; height: 100%; background: #fff;">
            <!-- Inner Sidebar -->
            <div style="width: 200px; border-right: 1px solid #e2e8f0; padding: 16px 0;">
                <div style="padding: 0 16px; margin-bottom: 12px; font-weight: 600; color: #1e293b; font-size: 0.9rem;">业务功能</div>
                <div class="task-menu-item active" onclick="window.switchBusinessFunction(this, 'payment')">付款申请</div>
                <div class="task-menu-item" onclick="window.switchBusinessFunction(this, 'invoice')">开票申请</div>
                <div class="task-menu-item" onclick="window.switchBusinessFunction(this, 'expense')">费用申请</div>
            </div>

            <!-- Main Task Content -->
            <div style="flex-grow: 1; display: flex; flex-direction: column;">
                <!-- Tabs -->
                <div style="display: flex; border-bottom: 1px solid #e2e8f0; padding: 0 20px;">
                    <div class="task-tab active" onclick="window.switchTaskTab(this, 'pending')">待处理的</div>
                    <div class="task-tab" onclick="window.switchTaskTab(this, 'initiated')">我发起的</div>
                    <div class="task-tab" onclick="window.switchTaskTab(this, 'processed')">已处理的</div>
                    <div class="task-tab" onclick="window.switchTaskTab(this, 'about_me')">关于我的</div>
                </div>

                <!-- Table Header -->
                <div style="padding: 0;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead style="background: #f8fafc; color: #64748b;">
                            <tr>
                                <th style="padding: 12px 16px; text-align: left; width: 40px;">#</th>
                                <th style="padding: 12px 16px; text-align: left;">申请单号</th>
                                <th style="padding: 12px 16px; text-align: left;">分类</th>
                                <th style="padding: 12px 16px; text-align: left;">业务说明</th>
                                <th style="padding: 12px 16px; text-align: left;">所属公司</th>
                                <th style="padding: 12px 16px; text-align: left;">结算单位</th>
                                <th style="padding: 12px 16px; text-align: left;">申请金额</th>
                                <th style="padding: 12px 16px; text-align: left;">流程名称</th>
                                <th style="padding: 12px 16px; text-align: left;">当前节点</th>
                                <th style="padding: 12px 16px; text-align: left;">审批状态</th>
                                <th style="padding: 12px 16px; text-align: left;">发起人</th>
                                <th style="padding: 12px 16px; text-align: left;">申请时间</th>
                                <th style="padding: 12px 16px; text-align: left;">流程结束时间</th>
                                <th style="padding: 12px 16px; text-align: left;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="task-table-body">
                            ${window.renderTaskTableBody('pending')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <style>
            .workbench-menu-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 20px;
                cursor: pointer;
                color: #64748b;
                font-size: 0.9rem;
                border-left: 3px solid transparent;
            }
            .workbench-menu-item:hover {
                background: #f8fafc;
                color: #3b82f6;
            }
            .workbench-menu-item.active {
                background: #eff6ff;
                color: #3b82f6;
                border-left-color: #3b82f6;
            }
            .task-menu-item {
                padding: 10px 24px;
                cursor: pointer;
                color: #64748b;
                font-size: 0.85rem;
            }
            .task-menu-item:hover {
                color: #3b82f6;
                background: #f8fafc;
            }
            .task-menu-item.active {
                color: #3b82f6;
                background: #eff6ff;
                font-weight: 500;
            }
            .task-tab {
                padding: 14px 20px;
                cursor: pointer;
                font-size: 0.9rem;
                color: #64748b;
                border-bottom: 2px solid transparent;
            }
            .task-tab.active {
                color: #3b82f6;
                border-bottom-color: #3b82f6;
                font-weight: 500;
            }
        </style>
    `;
};

/**
 * Handles switching between task status tabs.
 */
window.switchTaskTab = function (el, status) {
    // Update active state of tabs
    const tabs = el.parentElement.querySelectorAll('.task-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    el.classList.add('active');

    // Update the inner table body
    const tbody = document.getElementById('task-table-body');
    if (tbody) {
        tbody.innerHTML = window.renderTaskTableBody(status);
    }

    console.log(`Switching to task status: ${status}`);
};

/**
 * Returns the HTML for the task table body based on status.
 */
window.renderTaskTableBody = function (status) {
    if (status === 'processed') {
        return `
            <tr>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">1</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">PAY-20231024-001</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="background: #e0f2fe; color: #0284c7; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">付款申请</span></td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">10月物流运费结算</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">丰源物流</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">顺丰速运有限公司</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-weight: 500;">¥1,200.00</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">流程结算</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="color: #10b981; background: #d1fae5; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">已通过</span></td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">张三</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">2023-10-24 10:00</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">2023-10-24 14:00</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">
                    <a href="javascript:void(0)" style="color: #3b82f6; text-decoration: none;">查看</a>
                </td>
            </tr>
        `;
    } else if (status === 'initiated') {
        return `
            <tr>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">1</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">EXP-20231021-002</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">费用申请</span></td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">10月差旅费报销</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">丰源物流</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-weight: 500;">¥850.00</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">报销流程</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">经理审核</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="color: #3b82f6; background: #dbeafe; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">进行中</span></td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">我</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">2023-10-21 09:30</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">
                    <a href="javascript:void(0)" style="color: #3b82f6; text-decoration: none;">查看</a>
                </td>
            </tr>
        `;
    } else if (status === 'about_me') {
        return `
            <tr>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">1</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">INV-20231020-003</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="background: #f0fdf4; color: #16a34a; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">开票申请</span></td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">客户指定发票申请</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">丰源物流</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">贝塔测试科技有限公司</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-weight: 500;">¥3,200.00</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">开票核销流程</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">财务确认</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="color: #ea580c; background: #ffedd5; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">待审批</span></td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">李四</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">2023-10-20 15:45</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">
                    <a href="javascript:void(0)" style="color: #3b82f6; text-decoration: none;">查看</a>
                </td>
            </tr>
        `;
    }

    let html = '';
    let counter = 1;

    if (status === 'pending') {
        window.pendingRechargeRequests.forEach(req => {
            const isExpense = req.type === 'expense_audit';
            html += `
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${counter++}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.id}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="background: ${isExpense ? '#fef3c7' : '#e0f2fe'}; color: ${isExpense ? '#92400e' : '#0284c7'}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${isExpense ? '费用审核' : '付款申请'}</span></td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${isExpense ? `费用项目: ${req.cardId} (${req.cardName})` : `油卡充值: ${req.cardId} (${req.cardName})`}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">丰源物流</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-weight: 500;">¥${req.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${isExpense ? '费用审核审批' : '油卡充值审批'}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">财务审核</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="color: #ea580c; background: #ffedd5; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">待审批</span></td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.applicant}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.applyTime}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 8px;">
                        <a href="javascript:void(0)" onclick="window.approveRechargeRequest('${req.id}')" style="color: #10b981; text-decoration: none;">同意</a>
                        <a href="javascript:void(0)" onclick="window.rejectRechargeRequest('${req.id}')" style="color: #ef4444; text-decoration: none;">驳回</a>
                    </td>
                </tr>
            `;
        });
    }

    if (status === 'processed') {
        window.processedRechargeRequests.forEach(req => {
            const isExpense = req.type === 'expense_audit';
            html += `
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${counter++}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.id}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="background: ${isExpense ? '#fef3c7' : '#e0f2fe'}; color: ${isExpense ? '#92400e' : '#0284c7'}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${isExpense ? '费用审核' : '付款申请'}</span></td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${isExpense ? `费用项目: ${req.cardId} (${req.cardName})` : `油卡充值: ${req.cardId} (${req.cardName})`}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">丰源物流</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">-</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-weight: 500;">¥${req.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${isExpense ? '费用审核审批' : '油卡充值审批'}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">流程结算</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;"><span style="color: ${req.status === 'approved' ? '#10b981' : '#ef4444'}; background: ${req.status === 'approved' ? '#d1fae5' : '#fee2e2'}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${req.status === 'approved' ? '已通过' : '已驳回'}</span></td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.applicant}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.applyTime}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">${req.processTime}</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">
                        <a href="javascript:void(0)" style="color: #3b82f6; text-decoration: none;">查看</a>
                    </td>
                </tr>
            `;
        });
    }

    if (html) return html;

    return `
        <tr>
            <td colspan="14" style="padding: 40px; text-align: center; color: #94a3b8;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <i data-lucide="inbox" style="width: 32px; height: 32px; color: #cbd5e1;"></i>
                    <span>暂无此类任务</span>
                </div>
            </td>
        </tr>
    `;
};

/**
 * Handles switching between business functions in Task Center.
 */
window.switchBusinessFunction = function (el, func) {
    // Update active state of menu items
    const items = el.parentElement.querySelectorAll('.task-menu-item');
    items.forEach(item => item.classList.remove('active'));
    el.classList.add('active');

    // In a real app, this would load different categories of tasks
    console.log(`Switching to business function: ${func}`);
};

/**
 * Approves a fuel card recharge request.
 */
window.approveRechargeRequest = function (requestId) {
    const index = window.pendingRechargeRequests.findIndex(r => r.id === requestId);
    if (index === -1) return;

    const request = window.pendingRechargeRequests.splice(index, 1)[0];

    if (request.type === 'expense_audit') {
        const expense = window.expenseAuditData.find(e => e.id === request.orderId);
        if (expense) {
            expense.status = '审核通过';
        }
        alert(`费用审核通过: ${request.orderId}`);
    } else {
        const card = window.fuelCardData.find(c => c.sysId === request.sysId);
        if (card) {
            const currentBalance = parseFloat(card.balance.toString().replace(/,/g, '')) || 0;
            const newBalance = currentBalance + request.amount;
            card.balance = newBalance.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        alert('审批通过，油卡余额已更新');
    }

    request.status = 'approved';
    request.processTime = new Date().toLocaleString();
    window.processedRechargeRequests.push(request);

    // Refresh task list
    const activeTab = document.querySelector('.task-tab.active');
    if (activeTab) {
        const onclickAttr = activeTab.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/'([^']+)'/);
            if (match) {
                const status = match[1];
                const tbody = document.getElementById('task-table-body');
                if (tbody) tbody.innerHTML = window.renderTaskTableBody(status);
            }
        }
    }

    // Refresh other views if active
    const activeTabElement = document.querySelector('.tab-item.active');
    if (activeTabElement) {
        const activeTabTitle = activeTabElement.textContent.trim();
        if (activeTabTitle === '费用审核' || activeTabTitle === '录入订单') {
            renderTabs(activeTabTitle);
        }
    }
};

/**
 * Rejects a fuel card recharge request or expense audit.
 */
window.rejectRechargeRequest = function (requestId) {
    const index = window.pendingRechargeRequests.findIndex(r => r.id === requestId);
    if (index === -1) return;

    const request = window.pendingRechargeRequests.splice(index, 1)[0];

    if (request.type === 'expense_audit') {
        const expense = window.expenseAuditData.find(e => e.id === request.orderId);
        if (expense) {
            expense.status = '审核驳回';
        }
        alert(`费用申请已驳回: ${request.orderId}`);
    } else {
        alert('申请已驳回');
    }

    request.status = 'rejected';
    request.processTime = new Date().toLocaleString();
    window.processedRechargeRequests.push(request);

    // Refresh task list
    const activeTab = document.querySelector('.task-tab.active');
    if (activeTab) {
        const onclickAttr = activeTab.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/'([^']+)'/);
            if (match) {
                const status = match[1];
                const tbody = document.getElementById('task-table-body');
                if (tbody) tbody.innerHTML = window.renderTaskTableBody(status);
            }
        }
    }

    // Refresh other views if active
    const activeTabElement = document.querySelector('.tab-item.active');
    if (activeTabElement) {
        const activeTabTitle = activeTabElement.textContent.trim();
        if (activeTabTitle === '费用审核' || activeTabTitle === '录入订单') {
            renderTabs(activeTabTitle);
        }
    }
};

// --- Expense Modal Logic ---

/**
 * Injects the expense entry modal if it doesn't already exist.
 */
window.injectExpenseModal = function () {
    if (document.getElementById('expense-modal-container')) return;

    const modalHtml = `
        <div id="expense-modal-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; font-family: sans-serif;">
            <div style="background: white; border-radius: 8px; width: 1000px; max-width: 95%; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                <div style="padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                    <h3 style="margin: 0; font-size: 1rem; color: #1e293b;">新增费用项目</h3>
                    <button onclick="window.closeExpenseModal()" style="background: none; border: none; cursor: pointer; color: #64748b; padding: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div style="padding: 24px; display: flex; flex-direction: column; gap: 20px;">
                    <div id="modal-type-row" style="display: flex; align-items: center; gap: 12px; padding-bottom: 16px; border-bottom: 1px dashed #e2e8f0;">
                        <label style="font-size: 0.85rem; color: #64748b; font-weight: 600;">费用类型:</label>
                        <select id="modal-expense-type" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.85rem; outline: none; background: #f8fafc; cursor: pointer;">
                            <option value="revenue">收入金额</option>
                            <option value="advance">代垫金额</option>
                            <option value="payable" style="display: none;">支出费用</option>
                        </select>
                    </div>
                    
                    <div id="modal-table-container" style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; background: white;">
                        <!-- Table will be injected here -->
                    </div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                    <button onclick="window.closeExpenseModal()" style="padding: 8px 20px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-size: 0.9rem; cursor: pointer;">取消</button>
                    <button onclick="window.saveExpense()" style="padding: 8px 24px; border: none; border-radius: 6px; background: #4f46e5; color: white; font-size: 0.9rem; cursor: pointer; font-weight: 600;">保存</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    /**
     * Updates the modal table structure based on the selected expense type.
     */
    window.updateModalTable = function () {
        const typeSelect = document.getElementById('modal-expense-type');
        if (!typeSelect) return;
        const type = typeSelect.value;
        const container = document.getElementById('modal-table-container');
        if (!container) return;

        let tableHtml = '';
        if (type === 'revenue') {
            tableHtml = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                    <thead style="background: #f1f5f9;">
                        <tr>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 20%;"><span style="color: #ef4444;">*</span> 费用项目</th>
                            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 15%;"><span style="color: #ef4444;">*</span> 收入金额</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 25%;"><span style="color: #ef4444;">*</span> 结算公司</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">备注</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;">
                                <select id="modal-item" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;">
                                    <option value="" disabled selected>选择项目</option>
                                    <option value="信息费">信息费</option>
                                    <option value="送货费">送货费</option>
                                    <option value="接货费">接货费</option>
                                    <option value="停车费">停车费</option>
                                    <option value="保险费">保险费</option>
                                    <option value="其它">其它</option>
                                </select>
                            </td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="number" id="modal-amount" placeholder="0.00" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; text-align: right; font-weight: 600;"></td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;">
                                <select id="modal-company" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;">
                                    <option value="" disabled selected>选择公司</option>
                                    <option value="丰源物流">丰源物流</option>
                                    <option value="顺丰速运">顺丰速运</option>
                                    <option value="中通快递">中通快递</option>
                                    <option value="圆通速运">圆通速运</option>
                                    <option value="申通快递">申通快递</option>
                                    <option value="韵达快递">韵达快递</option>
                                </select>
                            </td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="date" id="modal-date" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;"></td>
                            <td style="padding: 0;"><input type="text" id="modal-remark" placeholder="..." style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem;"></td>
                        </tr>
                    </tbody>
                </table>
            `;
        } else if (type === 'advance') {
            tableHtml = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                    <thead style="background: #f1f5f9;">
                        <tr>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 15%;"><span style="color: #ef4444;">*</span> 费用项目</th>
                            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 12%;"><span style="color: #ef4444;">*</span> 代垫金额</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 18%;"><span style="color: #ef4444;">*</span> 结算公司</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 12%;">联系人</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 12%;">电话</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 12%;">计费日期</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">备注</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;">
                                <select id="modal-item" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;">
                                    <option value="" disabled selected>选择项目</option>
                                    <option value="运费">运费</option>
                                    <option value="装货费">装货费</option>
                                    <option value="卸货费">卸货费</option>
                                    <option value="停车费">停车费</option>
                                    <option value="保险费">保险费</option>
                                    <option value="其它">其它</option>
                                </select>
                            </td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="number" id="modal-amount" placeholder="0.00" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; text-align: right; font-weight: 600;"></td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;">
                                <select id="modal-company" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;">
                                    <option value="" disabled selected>选择公司</option>
                                    <option value="丰源物流">丰源物流</option>
                                    <option value="顺丰速运">顺丰速运</option>
                                    <option value="中通快递">中通快递</option>
                                    <option value="圆通速运">圆通速运</option>
                                    <option value="申通快递">申通快递</option>
                                    <option value="韵达快递">韵达快递</option>
                                </select>
                            </td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="text" id="modal-contact" placeholder="联系人" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem;"></td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="text" id="modal-phone" placeholder="电话" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem;"></td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="date" id="modal-date" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;"></td>
                            <td style="padding: 0;"><input type="text" id="modal-remark" placeholder="..." style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem;"></td>
                        </tr>
                    </tbody>
                </table>
            `;
        } else if (type === 'payable') {
            tableHtml = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                    <thead style="background: #f1f5f9;">
                        <tr>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 20%;"><span style="color: #ef4444;">*</span> 费用项目</th>
                            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 15%;"><span style="color: #ef4444;">*</span> 支出金额</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 25%;"><span style="color: #ef4444;">*</span> 结算公司</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">备注</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;">
                                <select id="modal-item" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;">
                                    <option value="" disabled selected>选择项目</option>
                                    <option value="运费">运费</option>
                                    <option value="装货费">装货费</option>
                                    <option value="卸货费">卸货费</option>
                                    <option value="停车费">停车费</option>
                                    <option value="保险费">保险费</option>
                                    <option value="其它">其它</option>
                                </select>
                            </td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="number" id="modal-amount" placeholder="0.00" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; text-align: right; font-weight: 600;"></td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;">
                                <select id="modal-company" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;">
                                    <option value="" disabled selected>选择公司</option>
                                    <option value="丰源物流">丰源物流</option>
                                    <option value="顺丰速运">顺丰速运</option>
                                    <option value="中通快递">中通快递</option>
                                    <option value="圆通速运">圆通速运</option>
                                    <option value="申通快递">申通快递</option>
                                    <option value="韵达快递">韵达快递</option>
                                </select>
                            </td>
                            <td style="padding: 0; border-right: 1px solid #e2e8f0;"><input type="date" id="modal-date" style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem; cursor: pointer;"></td>
                            <td style="padding: 0;"><input type="text" id="modal-remark" placeholder="..." style="width: 100%; height: 36px; border: none; outline: none; padding: 0 8px; background: transparent; font-size: 0.75rem;"></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }
        container.innerHTML = tableHtml;

        // Default date to today
        const dateInput = document.getElementById('modal-date');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    };

    const typeSelect = document.getElementById('modal-expense-type');
    if (typeSelect) {
        typeSelect.addEventListener('change', window.updateModalTable);
    }
};

/**
 * Shows the expense entry modal.
 */
window.showExpenseModal = function (context = 'receivable') {
    window.injectExpenseModal();
    const container = document.getElementById('expense-modal-container');
    const typeRow = document.getElementById('modal-type-row');
    const typeSelect = document.getElementById('modal-expense-type');

    if (container) {
        container.style.display = 'flex';

        if (context === 'payable') {
            if (typeRow) typeRow.style.display = 'none';
            if (typeSelect) typeSelect.value = 'payable';
        } else {
            if (typeRow) typeRow.style.display = 'flex';
            if (typeSelect && typeSelect.value === 'payable') typeSelect.value = 'revenue';
        }

        // Force table update and reset
        window.updateModalTable();
    }
};

/**
 * Closes the expense entry modal.
 */
window.closeExpenseModal = function () {
    const container = document.getElementById('expense-modal-container');
    if (container) {
        container.style.display = 'none';
    }
};

/**
 * Saves the expense from the modal, adds it to the audit list and creates a task.
 */
window.saveExpense = function () {
    const itemInput = document.getElementById('modal-item');
    const amountInput = document.getElementById('modal-amount');
    const companyInput = document.getElementById('modal-company');
    const dateInput = document.getElementById('modal-date');
    const remarkInput = document.getElementById('modal-remark');
    const typeSelect = document.getElementById('modal-expense-type');

    if (!itemInput || !amountInput || !companyInput || !itemInput.value.trim() || !amountInput.value.trim() || !companyInput.value.trim()) {
        alert('请填写必要字段 (费用项目, 金额, 结算公司)');
        return;
    }

    const type = typeSelect ? typeSelect.value : 'revenue';
    const amount = parseFloat(amountInput.value);
    const itemName = itemInput.value;
    const company = companyInput ? companyInput.value : '未指定公司';
    const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
    const remark = remarkInput ? remarkInput.value : '';

    if (type === 'payable') {
        const newPayableExpense = {
            id: 'PAY-' + Date.now(),
            itemName: itemName,
            amount: amount,
            company: company,
            date: date,
            remark: remark,
            status: '正常'
        };
        window.payableExpenseData.unshift(newPayableExpense);
        alert('支出费用保存成功');
    } else {
        // 1. Add to expenseAuditData
        const newOrderId = 'EXP-' + Date.now();
        const newExpense = {
            id: newOrderId,
            itemName: itemName,
            remark: remark,
            expenseType: type, // 'revenue' or 'advance'
            date: date,
            signDate: '-',
            pieces: 1,
            type: '费用单',
            weight: '0.00',
            salesman: '当前用户',
            volume: '0.00',
            operator: '当前用户',
            revenue: type === 'revenue' ? amount : 0,
            cost: type === 'advance' ? amount : 0,
            status: '审核中',
            customer: company
        };

        window.expenseAuditData.unshift(newExpense);

        // 2. Create Task in Task Center
        const newTask = {
            id: 'TASK-' + Date.now(),
            type: 'expense_audit',
            orderId: newOrderId,
            cardId: newOrderId, // Using orderId as identifier
            cardName: itemName,
            amount: amount,
            remark: remark,
            applicant: '当前用户',
            applyTime: new Date().toLocaleString(),
            status: 'pending'
        };

        window.pendingRechargeRequests.push(newTask);
        alert('保存成功，已提交审核申请至任务中心');
    }
    window.closeExpenseModal();

    // Refresh views if they are currently active
    const activeTabElement = document.querySelector('.tab-item.active');
    if (activeTabElement) {
        const activeTab = activeTabElement.textContent.trim();
        if (activeTab === '费用审核' || activeTab === '录入订单') {
            renderTabs(activeTab);
        }
    }

    // Also refresh workbench if active
    const workbenchActive = document.querySelector('.workbench-menu-item.active');
    if (workbenchActive && workbenchActive.textContent.includes('任务中心')) {
        window.switchWorkbenchView('task-center', workbenchActive);
    }
};

/**
 * Injects the configuration fields modal.
 */
window.injectConfigModal = function (type) {
    // Remove existing modal if any
    const existingModal = document.getElementById('config-modal-container');
    if (existingModal) existingModal.remove();

    // Save current type for later use
    window.currentConfigType = type;

    const isReceivable = type === 'receivable';
    const title = isReceivable ? '应收字段配置' : '应付字段配置';
    const titleColor = isReceivable ? '#0369a1' : '#dc2626';
    const bgColor = isReceivable ? '#f0f9ff' : '#fef2f2';

    // Try to read current fields from the panel
    const panelGridId = isReceivable ? 'expense-entry-receivable-grid' : 'expense-entry-payable-grid';
    const panelGrid = document.getElementById(panelGridId);

    let fields = [];

    if (panelGrid) {
        // Read current field labels from panel
        const panelLabels = panelGrid.querySelectorAll('label');
        panelLabels.forEach((label, index) => {
            const labelText = label.textContent.replace(':', '').trim();
            if (labelText) {
                fields.push({
                    label: labelText,
                    color: index === 0 ? '#ef4444' : '#475569',
                    fontWeight: index === 0 ? '600' : '400'
                });
            }
        });
    }

    // If no fields found in panel, use defaults
    if (fields.length === 0) {
        fields = isReceivable ? [
            { label: '应收运费', color: '#ef4444', fontWeight: '600' },
            { label: '客户计费重', color: '#475569', fontWeight: '400' },
            { label: '客户单价', color: '#475569', fontWeight: '400' },
            { label: '送货费', color: '#475569', fontWeight: '400' },
            { label: '装货费', color: '#475569', fontWeight: '400' },
            { label: '卸货费', color: '#475569', fontWeight: '400' },
            { label: '附加费', color: '#475569', fontWeight: '400' },
            { label: '收入合计', color: '#475569', fontWeight: '400' },
            { label: '待垫合计', color: '#475569', fontWeight: '400' }
        ] : [
            { label: '应付运费', color: '#ef4444', fontWeight: '600' },
            { label: '承运计费重', color: '#475569', fontWeight: '400' },
            { label: '承运单价', color: '#475569', fontWeight: '400' },
            { label: '油费', color: '#475569', fontWeight: '400' },
            { label: '到付车费', color: '#475569', fontWeight: '400' },
            { label: '回付车费', color: '#475569', fontWeight: '400' },
            { label: '信息费', color: '#475569', fontWeight: '400' },
            { label: '拦标价', color: '#475569', fontWeight: '400' }
        ];
    }

    // Build fields HTML in 3-column grid
    let fieldsHtml = '';
    fields.forEach(field => {
        fieldsHtml += `
            <div class="config-field-item" style="display: flex; align-items: center; gap: 4px;">
                <button onclick="this.parentElement.remove()" style="width: 20px; height: 20px; padding: 0; background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; flex-shrink: 0;" title="删除此字段">−</button>
                <label style="width: 70px; text-align: right; font-size: 0.8rem; color: ${field.color}; font-weight: ${field.fontWeight}; white-space: nowrap;">${field.label}:</label>
                <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
            </div>
        `;
    });

    // Add button HTML
    const addButtonHtml = `
        <div id="config-add-field-btn" style="display: flex; align-items: center; justify-content: center;">
            <button onclick="window.addConfigField()" style="width: 32px; height: 32px; padding: 0; background: white; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold;" title="新增字段">+</button>
        </div>
    `;

    const modalHtml = `
        <div id="config-modal-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; font-family: sans-serif;">
            <div style="background: white; border-radius: 8px; width: 900px; max-width: 95%; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                <div style="padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: ${bgColor};">
                    <h3 style="margin: 0; font-size: 1rem; color: ${titleColor};">${title}</h3>
                    <button onclick="window.closeConfigModal()" style="background: none; border: none; cursor: pointer; color: #64748b; padding: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div style="padding: 24px;">
                    <div id="config-fields-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        ${fieldsHtml}
                        ${addButtonHtml}
                    </div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                    <button onclick="window.closeConfigModal()" style="padding: 8px 20px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-size: 0.9rem; cursor: pointer;">取消</button>
                    <button onclick="window.saveConfigFields()" style="padding: 8px 24px; border: none; border-radius: 6px; background: #4f46e5; color: white; font-size: 0.9rem; cursor: pointer; font-weight: 600;">保存</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// Function to add a new field in the config modal
window.addConfigField = function () {
    const grid = document.getElementById('config-fields-grid');
    const addBtn = document.getElementById('config-add-field-btn');
    if (!grid || !addBtn) return;

    const newFieldHtml = `
        <div class="config-field-item" style="display: flex; align-items: center; gap: 4px;">
            <button onclick="this.parentElement.remove()" style="width: 20px; height: 20px; padding: 0; background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; flex-shrink: 0;" title="删除此字段">−</button>
            <select style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; background: white; min-width: 0; cursor: pointer;">
                <option value="">请选择费用</option>
                <option value="保险费">保险费</option>
                <option value="包装费">包装费</option>
                <option value="仓储费">仓储费</option>
                <option value="拖车费">拖车费</option>
                <option value="其他费用">其他费用</option>
            </select>
        </div>
    `;

    // Insert new field before the add button
    addBtn.insertAdjacentHTML('beforebegin', newFieldHtml);
};

// Function to save config fields and update panel
window.saveConfigFields = function () {
    const grid = document.getElementById('config-fields-grid');
    if (!grid) return;

    // Get all field items (exclude the add button)
    const fieldItems = grid.querySelectorAll('.config-field-item');
    const fieldLabels = [];

    fieldItems.forEach(item => {
        const label = item.querySelector('label');
        const select = item.querySelector('select');

        if (label) {
            // Get text without the colon
            const labelText = label.textContent.replace(':', '').trim();
            if (labelText) fieldLabels.push(labelText);
        } else if (select && select.value) {
            // For newly added fields with select dropdown
            fieldLabels.push(select.value);
        }
    });

    // Check for duplicates
    const uniqueLabels = new Set(fieldLabels);
    if (uniqueLabels.size !== fieldLabels.length) {
        alert('存在重复的字段，请检查后重试！');
        return;
    }

    // Check for empty select values
    const selectElements = grid.querySelectorAll('.config-field-item select');
    for (const select of selectElements) {
        if (!select.value) {
            alert('请为新增字段选择一个选项！');
            return;
        }
    }

    // Determine which panel to update
    const type = window.currentConfigType;
    const panelGridId = type === 'receivable' ? 'expense-entry-receivable-grid' : 'expense-entry-payable-grid';
    const panelGrid = document.getElementById(panelGridId);

    if (!panelGrid) {
        console.error('Panel grid not found:', panelGridId);
        window.closeConfigModal();
        return;
    }

    // Capture current input values before overwriting
    const currentValues = {};
    const existingInputs = panelGrid.querySelectorAll('input');
    existingInputs.forEach(input => {
        const labelEl = input.closest('div')?.querySelector('label');
        if (labelEl) {
            const lblTxt = labelEl.textContent.replace(':', '').replace(/\s+/g, '');
            currentValues[lblTxt] = input.value;
        }
    });

    // Create a global map of native fields by parsing the ACTUAL DOM 
    // to preserve readonly statuses, background colors, and native onchange handlers
    if (!window.nativeFieldsMap) {
        window.nativeFieldsMap = {};
        const allNativeDivs = document.querySelectorAll('#expense-entry-receivable-grid > div, #expense-entry-payable-grid > div');
        allNativeDivs.forEach(div => {
            // Only cache elements that are TRULY native (not previously generated custom inputs)
            const isCustom = div.querySelector('.custom-fee-input');
            const lbl = div.querySelector('label');
            if (lbl && !isCustom) {
                const text = lbl.textContent.replace(':', '').replace(/\s+/g, '');
                window.nativeFieldsMap[text] = div.innerHTML;
            }
        });
    }

    // Build new panel HTML from the config fields
    let panelHtml = '';
    fieldLabels.forEach((label, index) => {
        const isFirstField = index === 0;
        const labelColor = isFirstField ? '#ef4444' : '#475569';
        const fontWeight = isFirstField ? '600' : '400';
        const fieldId = `expense-entry-${type}-field-${index}`;
        const cleanLabel = label.replace(/\s+/g, '');

        // Check if it's a native field with specific hardcoded attributes
        if (window.nativeFieldsMap && window.nativeFieldsMap[cleanLabel]) {
            panelHtml += `
            <div style="display: flex; align-items: center; gap: 4px;">
                ${window.nativeFieldsMap[cleanLabel]}
            </div>`;
        } else {
            // It's a newly added custom field
            panelHtml += `
            <div style="display: flex; align-items: center; gap: 4px;">
                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: ${labelColor}; font-weight: ${fontWeight}; white-space: nowrap;">${label}:</label>
                <input id="${fieldId}" class="custom-fee-input" type="text" onchange="window.handleAdvanceTotal()" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; text-align: right; min-width: 0;">
            </div>
            `;
        }
    });

    // Update the panel grid dom
    panelGrid.innerHTML = panelHtml;

    // Restore previous values back into the newly rendered inputs
    const newRenderedInputs = panelGrid.querySelectorAll('input');
    newRenderedInputs.forEach(input => {
        const labelEl = input.closest('div')?.querySelector('label');
        if (labelEl) {
            const lblTxt = labelEl.textContent.replace(':', '').replace(/\s+/g, '');
            if (currentValues[lblTxt] !== undefined) {
                input.value = currentValues[lblTxt];
            }
        }
    });

    // Trigger sum check
    window.handleAdvanceTotal();

    // Close the modal
    window.closeConfigModal();

    // Show success message
    // alert('字段配置已保存！');
};

/**
 * Shows the configuration fields modal.
 * @param {string} type - 'receivable' or 'payable'
 */
window.showConfigModal = function (type = 'receivable') {
    window.injectConfigModal(type);
    const container = document.getElementById('config-modal-container');
    if (container) {
        container.style.display = 'flex';
    }
};

/**
 * Closes the configuration fields modal.
 */
window.closeConfigModal = function () {
    const container = document.getElementById('config-modal-container');
    if (container) {
        container.style.display = 'none';
    }
};

window.getFinancialPanelHTML = function () {
    return `
        <div style="display: flex; flex-direction: column; gap: 16px; width: 100%; height: 100%; box-sizing: border-box;">
            <!-- Receivable Section -->
            <div id="financial-income-module" style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px;">
                        <!-- Radio Group -->
                        <div style="display: flex; align-items: center; background: white; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0 8px; height: 32px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #334155; cursor: pointer; white-space: nowrap;">
                                <input type="radio" name="billStatus" checked style="accent-color: #3b82f6;"> 应收
                            </label>
                        </div>
                        
                        <!-- Checkbox -->
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #334155; cursor: pointer; margin-right: 8px; white-space: nowrap;">
                            <input type="checkbox" onchange="window.toggleReceivableState(this)" style="width: 14px; height: 14px; border: 1px solid #cbd5e1; border-radius: 2px;"> 完成应收
                        </label>

                        <!-- Buttons -->
                     <button onclick="window.jumpToInvoiceFromWaybill()" style="height: 32px; padding: 0 12px; background: #dbeafe; color: #2563eb; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; white-space: nowrap;">
                            开票申请
                        </button>
                         <button style="height: 32px; padding: 0 12px; background: #dbeafe; color: #2563eb; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; white-space: nowrap;">
                            生成账单
                        </button>
                        <button style="height: 32px; padding: 0 12px; background: #dbeafe; color: #2563eb; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap;">
                            提交审核 <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>

                    <!-- Summary & Calculation Section (Top) -->
                    <div id="receivable-summary-panel" style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; position: relative; margin-bottom: 12px;">

                        <!-- Config Button -->
                        <div onclick="window.showConfigModal()" style="position: absolute; top: 6px; left: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                            <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px 24px; margin-top: 32px;">
                            <!-- Row 1 -->
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #ef4444; font-weight: 600;">运  费:</label>
                                <input id="entry-freight" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">客户计费重:</label>
                                <input id="entry-billable-weight" oninput="document.getElementById('vehicle-carrier-weight').value = this.value;" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">客户单价:</label>
                                <input id="entry-unit-price" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                            </div>
                            <!-- Row 2 -->
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">送 货 费:</label>
                                <input id="entry-delivery-fee" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">装 货 费:</label>
                                <input id="entry-loading-fee" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">卸 货 费:</label>
                                <input id="entry-unloading-fee" oninput="window.updateOrderEntryTotals()" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #000000; font-weight: 600; text-align: right;">
                            </div>
                            <!-- Row 3 -->
                             <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">附 加 费:</label>
                                <input id="entry-additional-fee" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">收入合计:</label>
                                <input id="entry-revenue-total" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #1e293b; font-weight: 700; text-align: right; background: #f1f5f9; cursor: not-allowed;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 80px; text-align: right; font-size: 0.8rem; color: #475569;">待垫合计:</label>
                                <input id="entry-advance-total" type="text" readonly style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none; color: #4f46e5; font-weight: 600; text-align: right; background: #f8fafc; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>

                    <!-- Receivable Expense Area (Tables moved here) -->
                    <div id="receivable-expense-area" style="display: flex; gap: 12px; height: 260px; margin-bottom: 12px; flex-shrink: 0;">
                        <div style="flex: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                             <!-- Toolbar -->
                             <div style="padding: 8px 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: flex-start; background: #f8fafc;">
                                 <button onclick="window.showExpenseModal('receivable')" style="background: #4f46e5; color: white; border: none; border-radius: 4px; padding: 4px 12px; font-size: 0.85rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; height: 28px;">
                                     <i data-lucide="plus" style="width: 16px; height: 16px;"></i> 新增费用
                                 </button>
                             </div>
                             <!-- Table 1 -->
                             <div style="flex: 1; overflow: auto; border-bottom: 2px solid #e2e8f0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                        <tr>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">费用项目</th>
                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">收入金额</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 35%;">备注</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">状态</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'revenue').map(e => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.itemName || e.id}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;">${e.revenue.toFixed(2)}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.customer}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; white-space: nowrap;">${e.date}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.remark || '-'}</td>
                                                <td style="padding: 4px 8px;"><span style="color: ${e.status === '审核通过' ? '#10b981' : e.status === '审核驳回' ? '#ef4444' : '#f59e0b'}">${e.status}</span></td>
                                            </tr>
                                        `).join('')}
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'revenue').length < 8 ? Array(8 - window.expenseAuditData.filter(e => e.expenseType === 'revenue').length).fill(0).map(() => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px;"></td>
                                            </tr>
                                        `).join('') : ''}
                                    </tbody>
                                </table>
                             </div>
                             <!-- Table 2 -->
                             <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                        <tr>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">费用项目</th>
                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">代垫金额</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">联系人</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">电话</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">备注</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">状态</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'advance').map(e => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.itemName || e.id}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;">${e.cost.toFixed(2)}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.customer}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; white-space: nowrap;">${e.date}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">-</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">-</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.remark || '-'}</td>
                                                <td style="padding: 4px 8px;"><span style="color: ${e.status === '审核通过' ? '#10b981' : e.status === '审核驳回' ? '#ef4444' : '#f59e0b'}">${e.status}</span></td>
                                            </tr>
                                        `).join('')}
                                        ${window.expenseAuditData.filter(e => e.expenseType === 'advance').length < 8 ? Array(8 - window.expenseAuditData.filter(e => e.expenseType === 'advance').length).fill(0).map(() => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px;"></td>
                                            </tr>
                                        `).join('') : ''}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                </div>

                <!-- Right Column: Settlement & Cost (1/3 width) -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 12px; min-width: 0;">
                    <!-- Settlement Module -->
                    <div id="financial-settlement-module" style="background: #fdf2f2; border: 1px solid #fee2e2; border-radius: 8px; padding: 12px 24px; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.9rem; font-weight: 700; color: #1e293b;">* 结算方式:</label>
                                <div style="display: flex; align-items: center; background: white; border: 1px solid #4f46e5; border-radius: 4px; padding: 0; height: 36px; min-width: 120px;">
                                    <select id="settlementMethod" style="width: 100%; height: 100%; border: none; outline: none; background: transparent; color: #4f46e5; font-weight: 600; padding: 0 12px; cursor: pointer;">
                                        <option value="现付">现付</option>
                                        <option value="到付">到付</option>
                                        <option value="双付">双付</option>
                                        <option value="月结">月结</option>
                                        <option value="回单付">回单付</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: #db2777; font-weight: 600;">现付金额:</label>
                                    <input id="cashAmount" type="text" style="width: 100px; height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; font-weight: 700; color: #000000; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: #db2777; font-weight: 600;">到付金额:</label>
                                    <input id="deliveryAmount" type="text" style="width: 100px; height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; font-weight: 700; color: #000000; text-align: right;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: #db2777; font-weight: 600;">欠付金额:</label>
                                    <input type="text" style="width: 100px; height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 12px; font-size: 0.9rem; font-weight: 700; color: #000000; text-align: right;">
                                </div>

                                <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #4f46e5; font-weight: 600; cursor: pointer;">
                                    <input type="checkbox" style="width: 18px; height: 18px;"> 到付款月结
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Cost Module -->
                    <div id="financial-cost-module" style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; margin-bottom: 4px; overflow-x: auto; padding-bottom: 4px;">
                        <!-- Radio Group -->
                        <div style="display: flex; align-items: center; background: white; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0 8px; height: 32px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #334155; cursor: pointer; white-space: nowrap;">
                                <input type="radio" name="payableStatus" checked style="accent-color: #3b82f6;"> 应付
                            </label>
                        </div>
                        
                        <!-- Checkbox -->
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #334155; cursor: pointer; margin-right: 8px; white-space: nowrap;">
                            <input type="checkbox" onchange="window.togglePayableState(this)" style="width: 14px; height: 14px; border: 1px solid #cbd5e1; border-radius: 2px;"> 完成应付
                        </label>

                        <!-- Buttons -->
                         <button onclick="window.jumpToPaymentFromWaybill()" style="height: 32px; padding: 0 12px; background: #dbeafe; color: #2563eb; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; white-space: nowrap;">
                            付款申请
                        </button>
                         <button style="height: 32px; padding: 0 12px; background: #dbeafe; color: #2563eb; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; white-space: nowrap;">
                            生成账单
                        </button>
                        <button style="height: 32px; padding: 0 12px; background: #dbeafe; color: #2563eb; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap;">
                            提交审核 <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>

                    <!-- Vehicle Cost Section (New) -->
                    <div id="vehicle-cost-panel" style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 16px; margin-top: 12px; position: relative;">
                        <!-- Config Button -->
                        <div onclick="window.showConfigModal()" style="position: absolute; top: 6px; left: 6px; cursor: pointer; color: #94a3b8;" title="配置">
                            <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                        </div>

                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px 24px; margin-top: 32px;">
                            <!-- Row 1 -->
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #ef4444; white-space: nowrap;">基本车费:</label>
                                <input id="vehicle-basic-fee" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">承运商计费重:</label>
                                <input id="vehicle-carrier-weight" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">承运商单价:</label>
                                <input id="vehicle-carrier-price" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>

                            <!-- Row 2 -->
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">预付车费:</label>
                                <input id="vehicle-prepaid-fee" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">到付车费:</label>
                                <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">回付车费:</label>
                                <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>

                            <!-- Row 3 -->
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">信 息 费:</label>
                                <input type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="width: 100px; text-align: right; font-size: 0.8rem; color: #475569; white-space: nowrap;">拦 标 价:</label>
                                <input id="vehicle-bid-price" type="text" style="flex: 1; height: 30px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; font-size: 0.8rem; outline: none;">
                            </div>
                            <div style="visibility: hidden;"></div>
                        </div>
                    </div>

                    </div>

                    <!-- NEW: Payable Expense Tables (Copied from above) -->
                    <div id="payable-expense-area" style="display: flex; gap: 12px; height: 200px; margin-top: 12px; flex-shrink: 0;">
                         <div style="flex: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; font-size: 0.75rem;">
                             <!-- Toolbar -->
                             <div style="padding: 8px 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: flex-start; background: #f8fafc;">
                                 <button onclick="window.showExpenseModal('payable')" style="background: #4f46e5; color: white; border: none; border-radius: 4px; padding: 4px 12px; font-size: 0.85rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; height: 28px;">
                                     <i data-lucide="plus" style="width: 16px; height: 16px;"></i> 新增费用
                                 </button>
                             </div>
                             <!-- Table 1 (Displaying filter for revenue just in case, or adjusted for payable) -->
                             <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                        <tr>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">费用项目</th>
                                            <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #e2e8f0; width: 10%;">应付金额</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">结算公司</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 15%;">计费日期</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 35%;">备注</th>
                                            <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; width: 10%;">状态</th>
                                        </tr>
                                    </thead>
                                     <tbody>
                                        ${window.payableExpenseData.map(e => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.itemName}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;">${e.amount.toFixed(2)}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.company}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.date}</td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">${e.remark}</td>
                                                <td style="padding: 4px 8px;"><span style="color: #10b981;">${e.status}</span></td>
                                            </tr>
                                        `).join('')}
                                        ${window.payableExpenseData.length < 5 ? Array(5 - window.payableExpenseData.length).fill(0).map(() => `
                                            <tr style="border-bottom: 1px solid #f8fafc; height: 30px;">
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td>
                                                <td style="padding: 4px 8px;"></td>
                                            </tr>
                                        `).join('') : ''}
                                    </tbody>
                                </table>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    `;
};

window.togglePanel = function (containerId, isChecked) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const inputs = container.querySelectorAll('input, select, button, textarea');
    inputs.forEach(el => {
        // Don't disable the trigger checkboxes themselves
        if (el.getAttribute('onchange')?.includes('toggleReceivableState') ||
            el.getAttribute('onchange')?.includes('togglePayableState')) {
            return;
        }
        el.disabled = isChecked;
    });

    // Handle custom clickable elements
    const customButtons = container.querySelectorAll('div[onclick], i[onclick], span[onclick]');
    customButtons.forEach(el => {
        // Don't disable the config settings button if possible, but keep it simple for now
        el.style.pointerEvents = isChecked ? 'none' : 'auto';
        el.style.opacity = isChecked ? '0.5' : '1';
    });
};

window.toggleReceivableState = function (checkbox) {
    const isChecked = checkbox.checked;
    window.togglePanel('receivable-summary-panel', isChecked);
    window.togglePanel('receivable-expense-area', isChecked);
    window.togglePanel('financial-settlement-module', isChecked);
};

window.togglePayableState = function (checkbox) {
    const isChecked = checkbox.checked;
    window.togglePanel('vehicle-cost-panel', isChecked);
    window.togglePanel('payable-expense-area', isChecked);
};

/**
 * Jumps from Waybill/Financial Panel to Invoice Application (Create View).
 * Populates data if available.
 */
window.jumpToInvoiceFromWaybill = function () {
    // 1. Gather data to carry over
    // We'll look at window.expenseAuditData (Revenue items) as candidates
    const revenueItems = window.expenseAuditData ? window.expenseAuditData.filter(e => e.expenseType === 'revenue') : [];

    // Removed blocking confirmation as per user feedback/issue
    // if (revenueItems.length === 0) { ... }

    // 2. Switch Tab
    if (typeof window.addTab === 'function') {
        window.addTab('开票申请');
    } else if (typeof addTab === 'function') {
        addTab('开票申请');
    } else {
        console.error('addTab function not found');
        alert('无法跳转：addTab 函数未找到');
        return;
    }

    // 3. Switch View within Tab & Populate
    // We need to wait for the tab content to be rendered.
    setTimeout(() => {
        const createView = document.getElementById('invoice-application-create-view');
        const listView = document.getElementById('invoice-application-list-view');
        // Note: .customer-sidebar might not be globally unique or easily selectable if dynamic, 
        // but based on previous code it seemed static in the main layout.
        const sidebar = document.querySelector('.customer-sidebar');

        if (createView && listView) {
            listView.style.display = 'none';
            createView.style.display = 'flex';
            if (sidebar) sidebar.style.display = 'none';

            if (revenueItems.length > 0) {
                const uniqueCustomers = [...new Set(revenueItems.map(i => i.customer).filter(Boolean))];
                if (uniqueCustomers.length === 1) {
                    const customerSelect = document.getElementById('invoice-create-customer-select');
                    if (customerSelect) {
                        // Check if option exists, if not add it dynamically so the pre-fill works
                        let optionExists = false;
                        for (let i = 0; i < customerSelect.options.length; i++) {
                            if (customerSelect.options[i].value === uniqueCustomers[0]) {
                                optionExists = true;
                                break;
                            }
                        }
                        if (!optionExists) {
                            const newOption = new Option(uniqueCustomers[0], uniqueCustomers[0]);
                            customerSelect.add(newOption);
                        }
                        customerSelect.value = uniqueCustomers[0];
                    }
                }
            }

            // Populate Expense Table in the create view
            const tbody = createView.querySelector('.statement-table tbody');
            if (tbody && revenueItems.length > 0) {
                tbody.innerHTML = '';
                // We are not calculating deep totals here for brevity, just listing items.

                revenueItems.forEach((item, index) => {
                    const amount = parseFloat(item.revenue) || 0;
                    const taxRate = 0.09;

                    const exclTax = amount;
                    const taxAmount = exclTax * taxRate;
                    const total = exclTax + taxAmount;

                    tbody.innerHTML += `
                        <tr>
                            <td style="text-align: center;">${index + 1}</td>
                            <td>${item.itemName || '费用'}</td>
                            <td>*物流服务*${item.itemName || '运输费'}</td>
                            <td style="text-align: center;">次</td>
                            <td style="text-align: right;">1.00</td>
                            <td style="text-align: right;">${exclTax.toFixed(2)}</td>
                            <td style="text-align: right;">${exclTax.toFixed(2)}</td>
                            <td style="text-align: center;">9%</td>
                            <td style="text-align: right;">${taxAmount.toFixed(2)}</td>
                            <td style="text-align: right;">${total.toFixed(2)}</td>
                            <td style="text-align: right;">${total.toFixed(2)}</td>
                            <td style="text-align: center;">CNY</td>
                            <td>${item.remark || '-'}</td>
                            <td>-</td>
                            <td style="text-align: center;"><i data-lucide="trash-2" style="width: 14px; height: 14px; color: #ef4444; cursor: pointer;" onclick="this.closest('tr').remove()"></i></td>
                        </tr>
                    `;
                });

                if (window.lucide) window.lucide.createIcons();
            }
        }
    }, 500);
};

window.jumpToPaymentFromWaybill = function () {
    console.log('Jump triggered');
    alert('DEBUG: Function Called'); // Temporary debug
    // 1. Check if there are expenses to pay (expenses where cost > 0 or expenseType is advance)
    const expenses = window.expenseAuditData.filter(e => {
        // Since the data structure might vary, let's look for cost > 0 or type 'advance'
        return (e.cost && parseFloat(e.cost) > 0) || e.expenseType === 'advance';
    });

    if (expenses.length === 0) {
        // Fallback for demo: use mock data if no real data exists
        // This ensures the jump always works for the user to see the page
        expenses.push(
            { id: 999, date: '2025-01-25', itemName: '临时运费', cost: 500, customer: '临时客户', expenseType: 'advance' }
        );
        // alert('没有可申请付款的费用！');
        // return; 
    }

    // 2. Open "付款申请" Tab
    window.addTab('付款申请');

    // 3. Switch to Create View
    setTimeout(() => {
        // Try to use existing function if available
        if (typeof window.openPaymentApplicationCreateView === 'function') {
            window.openPaymentApplicationCreateView();
        } else {
            // Manual fallback
            const listView = document.getElementById('payment-application-list-view');
            const createView = document.getElementById('payment-application-create-view');
            if (listView && createView) {
                listView.style.display = 'none';
                createView.style.display = 'flex';
            }
        }

        // 4. Pre-fill Data
        const tableBody = document.querySelector('#payment-application-create-view table tbody');
        if (tableBody) {
            tableBody.innerHTML = expenses.map((e, index) => `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 8px; text-align: center;"><input type="checkbox" checked></td>
                    <td style="padding: 8px;">${index + 1}</td>
                    <td style="padding: 8px;">${e.date}</td>
                    <td style="padding: 8px;">EXP${e.id}</td>
                    <td style="padding: 8px;">${e.itemName}</td>
                    <td style="padding: 8px;">CNY</td>
                    <td style="padding: 8px; text-align: right;">${Number(e.cost).toFixed(2)}</td>
                    <td style="padding: 8px;">CUST001</td>
                    <td style="padding: 8px;">${e.customer}</td>
                    <td style="padding: 8px;">${e.customer}</td>
                    <td style="padding: 8px; text-align: right;">1.00</td>
                </tr>
            `).join('');

            // Also update totals if there are fields for it
            const totalAmount = expenses.reduce((sum, e) => sum + Number(e.cost || 0), 0);
            // Find elements to update? (Optional for now as per requirements)
        }
    }, 100);
};

/**
 * Saves the Waybill Entry.
 * Checks if "Prepaid Vehicle Fee" is entered and syncs to Fuel Card Management -> Pending Distribution.
 */
window.saveWaybillEntry = function () {
    // 1. Get Prepaid Vehicle Fee
    const prepaidFeeInput = document.getElementById('vehicle-prepaid-fee');
    const prepaidFee = prepaidFeeInput ? parseFloat(prepaidFeeInput.value) : 0;

    // Generate Waybill No
    const waybillNo = 'YD' + new Date().toISOString().replace(/\D/g, '').slice(0, 8) + Math.floor(Math.random() * 1000);

    // 2. If Fee > 0, Add to Fuel Card Management (Pending Distribution)
    if (prepaidFee > 0) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN').replace(/\//g, '-');

        const newRecord = {
            id: 'AUTO-' + Date.now(),
            sysId: 'SY-AUTO-' + Date.now(),
            waybillNo: waybillNo,
            waybillDate: dateStr,
            fuelCost: prepaidFee.toFixed(2),
            plateNo: '鄂A-88888', // Placeholder as not provided in this specific panel
            contactPhone: '13800000000', // Placeholder
            remarks: '由录入运单-预付车费自动生成',
            status: '待发放'
        };

        if (window.fuelCardData) {
            window.fuelCardData.unshift(newRecord);

            // Proactively refresh table if the View is active or render function exists
            if (typeof window.renderFuelCardTableBody === 'function') {
                // Check if current tab is Fuel Card Management
                // We just try to re-render "待发放" if it doesn't cause error
                try {
                    // Find active fuel card tab if any
                    const activeTab = document.querySelector('.status-tab.active');
                    if (activeTab && activeTab.textContent.trim() === '待发放') {
                        window.renderFuelCardTableBody('待发放');
                    }
                } catch (e) { console.log('Auto-refresh fuel card table skipped'); }
            }
        }
    }

    alert('运单保存成功！' + (prepaidFee > 0 ? '\n已自动生成油卡待发放记录。\n运单号: ' + waybillNo : '\n运单号: ' + waybillNo));
};
// --- Stored Value Card Management Functions ---

/**
 * Opens the Backend Recharge Modal (v2) for a specific user.
 * @param {string} userId - The user ID.
 * @param {string} userName - The user name.
 * @param {string} company - The company name.
 * @param {string} balance - The current balance (formatted string).
 */
window.openBackendRechargeModal = function (userId, userName, company, balance) {
    const modal = document.getElementById('backend-recharge-modal-v2');
    if (!modal) return;

    // Populate fields
    if (document.getElementById('modal-user-avatar')) document.getElementById('modal-user-avatar').textContent = userName.charAt(0);
    if (document.getElementById('modal-user-name')) document.getElementById('modal-user-name').textContent = userName;
    if (document.getElementById('modal-user-id')) document.getElementById('modal-user-id').textContent = userId;
    if (document.getElementById('modal-user-company')) document.getElementById('modal-user-company').textContent = company;
    if (document.getElementById('modal-user-balance')) document.getElementById('modal-user-balance').textContent = '¥' + balance;

    // Reset inputs
    if (document.getElementById('recharge-amount-input')) document.getElementById('recharge-amount-input').value = '1000';
    if (document.getElementById('modal-payment-select')) document.getElementById('modal-payment-select').textContent = '支付宝';
    const textarea = modal.querySelector('textarea');
    if (textarea) textarea.value = '';

    // Show modal
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
};

/**
 * Closes the Backend Recharge Modal.
 */
window.closeBackendRechargeModal = function () {
    const modal = document.getElementById('backend-recharge-modal-v2');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        const menu = document.getElementById('modal-payment-menu');
        if (menu) menu.classList.add('hidden');
    }
};

/**
 * Confirms the backend recharge.
 */
window.confirmBackendRecharge = function () {
    // Logic to save recharge would go here
    alert('充值成功 (模拟)');
    window.closeBackendRechargeModal();
};

/**
 * Opens the Backend Details Modal for a specific user.
 * @param {string} userId - The user ID.
 *  * @param {string} userName - The user name.
 * @param {string} company - The company name.
 * @param {string} balance - The current balance.
 */
window.openBackendDetailsModal = function (userId, userName, company, balance) {
    const modal = document.getElementById('backend-account-details-modal');
    if (!modal) return;

    // Populate fields
    if (document.getElementById('details-user-avatar')) document.getElementById('details-user-avatar').textContent = userName ? userName.charAt(0) : 'User';
    if (document.getElementById('details-user-name')) document.getElementById('details-user-name').textContent = userName || userId;
    if (document.getElementById('details-user-id')) document.getElementById('details-user-id').textContent = userId;
    if (document.getElementById('details-user-company')) document.getElementById('details-user-company').textContent = company || '-';
    if (document.getElementById('details-user-balance')) document.getElementById('details-user-balance').textContent = '¥' + (balance || '0.00');

    // Show modal
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
};

/**
 * Closes the Backend Details Modal.
 */
window.closeBackendDetailsModal = function () {
    const modal = document.getElementById('backend-account-details-modal');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
};

/**
 * Switches from Details modal to Recharge modal.
 */
window.switchToRechargeFromDetails = function () {
    window.closeBackendDetailsModal();
    // Simulate getting data from expected fields or passing them
    const userId = document.getElementById('details-user-id')?.textContent;
    const userName = document.getElementById('details-user-name')?.textContent;
    const company = document.getElementById('details-user-company')?.textContent;
    // Strip symbol
    let balance = document.getElementById('details-user-balance')?.textContent || '';
    balance = balance.replace('¥', '').replace(',', '');

    window.openBackendRechargeModal(userId, userName, company, balance);
};

// --- Batch Add Platform Tax Rate Modal ---
window.showBatchAddTaxRateModal = function () {
    if (document.getElementById('batch-add-tax-rate-modal')) return;

    const modal = document.createElement('div');
    modal.id = 'batch-add-tax-rate-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10003; font-family: sans-serif;';

    modal.innerHTML = `
        <div style="background: white; width: 400px; border-radius: 8px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
            <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                <h3 style="margin: 0; font-size: 1rem; color: #1e293b;">批量添加平台税金</h3>
                <i data-lucide="x" style="width: 20px; height: 20px; color: #64748b; cursor: pointer;" onclick="window.closeBatchAddTaxRateModal()"></i>
            </div>
            <div style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-size: 0.85rem; color: #475569;">平台</label>
                    <select id="batch-add-platform-select" style="height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none; font-size: 0.85rem;">
                        <option value="路歌">路歌</option>
                        <option value="A歌">A歌</option>
                        <option value="B歌">B歌</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-size: 0.85rem; color: #475569;">税率 (%)</label>
                    <input type="number" id="batch-add-tax-rate-input" placeholder="请输入税率" style="height: 36px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; outline: none; font-size: 0.85rem;">
                </div>
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                <button onclick="window.closeBatchAddTaxRateModal()" style="padding: 8px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; color: #475569; cursor: pointer; font-size: 0.85rem;">取消</button>
                <button onclick="window.confirmBatchAddTaxRate()" style="padding: 8px 16px; background: #4f46e5; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.85rem;">确定</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    if (window.lucide) window.lucide.createIcons();
};

window.closeBatchAddTaxRateModal = function () {
    const modal = document.getElementById('batch-add-tax-rate-modal');
    if (modal) modal.remove();
};

window.confirmBatchAddTaxRate = function () {
    const platform = document.getElementById('batch-add-platform-select').value;
    const rate = document.getElementById('batch-add-tax-rate-input').value;

    if (!rate) {
        alert('请输入税率');
        return;
    }

    alert(`已添加平台: ${platform}, 税率: ${rate}%`);
    window.closeBatchAddTaxRateModal();
};

window.addExpenseRow = function (type) {
    const tbodyId = type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    // Remove empty state if exists
    const emptyRow = tbody.querySelector('tr td[colspan="25"]');
    if (emptyRow) {
        tbody.innerHTML = '';
    }

    // Options configuration
    // 应收面板: 类别选项 应收(默认)、代垫; 应付面板: 应付(默认)
    const categoryOptions = type === 'receivable' ? ['应收', '代垫'] : ['应付'];
    // 结算公司: 5个虚拟选项
    const companyOptions = ['深圳市丰源物流有限公司', '上海顺丰速运有限公司', '北京京东世纪贸易有限公司', '广州德邦物流有限公司', '杭州中通快递有限公司'];
    // 费用: 5个虚拟选项
    const expenseOptions = ['运费', '操作费', '提货费', '送货费', '杂费'];

    const newRow = document.createElement('tr');
    newRow.style.borderBottom = '1px solid #f1f5f9';
    newRow.innerHTML = `
        <td style="padding: 6px 4px; text-align: center;"><input type="checkbox"></td>
        <td style="padding: 6px 8px; text-align: center;">${tbody.children.length + 1}</td>
        <td style="padding: 6px 8px;">
            <select style="width: 100%; min-width: 80px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; background: white;">
                ${categoryOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
        </td>
        <td style="padding: 6px 8px;">
            <select style="width: 100%; min-width: 220px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; background: white;">
                ${companyOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
        </td>
        <td style="padding: 6px 8px;">
             <select style="width: 100%; min-width: 100px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; background: white;">
                ${expenseOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
        </td>
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; text-align: right;"></td> <!-- 金额 -->
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; text-align: right;"></td> <!-- 单价 -->
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; text-align: right;"></td> <!-- 数量 -->
        <td style="padding: 6px 8px;"><input type="date" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px;"></td> <!-- 计费日期 -->
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px;"></td> <!-- 币别 -->
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px;"></td> <!-- 备注 -->
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; text-align: right;"></td> <!-- 汇率 -->
        <td style="padding: 6px 8px;"><input type="text" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px; text-align: right;"></td> <!-- 税率 -->
        <td style="padding: 6px 8px; text-align: right;">0.00</td> <!-- 本币金额 (Calculated?) -->
        <td style="padding: 6px 8px; text-align: center;">-</td> <!-- 关联状态 -->
        <td style="padding: 6px 8px; text-align: right;">0</td> <!-- 已销账 -->
        <td style="padding: 6px 8px; text-align: right;">0.00</td> <!-- 未销余额 -->
        <td style="padding: 6px 8px; text-align: right;">0.00</td> <!-- 实收实付 -->
        <td style="padding: 6px 8px;"></td> <!-- 核销时间 -->
        <td style="padding: 6px 8px;"></td> <!-- 对账单号 -->
        <td style="padding: 6px 8px;"></td> <!-- 形单号 -->
        <td style="padding: 6px 8px; text-align: center;"></td> <!-- 核销状态 -->
        <td style="padding: 6px 8px;"></td> <!-- 核销单号 -->
        <td style="padding: 6px 8px;"></td> <!-- 发票号 -->
        <td style="padding: 6px 8px; text-align: center;">
             <button style="border: none; background: transparent; color: #ef4444; cursor: pointer; padding: 2px;" onclick="this.closest('tr').remove()">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
    if (window.lucide) window.lucide.createIcons();
};

window.copyToReceivableRow = function () {
    const tbody = document.getElementById('expense-receivable-tbody');
    if (!tbody) return;

    // Find all checked rows in the receivable table
    const checkedRows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        return checkbox && checkbox.checked;
    });

    if (checkedRows.length === 0) {
        alert('请先勾选需要复制的数据');
        return;
    }

    checkedRows.forEach(row => {
        // Create a new row by cloning the existing one
        const newRow = row.cloneNode(true);

        // Update the checkbox to be unchecked for the new row
        const newCheckbox = newRow.querySelector('input[type="checkbox"]');
        if (newCheckbox) newCheckbox.checked = false;

        // Copy values from original inputs/selects to new inputs/selects
        // cloneNode(true) copies attributes but NOT the current value of inputs if changed by user
        const originalInputs = row.querySelectorAll('input, select');
        const newInputs = newRow.querySelectorAll('input, select');

        originalInputs.forEach((input, index) => {
            if (newInputs[index]) {
                newInputs[index].value = input.value;
            }
        });

        // Append the new row
        tbody.appendChild(newRow);
    });

    // Update indices for all rows
    Array.from(tbody.children).forEach((row, index) => {
        // Assuming the index is in the second column (index 1)
        if (row.cells[1]) {
            row.cells[1].textContent = index + 1;
        }
    });

    if (window.lucide) window.lucide.createIcons();
    alert(`成功复制 ${checkedRows.length} 条数据`);
};

window.copyToPayableRow = function () {
    const tbody = document.getElementById('expense-payable-tbody');
    if (!tbody) return;

    // Find all checked rows in the payable table
    const checkedRows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        return checkbox && checkbox.checked;
    });

    if (checkedRows.length === 0) {
        alert('请先勾选需要复制的数据');
        return;
    }

    checkedRows.forEach(row => {
        // Create a new row by cloning the existing one
        const newRow = row.cloneNode(true);

        // Update the checkbox to be unchecked for the new row
        const newCheckbox = newRow.querySelector('input[type="checkbox"]');
        if (newCheckbox) newCheckbox.checked = false;

        // Copy values from original inputs/selects to new inputs/selects
        // cloneNode(true) copies attributes but NOT the current value of inputs if changed by user
        const originalInputs = row.querySelectorAll('input, select');
        const newInputs = newRow.querySelectorAll('input, select');

        originalInputs.forEach((input, index) => {
            if (newInputs[index]) {
                newInputs[index].value = input.value;
            }
        });

        // Append the new row
        tbody.appendChild(newRow);
    });

    // Update indices for all rows
    Array.from(tbody.children).forEach((row, index) => {
        // Assuming the index is in the second column (index 1)
        if (row.cells[1]) {
            row.cells[1].textContent = index + 1;
        }
    });

    if (window.lucide) window.lucide.createIcons();
    alert(`成功复制 ${checkedRows.length} 条数据`);
};

window.toggleAllExpenseRows = function (source, type) {
    const tbodyId = type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = source.checked;
    });
};

window.batchModifyRow = function (type) {
    const tbodyId = type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    // Check checkboxes inside the tbody, avoiding the header checkbox if mistakenly grabbed
    const checkedBoxes = tbody.querySelectorAll('input[type="checkbox"]:checked');
    if (checkedBoxes.length === 0) {
        alert('请先勾选需要批量修改的数据');
        return;
    }

    // Check if modal already exists
    let modal = document.getElementById('batch-modify-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'batch-modify-modal';
        modal.className = 'modal-overlay';
        modal.style.zIndex = '9999'; // Ensure it's on top
        modal.style.position = 'fixed';
        modal.style.inset = '0';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.display = 'none'; // Initially hidden
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal-container" style="width: 480px; height: auto; max-height: 90vh; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column;">
            <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fff;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 4px; height: 16px; background: #4f46e5; border-radius: 2px;"></div>
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: #1e293b;">批量修改</h3>
                </div>
                <button onclick="window.closeBatchModifyModal()" style="border: none; background: transparent; cursor: pointer; color: #94a3b8; transition: color 0.2s;" onmouseover="this.style.color='#64748b'" onmouseout="this.style.color='#94a3b8'">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-content" style="padding: 24px; display: flex; flex-direction: column; gap: 20px;">
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px dashed #cbd5e1; color: #64748b; font-size: 0.8rem; display: flex; gap: 8px; align-items: flex-start;">
                    <i data-lucide="info" style="width: 14px; height: 14px; margin-top: 2px; flex-shrink: 0;"></i>
                    <span>仅修改您填写的字段，未填写的字段将保持原样。金额将根据新的单价/数量自动重新计算。</span>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-size: 0.85rem; font-weight: 500; color: #475569;">结算公司</label>
                    <div style="position: relative;">
                         <select id="batch-settlement-company" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px 12px; font-size: 0.9rem; outline: none; appearance: none; background: white; transition: border-color 0.2s; cursor: pointer;" onfocus="this.style.borderColor='#4f46e5'" onblur="this.style.borderColor='#e2e8f0'">
                            <option value="">(保持原样)</option>
                            <option value="深圳市土源物流有限公司">深圳市土源物流有限公司</option>
                            <option value="东莞市测试物流有限公司">东莞市测试物流有限公司</option>
                        </select>
                        <i data-lucide="chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #94a3b8; pointer-events: none;"></i>
                    </div>
                </div>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                        <label style="font-size: 0.85rem; font-weight: 500; color: #475569;">单价</label>
                        <div style="position: relative;">
                            <input type="number" id="batch-unit-price" placeholder="保持原样" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px 12px 10px 28px; font-size: 0.9rem; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='#4f46e5'" onblur="this.style.borderColor='#e2e8f0'">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 0.8rem;">¥</span>
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                        <label style="font-size: 0.85rem; font-weight: 500; color: #475569;">数量</label>
                         <div style="position: relative;">
                            <input type="number" id="batch-unit-quantity" placeholder="保持原样" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px 12px; font-size: 0.9rem; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='#4f46e5'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                <button onclick="window.closeBatchModifyModal()" style="padding: 8px 20px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; color: #64748b; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='white'">取消</button>
                <button onclick="window.saveBatchModify('${type}')" style="padding: 8px 24px; border: none; background: #4f46e5; border-radius: 6px; color: white; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background 0.2s; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);" onmouseover="this.style.background='#4338ca'" onmouseout="this.style.background='#4f46e5'">确认修改</button>
            </div>
        </div>
    `;

    modal.classList.add('show');
    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();
};

window.closeBatchModifyModal = function () {
    const modal = document.getElementById('batch-modify-modal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
};

window.saveBatchModify = function (type) {
    const company = document.getElementById('batch-settlement-company').value;
    const price = document.getElementById('batch-unit-price').value;
    const quantity = document.getElementById('batch-unit-quantity').value;

    const tbodyId = type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    const checkedBoxes = tbody.querySelectorAll('input[type="checkbox"]:checked');

    checkedBoxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (!row) return;

        // Settlement Company (Index 3) - Select
        if (company) {
            const companySelect = row.cells[3].querySelector('select');
            if (companySelect) companySelect.value = company;
        }

        // Unit Price (Index 6)
        if (price !== '') {
            const priceInput = row.cells[6].querySelector('input');
            if (priceInput) priceInput.value = price;
        }

        // Quantity (Index 7)
        if (quantity !== '') {
            const qtyInput = row.cells[7].querySelector('input');
            if (qtyInput) qtyInput.value = quantity;
        }

        // Recalculate Amount (Index 5) = Price * Qty
        const priceInput = row.cells[6].querySelector('input');
        const qtyInput = row.cells[7].querySelector('input');
        // Amount cell is index 5. Check if it's input or text. From original view_file logic it seemed to have input.
        const amountInput = row.cells[5].querySelector('input');

        if (priceInput && qtyInput && amountInput) {
            const p = parseFloat(priceInput.value) || 0;
            const q = parseFloat(qtyInput.value) || 0;
            amountInput.value = (p * q).toFixed(2);
        }
    });

    alert('修改成功');
    window.closeBatchModifyModal();
};






window.saveExpensePanelData = function () {
    let totalReceivable = 0;
    let totalPayable = 0;

    // Calculate Receivable
    const receivableRows = document.querySelectorAll('#expense-receivable-tbody tr');
    receivableRows.forEach(row => {
        // Amount is 6th cell (index 5)
        const amountInput = row.cells[5]?.querySelector('input');
        if (amountInput) {
            totalReceivable += parseFloat(amountInput.value) || 0;
        }
    });

    // Calculate Payable
    const payableRows = document.querySelectorAll('#expense-payable-tbody tr');
    payableRows.forEach(row => {
        // Amount is 6th cell (index 5)
        const amountInput = row.cells[5]?.querySelector('input');
        if (amountInput) {
            totalPayable += parseFloat(amountInput.value) || 0;
        }
    });

    const profit = totalReceivable - totalPayable;
    let margin = 0;
    if (totalReceivable !== 0) {
        margin = (profit / totalReceivable) * 100;
    }

    // Update Summary
    if (document.getElementById('summary-receivable')) document.getElementById('summary-receivable').textContent = totalReceivable.toFixed(2);
    if (document.getElementById('summary-payable')) document.getElementById('summary-payable').textContent = totalPayable.toFixed(2);
    if (document.getElementById('summary-profit')) document.getElementById('summary-profit').textContent = profit.toFixed(2);
    if (document.getElementById('summary-gross-margin')) document.getElementById('summary-gross-margin').textContent = margin.toFixed(2) + '%';

    alert('保存成功！数据已更新。');
};

window.completeExpensePanel = function () {
    // Disable Add buttons
    const buttons = document.querySelectorAll('button[onclick^="window.addExpenseRow"]');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    });
    alert('已完结！无法再新增费用。');
};

window.handleSettlementModeChange = function () {
    const mode = document.getElementById('settlement-mode-select').value;
    const spotInput = document.getElementById('spot-pay-input');
    const collectInput = document.getElementById('freight-collect-input');

    if (!spotInput || !collectInput) return;

    if (mode === '现付') {
        collectInput.disabled = true;
        collectInput.style.backgroundColor = '#f1f5f9';
        collectInput.value = '';
        spotInput.disabled = false;
        spotInput.style.backgroundColor = 'white';
    } else if (mode === '到付') {
        spotInput.disabled = true;
        spotInput.style.backgroundColor = '#f1f5f9';
        spotInput.value = '';
        collectInput.disabled = false;
        collectInput.style.backgroundColor = 'white';
    } else {
        spotInput.disabled = false;
        spotInput.style.backgroundColor = 'white';
        collectInput.disabled = false;
        collectInput.style.backgroundColor = 'white';
    }
};

window.addFeeEntryRow = function (type) {
    const tbodyId = type === 'income' ? 'fee-entry-income-tbody' : 'fee-entry-cost-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    const newRow = document.createElement('tr');
    newRow.style.borderBottom = '1px solid #f8fafc';
    newRow.style.height = '30px';

    // Define options
    const expenseOptions = ['请选择', '保险费', '装卸费', '保管费', '包装费', '其他'];
    const companyOptions = ['深圳市丰源物流有限公司', '东莞分公司', '广州分公司'];
    const categoryOptions = type === 'income' ? ['应收', '代垫'] : ['应付'];

    const expenseSelectOptions = expenseOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
    const companySelectOptions = companyOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
    const categorySelectOptions = categoryOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');

    newRow.innerHTML = `
        <td style="padding: 4px; width: 30px;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">
            <select style="width: 100%; border: none; outline: none; background: transparent;">
                ${expenseSelectOptions}
            </select>
        </td> <!-- 费用 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"><input type="text" class="income-fee-amount" onchange="window.handleAdvanceTotal()" style="width: 100%; border: none; outline: none; background: transparent; text-align: right;"></td> <!-- 费用金额 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">
             <select style="width: 100%; border: none; outline: none; background: transparent;">
                ${companySelectOptions}
            </select>
        </td> <!-- 结算公司 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">
             <select class="income-fee-category" onchange="window.handleAdvanceTotal()" style="width: 100%; border: none; outline: none; background: transparent;">
                ${categorySelectOptions}
            </select>
        </td> <!-- 类别 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="date" style="width: 100%; border: none; outline: none; background: transparent;"></td> <!-- 计费日期 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="text" style="width: 100%; border: none; outline: none; background: transparent;"></td> <!-- 联系人 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="text" style="width: 100%; border: none; outline: none; background: transparent;"></td> <!-- 电话 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="text" style="width: 100%; border: none; outline: none; background: transparent;"></td> <!-- 备注 -->
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"></td> <!-- 状态 -->
        <td style="padding: 4px 8px; text-align: center;">
            <button style="border: none; background: transparent; color: #ef4444; cursor: pointer; padding: 2px;" onclick="this.closest('tr').remove(); window.handleAdvanceTotal()">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
            </button>
        </td>
    `;
    // Insert before the last empty-like rows or just append? 
    // The existing code has 4 empty rows. IDK if I should remove them.
    // I'll just append for now, user didn't specify behavior for empty rows here.
    // Actually, usually you want to insert at the top or replace.
    // I'll prepend it to make it visible immediately.
    tbody.insertBefore(newRow, tbody.firstChild);

    if (window.lucide) window.lucide.createIcons();
};

// --- Expense Panel to Statement Creation Jump ---
window.jumpToStatementCreationFromExpensePanel = function () {
    // 1. Switch Tab to '对账单'
    if (typeof window.addTab === 'function') {
        // Trigger the tab logic which renders the HTML for '对账单'
        window.addTab('对账单');
    } else {
        console.error('addTab function not found');
        return;
    }

    // 2. Wait for the DOM to update
    setTimeout(() => {
        // 3. Find the views
        // Note: The ID might be inside the mainContent rendered string, so it should exist after addTab execution.
        const listView = document.getElementById('statement-list-view');
        const createView = document.getElementById('statement-create-view');
        const customerSidebar = document.querySelector('.customer-sidebar');

        if (listView && createView) {
            // 4. Toggle Visibility
            listView.style.display = 'none';
            createView.style.display = 'flex';
        } else {
            console.error('Views not found after switching tab');
        }

        // 5. Force hide customer sidebar if it persists from DOM caching
        if (customerSidebar) {
            customerSidebar.style.display = 'none';
        }
    }, 100);
};

// --- Expense Entry to Expense Panel Data Sync ---
// Global data arrays for expense panel
window.expensePanelReceivableData = window.expensePanelReceivableData || [];
window.expensePanelPayableData = window.expensePanelPayableData || [];

// Save expense entry data and sync to expense panel
window.saveExpenseEntryAndSyncToPanel = function () {
    // Get values from expense entry form
    const receivableFreight = document.getElementById('expense-entry-receivable-freight');
    const deliveryFee = document.getElementById('expense-entry-delivery-fee');
    const loadingFee = document.getElementById('expense-entry-loading-fee');
    const unloadingFee = document.getElementById('expense-entry-unloading-fee');
    const payableFreight = document.getElementById('expense-entry-payable-freight');

    const today = new Date().toISOString().split('T')[0];
    let hasData = false;

    // Clear previous data for new sync (or append, depending on requirement)
    window.expensePanelReceivableData = [];
    window.expensePanelPayableData = [];

    // Process receivable freight (应收运费 -> 费用面板应收: 运费)
    if (receivableFreight && receivableFreight.value && parseFloat(receivableFreight.value) > 0) {
        window.expensePanelReceivableData.push({
            id: 'REC-' + Date.now() + '-1',
            name: '运费',
            amount: parseFloat(receivableFreight.value) || 0,
            date: today,
            currency: 'CNY',
            status: '未核销'
        });
        hasData = true;
    }

    // Process delivery fee (送货费 -> 费用面板应收: 送货费)
    if (deliveryFee && deliveryFee.value && parseFloat(deliveryFee.value) > 0) {
        window.expensePanelReceivableData.push({
            id: 'REC-' + Date.now() + '-2',
            name: '送货费',
            amount: parseFloat(deliveryFee.value) || 0,
            date: today,
            currency: 'CNY',
            status: '未核销'
        });
        hasData = true;
    }

    // Process loading fee (装货费 -> 费用面板应收: 装货费)
    if (loadingFee && loadingFee.value && parseFloat(loadingFee.value) > 0) {
        window.expensePanelReceivableData.push({
            id: 'REC-' + Date.now() + '-3',
            name: '装货费',
            amount: parseFloat(loadingFee.value) || 0,
            date: today,
            currency: 'CNY',
            status: '未核销'
        });
        hasData = true;
    }

    // Process unloading fee (卸货费 -> 费用面板应收: 卸货费)
    if (unloadingFee && unloadingFee.value && parseFloat(unloadingFee.value) > 0) {
        window.expensePanelReceivableData.push({
            id: 'REC-' + Date.now() + '-4',
            name: '卸货费',
            amount: parseFloat(unloadingFee.value) || 0,
            date: today,
            currency: 'CNY',
            status: '未核销'
        });
        hasData = true;
    }

    // Process payable freight (应付运费 -> 费用面板应付: 运费)
    if (payableFreight && payableFreight.value && parseFloat(payableFreight.value) > 0) {
        window.expensePanelPayableData.push({
            id: 'PAY-' + Date.now() + '-1',
            name: '运费',
            amount: parseFloat(payableFreight.value) || 0,
            date: today,
            currency: 'CNY',
            status: '未核销'
        });
        hasData = true;
    }

    // Process income table data (上面面板 -> 费用面板)
    const incomeTbody = document.getElementById('fee-entry-income-tbody');
    if (incomeTbody) {
        const rows = incomeTbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const selects = row.querySelectorAll('select');
            const inputs = row.querySelectorAll('input');

            // First select is fee name, second is company, third is category
            const feeName = selects[0] ? selects[0].value.trim() : '';
            const company = selects[1] ? selects[1].value.trim() : '';
            const category = selects[2] ? selects[2].value.trim() : '应收'; // 应该只有"应收"或"代垫"

            // Array inputs based on addFeeEntryRow HTML structure
            const feeAmount = inputs[0] ? parseFloat(inputs[0].value) : 0;
            const feeDate = inputs[1] && inputs[1].value ? inputs[1].value : today;
            const contact = inputs[2] ? inputs[2].value.trim() : '';
            const phone = inputs[3] ? inputs[3].value.trim() : '';
            const remark = inputs[4] ? inputs[4].value.trim() : '';

            if (feeName && feeAmount > 0) {
                const dataObj = {
                    id: (category === '应收' ? 'REC-TABLE-' : 'PAY-TABLE-') + Date.now() + '-' + index,
                    name: feeName,
                    amount: feeAmount,
                    date: feeDate,
                    currency: 'CNY',
                    status: '未核销',
                    company: company,
                    category: category,
                    contact: contact,
                    phone: phone,
                    remark: remark
                };

                // 根据类别分流：代垫归入应付面板(Payable)
                if (category === '应收') {
                    window.expensePanelReceivableData.push(dataObj);
                } else {
                    window.expensePanelPayableData.push(dataObj);
                }
                hasData = true;
            }
        });
    }

    // Process cost table data (下面面板 -> 费用面板)
    const costTbody = document.getElementById('fee-entry-cost-tbody');
    if (costTbody) {
        const rows = costTbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const selects = row.querySelectorAll('select');
            const inputs = row.querySelectorAll('input');

            // First select is fee name, second is company, third is category
            const feeName = selects[0] ? selects[0].value.trim() : '';
            const company = selects[1] ? selects[1].value.trim() : '';
            const category = selects[2] ? selects[2].value.trim() : '应付'; // 应该主要是"应付"

            // Array inputs based on addFeeEntryRow HTML structure
            const feeAmount = inputs[0] ? parseFloat(inputs[0].value) : 0;
            const feeDate = inputs[1] && inputs[1].value ? inputs[1].value : today;
            const contact = inputs[2] ? inputs[2].value.trim() : '';
            const phone = inputs[3] ? inputs[3].value.trim() : '';
            const remark = inputs[4] ? inputs[4].value.trim() : '';

            if (feeName && feeAmount > 0) {
                window.expensePanelPayableData.push({
                    id: 'PAY-TABLE-' + Date.now() + '-' + index,
                    name: feeName,
                    amount: feeAmount,
                    date: feeDate,
                    currency: 'CNY',
                    status: '未核销',
                    company: company,
                    category: category,
                    contact: contact,
                    phone: phone,
                    remark: remark
                });
                hasData = true;
            }
        });
    }

    // Process newly added custom configured fields to sync to panel
    const customRecInputs = document.querySelectorAll('#expense-entry-receivable-grid .custom-fee-input');
    customRecInputs.forEach((input, index) => {
        const val = parseFloat(input.value);
        if (!isNaN(val) && val > 0) {
            const labelEl = input.closest('div')?.querySelector('label');
            const name = labelEl ? labelEl.textContent.replace(':', '').trim() : '自定义费用';
            window.expensePanelReceivableData.push({
                id: 'REC-CUSTOM-' + Date.now() + '-' + index,
                name: name,
                amount: val,
                date: today,
                currency: 'CNY',
                status: '未核销',
                company: '-',
                category: '应收',
                contact: '-',
                phone: '-',
                remark: '-'
            });
            hasData = true;
        }
    });

    const customPayInputs = document.querySelectorAll('#expense-entry-payable-grid .custom-fee-input');
    customPayInputs.forEach((input, index) => {
        const val = parseFloat(input.value);
        if (!isNaN(val) && val > 0) {
            const labelEl = input.closest('div')?.querySelector('label');
            const name = labelEl ? labelEl.textContent.replace(':', '').trim() : '自定义费用';
            window.expensePanelPayableData.push({
                id: 'PAY-CUSTOM-' + Date.now() + '-' + index,
                name: name,
                amount: val,
                date: today,
                currency: 'CNY',
                status: '未核销',
                company: '-',
                category: '应付',
                contact: '-',
                phone: '-',
                remark: '-'
            });
            hasData = true;
        }
    });

    // Process fuel card generation for oil fee (新增需联动的油费下发规则)
    const oilFeeInput = document.getElementById('expense-entry-oil-fee');
    if (oilFeeInput && oilFeeInput.value && parseFloat(oilFeeInput.value) > 0) {
        if (!window.fuelCardData) {
            window.fuelCardData = [];
        }
        window.fuelCardData.unshift({
            sysId: 'FC-FE' + Date.now().toString().slice(-6),
            waybillNo: 'FE' + Date.now().toString().slice(-6),
            waybillDate: today,
            fuelCost: parseFloat(oilFeeInput.value).toFixed(2),
            plateNo: '-',
            contactPhone: '-',
            remarks: '费用录单系统触发生成',
            status: '待发放'
        });
        // 顺便触发一下角标更新函数以实现右上角红点的实时显示
        if (typeof window.updatePendingFuelCardBadge === 'function') {
            window.updatePendingFuelCardBadge();
        }
        hasData = true;
    }

    if (hasData) {
        alert('保存成功！数据已同步至各项记录表列及油卡下发模块。');
    } else {
        alert('请填写明细数据后再保存。');
    }
};

// Function to add fee entry row to expense entry page tables
window.addFeeEntryRow = function (type) {
    const tbodyId = type === 'income' ? 'fee-entry-income-tbody' : 'fee-entry-cost-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) {
        console.error('Tbody not found for type:', type);
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    const newRow = document.createElement('tr');
    newRow.style.borderBottom = '1px solid #f8fafc';
    newRow.style.height = '30px';

    // Fee name options (5 virtual data)
    const feeNameOptions = `
        <option value="">请选择</option>
        <option value="运输费">运输费</option>
        <option value="装卸费">装卸费</option>
        <option value="仓储费">仓储费</option>
        <option value="保险费">保险费</option>
        <option value="包装费">包装费</option>
    `;

    // Settlement company options (3 virtual data)
    const companyOptions = `
        <option value="">请选择</option>
        <option value="丰源物流有限公司">丰源物流有限公司</option>
        <option value="顺达运输集团">顺达运输集团</option>
        <option value="中通供应链">中通供应链</option>
    `;

    // Category options for upper panel (income): 应收, 代垫 only (no 应付)
    const categoryOptionsIncome = `
        <option value="应收">应收</option>
        <option value="代垫">代垫</option>
    `;

    // Category options for lower panel (cost) - default to 应付
    const categoryOptionsCost = `
        <option value="应付">应付</option>
    `;

    const categoryOptions = type === 'income' ? categoryOptionsIncome : categoryOptionsCost;

    newRow.innerHTML = `
        <td style="padding: 4px; width: 30px;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">
            <select style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none; background: white;">
                ${feeNameOptions}
            </select>
        </td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc; text-align: right;"><input class="income-fee-amount" onchange="window.handleAdvanceTotal()" type="text" placeholder="0.00" style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none; text-align: right;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">
            <select style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none; background: white;">
                ${companyOptions}
            </select>
        </td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;">
            <select class="income-fee-category" onchange="window.handleAdvanceTotal()" style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none; background: white;">
                ${categoryOptions}
            </select>
        </td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="date" value="${today}" style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="text" placeholder="联系人" style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="text" placeholder="电话" style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><input type="text" placeholder="备注" style="width: 100%; height: 24px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 0 4px; font-size: 0.75rem; outline: none;"></td>
        <td style="padding: 4px 8px; border-right: 1px solid #f8fafc;"><span style="color: #f59e0b; font-size: 0.75rem;">未核销</span></td>
        <td style="padding: 4px 8px; text-align: center;">
            <button onclick="this.closest('tr').remove(); window.handleAdvanceTotal()" style="border: none; background: transparent; color: #ef4444; cursor: pointer; padding: 2px;">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
            </button>
        </td>
    `;

    tbody.appendChild(newRow);
    if (window.lucide) window.lucide.createIcons();
};

// Function to add expense row to expense panel tables (for rendering)
window.addExpenseRow = function (type) {
    const tbody = document.getElementById(type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody');
    if (!tbody) {
        console.error('Tbody not found for type:', type);
        return;
    }

    // Get the correct data array
    const dataArray = type === 'receivable' ? window.expensePanelReceivableData : window.expensePanelPayableData;

    // Add a new empty row for manual entry
    const today = new Date().toISOString().split('T')[0];
    const newId = (type === 'receivable' ? 'REC-' : 'PAY-') + Date.now();

    // Options configuration
    // 类别: 应收面板 - 应收(默认)/代垫; 应付面板 - 应付(默认)
    const categoryOptions = type === 'receivable'
        ? '<option value="应收" selected>应收</option><option value="代垫">代垫</option>'
        : '<option value="应付" selected>应付</option>';

    // 结算公司: 5个虚拟选项
    const companyOptions = `
        <option value="" selected>请选择</option>
        <option value="深圳市丰源物流有限公司">深圳市丰源物流有限公司</option>
        <option value="上海顺丰速运有限公司">上海顺丰速运有限公司</option>
        <option value="北京京东世纪贸易有限公司">北京京东世纪贸易有限公司</option>
        <option value="广州德邦物流有限公司">广州德邦物流有限公司</option>
        <option value="杭州中通快递有限公司">杭州中通快递有限公司</option>
    `;

    // 费用: 5个虚拟选项
    const expenseOptions = `
        <option value="" selected>请选择</option>
        <option value="运费">运费</option>
        <option value="操作费">操作费</option>
        <option value="提货费">提货费</option>
        <option value="送货费">送货费</option>
        <option value="杂费">杂费</option>
    `;

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td style="padding: 6px 4px; border-bottom: 1px solid #f1f5f9; text-align: center;"><input type="checkbox"></td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">${dataArray.length + 1}</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">
            <select style="width: 70px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; background: white;">
                ${categoryOptions}
            </select>
        </td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">
            <select style="width: 150px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; background: white;">
                ${companyOptions}
            </select>
        </td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">
            <select style="width: 80px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; background: white;">
                ${expenseOptions}
            </select>
        </td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" style="width: 70px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" style="width: 60px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="1" style="width: 40px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${today}</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">CNY</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;"><input type="text" style="width: 80px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem;"></td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">1.00</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0%</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">-</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;"><span style="color: #f59e0b;">未核销</span></td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
        <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">
            <button onclick="this.closest('tr').remove()" style="border: none; background: transparent; color: #ef4444; cursor: pointer;">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
            </button>
        </td>
    `;

    // Remove empty state row if exists
    const emptyRow = tbody.querySelector('tr td[colspan]');
    if (emptyRow) {
        emptyRow.closest('tr').remove();
    }

    tbody.appendChild(newRow);
    if (window.lucide) window.lucide.createIcons();
};

// Function to render expense panel data from saved expense entry
window.renderExpensePanelFromSavedData = function (currentTab) {
    const receivableTbody = document.getElementById('expense-receivable-tbody');
    const payableTbody = document.getElementById('expense-payable-tbody');

    // Render receivable data
    if (receivableTbody && window.expensePanelReceivableData && window.expensePanelReceivableData.length > 0) {
        receivableTbody.innerHTML = '';
        window.expensePanelReceivableData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 6px 4px; border-bottom: 1px solid #f1f5f9; text-align: center;"><input type="checkbox"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">${index + 1}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.category || '应收'}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.company || '-'}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.name}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="${item.amount.toFixed(2)}" style="width: 70px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right; font-weight: 600; color: #4f46e5;"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="${item.amount.toFixed(2)}" style="width: 60px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="1" style="width: 40px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.date}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.currency}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.remark || '-'}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">1.00</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0%</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">${item.amount.toFixed(2)}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">${item.amount.toFixed(2)}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;"><span style="color: #f59e0b;">${item.status}</span></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">
                    <button style="border: none; background: transparent; color: #4f46e5; cursor: pointer;">
                        <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </td>
            `;
            receivableTbody.appendChild(row);
        });
        if (window.lucide) window.lucide.createIcons();

        // Update summary totals
        const totalReceivable = window.expensePanelReceivableData.reduce((sum, item) => sum + item.amount, 0);
        const summaryReceivable = document.getElementById('summary-receivable');
        if (summaryReceivable) summaryReceivable.textContent = totalReceivable.toFixed(2);
    }

    // Render payable data
    if (currentTab !== '配载费用' && payableTbody && window.expensePanelPayableData && window.expensePanelPayableData.length > 0) {
        payableTbody.innerHTML = '';
        window.expensePanelPayableData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 6px 4px; border-bottom: 1px solid #f1f5f9; text-align: center;"><input type="checkbox"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">${index + 1}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.category || '应付'}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.company || '-'}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.name}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="${item.amount.toFixed(2)}" style="width: 70px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right; font-weight: 600; color: #ef4444;"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="${item.amount.toFixed(2)}" style="width: 60px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;"><input type="text" value="1" style="width: 40px; border: 1px solid #e2e8f0; border-radius: 2px; padding: 2px 4px; font-size: 0.75rem; text-align: right;"></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.date}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.currency}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.remark || '-'}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">1.00</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0%</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">${item.amount.toFixed(2)}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">${item.amount.toFixed(2)}</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">0.00</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;"><span style="color: #f59e0b;">${item.status}</span></td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">-</td>
                <td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9; text-align: center;">
                    <button style="border: none; background: transparent; color: #4f46e5; cursor: pointer;">
                        <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </td>
            `;
            payableTbody.appendChild(row);
        });
        if (window.lucide) window.lucide.createIcons();

        // Update summary totals
        const totalPayable = window.expensePanelPayableData.reduce((sum, item) => sum + item.amount, 0);
        const summaryPayable = document.getElementById('summary-payable');
        if (summaryPayable) summaryPayable.textContent = totalPayable.toFixed(2);
    }

    // Calculate and update profit
    const totalRec = (window.expensePanelReceivableData || []).reduce((sum, item) => sum + item.amount, 0);
    const totalPay = (window.expensePanelPayableData || []).reduce((sum, item) => sum + item.amount, 0);
    const profit = totalRec - totalPay;
    const profitEl = document.getElementById('summary-profit');
    if (profitEl) profitEl.textContent = profit.toFixed(2);

    // Calculate gross margin
    const marginEl = document.getElementById('summary-gross-margin');
    if (marginEl && totalRec > 0) {
        const margin = ((totalRec - totalPay) / totalRec * 100).toFixed(0);
        marginEl.textContent = margin + '%';
    }
};

window.batchDeleteRow = function (type) {
    const tbodyId = type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    const checkedBoxes = tbody.querySelectorAll('input[type="checkbox"]:checked');
    if (checkedBoxes.length === 0) {
        alert('请先勾选需要批量删除的数据');
        return;
    }

    if (confirm(`确定要删除选中的 ${checkedBoxes.length} 条记录吗？`)) {
        checkedBoxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) row.remove();
        });

        // Re-index rows
        Array.from(tbody.children).forEach((row, index) => {
            if (row.cells[1]) {
                row.cells[1].textContent = index + 1;
            }
        });

        const typeName = type === 'receivable' ? '应收' : '应付';
        alert(`批量删除${typeName}成功`);
    }
};

// ==================== 批量分摊功能 ====================
window.batchAllocateExpense = function (type) {
    const tbodyId = type === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    const checkedBoxes = tbody.querySelectorAll('input[type="checkbox"]:checked');
    if (checkedBoxes.length === 0) {
        alert('请先勾选需要批量分摊的数据');
        return;
    }

    // 收集勾选的数据
    const selectedData = [];
    checkedBoxes.forEach((checkbox, index) => {
        const row = checkbox.closest('tr');
        if (row) {
            // 获取行数据
            const billingDate = row.cells[8]?.querySelector('input')?.value || row.cells[8]?.textContent?.trim() || '-';
            const settlementCompany = row.cells[3]?.querySelector('select')?.value || row.cells[3]?.textContent?.trim() || '-';
            const fee = row.cells[4]?.querySelector('select')?.value || row.cells[4]?.textContent?.trim() || '-';
            const amount = row.cells[5]?.querySelector('input')?.value || row.cells[5]?.textContent?.trim() || '0.00';
            const currency = row.cells[9]?.querySelector('select')?.value || row.cells[9]?.textContent?.trim() || 'CNY';

            selectedData.push({
                index: index + 1,
                billingDate,
                settlementCompany,
                fee,
                amount,
                currency
            });
        }
    });

    // 打开批量分摊弹窗
    openBatchAllocateModal(selectedData, type);
};

function openBatchAllocateModal(data, type) {
    // 检查弹窗是否已存在
    let modal = document.getElementById('batch-allocate-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'batch-allocate-modal';
        modal.className = 'modal-overlay';
        document.body.appendChild(modal);
    }

    // 生成表格行
    let tableRows = '';
    if (data.length > 0) {
        data.forEach(item => {
            tableRows += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 10px 12px; text-align: center; font-size: 0.8rem; color: #475569;">${item.index}</td>
                    <td style="padding: 10px 12px; font-size: 0.8rem; color: #334155;">${item.billingDate}</td>
                    <td style="padding: 10px 12px; font-size: 0.8rem; color: #334155;">${item.settlementCompany}</td>
                    <td style="padding: 10px 12px; font-size: 0.8rem; color: #334155;">${item.fee}</td>
                    <td style="padding: 10px 12px; font-size: 0.8rem; color: #334155; text-align: right;">${item.amount}</td>
                    <td style="padding: 10px 12px; font-size: 0.8rem; color: #334155;">${item.currency}</td>
                </tr>
            `;
        });
    } else {
        tableRows = `
            <tr>
                <td colspan="6" style="padding: 60px 0; text-align: center; color: #94a3b8;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                        <i data-lucide="search-x" style="width: 48px; height: 48px; opacity: 0.4;"></i>
                        <span style="font-size: 0.85rem;">暂无数据</span>
                    </div>
                </td>
            </tr>
        `;
    }

    modal.innerHTML = `
        <div class="modal-container" style="width: 800px; height: auto; max-height: 80vh; background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
            <!-- Header -->
            <div class="modal-header" style="padding: 12px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: white;">
                <span style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">批量分摊</span>
                <div class="modal-actions" style="display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="maximize-2" class="header-icon" style="width: 16px; height: 16px; color: #94a3b8; cursor: pointer;"></i>
                    <i data-lucide="x" class="header-icon" style="width: 16px; height: 16px; color: #94a3b8; cursor: pointer;" onclick="closeBatchAllocateModal()"></i>
                </div>
            </div>

            <!-- Content -->
            <div style="padding: 20px; flex: 1; overflow: auto;">
                <!-- 分摊方式选择 -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <label style="font-size: 0.85rem; color: #475569; white-space: nowrap;">请选择分摊方式</label>
                    <select id="allocate-method" style="width: 150px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 10px; font-size: 0.85rem; color: #334155; outline: none;">
                        <option value="none">不分摊</option>
                        <option value="ticket">按票分摊</option>
                        <option value="billingWeight">按计费重分摊</option>
                        <option value="weight">按重量分摊</option>
                        <option value="volume">按体积分摊</option>
                        <option value="quantity">按件数分摊</option>
                        <option value="amount">按金额分摊</option>
                        <option value="custom">自定义分摊</option>
                    </select>
                </div>

                <!-- 数据表格 -->
                <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc;">
                                <th style="padding: 10px 12px; text-align: center; font-size: 0.8rem; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0; width: 50px;">#</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.8rem; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">计费日期</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.8rem; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">结算公司</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.8rem; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">费用</th>
                                <th style="padding: 10px 12px; text-align: right; font-size: 0.8rem; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">金额</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.8rem; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">币制</th>
                            </tr>
                        </thead>
                        <tbody id="batch-allocate-tbody">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 12px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                <button onclick="closeBatchAllocateModal()" style="height: 32px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; color: #475569; font-size: 0.85rem; cursor: pointer;">取消</button>
                <button onclick="confirmBatchAllocate()" style="height: 32px; padding: 0 16px; background: #3b82f6; border: none; border-radius: 4px; color: white; font-size: 0.85rem; cursor: pointer;">确认分摊</button>
            </div>
        </div>
    `;

    modal.classList.add('show');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';

    if (window.lucide) window.lucide.createIcons();
}

window.closeBatchAllocateModal = function () {
    const modal = document.getElementById('batch-allocate-modal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
};

window.confirmBatchAllocate = function () {
    const method = document.getElementById('allocate-method')?.value || 'none';
    if (method === 'none') {
        alert('请选择分摊方式');
        return;
    }

    // 执行分摊逻辑
    alert(`分摊方式：${method}\n分摊操作已完成`);
    closeBatchAllocateModal();
};

window.currentFeeTemplates = [];

window.openFeeTemplateModal = function (templates = [], context = null) {
    if (context) {
        window.currentFeeTemplateContext = context;
    }
    // Update global store if new templates provided
    if (templates.length > 0) {
        window.currentFeeTemplates = templates;
    } else {
        // If no templates passed, try to use existing global ones (optional, or just init empty)
        if (!window.currentFeeTemplates) window.currentFeeTemplates = [];
    }
    // Check if modal already exists
    let modal = document.getElementById('fee-template-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'fee-template-modal';
        modal.className = 'modal-overlay';
        modal.style.zIndex = '9999';
        modal.style.position = 'fixed';
        modal.style.inset = '0';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.display = 'none';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal-container" style="width: 1000px; height: 650px; background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column;">
            <!-- Header -->
            <div class="modal-header" style="padding: 0 16px; height: 48px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fff;">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1e293b;">费用模板</h3>
                <button onclick="document.getElementById('fee-template-modal').classList.remove('show'); document.getElementById('fee-template-modal').style.display='none';" style="border: none; background: transparent; cursor: pointer; color: #94a3b8; transition: color 0.2s;" onmouseover="this.style.color='#64748b'" onmouseout="this.style.color='#94a3b8'">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>

            <!-- Body -->
            <div style="flex: 1; display: flex; overflow: hidden;">
                <!-- Left Sidebar -->
                <div style="width: 300px; flex-shrink: 0; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; background: #fff;">
                    <!-- Tabs -->
                    <div style="display: flex; height: 40px; border-bottom: 1px solid #e2e8f0;">
                        <button style="flex: 1; border: none; background: #fff; color: #0284c7; font-weight: 500; font-size: 0.85rem; border-bottom: 2px solid #0284c7; cursor: pointer;">模板列表</button>
                    </div>
                    
                    <!-- Search & Filter -->
                    <div style="padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569; cursor: pointer;">
                            <input type="checkbox" checked style="accent-color: #0284c7;"> 显示他人模板
                        </label>
                        <div style="position: relative;">
                            <i data-lucide="search" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: #94a3b8;"></i>
                            <input type="text" placeholder="搜索模板" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 4px; padding: 6px 8px 6px 28px; font-size: 0.85rem; outline: none; background: #f8fafc;">
                        </div>
                    </div>

                    <!-- List Area -->
                    <div id="fee-template-sidebar-list" style="flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 12px; gap: 8px;">
                        ${window.currentFeeTemplates.length > 0 ? window.currentFeeTemplates.map((t, index) => `
                            <div onclick="window.loadFeeTemplate(${index})" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                                <i data-lucide="folder" style="width: 16px; height: 16px; color: #3b82f6;"></i>
                                <span style="font-size: 0.85rem; color: #334155;">${t.name}</span>
                            </div>
                        `).join('') : `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; gap: 8px;">
                                <div style="width: 48px; height: 48px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="folder-open" style="width: 24px; height: 24px; color: #cbd5e1;"></i>
                                </div>
                                <span style="font-size: 0.8rem;">无数据</span>
                            </div>
                        `}
                    </div>

                    <!-- Bottom Actions -->
                    <div style="height: 48px; border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-around; padding: 0 8px;">
                        <button onclick="window.onFeeTemplateAddClick()" style="border: none; background: transparent; cursor: pointer; color: #0284c7;"><i data-lucide="plus" style="width: 18px; height: 18px;"></i></button>
                        <button style="border: none; background: transparent; cursor: pointer; color: #0284c7;"><i data-lucide="edit-3" style="width: 16px; height: 16px;"></i></button>
                        <button onclick="window.copyFeeTemplate()" style="border: none; background: transparent; cursor: pointer; color: #0284c7;"><i data-lucide="copy" style="width: 16px; height: 16px;"></i></button>
                        <button onclick="window.deleteFeeTemplate()" style="border: none; background: transparent; cursor: pointer; color: #ef4444;"><i data-lucide="trash-2" style="width: 16px; height: 16px;"></i></button>
                    </div>
                </div>

                <!-- Right Content -->
                <div style="flex: 1; display: flex; flex-direction: column; background: #fff; position: relative;">
                    <!-- Table Container -->
                    <div style="flex: 1; overflow: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; white-space: nowrap;">
                            <thead style="background: #f8fafc; color: #475569; position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; text-align: left; font-weight: 500; min-width: 200px;">结算公司</th> <!-- Adjusted for Actions -->
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; text-align: left; font-weight: 500; min-width: 120px;">费用</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; text-align: left; font-weight: 500; min-width: 80px;">单位</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; text-align: left; font-weight: 500; min-width: 80px;">单价</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; text-align: left; font-weight: 500; min-width: 80px;">币制</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; text-align: left; font-weight: 500; min-width: 80px;">数量</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; font-weight: 500; min-width: 150px;">备注</th>
                                </tr>
                            </thead>
                            <tbody id="fee-template-tbody">
                                <!-- Rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State (Overlay) -->
                    <div id="fee-template-empty-state" style="position: absolute; inset: 0; top: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: #bfdbfe; background: white;">
                         <div style="width: 80px; height: 80px; background: #f0f9ff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                             <i data-lucide="search" style="width: 40px; height: 40px; opacity: 0.5;"></i>
                         </div>
                         <span style="font-size: 0.9rem; color: #94a3b8;">暂无数据</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div id="fee-template-footer" style="padding: 12px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; background: #fff;">
                <button style="padding: 6px 24px; border: none; background: #3b82f6; border-radius: 4px; color: white; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="import" style="width: 14px; height: 14px;"></i> 导入
                </button>
            </div>
        </div>
    `;

    modal.classList.add('show');
    modal.style.display = 'flex';
    if (window.lucide) window.lucide.createIcons();
};

window.onFeeTemplateAddClick = function () {
    // 1. Update Sidebar List Area
    const sidebarList = document.getElementById('fee-template-sidebar-list');
    if (sidebarList) {
        sidebarList.style.justifyContent = 'flex-start';
        sidebarList.style.padding = '12px';
        sidebarList.innerHTML = `
            <div style="width: 100%; display: flex; align-items: center; gap: 8px;">
                <div style="flex: 1; position: relative;">
                    <input type="text" placeholder="请输入模板名称" autofocus style="width: 100%; border: 1px solid #3b82f6; border-radius: 4px; padding: 6px 8px; font-size: 0.85rem; outline: none; background: #fff; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);">
                </div>
                <div style="width: 4px; height: 4px; background: #ef4444; border-radius: 50%;"></div>
            </div>
        `;
    }

    // 2. Update Right Content Body (Empty State Overlay)
    const emptyState = document.getElementById('fee-template-empty-state');
    if (emptyState) {
        emptyState.innerHTML = `
             <div style="width: 80px; height: 80px; background: #f0f9ff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                 <i data-lucide="search" style="width: 40px; height: 40px; opacity: 0.5;"></i>
             </div>
             <span style="font-size: 0.9rem; color: #94a3b8;">暂无数据</span>
             <button onclick="window.addFeeTemplateRow()" style="margin-top: 12px; padding: 6px 20px; border: none; background: #3b82f6; border-radius: 4px; color: white; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> 新增
             </button>
        `;
        if (window.lucide) window.lucide.createIcons();
    }

    // 3. Update Footer
    const footer = document.getElementById('fee-template-footer');
    if (footer) {
        footer.innerHTML = `
            <div style="display: flex; gap: 12px;">
                <button onclick="window.openFeeTemplateModal()" style="padding: 6px 20px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; color: #64748b; font-size: 0.85rem; cursor: pointer;">取消</button>
                <button onclick="window.saveFeeTemplate()" style="padding: 6px 24px; border: none; background: #3b82f6; border-radius: 4px; color: white; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="save" style="width: 14px; height: 14px;"></i> 保存
                </button>
            </div>
        `;
        if (window.lucide) window.lucide.createIcons();
    }
};

window.addFeeTemplateRow = function (rowData = null, isReadOnly = false) {
    const tbody = document.getElementById('fee-template-tbody');
    const emptyState = document.getElementById('fee-template-empty-state');

    if (emptyState) emptyState.style.display = 'none';
    if (!tbody) return;

    const tr = document.createElement('tr');
    tr.style.background = '#fff';
    tr.style.borderBottom = '1px solid #f1f5f9';

    // Inline styles for inputs to match "white input box" look
    const inputStyle = "width: 100%; border: 1px solid #e2e8f0; border-radius: 2px; padding: 4px; font-size: 0.8rem; outline: none; background: #fff;";
    const cellStyle = "padding: 8px; border-right: 1px solid #f8fafc;";

    tr.innerHTML = `
        <td style="${cellStyle}">
            <div style="display: flex; align-items: center; gap: 6px;">
                ${!isReadOnly ? `
                <button onclick="this.closest('tr').remove(); if(document.getElementById('fee-template-tbody').children.length === 0) document.getElementById('fee-template-empty-state').style.display='flex';" style="border: none; background: transparent; cursor: pointer; color: #94a3b8; padding: 0;"><i data-lucide="minus-circle" style="width: 16px; height: 16px;"></i></button>
                <button onclick="window.addFeeTemplateRow()" style="border: none; background: transparent; cursor: pointer; color: #94a3b8; padding: 0;"><i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i></button>
                ` : ''}
                <select style="${inputStyle} flex: 1;" ${isReadOnly ? 'disabled' : ''}>
                    <option value="">请选择结算公司</option>
                    <option value="company1" ${rowData && rowData.settlementCompany === 'company1' ? 'selected' : ''}>丰源物流有限公司</option>
                    <option value="company2" ${rowData && rowData.settlementCompany === 'company2' ? 'selected' : ''}>顺丰速运有限公司</option>
                    <option value="company3" ${rowData && rowData.settlementCompany === 'company3' ? 'selected' : ''}>京东速运有限公司</option>
                    <option value="company4" ${rowData && rowData.settlementCompany === 'company4' ? 'selected' : ''}>德邦速运有限公司</option>
                    <option value="company5" ${rowData && rowData.settlementCompany === 'company5' ? 'selected' : ''}>中通速运有限公司</option>
                </select>
            </div>
        </td>
        <td style="${cellStyle}">
            <select style="${inputStyle}" ${isReadOnly ? 'disabled' : ''}>
                <option value="">请选择费用</option>
                <option value="fee1" ${rowData && rowData.fee === 'fee1' ? 'selected' : ''}>运费</option>
                <option value="fee2" ${rowData && rowData.fee === 'fee2' ? 'selected' : ''}>操作费</option>
                <option value="fee3" ${rowData && rowData.fee === 'fee3' ? 'selected' : ''}>提货费</option>
                <option value="fee4" ${rowData && rowData.fee === 'fee4' ? 'selected' : ''}>送货费</option>
                <option value="fee5" ${rowData && rowData.fee === 'fee5' ? 'selected' : ''}>杂费</option>
            </select>
        </td>
        <td style="${cellStyle}"><input type="text" style="${inputStyle}" value="${rowData ? rowData.unit : ''}" ${isReadOnly ? 'disabled' : ''}></td>
        <td style="${cellStyle}"><input type="number" style="${inputStyle}" value="${rowData ? rowData.price : ''}" ${isReadOnly ? 'disabled' : ''}></td>
        <td style="${cellStyle}"><select style="${inputStyle}" ${isReadOnly ? 'disabled' : ''}><option ${rowData && rowData.currency === 'CNY' ? 'selected' : ''}>CNY</option><option ${rowData && rowData.currency === 'USD' ? 'selected' : ''}>USD</option></select></td>
        <td style="${cellStyle}"><input type="number" style="${inputStyle}" value="${rowData ? rowData.quantity : ''}" ${isReadOnly ? 'disabled' : ''}></td>
        <td style="${cellStyle}"><input type="text" style="${inputStyle}" value="${rowData ? rowData.remark : ''}" ${isReadOnly ? 'disabled' : ''}></td>
    `;

    tbody.appendChild(tr);
    if (window.lucide) window.lucide.createIcons();
};

window.saveFeeTemplate = function () {
    const nameInput = document.querySelector('#fee-template-sidebar-list input');
    if (!nameInput || !nameInput.value.trim()) {
        alert('请输入模板名称');
        return;
    }

    const rows = document.querySelectorAll('#fee-template-tbody tr');
    const data = [];
    rows.forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        if (inputs.length > 0) {
            data.push({
                settlementCompany: inputs[0].value,
                fee: inputs[1].value,
                unit: inputs[2].value,
                price: inputs[3].value,
                currency: inputs[4].value,
                quantity: inputs[5].value,
                remark: inputs[6].value
            });
        }
    });

    console.log('Template Name:', nameInput.value);
    console.log('Data:', data);
    alert(`模板 "${nameInput.value}" 保存成功！\n共包含 ${data.length} 条费用项。`);

    // Construct new template object
    const newTemplate = { name: nameInput.value, rows: data };

    // Add to global store
    const updatedTemplates = [...(window.currentFeeTemplates || []), newTemplate];

    // Reset UI to initial state (Reload modal) with the updated templates
    window.openFeeTemplateModal(updatedTemplates, window.currentFeeTemplateContext);
};

window.loadFeeTemplate = function (index) {
    const template = window.currentFeeTemplates[index];
    if (!template) return;

    // 1. Switch to "Add" view layout to get the input fields
    window.onFeeTemplateAddClick();

    // 2. Set Name
    const nameInput = document.querySelector('#fee-template-sidebar-list input');
    if (nameInput) nameInput.value = template.name;

    // 3. Clear existing rows
    const tbody = document.getElementById('fee-template-tbody');
    if (tbody) tbody.innerHTML = '';

    // 4. Hide Empty State
    const emptyState = document.getElementById('fee-template-empty-state');
    if (emptyState) emptyState.style.display = 'none';

    // 5. Add Rows
    if (template.rows && template.rows.length > 0) {
        template.rows.forEach(row => {
            window.addFeeTemplateRow(row, true); // Pass true for Read-Only
        });
    }

    // Store current template for import
    window.currentViewedTemplate = template;

    // 6. Update Footer to "Import"
    const footer = document.getElementById('fee-template-footer');
    if (footer) {
        footer.innerHTML = `
            <div style="display: flex; gap: 12px;">
                <button onclick="window.openFeeTemplateModal()" style="padding: 6px 20px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; color: #64748b; font-size: 0.85rem; cursor: pointer;">取消</button>
                <button onclick="window.importFeeTemplate()" style="padding: 6px 24px; border: none; background: #3b82f6; border-radius: 4px; color: white; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="folder-down" style="width: 14px; height: 14px;"></i> 导入
                </button>
            </div>
        `;
    }

    if (window.lucide) window.lucide.createIcons();
};

window.importFeeTemplate = function () {
    if (!window.currentViewedTemplate || !window.currentViewedTemplate.rows) return;

    const rows = window.currentViewedTemplate.rows;
    // Use stored context or default to 'receivable'
    const targetType = window.currentFeeTemplateContext || 'receivable';
    const tbodyId = targetType === 'receivable' ? 'expense-receivable-tbody' : 'expense-payable-tbody';
    const tbody = document.getElementById(tbodyId);

    if (!tbody) {
        console.error('Target table body not found:', tbodyId);
        return;
    }

    rows.forEach(row => {
        // Add new row using the existing function
        if (typeof window.addExpenseRow === 'function') {
            window.addExpenseRow(targetType);

            // Get the newly added row (last child)
            const newRow = tbody.lastElementChild;
            if (newRow) {
                // Map data to columns based on observed table headers
                // Headers: Checkbox(0), #(1), Category(2), Company(3), Fee(4), Amount(5), Price(6), Qty(7), Date(8), Currency(9), Remark(10)
                // Helper to set value safely
                const setCell = (index, value) => {
                    if (newRow.cells.length > index) {
                        const cell = newRow.cells[index];
                        const input = cell.querySelector('input, select');
                        if (input) {
                            input.value = value;
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                };

                // Mapping Dictionary for Template Values -> Main Table Options
                const companyMap = {
                    'company1': '深圳市丰源物流有限公司',
                    'company2': '上海顺丰速运有限公司',
                    'company3': '北京京东世纪贸易有限公司',
                    'company4': '广州德邦物流有限公司',
                    'company5': '杭州中通快递有限公司'
                };

                const feeMap = {
                    'fee1': '运费',
                    'fee2': '操作费',
                    'fee3': '提货费',
                    'fee4': '送货费',
                    'fee5': '杂费'
                };

                // Map values
                const mappedCompany = companyMap[row.settlementCompany] || row.settlementCompany;
                const mappedFee = feeMap[row.fee] || row.fee;

                // Set fields
                setCell(3, mappedCompany); // Settlement Company
                setCell(4, mappedFee);     // Fee
                setCell(6, row.price);     // Unit Price
                setCell(7, row.quantity);  // Quantity
                setCell(9, row.currency);  // Currency
                setCell(10, row.remark);   // Remark

                // Calculate and set Amount (Index 5)
                const price = parseFloat(row.price) || 0;
                const qty = parseFloat(row.quantity) || 0;
                const amount = (price * qty).toFixed(2);
                setCell(5, amount);


                // You might also want to map 'unit' if there's a column for it, or 'Category' if applicable.
                // For now, mapping core fields.
            }
        } else {
            console.error('window.addExpenseRow is not a function');
        }
    });

    // Close Modal
    const modal = document.getElementById('fee-template-modal');
    if (modal) modal.remove();

    alert('导入成功！');
};

window.copyFeeTemplate = function () {
    if (!window.currentViewedTemplate) {
        alert('请先选择一个模版');
        return;
    }

    const original = window.currentViewedTemplate;
    const newId = 'TEMP-' + Date.now();
    const newName = original.name + ' (1)';

    // Deep copy the template object
    const newTemplate = JSON.parse(JSON.stringify(original));
    newTemplate.id = newId;
    newTemplate.name = newName;

    // Add to global list
    window.currentFeeTemplates = window.currentFeeTemplates || [];
    window.currentFeeTemplates.push(newTemplate);

    // Refresh UI
    // Update the sidebar list (re-open modal effectively or just update list)
    // To keep it simple and consistent:
    window.openFeeTemplateModal(window.currentFeeTemplates, window.currentFeeTemplateContext);

    // Suggestion: Select the new template?
    // window.loadFeeTemplate(window.currentFeeTemplates.length - 1);

    alert('模版复制成功');
};

window.deleteFeeTemplate = function () {
    if (!window.currentViewedTemplate) {
        alert('请先选择一个模版');
        return;
    }

    if (!confirm('确定要删除该模版吗？')) return;

    // Remove from array
    window.currentFeeTemplates = window.currentFeeTemplates.filter(t => t.id !== window.currentViewedTemplate.id);

    // Clear current view
    window.currentViewedTemplate = null;

    // Refresh UI (this will also reset the right content to empty state since no template is "viewed" in the re-render logic if we don't pass one, 
    // but openFeeTemplateModal doesn't auto-select. It just renders the list.)
    window.openFeeTemplateModal(window.currentFeeTemplates, window.currentFeeTemplateContext);

    // Explicitly reset the right panel to empty state (as openFeeTemplateModal re-renders the shell but might not clear the inputs provided by addFeeTemplateRow if it was called before.
    // Actually, openFeeTemplateModal re-renders the ENTIRE modal content including the empty state div.)

    alert('模版已删除');
};

/**
 * Switch tabs in Red Letter Application Confirmation page
 */
window.switchRedLetterTab = function (element) {
    const container = element.parentElement;
    const tabs = container.querySelectorAll('.internal-tab');

    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
        tab.style.color = '#475569';
        tab.style.fontWeight = 'normal';
    });

    element.classList.add('active');
    element.style.borderBottom = '2px solid #4f46e5';
    element.style.color = '#4f46e5';
    element.style.fontWeight = '500';
};

// Global handlers for check all / uncheck all in Statement list
window.toggleAllStatementCheckboxes = function (source) {
    const checkboxes = document.querySelectorAll('.statement-row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = source.checked;
    });
};

window.updateStatementCheckAllState = function () {
    const checkAll = document.getElementById('statement-check-all');
    if (!checkAll) return;
    const checkboxes = document.querySelectorAll('.statement-row-checkbox');
    if (checkboxes.length === 0) return;

    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);

    checkAll.checked = allChecked;
    // Set indeterminate state if some but not all are checked
    checkAll.indeterminate = anyChecked && !allChecked;
};

// ==========================================
// Custom Dropdown UI Handlers
// ==========================================

window.toggleDropdown = function (element) {
    if (!element) return;
    const relativeContainer = element.closest('.relative-container');
    if (!relativeContainer) return;

    // Close all other dropdowns on the page first to emulate native select behavior
    document.querySelectorAll('.dropdown-menu-custom').forEach(menu => {
        if (menu !== relativeContainer.querySelector('.dropdown-menu-custom')) {
            menu.classList.add('hidden');
        }
    });

    const menu = relativeContainer.querySelector('.dropdown-menu-custom');
    if (menu) {
        menu.classList.toggle('hidden');
    }
};

window.selectOption = function (spanId, value) {
    const span = document.getElementById(spanId);
    if (span) {
        span.innerText = value;
        span.title = value; // update native hover title simultaneously
    }

    // Close the dropdown immediately after selection
    if (span) {
        const btn = span.closest('.relative-container');
        if (btn) {
            const menu = btn.querySelector('.dropdown-menu-custom');
            if (menu) menu.classList.add('hidden');
        }
    }
};

// Global click event to close dropdowns when clicking outside
document.addEventListener('click', function (event) {
    // If the click is inside a custom dropdown relative container, ignore it
    if (event.target.closest('.relative-container')) {
        return;
    }
    // Otherwise forcibly hide all expanded dropdowns
    document.querySelectorAll('.dropdown-menu-custom').forEach(menu => {
        menu.classList.add('hidden');
    });
});


// Append global modal and functions
window.openBankAccountModal = function () {
    let modal = document.getElementById('bank-account-selection-modal');
    if (!modal) {
        const modalHtml = `
        <div id="bank-account-selection-modal" class="modal-overlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div style="background: white; border-radius: 8px; width: 800px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
                <div style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: #1e293b;">请选择</h3>
                    <button onclick="window.closeBankAccountModal()" style="border: none; background: transparent; cursor: pointer; color: #64748b;"><i data-lucide="x"></i></button>
                </div>
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; text-align: left;">
                            <thead>
                                <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; color: #64748b;">
                                    <th style="padding: 12px 16px; width: 40px; text-align: center; border-right: 1px solid #e2e8f0;">#</th>
                                    <th style="padding: 12px 16px; width: 40px; text-align: center; border-right: 1px solid #e2e8f0;"><input type="checkbox" disabled></th>
                                    <th style="padding: 12px 16px; border-right: 1px solid #e2e8f0;">账户名称/银行名称</th>
                                    <th style="padding: 12px 16px; border-right: 1px solid #e2e8f0;">银行账号</th>
                                    <th style="padding: 12px 16px; border-right: 1px solid #e2e8f0;">币制</th>
                                    <th style="padding: 12px 16px;">备注</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="padding: 40px 0; text-align: center;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; color: #cbd5e1;">
                                            <div style="position: relative; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; opacity: 0.3;">
                                                <i data-lucide="search" style="width: 48px; height: 48px;"></i>
                                                <i data-lucide="circle-alert" style="width: 16px; height: 16px; position: absolute; bottom: 8px; left: 8px; background: white; border-radius: 50%;"></i>
                                            </div>
                                            <span style="font-size: 14px;">暂无数据</span>
                                            <span style="font-size: 11px; opacity: 0.7;">No data</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; background: #f8fafc;">
                    <button onclick="window.closeBankAccountModal()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="check" style="width: 16px; height: 16px;"></i> 确认
                    </button>
                </div>
            </div>
        </div>`;
        const div = document.createElement('div');
        div.innerHTML = modalHtml;
        document.body.appendChild(div.firstElementChild);
        modal = document.getElementById('bank-account-selection-modal');
    }
    modal.style.display = 'flex';
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }
};

window.closeBankAccountModal = function () {
    const modal = document.getElementById('bank-account-selection-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

// Added for Statement Generation check-all functionality
window.toggleAllStatementGenCheckboxes = function (masterCheckbox) {
    const table = masterCheckbox.closest('table');
    if (table) {
        const tbodyCheckboxes = table.querySelectorAll('tbody input[type="checkbox"]');
        tbodyCheckboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    }
};

// Added for Payment/Receipt check-all functionality
window.toggleAllPaymentCheckboxes = function (masterCheckbox) {
    const table = masterCheckbox.closest('table');
    if (table) {
        const tbodyCheckboxes = table.querySelectorAll('tbody input[type="checkbox"]');
        tbodyCheckboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    }
};
// Added for Invoice Application check-all functionality
window.toggleAllInvoiceAppCheckboxes = function (masterCheckbox) {
    const table = masterCheckbox.closest('table');
    if (table) {
        const tbodyCheckboxes = table.querySelectorAll('tbody input[type="checkbox"]');
        tbodyCheckboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    }
};
// Added for Bank Payment flow check-all functionality
window.toggleAllBankPaymentCheckboxes = function (masterCheckbox) {
    const table = masterCheckbox.closest('table');
    if (table) {
        const tbodyCheckboxes = table.querySelectorAll('tbody input[type="checkbox"]');
        tbodyCheckboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    }
};
